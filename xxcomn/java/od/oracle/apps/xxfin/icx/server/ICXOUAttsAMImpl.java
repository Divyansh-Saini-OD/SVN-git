package od.oracle.apps.xxfin.icx.server;
import oracle.jbo.RowSetIterator;
import oracle.jbo.domain.Number;
import java.sql.CallableStatement;
import oracle.apps.fnd.framework.server.OADBTransaction;
import oracle.apps.fnd.framework.server.OAApplicationModuleImpl;
//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class ICXOUAttsAMImpl extends OAApplicationModuleImpl 
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public ICXOUAttsAMImpl()
  {
  }

  /**
   * 
   * Container's getter for OUAttributesVO1
   */
  public OUAttributesVOImpl getOUAttributesVO1()
  {
    return (OUAttributesVOImpl)findViewObject("OUAttributesVO1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    launchTester("od.oracle.apps.xxfin.icx.server", "ICXOUAttsAMLocal");
  }

  public void apply()
  {
    OUAttributesVOImpl vo = getOUAttributesVO1();
    if (vo.isDirty()) {
      int fetchedRowCount = vo.getFetchedRowCount();
      if (fetchedRowCount>0) 
      {
        OUAttributesVORowImpl row = null;
        RowSetIterator rowIter = vo.createRowSetIterator("saveIter");
        rowIter.setRangeStart(0);
        rowIter.setRangeSize(fetchedRowCount);


        OADBTransaction txn = getOADBTransaction();
        int userId = txn.getUserId();
        int loginId = txn.getLoginId();
        
        try 
        {
          for (int i = 0; i < fetchedRowCount; i++) 
          {
            row = (OUAttributesVORowImpl)rowIter.getRowAtRangeIndex(i);
            if (row.isDirty())
            {
              String approver = row.getApproverName();
              Number org = row.getOrganizationID();
              updateOUAtts(org,approver,userId,loginId);
            }
          }
        }
        finally
        {
           rowIter.closeRowSetIterator();          
        }
      }
      vo.executeQuery();
    }
    //getTransaction().commit();
  }

  private void updateOUAtts(Number org, String approver, int userId, int loginId) 
  {
    OADBTransaction txn = getOADBTransaction();
    CallableStatement s = null;
    try
    {
      s = txn.createCallableStatement("call xx_icx_org_atts_pkg.load_row(?,?,?,?)",0);
      s.setLong(1,org.longValue());
      s.setString(2,approver);
      s.setInt(3,userId);
      s.setInt(4,loginId);
      s.execute();

      if (s != null) s.close();
    }
    catch(Exception ex)
    {
      try {if (s != null) s.close();}
      catch(Exception ex2) {};
    }
  }
}

