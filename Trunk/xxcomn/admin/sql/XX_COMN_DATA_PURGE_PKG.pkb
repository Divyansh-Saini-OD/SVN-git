CREATE OR REPLACE
PACKAGE BODY XX_COMN_DATA_PURGE_PKG                                                                                                                                                                                                                                                                                                                                                                             
-- +===================================================================+                                                                                                                                                                                                                                                                                                                                        
-- |                  Office Depot - Project Simplify                  |                                                                                                                                                                                                                                                                                                                                        
-- |                Oracle NAIO Consulting Organization                |                                                                                                                                                                                                                                                                                                                                        
-- +===================================================================+                                                                                                                                                                                                                                                                                                                                        
-- | Name        :  XX_DATA_PURGE_PKG.pks                              |                                                                                                                                                                                                                                                                                                                                        
-- | Description :  Custom/Staging tables data purging                 |                                                                                                                                                                                                                                                                                                                                        
-- |                                                                   |                                                                                                                                                                                                                                                                                                                                        
-- |Change Record:                                                     |                                                                                                                                                                                                                                                                                                                                        
-- |===============                                                    |                                                                                                                                                                                                                                                                                                                                        
-- |Version   Date        Author             Remarks                   |                                                                                                                                                                                                                                                                                                                                        
-- |========  =========== ================== ==========================|                                                                                                                                                                                                                                                                                                                                        
-- |DRAFT 1a  29-Oct-2007 Binoy              Initial draft version     |  
-- | 2.0      24-Mar-2016 Havish Kasina      Removed the schema referen|
-- |                                         ces as per R12.2 Changes  |                                                                                                                                                                                                                                                                                                                                      
-- +===================================================================+                                                                                                                                                                                                                                                                                                                                        
AS                                                                                                                                                                                                                                                                                                                                                                                                              
-- +===================================================================+                                                                                                                                                                                                                                                                                                                                        
-- | Name        :  data_purge_main                                    |                                                                                                                                                                                                                                                                                                                                        
-- | Description :  This procedure is invoked first when called from   |                                                                                                                                                                                                                                                                                                                                        
-- |                Data purging UI                                    |                                                                                                                                                                                                                                                                                                                                        
-- |                                                                   |                                                                                                                                                                                                                                                                                                                                        
-- |                                                                   |                                                                                                                                                                                                                                                                                                                                        
-- | Parameters  :                                                     |                                                                                                                                                                                                                                                                                                                                        
-- |                                                                   |                                                                                                                                                                                                                                                                                                                                        
-- | Returns     :                                                     |                                                                                                                                                                                                                                                                                                                                        
-- |                                                                   |                                                                                                                                                                                                                                                                                                                                        
-- +===================================================================+                                                                                                                                                                                                                                                                                                                                        
PROCEDURE data_purge_main                                                                                                                                                                                                                                                                                                                                                                                       
   (  x_errbuf              OUT VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      x_retcode             OUT VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_purge_group         IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_action_type         IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_commit              IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_c_para1             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_c_para2             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_c_para3             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_c_para4             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_c_para5             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_n_para1             IN  NUMBER,                                                                                                                                                                                                                                                                                                                                                                         
      p_n_para2             IN  NUMBER,                                                                                                                                                                                                                                                                                                                                                                         
      p_n_para3             IN  NUMBER,                                                                                                                                                                                                                                                                                                                                                                         
      p_n_para4             IN  NUMBER,                                                                                                                                                                                                                                                                                                                                                                         
      p_n_para5             IN  NUMBER,                                                                                                                                                                                                                                                                                                                                                                         
      p_d_para1             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_d_para2             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_d_para3             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_d_para4             IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_d_para5             IN  VARCHAR2                                                                                                                                                                                                                                                                                                                                                                        
  )                                                                                                                                                                                                                                                                                                                                                                                                             
-- the where cause for the insert/delete is required to have parameteres embedded like <c_para1>....<c_para5>                                                                                                                                                                                                                                                                                                   
-- also the date parameters will have <d_para1>....<d_para5>  and number parameters <n_para1>....<n_para5>                                                                                                                                                                                                                                                                                                      
-- These strings are replaced by the actual user entered parameters - during runtime                                                                                                                                                                                                                                                                                                                            
IS                                                                                                                                                                                                                                                                                                                                                                                                              
CURSOR lcu_purge IS                                                                                                                                                                                                                                                                                                                                                                                             
--SELECT                                                                                                                                                                                                                                                                                                                                                                                                        
--    source_schema,                                                                                                                                                                                                                                                                                                                                                                                            
--    source_table ,                                                                                                                                                                                                                                                                                                                                                                                            
--    target_table ,                                                                                                                                                                                                                                                                                                                                                                                            
--    insert_order ,                                                                                                                                                                                                                                                                                                                                                                                            
--    where_clause                                                                                                                                                                                                                                                                                                                                                                                              
--FROM                                                                                                                                                                                                                                                                                                                                                                                                          
--    xx_purge_tables                                                                                                                                                                                                                                                                                                                                                                                           
--WHERE purge_group = p_purge_group ;                                                                                                                                                                                                                                                                                                                                                                           
select nvl(source_value2, 0) step                                                                                                                                                                                                                                                                                                                                                                               
      ,source_value3 source_schema                                                                                                                                                                                                                                                                                                                                                                              
      ,source_value4 source_table                                                                                                                                                                                                                                                                                                                                                                               
      ,source_value5 target_schema                                                                                                                                                                                                                                                                                                                                                                              
      ,source_value6 target_table                                                                                                                                                                                                                                                                                                                                                                               
      ,target_value1 archival_date_column                                                                                                                                                                                                                                                                                                                                                                       
      -- Skipping columns 2..5 for future use                                                                                                                                                                                                                                                                                                                                                                   
      ,target_value6||' '||target_value7||' '||target_value8||' '||target_value9||' '||target_value10||' '||target_value11||' '||target_value12||' '||target_value13||' '||target_value14||' '||target_value15||' '||target_value16||' '||target_value17||' '||target_value18||' '||target_value19||' '||target_value20 where_clause                                                                            
FROM   xx_fin_translatedefinition           xdef,                                                                                                                                                                                                                                                                                                                                                               
       xx_fin_translatevalues               xval                                                                                                                                                                                                                                                                                                                                                                
WHERE  xdef.translation_name                = 'XXOD_COMN_ARCHIVE_PURGE'                                                                                                                                                                                                                                                                                                                                         
AND    xdef.translate_id                    = xval.translate_id                                                                                                                                                                                                                                                                                                                                                 
and    xval.source_value1                   = p_purge_group                                                                                                                                                                                                                                                                                                                                                     
AND    TRUNC  (SYSDATE) BETWEEN TRUNC(NVL(xval.start_date_active, SYSDATE -1)) AND TRUNC(NVL(xval.end_date_active, SYSDATE + 1))                                                                                                                                                                                                                                                                                
ORDER BY to_number(nvl(xval.source_value2, 0));                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                
CURSOR l_columns (p_schema VARCHAR2 ,                                                                                                                                                                                                                                                                                                                                                                           
                  p_table  VARCHAR2) IS                                                                                                                                                                                                                                                                                                                                                                         
SELECT column_name                                                                                                                                                                                                                                                                                                                                                                                              
FROM dba_tab_columns                                                                                                                                                                                                                                                                                                                                                                                            
WHERE owner = p_schema AND table_name = p_table                                                                                                                                                                                                                                                                                                                                                                 
ORDER BY column_name ;                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                
lc_sql     VARCHAR2(32000) ;                                                                                                                                                                                                                                                                                                                                                                                    
lc_columns VARCHAR2(32000) ;                                                                                                                                                                                                                                                                                                                                                                                    
lc_where   VARCHAR2(32000) ;                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                
BEGIN                                                                                                                                                                                                                                                                                                                                                                                                           
  fnd_file.put_line (fnd_file.log,'----    Parameters    ----');                                                                                                                                                                                                                                                                                                                                                
  fnd_file.put_line (fnd_file.log,'Group Name: ' || p_purge_group);                                                                                                                                                                                                                                                                                                                                             
  fnd_file.put_line (fnd_file.log,'Action Type: ' || p_action_type);                                                                                                                                                                                                                                                                                                                                            
  fnd_file.put_line (fnd_file.log,'Commit: ' || p_commit);                                                                                                                                                                                                                                                                                                                                                      
  fnd_file.put_line (fnd_file.log,'Char Parameters');                                                                                                                                                                                                                                                                                                                                                           
  fnd_file.put_line (fnd_file.log,'1: ' || p_c_para1);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'2: ' || p_c_para2);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'3: ' || p_c_para3);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'4: ' || p_c_para4);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'5: ' || p_c_para5);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'Numeric Parameters');                                                                                                                                                                                                                                                                                                                                                        
  fnd_file.put_line (fnd_file.log,'1: ' || p_n_para1);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'2: ' || p_n_para2);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'3: ' || p_n_para3);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'4: ' || p_n_para4);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'5: ' || p_n_para5);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'Date Parameters [Expected format: DD-MON-YYYY]');                                                                                                                                                                                                                                                                                                                            
  fnd_file.put_line (fnd_file.log,'1: ' || p_d_para1);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'2: ' || p_d_para2);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'3: ' || p_d_para3);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'4: ' || p_d_para4);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'5: ' || p_d_para5);                                                                                                                                                                                                                                                                                                                                                          
  fnd_file.put_line (fnd_file.log,'----    Parameters    ----');                                                                                                                                                                                                                                                                                                                                                
  fnd_file.put_line (fnd_file.log,' ');                                                                                                                                                                                                                                                                                                                                                                         
  -- Identify which group we want to work with.                                                                                                                                                                                                                                                                                                                                                                 
  FOR cur_purge IN lcu_purge LOOP                                                                                                                                                                                                                                                                                                                                                                               
    BEGIN                                                                                                                                                                                                                                                                                                                                                                                                       
      fnd_file.put_line (fnd_file.log,' ');                                                                                                                                                                                                                                                                                                                                                                     
      fnd_file.put_line (fnd_file.log,'Step  : ' || cur_purge.step);                                                                                                                                                                                                                                                                                                                                            
      fnd_file.put_line (fnd_file.log,'Source: ' || cur_purge.source_schema||'.'||cur_purge.source_table);                                                                                                                                                                                                                                                                                                      
      fnd_file.put_line (fnd_file.log,'Target: ' || cur_purge.target_schema||'.'||cur_purge.target_table);                                                                                                                                                                                                                                                                                                      
      lc_where := cur_purge.WHERE_CLAUSE ;                                                                                                                                                                                                                                                                                                                                                                      
      -- fnd_file.put_line (fnd_file.log,'Where Clause (Before substitutions): ' || lc_where);                                                                                                                                                                                                                                                                                                                  
      -- Replace parameterized variables with what is provided in the conc. program                                                                                                                                                                                                                                                                                                                             
      -- VARCHAR type parameters                                                                                                                                                                                                                                                                                                                                                                                
      lc_where := REPLACE(lc_where,'<c_para1>',''''||p_c_para1||'''') ;                                                                                                                                                                                                                                                                                                                                         
      lc_where := REPLACE(lc_where,'<c_para1>',''''||p_c_para2||'''') ;                                                                                                                                                                                                                                                                                                                                         
      lc_where := REPLACE(lc_where,'<c_para1>',''''||p_c_para3||'''') ;                                                                                                                                                                                                                                                                                                                                         
      lc_where := REPLACE(lc_where,'<c_para1>',''''||p_c_para4||'''') ;                                                                                                                                                                                                                                                                                                                                         
      lc_where := REPLACE(lc_where,'<c_para1>',''''||p_c_para5||'''') ;                                                                                                                                                                                                                                                                                                                                         
      -- Date type parameters                                                                                                                                                                                                                                                                                                                                                                                   
      -- Expected format: DD-MON-YYYY                                                                                                                                                                                                                                                                                                                                                                           
      lc_where := REPLACE(lc_where,'<d_para1>','to_date('''||p_d_para1||''', ''DD-MON-YYYY''') ;                                                                                                                                                                                                                                                                                                                
      lc_where := REPLACE(lc_where,'<d_para1>','to_date('''||p_d_para2||''', ''DD-MON-YYYY''') ;                                                                                                                                                                                                                                                                                                                
      lc_where := REPLACE(lc_where,'<d_para1>','to_date('''||p_d_para3||''', ''DD-MON-YYYY''') ;                                                                                                                                                                                                                                                                                                                
      lc_where := REPLACE(lc_where,'<d_para1>','to_date('''||p_d_para4||''', ''DD-MON-YYYY''') ;                                                                                                                                                                                                                                                                                                                
      lc_where := REPLACE(lc_where,'<d_para1>','to_date('''||p_d_para5||''', ''DD-MON-YYYY''') ;                                                                                                                                                                                                                                                                                                                
      -- Numeric parameters                                                                                                                                                                                                                                                                                                                                                                                     
      lc_where := REPLACE(lc_where,'<n_para1>',p_n_para1) ;                                                                                                                                                                                                                                                                                                                                                     
      lc_where := REPLACE(lc_where,'<n_para1>',p_n_para2) ;                                                                                                                                                                                                                                                                                                                                                     
      lc_where := REPLACE(lc_where,'<n_para1>',p_n_para3) ;                                                                                                                                                                                                                                                                                                                                                     
      lc_where := REPLACE(lc_where,'<n_para1>',p_n_para4) ;                                                                                                                                                                                                                                                                                                                                                     
      lc_where := REPLACE(lc_where,'<n_para1>',p_n_para5) ;                                                                                                                                                                                                                                                                                                                                                     
      -- fnd_file.put_line (fnd_file.log,'Where Clause (After Substitutions): ' || lc_where);                                                                                                                                                                                                                                                                                                                   
      lc_columns := NULL;                                                                                                                                                                                                                                                                                                                                                                                       
      -- Source and target table columns have to match 1 to 1.                                                                                                                                                                                                                                                                                                                                                  
      -- There could be additional columns in the archival table, but those are not supported for inserts.                                                                                                                                                                                                                                                                                                      
      -- All columns in the source table must exist in the target table                                                                                                                                                                                                                                                                                                                                         
      FOR cur_columns IN l_columns(cur_purge.SOURCE_SCHEMA, cur_purge.SOURCE_TABLE)                                                                                                                                                                                                                                                                                                                             
      LOOP                                                                                                                                                                                                                                                                                                                                                                                                      
         IF lc_columns IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                                         
            lc_columns := lc_columns || ',';                                                                                                                                                                                                                                                                                                                                                                    
         END IF ;                                                                                                                                                                                                                                                                                                                                                                                               
         lc_columns := lc_columns || cur_columns.column_name;                                                                                                                                                                                                                                                                                                                                                   
      END LOOP ;                                                                                                                                                                                                                                                                                                                                                                                                
      if (p_action_type = 'ARCHIVE') then                                                                                                                                                                                                                                                                                                                                                                       
          -- If "archival_date_column" is provided, set it to the current system date                                                                                                                                                                                                                                                                                                                           
	  -- This could become useful in the long term for partitioned approaches to archiving the target tables.                                                                                                                                                                                                                                                                                                      
	  -- There are ongoing discussion around the use  of transportable tablespaces                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                
          lc_sql := 'insert into ' ||                                                                                                                                                                                                                                                                                                                                                                           
                    cur_purge.target_schema||'.'||cur_purge.target_table ||                                                                                                                                                                                                                                                                                                                                     
                    ' ('||                                                                                                                                                                                                                                                                                                                                                                                      
                    lc_columns;                                                                                                                                                                                                                                                                                                                                                                                 
          if (cur_purge.archival_date_column is not null) then                                                                                                                                                                                                                                                                                                                                                  
              lc_sql := lc_sql || ', ' || cur_purge.archival_date_column;                                                                                                                                                                                                                                                                                                                                       
          end if;                                                                                                                                                                                                                                                                                                                                                                                               
          lc_sql := lc_sql || ') '||                                                                                                                                                                                                                                                                                                                                                                            
                    '( '||                                                                                                                                                                                                                                                                                                                                                                                      
                    ' select '||                                                                                                                                                                                                                                                                                                                                                                                
                    lc_columns;                                                                                                                                                                                                                                                                                                                                                                                 
          if (cur_purge.archival_date_column is not null) then                                                                                                                                                                                                                                                                                                                                                  
              lc_sql := lc_sql || ', sysdate';                                                                                                                                                                                                                                                                                                                                                                  
          end if;                                                                                                                                                                                                                                                                                                                                                                                               
          lc_sql := lc_sql || ' from '||                                                                                                                                                                                                                                                                                                                                                                        
                    cur_purge.source_schema||'.'||cur_purge.source_table ||                                                                                                                                                                                                                                                                                                                                     
                    ' where '||                                                                                                                                                                                                                                                                                                                                                                                 
                    lc_where ||                                                                                                                                                                                                                                                                                                                                                                                 
                    ') ';                                                                                                                                                                                                                                                                                                                                                                                       
          fnd_file.put_line (fnd_file.log,'Archive SQL: ' || lc_sql);                                                                                                                                                                                                                                                                                                                                           
          fnd_file.put_line (fnd_file.log,'Start Time: ' || to_char(sysdate, 'DD-MON-YYYY HH24:MI:SS'));                                                                                                                                                                                                                                                                                                        
          EXECUTE IMMEDIATE lc_sql ;                                                                                                                                                                                                                                                                                                                                                                            
          fnd_file.put_line (fnd_file.log,'End  Time: ' || to_char(sysdate, 'DD-MON-YYYY HH24:MI:SS'));                                                                                                                                                                                                                                                                                                         
          fnd_file.put_line (fnd_file.log,'Records Archived : '|| SQL%ROWCOUNT );                                                                                                                                                                                                                                                                                                                               
      end if;                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                
      if ( (p_action_type = 'ARCHIVE') OR (p_action_type = 'PURGE') ) then                                                                                                                                                                                                                                                                                                                                      
           lc_sql := 'DELETE ' ||                                                                                                                                                                                                                                                                                                                                                                               
                     cur_purge.source_schema||'.'||cur_purge.source_table ||                                                                                                                                                                                                                                                                                                                                    
                     ' WHERE ' ||                                                                                                                                                                                                                                                                                                                                                                               
                     lc_where ;                                                                                                                                                                                                                                                                                                                                                                                 
          fnd_file.put_line (fnd_file.log,'Purge SQL: ' || lc_sql);                                                                                                                                                                                                                                                                                                                                             
          fnd_file.put_line (fnd_file.log,'Start Time: ' || to_char(sysdate, 'DD-MON-YYYY HH24:MI:SS'));                                                                                                                                                                                                                                                                                                        
          EXECUTE IMMEDIATE lc_sql ;                                                                                                                                                                                                                                                                                                                                                                            
          fnd_file.put_line (fnd_file.log,'End  Time: ' || to_char(sysdate, 'DD-MON-YYYY HH24:MI:SS'));                                                                                                                                                                                                                                                                                                         
          fnd_file.put_line (fnd_file.log,'Records Purged  : '|| SQL%ROWCOUNT );                                                                                                                                                                                                                                                                                                                                
      end if;                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                
      -- Checking "commit" option                                                                                                                                                                                                                                                                                                                                                                               
      -- Primariy used for testing, but is useful when                                                                                                                                                                                                                                                                                                                                                          
      -- we want to check what will be moved/purged prior to commiting changes                                                                                                                                                                                                                                                                                                                                  
      if (p_commit = 'Y') then                                                                                                                                                                                                                                                                                                                                                                                  
          commit;                                                                                                                                                                                                                                                                                                                                                                                               
      else                                                                                                                                                                                                                                                                                                                                                                                                      
          rollback;                                                                                                                                                                                                                                                                                                                                                                                             
      end if;                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                
      EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                
          x_errbuf    :='Error procesing group: ' || p_purge_group ||' Table: ' || cur_purge.source_table || ' (Step|Where: ' || cur_purge.step ||'|'||lc_where || ' ) -> ) ' || cur_purge.target_table|| SQLERRM;                                                                                                                                                                                              
          x_retcode   :='2';                                                                                                                                                                                                                                                                                                                                                                                    
    end ;                                                                                                                                                                                                                                                                                                                                                                                                       
  end loop ;                                                                                                                                                                                                                                                                                                                                                                                                    
end data_purge_main;                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                
PROCEDURE purge_n_days_data                                                                                                                                                                                                                                                                                                                                                                                     
   (  x_errbuf              OUT VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      x_retcode             OUT VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_purge_group         IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_action_type         IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_commit              IN  VARCHAR2,                                                                                                                                                                                                                                                                                                                                                                       
      p_n_days              IN  NUMBER                                                                                                                                                                                                                                                                                                                                                                          
   )                                                                                                                                                                                                                                                                                                                                                                                                            
IS                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                
CURSOR c_batch_nbrs                                                                                                                                                                                                                                                                                                                                                                                             
IS                                                                                                                                                                                                                                                                                                                                                                                                              
select batch_id,                                                                                                                                                                                                                                                                                                                                                                                                
       creation_date                                                                                                                                                                                                                                                                                                                                                                                            
from hz_imp_batch_summary                                                                                                                                                                                                                                                                                                                                                                                  
where creation_date < sysdate-p_n_days                                                                                                                                                                                                                                                                                                                                                                          
order by batch_id;                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                
BEGIN                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                
fnd_file.put_line (fnd_file.log, 'Purge Started!');                                                                                                                                                                                                                                                                                                                                                             
fnd_file.put_line (fnd_file.log, 'Batch_IDs : ');                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                
FOR i IN c_batch_nbrs                                                                                                                                                                                                                                                                                                                                                                                           
LOOP                                                                                                                                                                                                                                                                                                                                                                                                            
    fnd_file.put_line (fnd_file.log, i.batch_id);                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                
    XX_COMN_DATA_PURGE_PKG.data_purge_main (                                                                                                                                                                                                                                                                                                                                                                    
                                             x_errbuf      => x_errbuf,                                                                                                                                                                                                                                                                                                                                         
                                             x_retcode     => x_retcode,                                                                                                                                                                                                                                                                                                                                        
                                             p_purge_group => p_purge_group,                                                                                                                                                                                                                                                                                                                                    
                                             p_action_type => p_action_type,                                                                                                                                                                                                                                                                                                                                    
                                             p_commit      => p_commit,                                                                                                                                                                                                                                                                                                                                         
                                             p_c_para1     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_c_para2     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_c_para3     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_c_para4     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_c_para5     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_n_para1     => i.batch_id,                                                                                                                                                                                                                                                                                                                                       
                                             p_n_para2     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_n_para3     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_n_para4     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_n_para5     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_d_para1     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_d_para2     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_d_para3     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_d_para4     => null,                                                                                                                                                                                                                                                                                                                                             
                                             p_d_para5     => null                                                                                                                                                                                                                                                                                                                                              
                                           );                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                
END LOOP;                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                
fnd_file.put_line (fnd_file.log, 'Purge Completed!');                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                
EXCEPTION                                                                                                                                                                                                                                                                                                                                                                                                       
  WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                              
    fnd_file.put_line (fnd_file.log, 'Exception: ' || SQLERRM);                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                
END PURGE_N_DAYS_DATA;                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                
END XX_COMN_DATA_PURGE_PKG;     
/

SHOW ERRORS;                                                                                                                                                                                                                                                                                                                                                                                

