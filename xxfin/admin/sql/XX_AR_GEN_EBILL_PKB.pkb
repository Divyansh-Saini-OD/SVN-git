CREATE OR REPLACE PACKAGE BODY xx_ar_gen_ebill_pkg
AS
---+============================================================================================+
---|                              Office Depot - Project Simplify                               |
---|                                   Providge Consulting                                      |
---+============================================================================================+
---|    Application     :       AR                                                              |
---|                                                                                            |
---|    Name           :        xx_ar_gen_ebill_pkg.pks                                         |
---|                                                                                            |
---|    Description   :        Generate text file from Oracle AR to OD's Ebill Central System   |
---|                                                                                            |
---|                                                                                            |
---|    Change Record                                                                           |
---|    ---------------------------------                                                       |
---|    Version         DATE              AUTHOR             DESCRIPTION                        |
---|    ------------    ----------------- ---------------    -----------------------------------|
---|    4.2				12-JUL-2018	      Aarthi             Sales person updated to NULL       |
---|                                                         for Defect#45279                   |	
---|    4.1             29-APR-2016       Havish Kasina      Kitting Changes, Defect#37670      |
---|    4.0             26-OCT-2015       Vasu Raparla       Removed schema References          |
---|    3.9             08-JAN-2014       Avinash Baddam     Included tax code for defect# 26781|
---|    3.8             04-DEC-2013       Arun Gannarapu     Made changes to add the status FINAL|
---|                                                         and approved -- defect 26795       |
---|    3.7             20-NOV-2013       Arun Gannarapu     Made changes to update status from |
---|                                                          Approved to Final'and CA tax issue|
---|                                                          defect # 26548                    |
-- |    3.6             15-JUL-2010       Gokila Tamilselvam Concatenating attribute15 column   |
-- |                                                         to the parameters in calling       |
-- |                                                         xx_ar_infocopy_handling function   |
---|                                                         as part of R1.4 CR# 586.           |
---|    3.5             12-MAY-2010       Ranjith Prabu      Changes for defect 5846            |
---|    3.4             28-APR-2010       Sambasiva Reddy D  Modified for Defects 3561,4761     |
---|                                                         Modified lc_comments for SPC orders|
---|                                                         Updated ar_cons_inv with standard  |
---|                                                         who columns and attribute15 as 'Y' |
-- |    3.3             06-APR-2010       Tamil Vendhan L    Modified for R1.3 CR 738 Defect    |
-- |                                                         2766                               |
-- |    3.2             31-MAR-2010       Tamil Vendhan L    Modified for R1.3 CR 733 Defect    |
-- |                                                         1212                               |
-- |    3.1             02-FEB-2010       Lincy K            Updated code for R1.2 Defect# 4136 |
-- |    3.0             28-JAN-2010       Lincy K            Modified for R1.2 Defect #4136     |
-- |    2.9             15-DEC-2009       Tamil Vendhan L    Modified for R1.2 CR 466           |
-- |                                                         Defect 1210                        |
---|    2.8             16-NOV-2009       Lincy K            Modified for the Prod Defect #2858 |
-- |    2.7             29-SEP-2009       Tamil Vendhan L    Modified for the Prod Defect #2025 |
-- |    2.6             16-SEP-2009       Tamil Vendhan L    Modified for the R1.1 Defect #1451 |
-- |                                                         (CR 626)                           |
---|    2.5             09-SEP-2009       RamyaPriya M       Modified for the Prod defect #2067 |
---|    2.4             28-AUG-2009       Vinaykumar S       Modified for Defect # 2122         |
---|    2.3             17-AUG-2009       Vinaykumar S       Defect # 1760                      |
---|    2.2             02-AUG-2009       RamyaPriya M       Modified for Defect #869 and #892  |
---|    2.1             01-AUG-2009       Sambasiva Reddy D  Defect # 1742                      |
---|    2.0             17-JUL-2009       Samabsiva Reddy D  Defect# 631 (CR# 662)              |
---|                                                         - Applied Credit Memos             |
---|    1.39            17-JUN-2009       Sambasiva Reddy D  Modified for defect 15063          |
---|    1.38            11-JUN-2009       Sambasiva Reddy D  Added for the Defect#15342         |
---|    1.37            12-MAR-2009       RamyaPriya M       Added for defect 13717             |
---|    1.36            11-MAR-2009       RamyaPriya M       Added for defect 13650             |
---|    1.35            02-MAR-2009       RamyaPriya M       Added for defect 13486,13488       |
---|    1.34            27-FEB-2009       mohan              Added changes for the defect 13472 |
---|    1.33            10-FEB-2009       Ranjith Thangasamy Added changes for the defect 8927  |
---|                                                         for printing cost center dept desc |
---|    1.32            07-JAN-2009       RamyaPriya M       Added for the defect 11993         |
---|    1.31            27-NOV-2008       Ganga Devi R       Added for Defect 12435           --|
---|    1.30            21-NOV-2008       Shobana S          Added a new procedure for          |
---|                                                         defect 12468                     --|
---|    1.29            03-NOV-2008       Shobana S          Added for Defect 8867              |
---|    1.28            30-OCT-2008       Shobana S          Added for Defect 12243             |
---|    1.27            21-OCT-2008       Shobana S          Added for Defect 10000             |
---|    1.26            21-OCT-2008       Sambasiva Reddy D  Added/modified log messages        |
---|    1.25            20-OCT-2008       Shobana S          Defect#10998,appended request_id   |
---|    1.24            07-OCT-2008       Sambasiva Reddy D  Defect # 11741                     |
---|    1.23            30-SEP-2008       Balaguru Seshadri  Multiply tax rate field by 100     |
---|                                                         to the variable assignment         |
---|                                                         lc_tax_rate :=ln_tax_rate          |
---|    1.22            19-SEP-2008       Balaguru Seshadri  Defects 10297, 10299, 11047, 10836 |
---|                                                         10000, 11214 and 11254.            |
---|    1.21            28-AUG-2008       Balaguru Seshadri  Defect# 9979                       |
---|    1.20            26-AUG-2008       Balaguru Seshadri  Defect# 10282 and 10284            |
---|    1.19            21-AUG-2008       Sarat Uppalapati   Defect# 9966 Missing Address       |
---|                                                         Business Name and AOPS Ship To     |
---|                                                         Sequence                           |
---|    1.18            12-AUG-2008       Sarat Uppalapati   Defect# 9077 Add new "As of Date"  |
---|                                                         parameter.                         |
---|    1.17            07-AUG-2008       Sarat Uppalapati   Defect# 9035 for Info copy         |
---|                                                         Changed back to <= SYSDATE         |
---|    1.16            29-JUL-2008       Sarat Uppalapati   Defect# 9035 for Info copy         |
---|    1.16            28-JUL-2008       Greg Dill          Defect# 9043 for Pay Docs          |
---|    1.15            24-JUL-2008       Sarat Uppalapati   Defect# 9035 ,9043                 |
---|    1.15            21-JUL-2008       Sarat Uppalapati   Defect# 9140 ,9142                 |
---|    1.14            17-JUL-2008       Sarat Uppalapati   Defect# 9043 ,8713                 |
---|    1.13            11-JUL-2008       Sarat Uppalapati   Defect# 8920                       |
---|    1.13            11-JUL-2008       Sarat Uppalapati   Defect# 8654                       |
---|    1.12            11-JUL-2008       Sarat Uppalapati   Changed generate_info_copy2        |
---|                                                         to generate_info_copy              |
---|    1.12            11-JUL-2008       Sarat Uppalapati   Deleted generate_info_copy1        |
---|                                                         , we are not using anymore         |
---|    1.12            09-JUL-2008       Sarat Uppalapati   Defect# 8866                       |
---|    1.11            09-JUL-2008       Sarat Uppalapati   Defect# 8673                       |
---|    1.11            07-JUL-2008       Sarat Uppalapati   Defect# 8713                       |
---|    1.10            07-JUL-2008       Sarat Uppalapati   Defect# 8673                       |
---|    1.9             01-JUL-2008       Sarat Uppalapati   Defect# 8616,8617                  |
---|    1.8             16-JUN-2008       Sarat Uppalapati   Defect# 5615                       |
---|    1.7             30-MAY-2008       Sarat Uppalapati   Modified Info file logic           |
---|    1.6             29-MAY-2008       Sarat Uppalapati   Added logic for totals             |
---|    1.5             12-MAY-2008       Sarat Uppalapati   Added Info file logic (Defect#5464)|
---|    1.4             30-APR-2008       Sarat Uppalapati   Add info copy logic.               |
---|    1.3             04-APR-2008       Balaguru Seshadri  Defect 5615                        |
---|    1.2             31-MAR-2008       Balaguru Seshadri  Defect 5614/16                     |
---|    1.1             03-MAR-2008       Balaguru Seshadri  Defect 4974                        |
---|    1.0             07-AUG-2007       Petritia Sampath   Initial Version                    |
---+============================================================================================+
   g_pkb_version   NUMBER (2, 1) := '3.6';
   gn_item_master_org            NUMBER                             := NULL; -- Added for Kitting, Defect#37670 

--=================================================
--This function is used to get the warehouse name
--=================================================
   FUNCTION get_warehouse_name (p_warehouse_id IN NUMBER)
      RETURN VARCHAR2
   IS
      lc_inv_org_name   org_organization_definitions.organization_name%TYPE := TO_CHAR (NULL);
   BEGIN
      SELECT ooh.organization_name
      INTO   lc_inv_org_name
      FROM   org_organization_definitions ooh
      WHERE  organization_id = p_warehouse_id;

      RETURN lc_inv_org_name;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN TO_CHAR (NULL);
      WHEN TOO_MANY_ROWS
      THEN
         RETURN TO_CHAR (NULL);
      WHEN OTHERS
      THEN
/*         fnd_file.put_line (fnd_file.LOG,
                            'get_warehouse_name :'
                            || SUBSTR (SQLERRM, 1, 2000)
                           ); */ --Commented for Defect # 1742
         RETURN TO_CHAR (NULL);
   END get_warehouse_name;

--=====================================
--Function to get the operating Unit
--=====================================
   FUNCTION get_operating_unit (org IN NUMBER)
      RETURN VARCHAR2
   IS
      lv_org_name   hr_operating_units.NAME%TYPE   := TO_CHAR (NULL);
   BEGIN
      SELECT NAME
      INTO   lv_org_name
      FROM   hr_operating_units
      WHERE  organization_id = org;

      RETURN lv_org_name;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN '';
      WHEN TOO_MANY_ROWS
      THEN
/*         fnd_file.put_line (fnd_file.LOG,
                               'GET_OPERATING_UNIT :TOO MANY ROWS'
                            || SUBSTR (SQLERRM, 1, 2000)
                           ); */ --Commented for Defect # 1742
         RETURN '';
      WHEN OTHERS
      THEN
/*         fnd_file.put_line (fnd_file.LOG,
                            'GET_OPERATING_UNIT :'
                            || SUBSTR (SQLERRM, 1, 2000)
                           ); */ --Commented for Defect # 1742
         RETURN '';
   END get_operating_unit;

   FUNCTION remove_special_char (ps_string VARCHAR2)
      RETURN VARCHAR2
   IS
      ls_string        VARCHAR2 (2000);
      ln_pos           NUMBER;
      ls_string_new    VARCHAR2 (2000);
      ls_placeholder   VARCHAR2 (10)   := '&~#@%^|';
   BEGIN
      ls_string := REPLACE (ASCIISTR (ps_string), '\005C', ls_placeholder);
      ls_string_new := ls_string;

      LOOP
         ln_pos := INSTR (ls_string, '\');

         IF ln_pos != 0
         THEN
            ls_string_new :=
                  SUBSTR (ls_string, 1, ln_pos - 1)
               || SUBSTR (ls_string, ln_pos + 5);
         ELSE
            EXIT;
         END IF;

         ls_string := ls_string_new;
      END LOOP;

      RETURN REPLACE (ls_string_new, ls_placeholder, '\');
   EXCEPTION
      WHEN OTHERS
      THEN
      RETURN NULL;  --Added for Defect # 1742
/*         fnd_file.put_line (fnd_file.LOG,
                            'Problem in function remove_special_char'
                           );
         fnd_file.put_line (fnd_file.LOG, 'remove_special_char: ' || SQLERRM); */ --Commented for Defect # 1742
   END remove_special_char;

   FUNCTION get_total_discount (p_trx_id IN NUMBER)
      RETURN NUMBER
   IS
-- =========================
-- Total Discount
-- =========================
   BEGIN
--      SELECT SUM (NVL (ractl.extended_amount, 0))       -- Commented as a part of the prod defect # 2025
       SELECT NVL(SUM(ractl.extended_amount),0)           -- Added as a part of the prod defect # 2025
        INTO xx_ar_gen_ebill_pkg.g_discount
        FROM ra_customer_trx_lines ractl, oe_price_adjustments oepa
       WHERE 1 = 1
         AND ractl.customer_trx_id = p_trx_id
         AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id;

      RETURN xx_ar_gen_ebill_pkg.g_discount;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN 0;
      WHEN OTHERS
      THEN
/*         fnd_file.put_line
                     (fnd_file.output,
                         'Error in get_total_discount for customer_trx_id =>'
                      || p_trx_id
                     );
         fnd_file.put_line (fnd_file.output, SQLCODE || '-' || SQLERRM); */ --Commented for Defect # 1742
         RETURN 0;
   END get_total_discount;

   FUNCTION get_total_misc_chrg (p_trx_id IN NUMBER)
      RETURN NUMBER
   IS
-- ===================++++======
-- Total Miscellaneous Charges
-- =======================++++==
   BEGIN
--      SELECT SUM (NVL (a.extended_amount, 0))     -- Commented as a part of the prod defect # 2025
       SELECT NVL(SUM(a.extended_amount),0)         -- Added as a part of the prod defect # 2025
        INTO xx_ar_gen_ebill_pkg.g_misc_charges
        FROM ra_customer_trx_lines a
       WHERE 1 = 1
         AND a.customer_trx_id = p_trx_id
         AND EXISTS (
                SELECT 1
                  FROM fnd_lookup_values
                 WHERE lookup_type = 'OD_FEES_ITEMS'
                   AND attribute7 = 'MISCELLANEOUS'
                   AND attribute6 = a.inventory_item_id
                   AND LANGUAGE = USERENV ('LANG'));

      RETURN xx_ar_gen_ebill_pkg.g_misc_charges;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN 0;
      WHEN OTHERS
      THEN
/*         fnd_file.put_line
                    (fnd_file.output,
                        'Error in get_total_misc_chrg for customer_trx_id =>'
                     || p_trx_id
                    );
         fnd_file.put_line (fnd_file.output, SQLCODE || '-' || SQLERRM); */ --Commented for Defect # 1742
         RETURN 0;
   END get_total_misc_chrg;

   FUNCTION get_total_delivery (p_trx_id IN NUMBER)
      RETURN NUMBER
   IS
-- =========================
-- Total Delivery Charges
-- =========================
   BEGIN
--      SELECT SUM (NVL (a.extended_amount, 0))      -- Commented as a part of the prod defect # 2025
       SELECT NVL(SUM(a.extended_amount),0)          -- Added as a part of the prod defect # 2025
        INTO xx_ar_gen_ebill_pkg.g_delivery
        FROM ra_customer_trx_lines a
       WHERE 1 = 1
         AND customer_trx_id = p_trx_id
         AND EXISTS (
                SELECT 1
                  FROM fnd_lookup_values
                 WHERE lookup_type = 'OD_FEES_ITEMS'
                   AND attribute7 = 'DELIVERY'
                   AND attribute6 = a.inventory_item_id
                   AND LANGUAGE = USERENV ('LANG'));

      RETURN xx_ar_gen_ebill_pkg.g_delivery;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN 0;
      WHEN OTHERS
      THEN
/*         fnd_file.put_line
                     (fnd_file.output,
                         'Error in get_total_delivery for customer_trx_id =>'
                      || p_trx_id
                     );
         fnd_file.put_line (fnd_file.output, SQLCODE || '-' || SQLERRM); */ --Commented for Defect # 1742
         RETURN 0;
   END get_total_delivery;

   FUNCTION get_total_coupon (p_trx_id IN NUMBER)
      RETURN NUMBER
   IS
-- =========================
-- Total Coupon amount
-- =========================
   BEGIN
--      SELECT SUM (NVL (ractl.extended_amount, 0))      -- Commented as a part of the prod defect # 2025
       SELECT NVL(SUM(ractl.extended_amount),0)          -- Added as a part of the prod defect # 2025
        INTO xx_ar_gen_ebill_pkg.g_coupon
        FROM ra_customer_trx_lines ractl, oe_price_adjustments oepa
       WHERE 1 = 1
         AND ractl.customer_trx_id = p_trx_id
         AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
         AND oepa.attribute8 = '10';

      RETURN xx_ar_gen_ebill_pkg.g_coupon;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN 0;
      WHEN OTHERS
      THEN
/*         fnd_file.put_line
                       (fnd_file.output,
                           'Error in get_total_coupon for customer_trx_id =>'
                        || p_trx_id
                       );
         fnd_file.put_line (fnd_file.output, SQLCODE || '-' || SQLERRM); */ --Commented for Defect # 1742
         RETURN 0;
   END get_total_coupon;

   FUNCTION get_inv_totals (
      p_type      IN   VARCHAR2,
      p_inv_org   IN   NUMBER,
      p_trx_id    IN   NUMBER
   )
      RETURN NUMBER
   IS
      n_amount   NUMBER := 0;
   BEGIN
      IF p_type = 'INVOICE'
      THEN
--         SELECT SUM (NVL (ailv.extended_amount, 0))            -- Commented as a part of the prod defect # 2025
          SELECT NVL(SUM(ailv.extended_amount),0)                -- Added as a part of the prod defect # 2025
           INTO n_amount
           FROM ra_customer_trx_lines ailv
          WHERE ailv.customer_trx_id = p_trx_id;

         RETURN n_amount;
      ELSIF p_type = 'SKU'
      THEN
--         SELECT SUM (NVL (ailv.extended_amount, 0))                -- Commented as a part of the prod defect # 2025
          SELECT NVL(SUM(ailv.extended_amount),0)                    -- Added as a part of the prod defect # 2025
           INTO n_amount
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = p_inv_org) msib
          WHERE 1 = 1
            AND (    ailv.customer_trx_id = p_trx_id
                 AND ailv.line_type = 'LINE'
                 AND ailv.interface_line_attribute11=0 -- added for defect #892 -- avoids discounts
                 AND ailv.inventory_item_id = msib.inv_item_id
                 /* AND ailv.inventory_item_id NOT IN (
                        SELECT TO_NUMBER (attribute6)
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND LANGUAGE = USERENV ('LANG')) */ -- Commented for the defect #2067
                 AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
                );

         RETURN n_amount;
      ELSE
         RETURN 0;
      END IF;
   EXCEPTION
      WHEN OTHERS
      THEN
/*         fnd_file.put_line
              (fnd_file.LOG,
                  'problem in function get_inv_totals ,invoice type and id :'
               || p_type
               || ' ,'
               || p_trx_id
              );
         fnd_file.put_line (fnd_file.LOG, SQLERRM); */ --Commented for Defect # 1742
         RETURN 0;
   END get_inv_totals;

-- Below function is added for R1.1 Defect # 1451 (CR 626)

   FUNCTION get_total_gc_chrg (p_trx_id IN NUMBER)
      RETURN NUMBER
   IS
-- =========================
-- Total Gift Card Charges
-- =========================

   lc_trx_type           ra_cust_trx_types.type%TYPE;
   ln_gc_amt             NUMBER            := 0;
   lc_error_location     VARCHAR2(4000)    := NULL;
   lc_error_debug        VARCHAR2(4000)    := NULL;

   BEGIN
      lc_error_location := 'Getting transaction type for gift card transactions';
      lc_error_debug    := ' Trx_id : ' ||p_trx_id;
      SELECT  RCTT.type
      INTO    lc_trx_type
      FROM    ra_customer_trx_all RCT
             ,ra_cust_trx_types  RCTT
      WHERE   RCT.cust_trx_type_id            = RCTT.cust_trx_type_id
      AND     RCT.customer_trx_id             = p_trx_id;

      IF (lc_trx_type = 'INV') THEN
         lc_error_location := 'Getting total amount for gift card invoices';
         lc_error_debug    := ' Trx_id : ' ||p_trx_id;
         SELECT  NVL(SUM(OP.payment_amount),0)
         INTO    ln_gc_amt
         FROM    oe_payments OP
                ,ra_customer_trx_all RCT
         WHERE   OP.header_id        = RCT.attribute14
         AND     RCT.customer_trx_id = p_trx_id;
      ELSIF (lc_trx_type = 'CM') THEN
         lc_error_location := 'Getting total amount for gift card credit memos';
         lc_error_debug    := ' Trx_id : ' ||p_trx_id;
         SELECT  NVL(SUM(ORT.credit_amount)*-1,0)
         INTO    ln_gc_amt
         FROM    xx_om_return_tenders_all ORT
                ,ra_customer_trx_all RCT
         WHERE   ORT.header_id       = RCT.attribute14
         AND     RCT.customer_trx_id = p_trx_id;
      END IF;

   RETURN ln_gc_amt;

   EXCEPTION
      WHEN OTHERS THEN
         FND_FILE.PUT_LINE(FND_FILE.LOG, 'Error in getting the total gift card amount');
         FND_FILE.PUT_LINE(FND_FILE.LOG, lc_error_location || lc_error_debug ||' Error Message : ' || SQLERRM );
         RAISE;

   END get_total_gc_chrg;

-- End of changes for R1.1 Defect # 1451 (CR 626)

--Below function is added for the R1.3 Defect # 2766 (CR 738)

-- +===================================================================================+
-- |                  Office Depot - Project Simplify                                  |
-- |                       WIPRO Technologies                                          |
-- +===================================================================================+
-- | Name        : Infocopies handling logic for INV_IC scenario                       |
-- | Description : This function will return 'Y' or 'N' depending upon whether the     |
-- |               infocopy can be sent or not                                         |
-- |                                                                                   |
-- |                                                                                   |
-- |                                                                                   |
-- |Change Record:                                                                     |
-- |===============                                                                    |
-- |Version   Date          Author              Remarks                                |
-- |=======   ==========   =============        =======================================|
-- |1.0       01-Apr-10    Tamil Vendhan L      Initial Version                        |
-- +===================================================================================+

FUNCTION XX_AR_INFOCOPY_HANDLING (p_attr             IN VARCHAR2
                                 ,p_doc_term         IN VARCHAR2
                                 ,p_cut_off_date     IN DATE
                                 ,p_eff_start_date   IN DATE
                                 ,p_as_of_date       IN DATE
                                 )
RETURN VARCHAR2 AS

   lc_result         VARCHAR2(1);
   lc_error_location VARCHAR2(2000);

    BEGIN
       lc_error_location := 'Checking for the effective start date condition ';

       IF ( xx_ar_inv_freq_pkg.compute_effective_date (p_doc_term
                                                      ,p_cut_off_date
                                                      ) >= p_eff_start_date ) THEN

       lc_error_location := 'Checking for whether the paydoc sent or not ';

          IF (p_attr IS NOT NULL) THEN
              lc_result :='Y';
          ELSE
             lc_error_location := 'Checking for whether the infodoc falls under the current frequency ';
             IF p_cut_off_date = p_as_of_date THEN
                lc_result :='Y';
             ELSE
               lc_result :='N';
             END IF;
          END IF;
       ELSE
          lc_result :='N';
       END IF;
    RETURN (lc_result);

    EXCEPTION
       WHEN OTHERS THEN
          FND_FILE.PUT_LINE(FND_FILE.LOG,'When others exception in '||lc_error_location);
          RETURN ('N');

    END XX_AR_INFOCOPY_HANDLING;

-- End of changes for R1.3 CR 738 Defect 2766

--==================================================
--Main procedure that extracts the data into a file
--===================================================
   PROCEDURE generate_file (
      x_errbuf       OUT      VARCHAR2,
      x_retcode      OUT      VARCHAR2,
      p_file_path    IN       VARCHAR2,
      p_as_of_date   IN       VARCHAR2 DEFAULT SYSDATE,          -- Defect 9077
      p_cust_id_from IN       NUMBER,      --Added as a part of the defect 1760
      p_cust_id_to   IN       NUMBER      --Added as a part of the defect 1760
   )
   IS
--+==========================================================
-- Cursor for getting all the header level details
--+==========================================================
      CURSOR lcu_header(p_attr_group_id IN NUMBER  --Added as a part of the defect 13717
                       ,p_cust_id_from  IN NUMBER      --Added as a part of the defect 1760
                       ,p_cust_id_to    IN NUMBER      --Added as a part of the defect 1760
                       )
      IS
         SELECT   *
             FROM (SELECT TO_CHAR (NULL) trx_number,
                          aci.site_use_id billing_site_id,
                          aci.term_id term_id, aci.cons_inv_id cons_inv_id,
                          aci.cons_billing_number cbi_number,
                          acitl.customer_trx_id customer_trx_id,
                          TO_CHAR (NULL) interface_header_attribute1,
                          TO_CHAR (NULL) LOCATION, TO_CHAR (NULL)
                                                                 phone_number,
                          aci.currency_code invoice_currency_code,
                          TO_CHAR (NULL) orig_system_reference,
                          TO_CHAR (NULL) site_use_code,
                          TO_CHAR (NULL) purchase_order_number,
                          TO_CHAR (NULL) bill_to_customer_number,
                          aci.cut_off_date cut_off_date,
                          aci.issue_date issue_date,
                          TO_CHAR (NULL) bus_name      --bill_to_customer_name
                                                 ,
                          aci.due_date due_date
                                               --,TO_CHAR(NULL)                     name
                          , aci.term_name NAME,
                          TO_CHAR (NULL) interface_header_attribute2,
                          TO_CHAR (NULL) tax_registration_number,
                          TO_CHAR (NULL) primary_salesrep_name,
                          TO_CHAR (NULL) ship_to_customer_name,
                          TO_CHAR (NULL) ship_to_address1,
                          TO_CHAR (NULL) ship_to_address2,
                          TO_CHAR (NULL) ship_to_city,
                          TO_CHAR (NULL) ship_to_state,
                          TO_CHAR (NULL) ship_to_postal_code,
                          TO_CHAR (NULL) ship_to_country,
                          TO_CHAR (NULL) ship_to_contact
             --AIHV.ship_to_contact_first_name||AIHV.ship_to_contact_last_name
                                                        ,
                          TO_DATE (NULL) trx_date,
                          TO_CHAR (NULL) ship_to_location,
                          TO_CHAR (NULL) bill_to_name
                                                  --AIHV.bill_to_customer_name
                                                     ,
                          TO_CHAR (NULL) bill_to_location,
                          TO_CHAR (NULL) bill_to_address1,
                          TO_CHAR (NULL) bill_to_address2,
                          TO_CHAR (NULL) bill_to_city,
                          TO_CHAR (NULL) bill_to_state,
                          TO_CHAR (NULL) bill_to_postal_code,
                          TO_CHAR (NULL) bill_to_country,
                          TO_CHAR (NULL) default_bill_attn, aci.org_id org_id,
                          xcaebv.extension_id extension_id,
                          aci.customer_id customer_id,
                          TO_CHAR (NULL) ordsourcecd
                                                 --interface_header_attribute2
                                                    ,
                          RPAD (xcaebv.spl_handling, 4, ' ') specl_handlg_cd,
                          xcaebv.billing_term billing_term,
                          TO_DATE (NULL) invoice_date, NULL billing_id,
                          'PAYDOC' billing_method,                                  -- Added for R1.2 Defect 1210 CR 466
                          xcaebv.cust_doc_id cust_doc_id                                        -- Added for R1.2 Defect 1210 CR 466
                          ,NULL CREATION_DATE                                       -- Added for defect #4136
                     FROM (SELECT arci.customer_id,
                                  TRUNC (arci.due_date) due_date
                                                                --,TRUNC(arci.issue_date) issue_date
                                  ,
                               -- TRUNC (arci.cut_off_date) issue_date,     --Commented for the defect 11993
                                  --TRUNC (arci.cut_off_date - 1) issue_date, --Added for the defect 11993 but Commented for the defect 15063
                                  TO_DATE(arci.attribute1) - 1   issue_date,  --Added for Defect# 15063. The logic of the attribute1 column is handled in the procedure XX_AR_PRINT_NEW_CON_PKG.MAIN
                                  arci.cons_billing_number, arci.cons_inv_id,
                                  hzcp.standard_terms term_id,
                                  SUBSTR (rt.description, 1, 15) term_name,
                                  arci.site_use_id,
                                  --TRUNC (arci.cut_off_date - 1) cut_off_date Commented for the defect 15063
                                  TO_DATE(arci.attribute1) - 1   cut_off_date,  --Added for Defect# 15063. The logic of the attribute1 column is handled in the procedure XX_AR_PRINT_NEW_CON_PKG.MAIN
                                                                -- Defect 9043
                                  arci.currency_code, arci.org_id
                             FROM ar_cons_inv arci,
                                  hz_customer_profiles hzcp,
                                  ra_terms_tl rt
                            WHERE  hzcp.cust_account_id = arci.customer_id
                              AND arci.customer_id BETWEEN p_cust_id_from AND p_cust_id_to             --Added as a part of the Defect# 1760
                              AND hzcp.site_use_id = arci.site_use_id
                              AND rt.term_id = hzcp.standard_terms
                              AND rt.language =USERENV('LANG')   -- added for 1760
                              AND arci.status IN ( 'FINAL' ,'ACCEPTED')      -- Defect 8654 26795
                              AND (    arci.attribute2 IS NULL
                                   AND arci.attribute4 IS NULL
                                   AND arci.attribute10 IS NULL
                                   AND ARCI.attribute15 IS NULL    --Added as part of R1.4 CR# 586
                                  )
                                   --AND NVL(arci.attribute4 ,'N') != 'Y'
                          ) aci,
                          (SELECT   a.cons_inv_id, a.customer_trx_id
                               FROM ar_cons_inv_trx_lines_all a
                              WHERE 1 = 1
                           GROUP BY a.cons_inv_id, a.customer_trx_id) acitl,
                          /*(SELECT extension_id, cust_account_id,           --Commented as a part of the defect 13717
                                  billdocs_special_handling spl_handling,
                                  billdocs_payment_term billing_term
                             FROM xx_cdh_a_ext_billdocs_v
                            WHERE 1 = 1
                              AND billdocs_doc_type = 'Consolidated Bill'
                              AND billdocs_delivery_meth = 'ELEC' \
                              AND billdocs_paydoc_ind = 'Y') xcaebv*/
                            (SELECT extension_id,
                                    cust_account_id,
                                    c_ext_attr4  spl_handling,
                                    c_ext_attr14 billing_term,
                                    n_ext_attr2  cust_doc_id                       -- Added for R1.2 Defect 1210 CR 466
                             FROM xx_cdh_cust_acct_ext_b
                             WHERE c_ext_attr1= 'Consolidated Bill'
                               AND c_ext_attr3 = 'ELEC'
                               AND c_ext_attr2 = 'Y'
                               AND attr_group_id = p_attr_group_id          --Added as a part of the defect 13717
                               -- Added for the below conditions for R1.3 CR 738 Defect 2766
                               AND g_as_of_date  >= d_ext_attr1
                               AND (d_ext_attr2  IS NULL
                                    OR
                                    g_as_of_date <= d_ext_attr2))  xcaebv
                               -- End of changes for R1.3 CR 738 Defect 2766
                    WHERE 1 = 1
                      AND aci.cons_inv_id = acitl.cons_inv_id
                      AND aci.customer_id = xcaebv.cust_account_id
                      AND 'Y' =
                             (SELECT 'Y'
                                FROM ar_payment_schedules arps
                               WHERE 1 = 1
                                 AND arps.customer_trx_id =
                                                         acitl.customer_trx_id
                             --  AND arps.amount_due_original != 0  -- Commented for Defect# 631 (CR# 662)
                                 AND arps.amount_due_original NOT BETWEEN xx_ar_gen_ebill_pkg.ln_write_off_amt_low
                                             AND xx_ar_gen_ebill_pkg.ln_write_off_amt_high  -- Added for Defect# 631 (CR# 662)
                              )
--  AND EXISTS
--      (
--        SELECT cons_inv_id, transaction_type
--        FROM ar_cons_inv_trx acit
--        WHERE 1 =1
--          AND acit.cons_inv_id = aci.cons_inv_id
--          AND acit.transaction_type in ('INVOICE', 'CREDIT_MEMO')
--      )
                      AND xx_ar_inv_freq_pkg.compute_effective_date
                                                         (xcaebv.billing_term,
                                                          aci.issue_date
                                                         ) <= g_as_of_date)
         ORDER BY cons_inv_id, customer_trx_id;

/*
-- ===============================================
-- Deferred POST GO-LIVE...
-- ===============================================
UNION ALL
SELECT TO_CHAR(NULL)
      ,aci.site_use_id
      ,aci.term_id
      ,aci.cons_inv_id
      ,aci.cons_billing_number
      ,arps.customer_trx_id
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,aci.currency_code
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,aci.cut_off_date
      ,aci.issue_date
      ,TO_CHAR(NULL)
      ,aci.due_date
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_DATE(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,aci.org_id
      ,xcaebv.extension_id
      ,aci.customer_id
      ,TO_CHAR(NULL)
      ,RPAD(xcaebv.spl_handling ,4 ,' ')
      ,xcaebv.billing_term               billing_term
      ,to_date(null)                     invoice_date
FROM   (
         SELECT arci.customer_id
               ,TRUNC(arci.due_date) due_date
               ,TRUNC(arci.issue_date) issue_date
               ,arci.cons_billing_number
               ,arci.cons_inv_id
               ,arci.term_id
               ,arci.site_use_id
               ,TRUNC(arci.cut_off_date) cut_off_date
               ,arci.currency_code
               ,arci.org_id
         FROM   ar_cons_inv arci
         WHERE  NVL(arci.attribute4 ,'N') != 'Y'
       ) aci
      ,( SELECT extension_id
               ,cust_account_id
               ,billdocs_special_handling spl_handling
               ,billdocs_payment_term billing_term
         FROM  xx_cdh_a_ext_billdocs_v
         WHERE 1 =1
           AND billdocs_doc_type      ='Consolidated Bill'
           AND billdocs_delivery_meth ='ELEC'
           AND billdocs_paydoc_ind    ='Y'
       ) xcaebv
       ,ar_cons_inv_trx acit
       ,ar_payment_schedules arps
WHERE  1 =1
  AND  aci.customer_id       =xcaebv.cust_account_id
  AND  aci.cons_inv_id       = acit.cons_inv_id
  AND  acit.transaction_type ='ADJUSTMENT'
  AND  acit.adj_ps_id        =arps.payment_schedule_id
*/

      --+=================================================================
-- Cursor to fetch invoice related information.
--+=================================================================
      CURSOR lcu_invoices (p_trx_id IN NUMBER, p_tax_code IN VARCHAR2)
      IS
         SELECT aihv.trx_number, aihv.bill_to_site_use_id,
                aihv.ship_to_site_use_id, aihv.interface_header_attribute1,
                aihv.LOCATION, aihv.phone_number, aihv.orig_system_reference,
                aihv.site_use_code           --We are not using this any more.
                                  ,
                aihv.purchase_order_number, aihv.bill_to_customer_number,
                aihv.bus_name, aihv.term_name term_name,
                aihv.interface_header_attribute2,
                p_tax_code tax_registration_number,
                --aihv.primary_salesrep_name, aihv.ship_to_customer_name, -- Commented for ver 4.2 Defect Id: 45279 Updting sales person to null
                NULL primary_salesrep_name, aihv.ship_to_customer_name,   -- Added for ver 4.2 Defect Id: 45279 Updting sales person to null
                aihv.ship_to_address1, aihv.ship_to_address2,
                aihv.ship_to_city, aihv.ship_to_state,
                aihv.ship_to_postal_code, aihv.ship_to_country,
                aihv.ship_to_contact, aihv.trx_date trx_date,
                aihv.ship_to_location, aihv.bill_to_name,
                aihv.bill_to_location, aihv.bill_to_address1,
                aihv.bill_to_address2, aihv.bill_to_city, aihv.bill_to_state,
                aihv.bill_to_postal_code, aihv.bill_to_province,
                aihv.bill_to_country,
                NVL (aihv.default_bill_attn,
                     'Attn: Accounts Payable'
                    ) bill_to_attn,
                aihv.ordsourcecd, aihv.ordcompletedate, aihv.orgordnbr,
                aihv.trx_class, aihv.invoice_source, aihv.invoice_source_id,
                aihv.order_header_id
           FROM xx_ar_ebill_trx_v aihv
          WHERE aihv.customer_trx_id = p_trx_id;

/*
SELECT aihv.trx_number
      ,aihv.bill_to_site_use_id
      ,aihv.ship_to_site_use_id
      ,aihv.interface_header_attribute1
      ,NULL location --Ignore TO_CHAR(hcsu.site_use_id) location. Use lcu_bill_siteuses.addrid field
      ,hcp.phone_number
      ,nvl
        (
          substr(hca.orig_system_reference ,1 ,instr(hca.orig_system_reference ,'-')-1)
         ,hca.orig_system_reference
        ) orig_system_reference
      ,NULL site_use_code --We are not using this any more.
      ,aihv.purchase_order_number
      ,aihv.bill_to_customer_number
      ,aihv.bill_to_customer_name bus_name
      ,aihv.term_name term_name
      ,aihv.interface_header_attribute2
      ,aihv.tax_registration_number
      ,aihv.primary_salesrep_name
      ,aihv.ship_to_customer_name
      ,aihv.ship_to_address1
      ,aihv.ship_to_address2
      ,aihv.ship_to_city
      ,aihv.ship_to_state
      ,aihv.ship_to_postal_code
      ,aihv.ship_to_country
      ,aihv.ship_to_contact_first_name||aihv.ship_to_contact_last_name ship_to_contact
      ,aihv.trx_date trx_date
      ,aihv.ship_to_location
      ,aihv.bill_to_customer_name bill_to_name
      ,aihv.bill_to_location
      ,aihv.bill_to_address1
      ,aihv.bill_to_address2
      ,aihv.bill_to_city
      ,aihv.bill_to_state
      ,aihv.bill_to_postal_code
      ,aihv.bill_to_province
      ,aihv.bill_to_country
      ,aihv.default_bill_attn
      ,NULL                                                          ordsourcecd
      ,TRUNC(aihv.ship_date_actual)                                  ordcompletedate
      ,previous_trx_number                                           orgordnbr
      ,aihv.class                                                    trx_class
      ,aihv.batch_source_name                                        invoice_source
      ,aihv.batch_source_id                                          invoice_source_id
      ,TO_NUMBER(aihv.attribute14)                                        order_header_id
FROM   ar_invoice_header_v          aihv
      ,hz_cust_accounts             hca
      ,hz_contact_points            hcp
WHERE  aihv.customer_trx_id  =p_trx_id
  AND  hca.cust_account_id   =aihv.bill_to_customer_id
  AND  hcp.owner_table_id(+) =hca.party_id;
*/
--+=================================================================
-- Cursor to get the ADDRID and ADDRALIASNAME for a BILL TO SITE ID
--+=================================================================
      CURSOR lcu_bill_siteuses (p_bill_to_site_use_id IN NUMBER)
      IS
         SELECT TO_CHAR (hzcsu.site_use_id) addrid,
                hzl.address_lines_phonetic xcust_name,
                hzcsu.LOCATION xmail_site_name
           FROM hz_locations hzl,
                hz_party_sites hzps,
                hz_cust_acct_sites hzcas,
                hz_cust_site_uses hzcsu
          WHERE 1 = 1
            AND hzcsu.site_use_id = p_bill_to_site_use_id
            AND hzcas.cust_acct_site_id = hzcsu.cust_acct_site_id
            AND hzps.party_site_id = hzcas.party_site_id
            AND hzl.location_id = hzps.location_id;

/*
select TO_CHAR(hzcsu.site_use_id)                               addrid
      ,substr(hzcsu.location ,instr(hzcsu.location ,'-')+1) addraliasname
from   hz_cust_site_uses hzcsu
where  1 =1
  and  hzcsu.site_use_id       =p_bill_to_site_use_id;
*/
--+======================================================================
-- Cursor to get the AOPSSHIPTOSEQ and ADDRBUSNAME for a SHIP TO SITE ID
--+======================================================================
      CURSOR lcu_ship_siteuses (p_ship_to_site_use_id IN NUMBER)
      IS
         SELECT regexp_replace
                   (SUBSTR
                        (NVL (SUBSTR (hzcsu.orig_system_reference,
                                        INSTR (hzcsu.orig_system_reference,
                                               '-'
                                              )
                                      + 1,
                                        (  INSTR (hzcsu.orig_system_reference,
                                                  '-',
                                                  2,
                                                  2
                                                 )
                                         - INSTR (hzcsu.orig_system_reference,
                                                  '-',
                                                  2
                                                 )
                                        )
                                      - 1
                                     ),
                              hzcsu.orig_system_reference
                             ),
                         1,
                         9
                        ),
                    '^0*',
                    ''
                   ) aopsshiptoseq,
                hzl.address_lines_phonetic addrbusname,
                hzcsu.LOCATION xaddr_alias_name
           FROM hz_locations hzl,
                hz_party_sites hzps,
                hz_cust_acct_sites hzcas,
                hz_cust_site_uses hzcsu
          WHERE 1 = 1
            AND hzcsu.site_use_id = p_ship_to_site_use_id
            AND hzcas.cust_acct_site_id = hzcsu.cust_acct_site_id
            AND hzps.party_site_id = hzcas.party_site_id
            --and  hzl.location_id         =hzps.party_site_id   Defect 9966
            AND hzl.location_id = hzps.location_id;
                               -- Defect 9966 by Sarat Uppalapati on 21-AUG-08

/*
UNION
select TO_CHAR(NULL)
      ,TO_CHAR(NULL)
from   dual
where 0 =
    ( select count(1)
      from hz_locations hzl
          ,hz_party_sites hzps
          ,hz_cust_acct_sites hzcas
          ,hz_cust_site_uses hzcsu
      where 1 =1
        and hzcsu.site_use_id       =p_ship_to_site_use_id
        and hzcas.cust_acct_site_id =hzcsu.cust_acct_site_id
        and hzps.party_site_id      =hzcas.party_site_id
       -- and hzl.location_id         =hzps.party_site_id     --Defect 9966
       and  hzl.location_id         =hzps.location_id -- Defect 9966 by Sarat Uppalapati on 21-AUG-08
    );
*/
      ln_item_master_org            NUMBER                             := NULL;

--+=================================================================
-- Cursor for getting all the lines other than the dummy items
--+=================================================================
      CURSOR lcu_line (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT ailv.interface_line_attribute10, xolaa.cust_item_number,
                UPPER
                   (SUBSTR
                       (xx_ar_gen_ebill_pkg.remove_special_char
                                                             (ailv.description),
                        1,
                        30
                       )
                   ) description,
                ailv.uom_code,
                -- ailv.quantity_ordered, -- Commented for the Defect #2067
                -- ailv.quantity_invoiced  -- Commented for Defect # 2122
                DECODE(p_trx_class,'CM',ailv.quantity_credited
                                       ,ailv.quantity_ordered) ,     -- Added for the Defect # 2067
                DECODE(p_trx_class,'CM',ailv.quantity_credited
                                       ,ailv.quantity_invoiced) ,     -- Added for the Defect # 2122
                xolaa.backordered_qty, ailv.unit_selling_price,
                xolaa.sku_list_price, ailv.extended_amount,
                xolaa.vendor_product_code, xolaa.taxable_flag,
                ailv.interface_line_attribute6,
                SUBSTR (xolaa.contract_details,
                        1,
                        INSTR (xolaa.contract_details, '-') - 1
                       ),
                SUBSTR (xolaa.contract_details,
                        INSTR (xolaa.contract_details, '-') + 1,
                          INSTR (xolaa.contract_details, '-', -1)
                        - (INSTR (xolaa.contract_details, '-') + 1)
                       ),
                SUBSTR (xolaa.contract_details,
                        INSTR (xolaa.contract_details, '-', -1) + 1
                       ),
                msib.item_number, oeol.actual_shipment_date ordcompletedate
                                                                           --,oeol.user_item_description                    productcdentered -- Defect 9142
                ,
                ailv.translated_description productcdentered    -- Defect 9142
                                                            ,
                --TO_CHAR (TO_NUMBER (oeol.customer_line_number)) custpolinenbr,  --Commented for Defect 10000
                    NVL(TO_CHAR(TO_NUMBER(oeol.customer_line_number)),DECODE(SUBSTR(oeol.orig_sys_line_ref,1,1),'0',LTRIM(oeol.orig_sys_line_ref,'0'),SUBSTR(oeol.orig_sys_line_ref,1,9))) custpolinenbr, --Added for defect 10000
                xolaa.wholesaler_item wholesaleprodcd,
                xolaa.line_comments xxom_line_comments,
				TRIM(ailv.attribute3) bill_level, -- Added for Kitting, Defect# 37670
				DECODE (TRIM(ailv.attribute3) ,'D', TRIM(ailv.attribute4) , NULL) kit_item -- Added for Kitting, Defect# 37670
           FROM ra_customer_trx_lines ailv,
                xx_om_line_attributes_all xolaa,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = ln_item_master_org) msib,
                oe_order_lines oeol                              --Defect 5615
          WHERE 1 = 1
            AND ((    p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
                  AND ailv.customer_trx_id = p_trx_id
                  AND ailv.line_type != 'TAX'
                  AND TO_NUMBER (ailv.interface_line_attribute6) =
                                                                  oeol.line_id
                  AND ailv.interface_line_attribute11 = 0
                  AND ailv.interface_line_attribute6 = xolaa.line_id(+)
                  AND ailv.inventory_item_id = msib.inv_item_id(+)
                  /*AND ailv.inventory_item_id NOT IN (
                         SELECT TO_NUMBER (attribute6)
                           FROM fnd_lookup_values
                          WHERE lookup_type = 'OD_FEES_ITEMS'
                            AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                            AND LANGUAGE = USERENV ('LANG')) */--Commented for the Defect #2067
                 AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
                 AND DECODE(ailv.attribute3,'K',DECODE(ailv.attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
                 )
                )
         UNION ALL
         SELECT ailv.interface_line_attribute10, TO_CHAR (NULL),
                UPPER
                   (SUBSTR
                       (xx_ar_gen_ebill_pkg.remove_special_char
                                                             (ailv.description),
                        1,
                        30
                       )
                   ) description,
                ailv.uom_code, ailv.quantity_ordered, ailv.quantity_invoiced,
                TO_NUMBER (NULL), ailv.unit_selling_price, TO_NUMBER (NULL),
                ailv.extended_amount, TO_CHAR (NULL), TO_CHAR (NULL),
                ailv.interface_line_attribute6, TO_CHAR (NULL),
                TO_CHAR (NULL), TO_CHAR (NULL), msib.item_number,
                TO_DATE (NULL) ordcompletedate
                                              --,oeol.user_item_description                    productcdentered -- Defect 9142
                ,
                ailv.translated_description productcdentered    -- Defect 9142
                                                            ,
                TO_CHAR (NULL) custpolinenbr, TO_CHAR (NULL) wholesaleprodcd,
                TO_CHAR (NULL) xxom_line_comments,
				TRIM(ailv.attribute3) bill_level, -- Added for Kitting, Defect# 37670
				DECODE (TRIM(ailv.attribute3) ,'D', TRIM(ailv.attribute4) , NULL) kit_item -- Added for Kitting, Defect# 37670
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = ln_item_master_org) msib
          WHERE 1 = 1
            AND (    p_invoice_source NOT IN
                        ('SALES_ACCT_US',
                         'SALES_ACCT_CA',
                         'MANUAL_CA',
                         'MANUAL_US',
                         'SERVICE'
                        )
                 AND ailv.customer_trx_id = p_trx_id
                 AND ailv.line_type != 'TAX'
                 AND ailv.inventory_item_id = msib.inv_item_id(+)
                 /*AND ailv.inventory_item_id NOT IN (
                        SELECT TO_NUMBER (attribute6)
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND LANGUAGE = USERENV ('LANG')) */ --Commented for the defect #2067
                 AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
                 AND DECODE(ailv.attribute3,'K',DECODE(ailv.attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
                )
         UNION ALL
         SELECT ailv.interface_line_attribute10, TO_CHAR (NULL),
                UPPER
                   (SUBSTR
                       (xx_ar_gen_ebill_pkg.remove_special_char
                                                             (ailv.description),
                        1,
                        30
                       )
                   ) description,
                ailv.uom_code, ailv.quantity_ordered, ailv.quantity_invoiced,
                TO_NUMBER (NULL), ailv.unit_selling_price, TO_NUMBER (NULL),
                ailv.extended_amount, TO_CHAR (NULL), TO_CHAR (NULL),
                ailv.interface_line_attribute6, TO_CHAR (NULL),
                TO_CHAR (NULL), TO_CHAR (NULL), msib.item_number,
                TO_DATE (NULL) ordcompletedate,
                TO_CHAR (NULL) productcdentered, TO_CHAR (NULL) custpolinenbr,
                TO_CHAR (NULL) wholesaleprodcd,
                TO_CHAR (NULL) xxom_line_comments,
				TRIM(ailv.attribute3) bill_level, -- Added for Kitting, Defect# 37670
				DECODE (TRIM(ailv.attribute3) ,'D', TRIM(ailv.attribute4) , NULL) kit_item-- Added for Kitting, Defect# 37670
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = ln_item_master_org) msib
          WHERE 1 = 1
            AND (    p_invoice_source IN
                                        ('MANUAL_US', 'MANUAL_CA', 'SERVICE')
                 AND (p_trx_class != 'CM')
                )
--  AND ((:p_trx_class !='CM') AND :p_invoice_source IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE'))
            AND ailv.line_type != 'TAX'
            AND ailv.customer_trx_id = p_trx_id
            AND ailv.inventory_item_id = msib.inv_item_id(+)
            /*AND ailv.inventory_item_id NOT IN (
                   SELECT TO_NUMBER (attribute6)
                     FROM fnd_lookup_values
                    WHERE lookup_type = 'OD_FEES_ITEMS'
                      AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                      AND LANGUAGE = USERENV ('LANG'))*/ --Commented for the defect #2067
            AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
			AND DECODE(ailv.attribute3,'K',DECODE(ailv.attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
         UNION ALL
         SELECT TO_CHAR (NULL), TO_CHAR (NULL), 'MISC CREDIT MEMO',
                TO_CHAR (NULL), 1, 1, TO_NUMBER (NULL),
                misc_cm.cm_amount                           --unitsellingprice
                                 ,
                TO_NUMBER (NULL), misc_cm.cm_amount          --extended_amount
                                                   ,
                TO_CHAR (NULL), TO_CHAR (NULL), TO_CHAR (NULL),
                TO_CHAR (NULL), TO_CHAR (NULL), TO_CHAR (NULL),
                TO_CHAR (NULL), TO_DATE (NULL) ordcompletedate,
                TO_CHAR (NULL) productcdentered, TO_CHAR (NULL) custpolinenbr,
                TO_CHAR (NULL) wholesaleprodcd,
                TO_CHAR (NULL) xxom_line_comments,
				TO_CHAR (NULL) bill_level,  -- Added for Kitting, Defect# 37670
				TO_CHAR (NULL) kit_item  -- Added for Kitting, Defect# 37670
           FROM (
                 -- SELECT sum(extended_amount) cm_amount ,customer_trx_id
                 SELECT   SUM (NVL (extended_amount, 0)) cm_amount,
                          customer_trx_id
                     FROM ra_customer_trx_lines
                    WHERE customer_trx_id = p_trx_id 
					  AND line_type != 'TAX'
					  AND DECODE(attribute3,'K',DECODE(attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
                 GROUP BY customer_trx_id) misc_cm
          WHERE 1 = 1
            AND (    p_invoice_source IN
                                        ('MANUAL_US', 'MANUAL_CA', 'SERVICE')
                 AND (p_trx_class = 'CM')
                )
			;

    --+===================================================================================
-- Defect#12673- Add bulk discount line to the EBL file
-- Cursor to sum all the bulk discount lines into one line under eBill rec type MS
--+===================================================================================
    CURSOR lc_bulk_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'BULK DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ractl.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'BULK DISCOUNT' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'BULK DISCOUNT' wholesaleprodcd
             FROM ra_customer_trx_lines ractl,
                  ra_customer_trx ract,
                  oe_price_adjustments oepa
            WHERE 1 = 1
              AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              AND ractl.line_type != 'TAX'
              AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
              AND oepa.attribute8 = '21'
         GROUP BY ractl.customer_trx_id;

--+===================================================================================
-- Cursor to sum all the tiered discount lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_tiered_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'TIERED DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ractl.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'TIERED DISCOUNT' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'TIERED DISCOUNT' wholesaleprodcd
             FROM ra_customer_trx_lines ractl,
                  ra_customer_trx ract,
                  oe_price_adjustments oepa
            WHERE 1 = 1
              AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              AND ractl.line_type != 'TAX'
              AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
              AND oepa.attribute8 = 'TD'
         /*
           AND  (p_trx_class !='CM'
                 OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                    )
              )
         */
         GROUP BY ractl.customer_trx_id;
         --==== Start of changes for the defect 12435====--
/*
         UNION
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'TIERED DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ract.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  TO_CHAR (NULL) productcdentered,
                  TO_CHAR (NULL) custpolinenbr, TO_CHAR (NULL)
                                                              wholesaleprodcd
             FROM ra_customer_trx_lines ractl, ra_customer_trx ract
            WHERE 1 = 1
              AND p_invoice_source NOT IN
                     ('SALES_ACCT_US',
                      'SALES_ACCT_CA',
                      'MANUAL_CA',
                      'MANUAL_US',
                      'SERVICE'
                     )
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              --AND  NVL(ractl.interface_line_context, '?') != 'ORDER ENTRY'
              AND ractl.description = 'Tiered Discount'
         /*
          AND  (p_trx_class !='CM'
                    OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('SALES_ACCT_US' ,'SALES_ACCT_CA' ,'MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                       )
                 )

         GROUP BY ract.customer_trx_id;
*/
      --====End of changes for the defect 12435====--
--+===================================================================================
-- Cursor to sum all the Association discount lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_association_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'ASSOCIATION DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ract.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'ASSOCIATION DISCOUNT' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'ASSOCIATION DISCOUNT' wholesaleprodcd
             FROM ra_customer_trx_lines ractl,
                  ra_customer_trx ract,
                  oe_price_adjustments oepa
            WHERE 1 = 1
              AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              AND ractl.line_type != 'TAX'
              AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
              AND oepa.attribute8 = 'AD'
         /*
           AND  (p_trx_class !='CM'
                   OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                      )
                )
         */
         GROUP BY ract.customer_trx_id;
         --==== Start of changes for the defect 12435====--
/*         UNION
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'ASSOCIATION DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ract.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  TO_CHAR (NULL) productcdentered,
                  TO_CHAR (NULL) custpolinenbr, TO_CHAR (NULL)
                                                              wholesaleprodcd
             FROM ra_customer_trx_lines ractl, ra_customer_trx ract
            WHERE 1 = 1
              AND p_invoice_source NOT IN
                     ('SALES_ACCT_US',
                      'SALES_ACCT_CA',
                      'MANUAL_CA',
                      'MANUAL_US',
                      'SERVICE'
                     )
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              --AND  NVL(ractl.interface_line_context, '?') !='ORDER ENTRY'
              AND ractl.description = 'Association Discount'
         /*
          AND  (p_trx_class !='CM'
                    OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('SALES_ACCT_US' ,'SALES_ACCT_CA' ,'MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                       )
                 )
          GROUP BY ract.customer_trx_id;
  */
      --====End of changes for the defect 12435====--
--+===================================================================================
-- Cursor to sum all the GSA COMMENT lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_gsa_comment (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT TO_CHAR (NULL) interface_line_attribute10,
                TO_CHAR (NULL) cust_item_number, 'GSA COMMENT' description,
                TO_CHAR (NULL) uom_code, TO_NUMBER (NULL) quantity_ordered,
                TO_NUMBER (NULL) quantity_invoiced,
                TO_NUMBER (NULL) backordered_qty,
                TO_NUMBER (NULL) unit_selling_price,
                TO_NUMBER (NULL) sku_list_price,
                TO_NUMBER (NULL) extended_amount,
                TO_CHAR (NULL) vendor_product_code,
                TO_CHAR (NULL) taxable_flag,
                TO_CHAR (NULL) interface_line_attribute6,
                TO_NUMBER (NULL) customer_trx_id, TO_CHAR (NULL) item_number,
                TO_DATE (NULL) ordcompletedate,
                'GSA COMMENT' productcdentered, TO_CHAR (NULL) custpolinenbr,
                'GSA COMMENT' wholesaleprodcd
           FROM ra_customer_trx_lines ractl
          WHERE 1 = 1
            AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
            AND ractl.customer_trx_id = p_trx_id
            AND ractl.interface_line_context = 'ORDER ENTRY'
            AND ractl.line_type != 'TAX'
            AND EXISTS (
                   SELECT 1
                     FROM xx_om_line_attributes_all
                    WHERE line_id =
                                   TO_NUMBER (ractl.interface_line_attribute6)
                      AND gsa_flag IN (1, 2));

/*
SELECT  TO_CHAR(NULL)                      interface_line_attribute10
       ,TO_CHAR(NULL)                      cust_item_number
       ,UPPER('GSA Comment')               description
       ,TO_CHAR(NULL)                      uom_code
       ,TO_NUMBER(NULL)                    quantity_ordered
       ,TO_NUMBER(NULL)                    quantity_invoiced
       ,TO_NUMBER(NULL)                    backordered_qty
       ,TO_NUMBER(NULL)                    unit_selling_price
       ,TO_NUMBER(NULL)                    sku_list_price
       ,TO_NUMBER(NULL)                    extended_amount
       ,TO_CHAR(NULL)                      vendor_product_code
       ,TO_CHAR(NULL)                      taxable_flag
       ,TO_CHAR(NULL)                      interface_line_attribute6
       ,TO_NUMBER(NULL)                    customer_trx_id
       ,TO_CHAR(NULL)                      item_number
       ,TO_DATE(NULL)                      ordcompletedate
       ,UPPER('GSA Comment')               productcdentered
       ,TO_CHAR(NULL)                      custpolinenbr
       ,UPPER('GSA Comment')               wholesaleprodcd
FROM   ra_customer_trx_lines ractl
WHERE  1 =1
    AND  ractl.customer_trx_id      =p_trx_id
    AND  EXISTS
         ( SELECT 1
             FROM xx_om_line_attributes_all
            WHERE line_id =ractl.interface_line_attribute6
              AND gsa_flag IN (1,2)
         )
    AND  (p_trx_class !='CM'
            OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
               )
         );
*/
--+============================================================================
-- Cursor to fetch the lines with Miscellaneous or Delivery charges.
--+============================================================================
      CURSOR lcu_charges_lines (
         p_trx_id           IN   NUMBER,
         p_charge_type      IN   VARCHAR2,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT ailv.interface_line_attribute10, xolaa.cust_item_number
                                                                       --,UPPER(substr(xx_ar_gen_ebill_pkg.remove_special_char(AILV.description) ,1 ,30)) description
                ,
                UPPER ('MISCELLANEOUS') description, ailv.uom_code,
                ailv.quantity_ordered,
                NVL (ailv.quantity_invoiced,
                     ailv.quantity_credited
                    ) quantity_invoiced,
                xolaa.backordered_qty, ailv.unit_selling_price,
                xolaa.sku_list_price, ailv.extended_amount,
                xolaa.vendor_product_code, xolaa.taxable_flag,
                ailv.interface_line_attribute6, ailv.customer_trx_id,
                msib.item_number,
                TRUNC (oeol.actual_shipment_date) ordcompletedate
                                                                 --,oeol.user_item_description                    productcdentered
                ,
                UPPER ('MISCELLANEOUS') productcdentered,
                 NULL custpolinenbr  --Added for the defect 13488
               -- TO_CHAR (TO_NUMBER (oeol.customer_line_number)) custpolinenbr   --Commented for Defect 10000
                -- NVL(TO_CHAR(TO_NUMBER(oeol.customer_line_number)),DECODE(SUBSTR(oeol.orig_sys_line_ref,1,1),'0',LTRIM(oeol.orig_sys_line_ref,'0'),SUBSTR(oeol.orig_sys_line_ref,1,9))) custpolinenbr --Added for the defect 10000--Commented for defect 13488
                --,xolaa.wholesaler_item                         wholesaleprodcd
                , UPPER ('MISCELLANEOUS') wholesaleprodcd
           FROM ra_customer_trx_lines ailv,
                xx_om_line_attributes_all xolaa,
                oe_order_lines oeol                              --Defect 5615
                                   ,
                (SELECT DISTINCT TO_NUMBER (attribute6) odf_item_id
                            FROM fnd_lookup_values
                           WHERE lookup_type = 'OD_FEES_ITEMS'
                             AND attribute7 =
                                    p_charge_type
                                              --'MISCELLANEOUS'  OR 'DELIVERY'
                             AND LANGUAGE = USERENV ('LANG')) od_fees_item,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = ln_item_master_org) msib
          WHERE 1 = 1
            AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
            AND ailv.customer_trx_id = p_trx_id
            AND ailv.line_type != 'TAX'
            AND TO_NUMBER (ailv.interface_line_attribute6) = xolaa.line_id(+)
            AND TO_NUMBER (ailv.interface_line_attribute6) = oeol.line_id
            AND ailv.inventory_item_id = od_fees_item.odf_item_id
            AND msib.inv_item_id = ailv.inventory_item_id;

   /*
    AND  (p_trx_class !='CM'
            OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
               )
         );
   */
--+=============================================================
-- Cursor for getting the count of the lines for a transaction
--+=============================================================
      CURSOR lcu_count_lines (
         p_trx_id           IN   NUMBER,
         p_invoice_source   IN   VARCHAR2,
         p_trx_class        IN   VARCHAR2
      )
      IS
         SELECT COUNT (ailv.customer_trx_line_id)
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = ln_item_master_org) msib
          WHERE 1 = 1
            AND ailv.line_type = 'LINE'
            AND ailv.interface_line_attribute11 = 0
            AND ailv.customer_trx_id = p_trx_id
            AND ailv.inventory_item_id = msib.inv_item_id(+)
           /* AND ailv.inventory_item_id NOT IN (
                   SELECT TO_NUMBER (attribute6)
                     FROM fnd_lookup_values
                    WHERE lookup_type = 'OD_FEES_ITEMS'
                      AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                      AND LANGUAGE = USERENV ('LANG'))*/ --Commented for the defect #2067
            AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067

            AND (   p_trx_class != 'CM'
                 OR (    p_trx_class = 'CM'
                     AND p_invoice_source NOT IN
                                        ('MANUAL_CA', 'MANUAL_US', 'SERVICE')
                    )
                );

--+============================================================
-- Cursor for getting the previous billing date for a customer
--+============================================================
      CURSOR lcu_get_issue_date (
         p_customer_id   IN   NUMBER,
         p_site_id       IN   NUMBER,
         p_cons_inv_id   IN   NUMBER
      )
      IS
--Defect 9043 changed this query as cons_inv_id does not appear to be truly sequential
--by Greg Dill on 28-JUL-08
         --SELECT MAX (cut_off_date)  Commented for the defect 15063
           SELECT MAX(TO_DATE(attribute1))    --Added for Defect# 15063. The logic of the attribute1 column is handled in the procedure XX_AR_PRINT_NEW_CON_PKG.MAIN
           FROM ar_cons_inv
          WHERE customer_id = p_customer_id
            AND site_use_id = p_site_id
            AND status IN ('FINAL' ,'ACCEPTED' )                            -- Defect 9043
            AND cons_inv_id != p_cons_inv_id;

--SELECT TRUNC(CUT_OFF_DATE) -- TRUNC(issue_date)
--FROM ar_cons_inv
--WHERE cons_inv_id = (
--                      SELECT MAX(cons_inv_id)-1
--                      FROM   ar_cons_inv
--                      WHERE  customer_id     =p_customer_id
--                        AND  site_use_id =p_site_id
--                        AND  status = 'ACCEPTED' -- Defect 9043
--                     );
/*
union
SELECT TO_DATE
     (   TO_CHAR(term.due_cutoff_day)
       ||'-'
       ||TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE), -termlines.DUE_MONTHS_FORWARD) ,'MON-RRRR')
      ,'DD-MON-RRRR'
     )
FROM ra_terms term
    ,ra_terms_lines termlines
WHERE term.term_id =p_term_id
  AND termlines.term_id =term.term_id
  AND 0 =
      ( SELECT COUNT(DISTINCT issue_date)
        FROM xx_ar_gen_bill_temp
        WHERE cons_inv_id = (
                      SELECT MAX(cons_inv_id)
                      FROM xx_ar_gen_bill_temp
                      WHERE customer_id     =p_customer_id
                        AND billing_site_id =p_site_id)
      );
*/
--+======================================
-- Cursor to fetch the US tax details
--+======================================
      CURSOR lcu_get_tax_details_us (p_trx_id IN NUMBER)
      IS
         SELECT SUM (aitsv.extended_amount) tax_amount, 'SALES TAX' tax_code,
--                (SUM (NVL (aitsv.tax_rate, 0)) / 100) tax_rate   --Commented for character string buffer too small
                  (SUM (NVL (SUBSTR(aitsv.tax_rate,1,8), 0)) / 100) tax_rate  --Added Substr for the above error
           FROM ra_customer_trx_lines aitsv
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND line_type = 'TAX'
            AND aitsv.extended_amount <> 0;         --Added for Defect # 11741

/*
    --SELECT NVL(SUM(aitsv.tax_amount) ,0) tax_amount ,'Sales Tax' tax_code ,to_char(sum(tax_rate)/100) tax_rate
    SELECT SUM(NVL(aitsv.tax_amount,0)) tax_amount ,'Sales Tax' tax_code ,to_char(sum(NVL(tax_rate,0))/100) tax_rate
    FROM ar_invoice_tax_summary_v aitsv
    WHERE aitsv.customer_trx_id  =p_trx_id;
*/
--+================================================================
-- Cursor to fetch the CANADIAN tax details at the invoice level
-- The field values are copied for both the PST/QST and GST lines.
--+================================================================
      CURSOR lcu_tax_ca (p_trx_id IN NUMBER)
      IS
         SELECT SUM (NVL (aitsv.extended_amount, 0)) xtotal_tax_amt,
                SUM
                   (CASE
                       --WHEN vat.tax = 'COUNTY' --commented for r12 retrofit
                       WHEN vat.tax in('COUNTY','COUNTY-SALES_TAX')
                          THEN NVL (aitsv.extended_amount, 0)
                       ELSE 0
                    END
                   ) xtotal_tax_pst_qst,
                SUM
                   (CASE
                       --WHEN vat.tax = 'STATE' --commented for r12 retrofit
                       WHEN vat.tax in('STATE','STATE-SALES_TAX')
                          THEN NVL (aitsv.extended_amount, 0)
                       ELSE 0
                    END
                   ) xtotal_tax_gst
           FROM ra_customer_trx_lines aitsv, zx_rates_b vat --ar_vat_tax_vl vat
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND aitsv.line_type = 'TAX'
            AND vat.tax_rate_id(+) = aitsv.vat_tax_id;

/*
    CURSOR lcu_tax_CA (p_trx_id IN NUMBER)
    IS
    SELECT ca_tax.xtotal_tax_amt ,ca_prov_tax.xtotal_tax_PST_QST ,ca_gst.xtotal_tax_GST
    FROM
    (
     SELECT SUM(NVL(tax_amount,0)) xtotal_tax_amt
     FROM   ar_invoice_tax_summary_v
     WHERE  customer_trx_id =p_trx_id
    ) ca_tax,
    (
     SELECT SUM(NVL(tax_amount,0)) xtotal_tax_PST_QST
     FROM   ar_invoice_tax_summary_v
     WHERE  customer_trx_id =p_trx_id
       AND  tax_code_name ='COUNTY'
    ) ca_prov_tax,
    (
     SELECT SUM(NVL(tax_amount,0)) xtotal_tax_GST
     FROM   ar_invoice_tax_summary_v
     WHERE  customer_trx_id =p_trx_id
       AND  tax_code_name ='STATE'
    ) ca_gst;
*/
--+==================================================================================
-- Cursor to fetch the CANADIAN tax details at the invoice level by PST/QST and GST.
-- PST/QST and GST will be on two different TX tax records.
--+==================================================================================
      CURSOR lcu_get_tax_details_ca (
         p_trx_id             IN   NUMBER,
         p_billing_province   IN   VARCHAR2
      )
      IS
         SELECT SUM (NVL (aitsv.extended_amount, 0)) tax_amount,
                DECODE (p_billing_province, 'QC', 'QST', 'PST') tax_code,
                (SUM (NVL (vat.percentage_rate, 0)) ) tax_rate
           FROM ra_customer_trx_lines aitsv, zx_rates_b vat -- ar_vat_tax_vl vat
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND aitsv.line_type = 'TAX'
            AND vat.tax_rate_id(+) = aitsv.vat_tax_id
            --AND vat.tax = 'COUNTY' 	--commented for r12 retrofit
            AND vat.tax in('COUNTY','COUNTY-SALES_TAX')
            AND aitsv.extended_amount <> 0          --Added for Defect # 11741
         UNION ALL
         SELECT SUM (NVL (aitsv.extended_amount, 0)) tax_amount,
                'GST' tax_code, (SUM (NVL (vat.percentage_rate, 0)) ) tax_rate
           FROM ra_customer_trx_lines aitsv, zx_rates_b vat -- ar_vat_tax_vl vat
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND aitsv.line_type = 'TAX'
            AND vat.tax_rate_id(+) = aitsv.vat_tax_id
            --AND vat.tax = 'STATE'     --commented for r12 retrofit
            AND vat.tax in('STATE','STATE-SALES_TAX')
            AND aitsv.extended_amount <> 0;         --Added for Defect # 11741

/*
    --SELECT NVL(SUM(odtx.tax_amount),0)                     tax_amount
    SELECT SUM(NVL(odtx.tax_amount,0))                     tax_amount
          ,DECODE(p_billing_province ,'QC' ,'QST' ,'PST') tax_code
          --,TO_CHAR(odtx.tax_rate/100)                      tax_rate
          ,TO_CHAR(NVL(odtx.tax_rate,0)/100)                      tax_rate
    FROM   ar_invoice_tax_summary_v odtx
    WHERE  odtx.customer_trx_id  =p_trx_id
      AND  odtx.tax_code_name    ='COUNTY'
    GROUP BY odtx.tax_rate
    UNION ALL
    --SELECT NVL(SUM(odtx.tax_amount),0)                     tax_amount
    SELECT SUM(NVL(odtx.tax_amount,0))                     tax_amount
          ,'GST'                                           tax_code
          --,TO_CHAR(odtx.tax_rate/100)                      tax_rate
          ,TO_CHAR(NVL(odtx.tax_rate,0)/100)                      tax_rate
    FROM   ar_invoice_tax_summary_v odtx
    WHERE  odtx.customer_trx_id  =p_trx_id
      AND  odtx.tax_code_name    ='STATE'
    GROUP BY odtx.tax_rate;
*/
--+========================================================
-- Cursor for getting the header level order details
--+========================================================
      CURSOR lcu_get_shipping_ins (
         p_header_id    IN   NUMBER,
         p_inv_source   IN   VARCHAR2
      )
      IS
         SELECT DECODE (p_inv_source,
                        'SALES_ACCT_US', SUBSTR (ooh.orig_sys_document_ref,
                                                 -3,
                                                 3
                                                ),
                        'SALES_ACCT_CA', SUBSTR (ooh.orig_sys_document_ref,
                                                 -3,
                                                 3
                                                ),
                        ''
                       ) subordernum,
                ooh.shipping_instructions, ooh.header_id,
                TRUNC (ooh.ordered_date) ordered_date,
                lkup.lookup_code ordsourcecd, oeos.NAME spc_order
           FROM oe_order_headers ooh,
                fnd_lookup_values lkup,
                oe_order_sources oeos
          WHERE 1 = 1
            AND ooh.header_id = p_header_id
            AND oeos.order_source_id = ooh.order_source_id
            AND lkup.lookup_type = 'OD_ORDER_SOURCE'
            AND lkup.attribute6 = TO_CHAR (ooh.order_source_id)
            AND lkup.enabled_flag = 'Y'
            AND lkup.start_date_active <= TRUNC (SYSDATE)
            AND NVL (lkup.end_date_active, TRUNC (SYSDATE)) >= TRUNC (SYSDATE)
            AND ROWNUM < 2;

/*
    CURSOR lcu_get_shipping_ins(p_order_number IN VARCHAR2)
    IS
    SELECT SUBSTR(OOH.orig_sys_document_ref,-3,3) subordernum
          ,OOH.shipping_instructions
          ,OOH.header_id
          ,TRUNC(OOH.ordered_date)                ordered_date
          ,lkup.lookup_code                       ordsourcecd
          ,oeos.name                              spc_order
    FROM   oe_order_headers  ooh
          ,fnd_lookup_values lkup
          ,oe_order_sources  oeos
    WHERE ooh.order_number                          =p_order_number
      AND oeos.order_source_id                      =ooh.order_source_id
      AND lkup.lookup_type                          ='OD_ORDER_SOURCE'
      AND lkup.attribute6                           =TO_CHAR(ooh.order_source_id)
      AND lkup.enabled_flag                         ='Y'
    --  AND lkup.start_date_active                    <=TRUNC(SYSDATE)
    --  AND NVL(lkup.end_date_active ,TRUNC(SYSDATE)) >=TRUNC(SYSDATE)
      AND lkup.start_date_active                    <=TRUNC(g_as_of_date) -- Defect 9077
      AND NVL(lkup.end_date_active ,TRUNC(g_as_of_date)) >=TRUNC(g_as_of_date) -- Defect 9077
      AND ROWNUM <2
    UNION
    SELECT TO_CHAR(NULL)
          ,TO_CHAR(NULL)
          ,TO_NUMBER(NULL)
          ,TO_DATE(NULL)
          ,TO_CHAR(NULL)
          ,TO_CHAR(NULL)
    FROM   DUAL
    WHERE 0 =
          (
            SELECT COUNT(1)
            FROM oe_order_headers OOH
            WHERE OOH.order_number =p_order_number
          );
*/
--+========================================================
-- Cursor for getting the custom header level OM details
--+========================================================
      CURSOR lcu_get_om_details (p_header_id IN NUMBER
                                ,p_customer_id IN NUMBER      -- added for defect 8927
                                )
      IS
         SELECT xohaa.release_number, xohaa.cost_center_dept,
                xohaa.desk_del_addr, xohaa.placement_method_code,
                xohaa.created_by_id ordcreateid,
                xohaa.od_order_type custtypecd,
                xohaa.cust_contact_name aops_cust_contact,
                xohaa.cust_pref_phone aops_cust_phone,
                xohaa.cust_pref_phextn aops_cust_phone_ext,
                RPAD (NVL (SUBSTR (xohaa.spc_card_number, 1, 12), ' '),
                      12,
                      ' '
                     ) spc_card_num,
                SUBSTR (ooh.orig_sys_document_ref, 1, 4) spc_location_num,
                SUBSTR (ooh.orig_sys_document_ref, 5, 8) spc_trans_date,
                RPAD
                   (NVL (SUBSTR (ooh.orig_sys_document_ref, 13, 3), ' '),
                    5,
                    ' '
                   ) spc_register_num,
                RPAD (NVL (SUBSTR (ooh.orig_sys_document_ref, 16, 5), ' '),
                      5,
                      ' '
                     ) spc_trans_num,
                xohaa.tax_rate xxom_hdr_tax_rate,
                nvl(XCDH.cost_center_description,xohaa.cost_center_dept) cost_center_desc  -- added for defect 8927
           FROM xx_om_header_attributes_all xohaa
               ,oe_order_headers ooh
               ,XX_CDH_5TH_SOFT_HEADER_V XCDH    -- added for defect 8927
          WHERE
          1 = 1
          AND ooh.header_id = p_header_id
          AND xohaa.header_id(+) = ooh.header_id
          AND XCDH.cust_Account_id(+) = p_customer_id               -- added for defect 8927
          AND XCDH.cost_center_code (+)= xohaa.cost_center_dept     -- added for defect 8927
          AND rownum<2;

/*
FROM  xx_om_header_attributes_all XOHAA
      ,oe_order_headers OOH
WHERE  XOHAA.header_id(+) = OOH.header_id
  AND  OOH.order_number = p_order_number
   -- Defect 8920
UNION
SELECT TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
FROM   DUAL
WHERE 0 =
          (
            SELECT COUNT(1)
            FROM  xx_om_header_attributes_all XOHAA
                  ,oe_order_headers OOH
            WHERE  XOHAA.header_id  =OOH.header_id
              AND  OOH.order_number =p_order_number
          )
*/
--+==================================================
-- Cursor for getting the discount and coupon amounts
--+==================================================
-- Commented for Prod Defect # 2025
/*      CURSOR lcu_get_dis_amt (p_header_id IN NUMBER)
      IS
         SELECT SUM (NVL (opa.adjusted_amount, 0))
           FROM oe_price_adjustments opa, oe_order_headers ooh
          WHERE 1 = 1
            AND ooh.header_id = p_header_id
            AND opa.header_id = ooh.header_id;*/   -- Commented for Prod Defect # 2025

/*
    CURSOR lcu_get_dis_amt(p_order_number IN VARCHAR2)
    IS
    SELECT NVL(SUM(OPA.adjusted_amount)  ,0)
      FROM oe_price_adjustments OPA
          ,oe_order_headers OOH
     WHERE OOH.header_id = OPA.header_id
       AND OPA.header_id = p_order_number;
  */
--+==================================================
-- Cursor for getting the line level order details
--+==================================================
      CURSOR lcu_get_ship_date_item (p_line_id IN NUMBER)
      IS
         SELECT ool.schedule_ship_date, ool.ordered_item
           FROM oe_order_lines ool
          WHERE ool.line_id = p_line_id;

/*
UNION
SELECT TO_DATE(NULL)
      ,TO_CHAR(NULL)
FROM DUAL
WHERE 0 =
   (
     SELECT COUNT(1)
     FROM oe_order_lines OOL
     WHERE OOL.line_id =p_line_id
   );
*/

-- Start of Changes for R1.1 Defect # 1451 (CR 626)
--+================================================================================
-- Cursor to sum all the gift card lines into one line under eBill rec type MS
--+================================================================================
      CURSOR lc_gc_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'GIFT CARD' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  'GIFT CARD' vendor_product_code,
                  xx_ar_gen_ebill_pkg.get_total_gc_chrg(p_trx_id) extended_amount,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  RCT.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'GIFT CARD' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'GIFT CARD' wholesaleprodcd,
                  'GIFT CARD' custprodcd
         FROM     ra_customer_trx_all RCT
         WHERE    p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
         AND      RCT.customer_trx_id = p_trx_id;
-- End of Changes for R1.1 Defect # 1451 (CR 626)

-- Start of Changes for Prod Defect # 2025
--+===================================================================================
-- Cursor to sum all the coupon discount lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_coupon_discount (
         p_trx_id           IN   NUMBER,
         p_amount           IN   NUMBER
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'COUPON' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  p_amount   extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  p_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'COUPON' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'COUPON' wholesaleprodcd,
                  'COUPON' custprodcd
             FROM DUAL;
-- End of Changes for Prod Defect # 2025

      lc_file_handle                UTL_FILE.file_type;

      TYPE idheader IS TABLE OF header_rec_type;

      TYPE idline IS TABLE OF line_rec_type;

      get_om_details_rec_type       lcu_get_om_details%ROWTYPE;
      get_shipping_rec_type         lcu_get_shipping_ins%ROWTYPE;
      delivery_charge_rec_type      lcu_charges_lines%ROWTYPE;
      misc_charge_rec_type          lcu_charges_lines%ROWTYPE;
      lcu_tax_ca_rec                lcu_tax_ca%ROWTYPE;
      lc_tiered_discount_rec        lc_tiered_discount%ROWTYPE;
      lc_bulk_discount_rec          lc_bulk_discount%ROWTYPE;
      lc_association_discount_rec   lc_association_discount%ROWTYPE;
      lc_gsa_comment_rec            lc_gsa_comment%ROWTYPE;
      lc_gc_discount_rec            lc_gc_discount%ROWTYPE;     --Added for R1.1 Defect # 1451 (CR 626)
      lc_coupon_discount_rec        lc_coupon_discount%ROWTYPE;  --Added for Prod Defect # 2025
      vidheader                     idheader;
      vidline                       idline;
      --lc_file_name                  VARCHAR2 (1000);          -- Commeted as this local variable is not used.
      lc_errormsg                   VARCHAR2 (1000);
      lc_elecrectype                VARCHAR2 (20);
      ln_tax_amount                 NUMBER;
      lc_tax_code                   VARCHAR2 (40);
      lc_tax_rate                   VARCHAR2 (10);
      lc_ordered_item               VARCHAR2 (200);
      ld_reconcile_date             DATE;
      lc_release_number             VARCHAR2 (240);
      lc_cost_center_dept           VARCHAR2 (240);
      lc_desk_del_addr              VARCHAR2 (240);
      ln_line_count                 NUMBER;
      ln_totalorder_amt             NUMBER;
      ln_ordersub_total             NUMBER;
--      ln_dis_amt                    NUMBER;            Commented for Prod Defect # 2025
      lc_ordersub_total_sign        VARCHAR2 (10);
      lc_totalorder_amt_signs       VARCHAR2 (10);
      lc_totalorder_amt_sign        VARCHAR2 (10);
      lc_ordersub_total_signs       VARCHAR2 (10);
      lc_get_warehouse_name         VARCHAR2 (100);
      lc_ship_to_addr_flag          VARCHAR2 (20);
      ln_req_id                     NUMBER;
      lc_wait                       BOOLEAN;
      lc_conc_phase                 VARCHAR2 (50);
      lc_conc_status                VARCHAR2 (50);
      lc_dev_phase                  VARCHAR2 (50);
      lc_dev_status                 VARCHAR2 (50);
      lc_conc_message               VARCHAR2 (50);
      lc_err_status                 VARCHAR2 (10);
      lc_err_msg                    VARCHAR2 (1000);
      p_file_name                   VARCHAR2 (100);
      ld_get_date                   DATE;
      ld_issue_date                 DATE                     := TO_DATE (NULL);
      ln_request_id                 NUMBER       := fnd_global.conc_request_id;
      ln_common_count               NUMBER                                := 0;
      ln_detail_count               NUMBER                                := 0;
      ln_detail_line_count          NUMBER                                := 0;  --Added for the defect 13488
      lc_delimiter                  VARCHAR2 (4)                        := '|';
      lc_line1                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line2                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line3                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line4                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line5                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_dba_dir_path               VARCHAR2 (100)           := TO_CHAR (NULL);
      lc_delivery                   VARCHAR2 (40)                := 'DELIVERY';
      lc_misc_charges               VARCHAR2 (40)           := 'MISCELLANEOUS';
      lc_prev_cbi_id                ar_cons_inv_all.cons_inv_id%TYPE      := 0;
      lc_curr_cbi_id                ar_cons_inv_all.cons_inv_id%TYPE      := 0;
      lc_partial_shipment           VARCHAR2 (1)                       := NULL;
      lc_addrid                     VARCHAR2 (80)                      := NULL;
      lc_addraliasname              VARCHAR2 (80)                      := NULL;
      lc_aopsshiptoseq              VARCHAR2 (80)                      := NULL;
      lc_addrbusname                VARCHAR2 (80)                      := NULL;
      ld_hd_ordcompletedate         DATE;
      lc_orgordnbr                  VARCHAR2 (80)                      := NULL;
      lc_orgordsubnbr               VARCHAR2 (10)                      := NULL;
      lc_trx_class                  ra_cust_trx_types.TYPE%TYPE;
      lc_invoice_source             ra_batch_sources.NAME%TYPE;
      lc_invoice_source_id          ra_batch_sources.batch_source_id%TYPE;
      lc_province                   ar_invoice_header_v.bill_to_province%TYPE;
      ld_least_trx_date             DATE                     := TO_DATE (NULL);
      lc_cust_phone_ext             VARCHAR2 (10)                      := NULL;
      lc_spc_source                 VARCHAR2 (3)                      := 'SPC';
      lc_pos_acct_nbr               VARCHAR2 (12)                      := NULL;
      lc_pos_tran_nbr               VARCHAR2 (5)                       := NULL;
      lc_pos_reg_nbr                VARCHAR2 (5)                       := NULL;
      lc_comments                   VARCHAR2 (70)                      := NULL;
--ln_paydoc_cbi_number                 VARCHAR2(10) :=NULL;
      ln_ord_id                     NUMBER                                := 0;
      ln_total_tax_amt              NUMBER;
      ln_total_disc_amt             NUMBER;
      ln_total_misc_chrg            NUMBER;
      ln_total_deliv_chrg           NUMBER;
      ln_total_tax_gst              NUMBER;
      ln_total_coupon_amt           NUMBER;
      ln_total_deposits             NUMBER;
      ln_total_tax_pst              NUMBER;
      lc_xmail_site_name            VARCHAR2 (80)                      := NULL;
      lc_xaddr_alias_name           VARCHAR2 (80)                      := NULL;
      ln_operating_unit             NUMBER                             := NULL;
      ln_us_operating_unit          NUMBER                             := NULL;
      ln_ca_operating_unit          NUMBER                             := NULL;
      p_tax_id                      ar_system_parameters.tax_registration_number%TYPE
                                                                       := NULL;
      ln_tax_rate                   xx_om_header_attributes_all.tax_rate%TYPE
                                                                       := NULL;
      lc_status_code                 VARCHAR2 (1);    --Added for the defect 12435
      lc_error_msg_info_cfile        VARCHAR2 (2000);  --Added for the defect 12435
      e_infocopy_exception           EXCEPTION;
      lc_error_location               VARCHAR2(4000) := NULL;  --Added as a part of defect 11993
      lc_error_debug                  VARCHAR2(4000) := NULL;  --Added as a part of defect 11993
      ln_attr_group_id                NUMBER;   --Added as a part of the defect 13717
      ln_total_gc_amt                NUMBER;                         --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text1                 VARCHAR2 (180) ;  --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text2                 VARCHAR2 (180) ;  --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text3                 VARCHAR2 (180) ;  --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text                  VARCHAR2 (250) ;  --Added for R1.1 Defect # 1451 (CR 626)
--ld_as_of_date                        DATE; -- Defect 9077
      ln_kit_extended_amt             NUMBER;           -- Added for Kitting, Defect# 37670
	  ln_kit_unit_price               NUMBER;           -- Added for Kitting, Defect# 37670
	  lc_kit_item_description         VARCHAR2(240);    -- Added for Kitting, Defect# 37670
	  lc_kit_sku                      VARCHAR2(100);    -- Added for Kitting, Defect# 37670
   BEGIN
      g_as_of_date := TRUNC (fnd_conc_date.string_to_date (p_as_of_date));
                                                               -- Defect 9077
      fnd_file.put_line (fnd_file.output,
                         'Start Paydoc, As of date :' || TRUNC (g_as_of_date)
                        );

      FND_FILE.PUT_LINE(FND_FILE.LOG,'WRITEN_OFF_AMT_LOW_VALUE: '||xx_ar_gen_ebill_pkg.ln_write_off_amt_low);   --Added for the Defect# 631 (CR 662)
      FND_FILE.PUT_LINE(FND_FILE.LOG,'WRITEN_OFF_AMT_HIGH_VALUE: '||xx_ar_gen_ebill_pkg.ln_write_off_amt_high); --Added for the Defect# 631 (CR 662)

        SELECT attr_group_id     --Added as a part of the defect 13717
          INTO ln_attr_group_id
        FROM ego_attr_groups_v
        WHERE attr_group_type = 'XX_CDH_CUST_ACCOUNT'
           AND attr_group_name = 'BILLDOCS' ;
-- =======================================
-- Get Current OD operating unit tax code
-- =======================================
      BEGIN
         SELECT tax_registration_number
           INTO p_tax_id
           FROM ar_system_parameters;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            p_tax_id := NULL;
         WHEN OTHERS
         THEN
            p_tax_id := NULL;
      END;

         fnd_file.put_line (fnd_file.LOG,'Tax Registration number : '||p_tax_id);
-- ==============================
-- Get Current operating unit ID
-- ==============================
      BEGIN
         ln_operating_unit := fnd_profile.VALUE ('ORG_ID');
         fnd_file.put_line (fnd_file.LOG,
                            'Current Operating Unit ID :' || ln_operating_unit
                           );
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            ln_operating_unit := 0;
            fnd_file.put_line (fnd_file.LOG,
                                  'In No data found, Operating Unit ID is :'
                               || ln_operating_unit
                              );
         WHEN OTHERS
         THEN
            ln_operating_unit := 0;
            fnd_file.put_line (fnd_file.LOG,
                                  'In Other errors, Operating Unit ID is :'
                               || ln_operating_unit
                              );
      END;

-- ==============================
-- Get US operating unit ID
-- ==============================
      BEGIN
         ln_us_operating_unit := xx_fin_country_defaults_pkg.f_org_id ('US');
         fnd_file.put_line (fnd_file.LOG,
                            'US Operating Unit ID :' || ln_us_operating_unit
                           );
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            ln_us_operating_unit := 0;
            fnd_file.put_line (fnd_file.LOG,
                                  'In No data found, US Operating Unit ID :'
                               || ln_us_operating_unit
                              );
         WHEN OTHERS
         THEN
            ln_us_operating_unit := 0;
            fnd_file.put_line (fnd_file.LOG,
                                  'In Other errors, US Operating Unit ID :'
                               || ln_us_operating_unit
                              );
      END;

-- ==============================
-- Get CA operating unit ID
-- ==============================
      BEGIN
         ln_ca_operating_unit := xx_fin_country_defaults_pkg.f_org_id ('CA');
         fnd_file.put_line (fnd_file.LOG,
                            'CA Operating Unit ID :' || ln_ca_operating_unit
                           );
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            ln_ca_operating_unit := 0;
            fnd_file.put_line (fnd_file.LOG,
                                  'In No data found, CA Operating Unit ID :'
                               || ln_ca_operating_unit
                              );
         WHEN OTHERS
         THEN
            ln_ca_operating_unit := 0;
            fnd_file.put_line (fnd_file.LOG,
                                  'In Other errors, CA Operating Unit ID :'
                               || ln_ca_operating_unit
                              );
      END;

     IF ln_us_operating_unit = ln_operating_unit
      THEN
         p_file_name :=
               'XX_AR_EBILL_US_'
            || TO_CHAR (SYSDATE, 'DDMONYYYYHH24MISS')
            ||'_'                --Added for Defect 12435
            || ln_request_id     --Added for Defect 12435
            || '.txt';
      ELSIF ln_ca_operating_unit = ln_operating_unit
      THEN
         p_file_name :=
               'XX_AR_EBILL_CA_'
            || TO_CHAR (SYSDATE, 'DDMONYYYYHH24MISS')
            ||'_'                --Added for Defect 12435
            || ln_request_id     --Added for Defect 12435
            ||'.txt';
      ELSE
         p_file_name := NULL;
      END IF;

      fnd_file.put_line (fnd_file.output, 'Filename is :' || p_file_name);
      fnd_file.put_line (fnd_file.LOG,'File Name : '||p_file_name);
      lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);

-- ================================
-- Get Item Master Organization ID
-- ================================
      BEGIN
         SELECT odef.organization_id
           INTO ln_item_master_org
           FROM org_organization_definitions odef
          WHERE 1 = 1 AND odef.organization_name = 'OD_ITEM_MASTER';

         fnd_file.put_line (fnd_file.LOG,
                               'Item Master Organization ID :'
                            || ln_item_master_org
                           );
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            ln_item_master_org := TO_NUMBER (NULL);
            fnd_file.put_line
                        (fnd_file.LOG,
                            'In No data found, Item Master Organization ID :'
                         || ln_item_master_org
                        );
         WHEN OTHERS
         THEN
            ln_item_master_org := TO_NUMBER (NULL);
            fnd_file.put_line
                         (fnd_file.LOG,
                             'In Other errors, Item Master Organization ID :'
                          || ln_item_master_org
                         );
      END;
	  
	  gn_item_master_org := ln_item_master_org; -- Added for Kitting, Defect#37670 

-- Start of Changes for R1.1 Defect # 1451 (CR 626)
 --Getting Gift card text
    BEGIN

        SELECT  SUBSTR(description,1,50)
        INTO    lc_tender_text1
        FROM    fnd_lookup_values_vl
        WHERE   lookup_type='OD_BILLING_TENDER_PAYMENT_TEXT'
        AND     lookup_code='TEXT1'
        AND     enabled_flag='Y'
        AND     TRUNC(SYSDATE) BETWEEN TRUNC(start_date_active) AND TRUNC(NVL(end_date_active,SYSDATE+1));

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
           lc_tender_text1  := NULL;
        WHEN OTHERS THEN
           lc_tender_text1  := NULL;
     END;

     BEGIN

        SELECT  SUBSTR(description,1,50)
        INTO    lc_tender_text2
        FROM    fnd_lookup_values_vl
        WHERE   lookup_type='OD_BILLING_TENDER_PAYMENT_TEXT'
        AND     lookup_code='TEXT2'
        AND     enabled_flag='Y'
        AND     trunc(SYSDATE) BETWEEN TRUNC(start_date_active) AND TRUNC(NVL(end_date_active,SYSDATE+1));

     EXCEPTION
        WHEN NO_DATA_FOUND THEN

           lc_tender_text2 := NULL;
        WHEN OTHERS THEN

            lc_tender_text2 := NULL;
      END;

     BEGIN
          SELECT  SUBSTR(description,1,50)
        INTO    lc_tender_text3
        FROM    fnd_lookup_values_vl
        WHERE   lookup_type='OD_BILLING_TENDER_PAYMENT_TEXT'
        AND     lookup_code='TEXT3'
        AND     enabled_flag='Y'
        AND     TRUNC(SYSDATE) BETWEEN TRUNC(start_date_active) AND TRUNC(NVL(end_date_active,SYSDATE+1));

     EXCEPTION
        WHEN NO_DATA_FOUND THEN

           lc_tender_text3 := NULL;
        WHEN OTHERS THEN

           lc_tender_text3 := NULL;
     END;
     -- End of changes for R1.1 Defect # 1451 (CR 626)

--==============================================================
--Fetching the header level data and inserting then in the File
--==============================================================
      lc_error_location := 'Opening the lcu_header cursor';  --Added as a part of defect 11993
      OPEN lcu_header(ln_attr_group_id --Added as a part of the defect 13717
                     ,p_cust_id_from      -- Added as a part of the defect 1760
                     ,p_cust_id_to);      -- Added as a part of the defect 1760
      LOOP
--          fnd_file.put_line(fnd_file.LOG, 'Inside LCU-Header in generate_file...');  --Commented for Defect # 1742
         FETCH lcu_header
         BULK COLLECT INTO vidheader LIMIT 100;

         EXIT WHEN vidheader.COUNT = 0;

--================================
--Load Invoice related information
--================================
         IF vidheader.COUNT > 0
         THEN
            FOR i IN vidheader.FIRST .. vidheader.LAST
            LOOP
             --  fnd_file.put_line (fnd_file.LOG,'Cons Inv ID : '||vidheader (i).cons_inv_id); --Commented for Defect # 1742
               IF (   (lc_curr_cbi_id = 0)
                   OR (lc_curr_cbi_id <> vidheader (i).cons_inv_id)
                  )
               THEN
                  ld_issue_date := TO_DATE (NULL);
                  lc_error_location := 'Opening the lcu_get_issue_date cursor in generate_file..';   --Added as a part of defect 11993
                  lc_error_debug    := 'lcu_get_issue_date for --'                                   --Added as a part of defect 11993
                                        ||vidheader(i).customer_id
                                        ||'-'
                                        ||vidheader(i).billing_site_id
                                        ||'-'
                                        ||vidheader (i).cons_inv_id;
                  OPEN lcu_get_issue_date (vidheader (i).customer_id,
                                           vidheader (i).billing_site_id,
                                           vidheader (i).cons_inv_id
                                          );

                  FETCH lcu_get_issue_date
                   INTO ld_issue_date;
                  CLOSE lcu_get_issue_date;
                 /* fnd_file.put_line(fnd_file.log,'ld_issue_date from lcu_get_issue_date' || ld_issue_date);  --Added as a part of defect 11993
                 */ --Commented for Defect # 1742
                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_issue_date...');
                  IF ld_issue_date IS NULL
                  THEN
-- =============================================================
-- We need the least transaction date in case if this is the
-- first run. For subsequent runs we may use the issue_date +1
-- using the cursor lcu_get_issue_date. This query will run
-- once per consolidated bill.
-- =============================================================
                     BEGIN
                        SELECT MIN (TRUNC (ract.trx_date))
                          INTO ld_issue_date
                          FROM ra_customer_trx ract,
                               (SELECT   customer_trx_id
                                    FROM ar_cons_inv_trx_lines
                                   WHERE cons_inv_id =
                                                     vidheader (i).cons_inv_id
                                GROUP BY customer_trx_id) cons_trx
                         WHERE ract.customer_trx_id = cons_trx.customer_trx_id
                           AND ract.complete_flag = 'Y'         -- Defect 9043
                                                       ;
/*                        fnd_file.put_line (fnd_file.LOG,'ld_issue_date as least invoice date for first run : '
                                                        ||ld_issue_date); --Added as part of defect 11993
*/ --Commented for Defect # 1742
                     EXCEPTION
                        WHEN NO_DATA_FOUND
                        THEN
                           ld_issue_date := TO_DATE (NULL);
                        WHEN OTHERS
                        THEN
                /*           fnd_file.put_line
                              (fnd_file.LOG,
                                  'Error in fetching the least invoice date in generate_file...'
                               || SQLERRM
                              );  */ --Commented for Defect # 1742
                           ld_issue_date := TO_DATE (NULL);
                     END;
                     lc_curr_cbi_id := vidheader (i).cons_inv_id;
                  ELSE
                     NULL;
-- ==========================================
-- We've got the bill from date, just skip
-- the code.
-- ==========================================
                  END IF;
                  --fnd_file.put_line (fnd_file.LOG,'Issue date : '||ld_issue_date); Commented for 11993
               ELSE
                  lc_curr_cbi_id := vidheader (i).cons_inv_id;
               END IF;

--+==========================================================
     -- For getting the Total Tax Amount, GST and PST/QST
--+==========================================================
               IF ln_us_operating_unit = ln_operating_unit
               THEN
                  BEGIN
                     SELECT SUM (NVL (aitsv.extended_amount, 0)), 0,
                            0
                       INTO ln_total_tax_amt, ln_total_tax_pst,
                            ln_total_tax_gst
                       FROM ra_customer_trx_lines aitsv,zx_rates_b vat -- ar_vat_tax_vl vat
                      WHERE 1 = 1
                        AND aitsv.customer_trx_id =
                                                 vidheader (i).customer_trx_id
                        AND aitsv.line_type = 'TAX'
                        AND vat.tax_rate_id(+) = aitsv.vat_tax_id;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
           /*             fnd_file.put_line                        --Added as a part of defect 11993
                        (fnd_file.LOG,
                            'In No data found, Total tax amount for US in generate_file...:'
                         ||ln_total_tax_amt
                         ||'-'
                         ||ln_total_tax_pst
                         ||'-'
                         ||ln_total_tax_gst
                        ); */ --Commented for Defect # 1742
                     WHEN OTHERS
                     THEN
/*                        fnd_file.put_line                        --Added as a part of defect 11993
                                 (fnd_file.LOG,
                                    'Error in fetching the Total tax amount for US in generate_file...'
                                    || SQLERRM
                                 ); */ --Commented for Defect # 1742
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                  END;
               ELSIF ln_ca_operating_unit = ln_operating_unit
               THEN
                  BEGIN

                  lc_error_location := 'Opening the lcu_tax_ca cursor in generate_file..';   --Added as a part of defect 11993
                  lc_error_debug    := 'lcu_tax_ca for --'                                   --Added as a part of defect 11993
                                        ||vidheader(i).customer_id;

                     OPEN lcu_tax_ca (vidheader (i).customer_trx_id);

                     FETCH lcu_tax_ca
                      INTO lcu_tax_ca_rec;

                     IF lcu_tax_ca%NOTFOUND
                     THEN
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                     ELSE
                        ln_total_tax_amt := lcu_tax_ca_rec.xtotal_tax_amt;
                        ln_total_tax_pst := lcu_tax_ca_rec.xtotal_tax_pst_qst;
                        ln_total_tax_gst := lcu_tax_ca_rec.xtotal_tax_gst;
                     END IF;

                     CLOSE lcu_tax_ca;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                   /*     fnd_file.put_line                        --Added as a part of defect 11993
                              (fnd_file.LOG,
                                   'In No data found, Total tax amount, GST and PST/QST for CA in generate_file...:'
                                   ||ln_total_tax_amt
                                   ||'-'
                                   ||ln_total_tax_pst
                                   ||'-'
                                   ||ln_total_tax_gst
                               );  */ --Commented for Defect # 1742
                     WHEN OTHERS
                     THEN
                 /*        fnd_file.put_line                        --Added as a part of defect 11993
                               (fnd_file.LOG,
                                    'Error in fetching the Total tax amount,GST and PST/QST for CA in generate_file...'
                                    || SQLERRM
                                );  */--Commented for Defect # 1742
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                  END;
               ELSE
-- =========================
-- Not US or CANADA....
-- =========================
                  ln_total_tax_amt := 0;
                  ln_total_tax_pst := 0;
                  ln_total_tax_gst := 0;
               END IF;

     /*      fnd_file.put_line (fnd_file.LOG,ln_operating_unit||' Tax totals  : Total Tax amount : '||ln_total_tax_amt
                                         ||'  PST tax : '||ln_total_tax_pst
                                         ||'  GST tax : '||ln_total_tax_gst);
    */  --Commented for Defect # 1742

--+==========================================================
     -- For getting the Total Discount Amount
--+==========================================================
               ln_total_disc_amt :=
                  xx_ar_gen_ebill_pkg.get_total_discount
                                                 (vidheader (i).customer_trx_id
                                                 );

--                fnd_file.put_line (fnd_file.LOG,'Total Discount : '||ln_total_disc_amt);  --Commented for Defect # 1742

-- Start of changes for R1.1 Defect # 1451 (CR 626)
--+=================================================
     -- For getting the Total Gift Card Charges
--+=================================================
                     ln_total_gc_amt   :=
                        xx_ar_gen_ebill_pkg.get_total_gc_chrg
                                                 (vidheader (i).customer_trx_id
                                                 );
-- End of changes for R1.1 Defect # 1451 (CR 626)

--+==========================================================
     -- For getting the Total Miscellaneous Charges
--+==========================================================
               ln_total_misc_chrg :=
                  xx_ar_gen_ebill_pkg.get_total_misc_chrg
                                                 (vidheader (i).customer_trx_id
                                                 );
               ln_total_misc_chrg := ln_total_misc_chrg - ln_total_gc_amt; -- Added for the R1,1 Defect # 1451 (CR 626)
          -- fnd_file.put_line (fnd_file.LOG,'Total Misc Charges : '||ln_total_misc_chrg);  --Commented for Defect # 1742

--+==========================================================
     -- For getting the Total Delivery Charges
--+==========================================================
               ln_total_deliv_chrg :=
                  xx_ar_gen_ebill_pkg.get_total_delivery
                                                 (vidheader (i).customer_trx_id
                                                 );

--           fnd_file.put_line (fnd_file.LOG,'Total Delivery Charges : '||ln_total_deliv_chrg);  --Commented for Defect # 1742

--+==========================================================
     -- For getting the Total Coupon Amount
--+==========================================================
               ln_total_coupon_amt :=
                  xx_ar_gen_ebill_pkg.get_total_coupon
                                                 (vidheader (i).customer_trx_id
                                                 );

--           fnd_file.put_line (fnd_file.LOG,'Total coupon amount : '||ln_total_coupon_amt);  --Commented for Defect # 1742

--+==========================================================
     -- For getting the Total deposits for Canadian
--+==========================================================
               ln_total_deposits := 0;
               lc_error_location := 'Opening lcu_invoices cursor in generate_file';    --Added as a part of defect 11993
               lc_error_debug    := 'lcu_invoices for --'                              --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id
                                    ||'-'
                                    ||p_tax_id;
               FOR lcu_invoices_rec IN
                  lcu_invoices (vidheader (i).customer_trx_id, p_tax_id)
               LOOP
          /*        fnd_file.put_line (fnd_file.LOG,
                                     'Invoice: '
                                     || lcu_invoices_rec.trx_number
                                    );  */ --Commented for Defect # 1742
                  vidheader (i).trx_number := lcu_invoices_rec.trx_number;
                  vidheader (i).interface_header_attribute1 :=
                                  lcu_invoices_rec.interface_header_attribute1;
                  vidheader (i).LOCATION := lcu_invoices_rec.LOCATION;
                  vidheader (i).orig_system_reference :=
                                        lcu_invoices_rec.orig_system_reference;
                  vidheader (i).site_use_code :=
                                                lcu_invoices_rec.site_use_code;
                  vidheader (i).purchase_order_number :=
                                        lcu_invoices_rec.purchase_order_number;
                  vidheader (i).bill_to_customer_number :=
                                      lcu_invoices_rec.bill_to_customer_number;
                  vidheader (i).bus_name := lcu_invoices_rec.bus_name;
                  vidheader (i).interface_header_attribute2 :=
                                  lcu_invoices_rec.interface_header_attribute2;
                  vidheader (i).tax_registration_number :=
                                      lcu_invoices_rec.tax_registration_number;
                  vidheader (i).primary_salesrep_name :=
                                        lcu_invoices_rec.primary_salesrep_name;
                  vidheader (i).ship_to_customer_name :=
                                        lcu_invoices_rec.ship_to_customer_name;
                  vidheader (i).ship_to_address1 :=
                                             lcu_invoices_rec.ship_to_address1;
                  vidheader (i).ship_to_address2 :=
                                             lcu_invoices_rec.ship_to_address2;
                  vidheader (i).ship_to_city := lcu_invoices_rec.ship_to_city;
                  vidheader (i).ship_to_state :=
                                                lcu_invoices_rec.ship_to_state;
                  vidheader (i).ship_to_postal_code :=
                                          lcu_invoices_rec.ship_to_postal_code;
                  vidheader (i).ship_to_country :=
                                              lcu_invoices_rec.ship_to_country;
                  vidheader (i).ship_to_contact :=
                                              lcu_invoices_rec.ship_to_contact;
                  vidheader (i).trx_date := lcu_invoices_rec.trx_date;
                  vidheader (i).ship_to_location :=
                                             lcu_invoices_rec.ship_to_location;
                  vidheader (i).bill_to_name := lcu_invoices_rec.bill_to_name;
                  vidheader (i).bill_to_location :=
                                             lcu_invoices_rec.bill_to_location;
                  vidheader (i).bill_to_address1 :=
                                             lcu_invoices_rec.bill_to_address1;
                  vidheader (i).bill_to_address2 :=
                                             lcu_invoices_rec.bill_to_address2;
                  vidheader (i).bill_to_city := lcu_invoices_rec.bill_to_city;
                  vidheader (i).bill_to_state :=
                                                lcu_invoices_rec.bill_to_state;
                  vidheader (i).bill_to_postal_code :=
                                          lcu_invoices_rec.bill_to_postal_code;
                  vidheader (i).bill_to_country :=
                                              lcu_invoices_rec.bill_to_country;
                  vidheader (i).bill_to_attn := lcu_invoices_rec.bill_to_attn;
                  vidheader (i).ordsourcecd := lcu_invoices_rec.ordsourcecd;
                  ld_hd_ordcompletedate := lcu_invoices_rec.ordcompletedate;
                  lc_trx_class := lcu_invoices_rec.trx_class;
                  lc_orgordnbr :=TO_CHAR (TO_NUMBER (lcu_invoices_rec.orgordnbr));
                  lc_orgordsubnbr := NULL;   --Added for the defect 13650
                    -- Start of changes for defect 8867
                  IF lc_orgordnbr IS NULL AND lc_trx_class='CM' THEN
                  BEGIN
--                  SELECT SUBSTR(ret_orig_order_num,1,9),          -- Commented for R1.3 CR 733 Defect 1212
--                         SUBSTR(ret_orig_order_num,-3,3)          -- Commented for R1.3 CR 733 Defect 1212
                  SELECT -- ret_orig_order_num                         -- Added for R1.3 CR 733 Defect 1212 commented for defect 5846
                  OOH1.order_number   -- added for defect 5846
                  INTO   lc_orgordnbr
--                         lc_orgordsubnbr                           -- Commented for R1.3 CR 733 Defect 1212
                  FROM xx_om_line_attributes_all XOLA,
                       oe_order_lines_all OOL,
                       oe_order_headers_all OOH,
                       oe_order_headers_all OOH1
                       WHERE XOLA.line_id=OOL.line_id
                  AND   OOL.header_id=OOH.header_id
                  AND   OOH1.orig_sys_document_ref = XOLA.ret_orig_order_num -- added for defect 5846
                  AND   XOLA.ret_orig_order_num IS NOT NULL -- added for defect 5846
                  AND   OOH.header_id=lcu_invoices_rec.order_header_id
                  AND   ROWNUM=1;
                 EXCEPTION
                    WHEN OTHERS THEN
                        --fnd_file.put_line (fnd_file.log,'Could not derive lcorgordnum and lc_orgordsubnbr'||SQLERRM); --Commented for Defect # 1742
                        lc_orgordnbr :=NULL;   --Added for the defect 12435
                        lc_orgordsubnbr :=NULL;--Added for the defect 12435
                     END;
                     END IF;
                   -- End of changes for defect 8867

                  lc_invoice_source := lcu_invoices_rec.invoice_source;
                  lc_invoice_source_id := lcu_invoices_rec.invoice_source_id;
                  lc_province := lcu_invoices_rec.bill_to_province;
                  ln_ord_id := lcu_invoices_rec.order_header_id;

                  lc_error_location := 'Opening lcu_bill_siteuses cursor in generate_file';    --Added as a part of defect 11993
                  lc_error_debug    := 'lcu_bill_siteuses for --'                              --Added as a part of defect 11993
                                       ||lcu_invoices_rec.bill_to_site_use_id;

                  OPEN lcu_bill_siteuses (lcu_invoices_rec.bill_to_site_use_id);

                  FETCH lcu_bill_siteuses
                   INTO lc_addrid, lc_addraliasname, lc_xmail_site_name;

                  CLOSE lcu_bill_siteuses;

                  lc_error_location := 'Opening lcu_ship_siteuses cursor in generate_file';    --Added as a part of defect 11993
                  lc_error_debug    := 'lcu_ship_siteuses for --'                              --Added as a part of defect 11993
                                       ||lcu_invoices_rec.ship_to_site_use_id;

                  OPEN lcu_ship_siteuses (lcu_invoices_rec.ship_to_site_use_id);

                  FETCH lcu_ship_siteuses
                   INTO lc_aopsshiptoseq, lc_addrbusname, lc_xaddr_alias_name;

                  CLOSE lcu_ship_siteuses;

               --   fnd_file.put_line (fnd_file.LOG,'After getting bill to and ship to site uses ... ');  --Commented for Defect # 1742

                  get_om_details_rec_type.release_number := NULL;
                  get_om_details_rec_type.cost_center_dept := NULL;
                  get_om_details_rec_type.cost_center_desc := NULL; -- added for defect 8927
                  get_om_details_rec_type.desk_del_addr := NULL;
                  get_om_details_rec_type.placement_method_code := NULL;
                  get_om_details_rec_type.ordcreateid := NULL;
                  get_om_details_rec_type.custtypecd := NULL;
                  get_om_details_rec_type.aops_cust_contact := NULL;
                  get_om_details_rec_type.aops_cust_phone := NULL;
                  get_om_details_rec_type.aops_cust_phone_ext := NULL;
                  get_om_details_rec_type.spc_card_num := NULL;
                  get_om_details_rec_type.spc_location_num := NULL;
                  get_om_details_rec_type.spc_trans_date := NULL;
                  get_om_details_rec_type.spc_register_num := NULL;
                  get_om_details_rec_type.spc_trans_num := NULL;
                  get_om_details_rec_type.xxom_hdr_tax_rate := NULL;   -- Added for the defect 13650
--Start of changes for SPC details as a part of defect 11993
                  get_shipping_rec_type.ordsourcecd           := NULL;
                  get_shipping_rec_type.subordernum           := NULL;
                  get_shipping_rec_type.spc_order             := NULL;
                  get_shipping_rec_type.shipping_instructions := NULL;
                  get_shipping_rec_type.ordered_date          := NULL;
--End of Changes for SPC details as a part of defect 11993
                  ln_tax_rate := NULL;

                  IF (lc_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
                     )
                  THEN
                     lc_error_location := 'Opening lcu_get_om_details for SALES_ACCT_US and SALES_ACCT_CA invoice sources in generate_file';    --Added as a part of defect 11993
                     lc_error_debug    := 'lcu_get_om_details for --'                              --Added as a part of defect 11993
                                          ||ln_ord_id;

                     OPEN lcu_get_om_details (ln_ord_id
                                              ,vidheader (i).customer_id  -- added for defect 8927
                                              );

                     FETCH lcu_get_om_details
                      INTO get_om_details_rec_type;

                     ln_tax_rate :=
                        NVL (get_om_details_rec_type.xxom_hdr_tax_rate,
                             TO_NUMBER (NULL)
                            );

                     CLOSE lcu_get_om_details;
                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_om_details...');
                    --          fnd_file.put_line (fnd_file.LOG,'Tax rate : '||ln_tax_rate);  --Commented for Defect # 1742
                  END IF;

                  IF get_om_details_rec_type.aops_cust_phone IS NOT NULL
                  THEN
                     vidheader (i).phone_number :=
                        RPAD (NVL (get_om_details_rec_type.aops_cust_phone,
                                   ' '
                                  ),
                              11,
                              ' '
                             );
                     lc_cust_phone_ext :=
                        RPAD
                           (NVL (get_om_details_rec_type.aops_cust_phone_ext,
                                 ' '
                                ),
                            4,
                            ' '
                           );
                  ELSE
                     vidheader (i).phone_number :=
                                                lcu_invoices_rec.phone_number;
                     lc_cust_phone_ext := NULL;
                  END IF;

/*                  fnd_file.put_line (fnd_file.LOG,'Customer Phone Number'               --Added as a prt of defect 11993
                                                  ||vidheader (i).phone_number
                                                  ||'Customer Phone ext : '
                                                  ||lc_cust_phone_ext);
*/ --Commented for Defect # 1742

                  IF get_om_details_rec_type.aops_cust_contact IS NOT NULL
                  THEN
                     vidheader (i).ship_to_contact :=
                                    get_om_details_rec_type.aops_cust_contact;
                  ELSE
                     NULL;
                  END IF;
               END LOOP;

               ld_get_date :=
                  xx_ar_inv_freq_pkg.compute_effective_date
                                                   (vidheader (i).billing_term,
                                                    vidheader (i).issue_date
                                                   );
                 --fnd_file.put_line(fnd_file.output, 'Out of get frequency...');
               --IF ld_get_date <= TRUNC(SYSDATE)
               --IF ld_get_date <= TRUNC(g_as_of_date) THEN-- Defect 9077

      --         fnd_file.put_line (fnd_file.LOG,'Get date from frequency pkg : '||ld_get_date);  --Commented for Defect # 1742

               lc_elecrectype := 'HD';
               ln_common_count := ln_common_count + 1;

               lc_error_location := 'Opening lcu_get_shipping_ins in generate_file';    --Added as a part of defect 11993
               lc_error_debug    := 'lcu_get_shipping_ins for --'                         --Added as a part of defect 11993
                                    ||'Order header ID'
                                    ||ln_ord_id
                                    ||'Invoice Source'
                                    ||lc_invoice_source;

               OPEN lcu_get_shipping_ins (ln_ord_id, lc_invoice_source);

               FETCH lcu_get_shipping_ins
                INTO get_shipping_rec_type;

               vidheader (i).ordsourcecd := get_shipping_rec_type.ordsourcecd;

               CLOSE lcu_get_shipping_ins;

--               fnd_file.put_line (fnd_file.LOG,'Out of lcu_get_shipping_ins... ');  --Commented for Defect # 1742

                       --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_shipping_ins...');
               /*
                     OPEN  lcu_get_om_details(vidheader(i).interface_header_attribute1);
                     FETCH lcu_get_om_details INTO get_om_details_rec_type;
                     CLOSE lcu_get_om_details;
                       fnd_file.put_line(fnd_file.output, 'Out of lcu_get_om_details...');
               */
               lc_error_location := 'Opening lcu_count_lines in generate_file';    --Added as a part of defect 11993
               lc_error_debug    := 'lcu_count_lines for Transaction ID --'        --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id;

               OPEN lcu_count_lines (vidheader (i).customer_trx_id,
                                     lc_invoice_source,
                                     lc_trx_class
                                    );

               FETCH lcu_count_lines
                INTO ln_line_count;

               CLOSE lcu_count_lines;

--               fnd_file.put_line (fnd_file.LOG,' No of lines for trx id '||vidheader (i).customer_trx_id||' : '||ln_line_count);  --Commented for Defect # 1742

-- Commented for Prod Defect # 2025
/*               lc_error_location := 'Opening lcu_get_dis_amt in generate_file';    --Added as a part of defect 11993
               lc_error_debug    := 'lcu_get_dis_amt for --'                       --Added as a part of defect 11993
                                    ||ln_ord_id;
               --fnd_file.put_line(fnd_file.output, 'Out of lcu_count_lines...');
               OPEN lcu_get_dis_amt (ln_ord_id);

               FETCH lcu_get_dis_amt
                INTO ln_dis_amt;

               CLOSE lcu_get_dis_amt;*/    -- Commented for Prod Defect # 2025

         /*      fnd_file.put_line(fnd_file.LOG, 'Out of lcu_get_dis_amt...ln_dis_amt--'||ln_dis_amt); --Added as a part of defect 11993
     */ --Commented for Defect # 1742
               /*
                    OPEN  lcu_get_issue_date(vidheader(i).customer_id ,vidheader(i).billing_site_id ,vidheader(i).term_id);
                    FETCH lcu_get_issue_date INTO ld_issue_date;
                    CLOSE lcu_get_issue_date;
                      fnd_file.put_line(fnd_file.output, 'Out of lcu_get_issue_date...');
               */
               IF lc_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
               THEN
                  BEGIN
                     lc_error_location := 'Total order amount for SALES_ACCT_US and SALES_ACCT_CA invoices in generate_file';
                     lc_error_debug    :=  'Total order amount for--'
                                           ||'Transaction ID'
                                           ||vidheader (i).customer_trx_id
                                           ||'Item Master Organization ID'
                                           ||ln_item_master_org;   --Added as a part of defect 11993
                     ln_totalorder_amt :=
                        xx_ar_gen_ebill_pkg.get_inv_totals
                                                ('INVOICE',
                                                 ln_item_master_org,
                                                 vidheader (i).customer_trx_id
                                                );
                     ln_totalorder_amt := ln_totalorder_amt - ln_total_gc_amt;   -- Added for R1.1 Defect # 1451 (CR 626)
                   --ln_totalorder_amt      := OE_TOTALS_GRP.get_order_total(ln_ord_id ,NULL ,'ALL');
                  --fnd_file.put_line(fnd_file.output, 'After xx_ar_gen_ebill_pkg.get_inv_totals...');
                  EXCEPTION
                     WHEN OTHERS
                     THEN
/*                        fnd_file.put_line
                            (fnd_file.output,
                             'Error in xx_ar_gen_ebill_pkg.get_inv_totals (Total Order Amount)...'||vidheader (i).customer_trx_id
                            );
                        fnd_file.put_line (fnd_file.output, SQLERRM);*/ --Commented for Defect # 1742
                        ln_totalorder_amt := 0;
                  END;

                  BEGIN
                     lc_error_location := 'Suborder total for SALES_ACCT_US and SALES_ACCT_CA invoice sources in generate_file';
                     lc_error_debug    := 'Suborder total for'
                                          ||'Transaction ID'
                                          ||vidheader (i).customer_trx_id
                                          ||'Item Master Organization ID'
                                          ||ln_item_master_org;   --Added as a part of defect 11993
                     ln_ordersub_total :=
                        xx_ar_gen_ebill_pkg.get_inv_totals
                                                ('SKU',
                                                 ln_item_master_org,
                                                 vidheader (i).customer_trx_id
                                                );
                                          --ln_ordersub_total      := OE_OE_TOTALS_SUMMARY.order_subtotals(ln_ord_id);
                  --fnd_file.put_line(fnd_file.output, 'After xx_ar_gen_ebill_pkg.get_inv_totals...');
                  EXCEPTION
                     WHEN OTHERS
                     THEN
/*                        fnd_file.put_line
                            (fnd_file.output,
                             'Error in xx_ar_gen_ebill_pkg.get_inv_totals (Order Sub-total)...'||vidheader (i).customer_trx_id
                            );
                        fnd_file.put_line (fnd_file.output, SQLERRM); */ --Commented for Defect # 1742
                        ln_ordersub_total := 0;
                  END;
               ELSE
                  ln_totalorder_amt := TO_NUMBER (NULL);
                  ln_ordersub_total := TO_NUMBER (NULL);
               END IF;

--               fnd_file.put_line (fnd_file.LOG,'Total order amount : '||ln_totalorder_amt);  --Commented for Defect # 1742
--               fnd_file.put_line (fnd_file.LOG,'Order subtotal : '||ln_ordersub_total);   --Commented for Defect # 1742

               IF vidheader (i).ship_to_location IS NOT NULL
               THEN
                  lc_ship_to_addr_flag := 'Y';
               ELSE
                  lc_ship_to_addr_flag := 'N';
               END IF;

               /*IF lc_trx_class = 'CM'
               THEN
                  lc_orgordsubnbr :=
                     RPAD
                        (NVL
                            (TO_CHAR
                                 (TO_NUMBER (get_shipping_rec_type.subordernum) -- Commented for Defect 8867
                                 ),
                             ' '
                            ),
                         5,
                         ' '
                        );
               ELSE
                  lc_orgordsubnbr := RPAD (' ', 5, ' ');
               END IF; */

               -- Start of changes for defect 8867
               IF lc_orgordsubnbr IS NULL AND lc_trx_class='CM'
               THEN
                 --lc_orgordsubnbr := TO_CHAR(TO_NUMBER(get_shipping_rec_type.subordernum)); --Commented for the defect 13650
                 lc_orgordsubnbr := get_shipping_rec_type.subordernum; --Added for the defect 13650
               /*  fnd_file.put_line(fnd_file.LOG,'Sub Order Number for CM'
                                                ||lc_orgordsubnbr);*/--Commented for Defect # 1742
               END IF;

               -- End of changes for defect 8867
               IF get_shipping_rec_type.spc_order = lc_spc_source
               THEN
                  lc_pos_acct_nbr :=
                     NVL (get_om_details_rec_type.spc_card_num,
                          RPAD (' ', 12, ' ')
                         );
                  lc_pos_tran_nbr :=
                     NVL (get_om_details_rec_type.spc_trans_num,
                          RPAD (' ', 5, ' ')
                         );
                  lc_pos_reg_nbr :=
                     NVL (get_om_details_rec_type.spc_register_num,
                          RPAD (' ', 5, ' ')
                         );
                  lc_comments :=
                     RPAD (NVL (   lc_spc_source
                                || get_om_details_rec_type.spc_card_num
                                || ' '
                                || 'Date: '
                                || get_om_details_rec_type.spc_trans_date
                                || ' '
--                                || 'Location:'  -- Commented for Defect # 3561
                                || 'Loc:'  -- Added for Defect # 3561
                                || get_om_details_rec_type.spc_location_num
                                || ' '
                                || 'Register:'
                                || get_om_details_rec_type.spc_register_num
                                || ' '
                                || 'Trans#:'
                                || get_om_details_rec_type.spc_trans_num,
                                ' '
                               ),
                           70,
                           ' '
                          );
               -- ADDED FOR DEFECT 13472 , Mohan
                get_shipping_rec_type.subordernum := SUBSTR(vidheader (i).interface_header_attribute1,10,5) ;
                --end  Defect 13472
               ELSE
                  lc_pos_acct_nbr := RPAD (' ', 12, ' ');
                  lc_pos_tran_nbr := RPAD (' ', 5, ' ');
                  lc_pos_reg_nbr := RPAD (' ', 5, ' ');
                  lc_comments :=
                     RPAD (NVL (get_shipping_rec_type.shipping_instructions,
                                ' '
                               ),
                           70,
                           ' '
                          );
               END IF;

/*              fnd_file.put_line (fnd_file.LOG,'Shipping Comments : '||lc_comments);

              fnd_file.put_line (fnd_file.LOG,'Extracting the data for :'||lc_elecrectype);
*/--Commented for Defect # 1742
               BEGIN
                  UTL_FILE.put_line
                     (lc_file_handle,
                         RPAD
                            (NVL
                                (REPLACE (vidheader (i).orig_system_reference,
                                          '-',
                                          ''
                                         ),
                                 ' '
                                ),
                             9,
                             ' '
                            )                               --BILL_CUSTOMER_ID
                      || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                               9,
                               ' '
                              )
                      || RPAD (' ', 5, ' ')
                      || RPAD (NVL (vidheader (i).interface_header_attribute1,
                                    ' '
                                   ),
                               9,
                               ' '
                              )
                       -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                      || RPAD (NVL (vidheader (i).phone_number, ' '), 11, ' ')
                      || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                      || RPAD (' ', 18, ' ')                          --FILLER
                      || RPAD (NVL (lc_addrid, ' '), 9, ' ')          --ADDRID
                      || RPAD (NVL (vidheader (i).invoice_currency_code, ' '),
                               3,
                               ' '
                              )
                      || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                      || RPAD (NVL (vidheader (i).purchase_order_number, ' '),
                               22,
                               ' '
                              )
                      || RPAD (NVL (get_om_details_rec_type.release_number,
                                    ' '
                                   ),
                               12,
                               ' '
                              )
                      || RPAD (NVL (get_om_details_rec_type.cost_center_dept,
                                    ' '
                                   ),
                               20,
                               ' '
                              )
                      || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                    ' '),
                               20,
                               ' '
                              )
                      || RPAD
                            (NVL
                                (REPLACE (vidheader (i).orig_system_reference,
                                          '-',
                                          ''
                                         ),
                                 ' '
                                ),
                             9,
                             ' '
                            )                                       --CHILD_ID
                      || NVL (TO_CHAR (vidheader (i).cut_off_date, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )
                      || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )
                      || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                      || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )
                      || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                      || RPAD (NVL (vidheader (i).tax_registration_number,
                                    ' '),
                               10,
                               ' '
                              )
                      || RPAD (' ', 7, ' ')
                      || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                        '9999990.99S'
                                       ),
                               11,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                        '9999990.99S'
                                       ),
                               11,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                        '9999990.99S'
                                       ),
                               11,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                        '9999990.99S'
                                       ),
                               11,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                        '9999990.99S'
                                       ),
                               11,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                        '9999990.99S'
                                       ),
                               11,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                        '999999990.99S'
                                       ),
                               13,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                        '999999990.99S'
                                       ),
                               13,
                               ' '
                              )
                      || RPAD (' ', 1, ' ')
                      || lc_pos_acct_nbr                        --SPC ACCT NBR
                      || lc_pos_tran_nbr                    --SPC TRANS NUMBER
                      || lc_pos_reg_nbr                       --SPC REG NUMBER
                      || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                       'YYYYMMDD'
                                      ),
                              RPAD (' ', 8, ' ')
                             )
                      || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )
                      || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1, ' ')
                                                                 --ordsourcecd
                      || RPAD
                            (NVL (get_om_details_rec_type.ordcreateid, ' '),
                             10,
                             ' '
                            )                                    --ordgreateid
                      || RPAD (' ', 5, ' ')
                      || RPAD (' ', 5, ' ')
                      || RPAD (' ', 5, ' ')
                      || RPAD
                            (NVL
                                (get_om_details_rec_type.placement_method_code,
                                 ' '
                                ),
                             1,
                             ' '
                            )
                      || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )                                   --Pickup Date
                      || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )                                --Reconcile Date
                      || RPAD
                            (NVL (get_om_details_rec_type.custtypecd, ' '),
                             1,
                             ' '
                            )                                --Order Type code
                      || RPAD (NVL (vidheader (i).primary_salesrep_name, ' '),
                               25,
                               ' '
                              )
                      || RPAD (' ', 12, ' ')
                      || RPAD (' ', 4, ' ')
                      || RPAD (' ', 1, ' ')
                      || RPAD (' ', 1, ' ')
                      || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                        '999999990.99S'
                                       ),
                               13,
                               ' '
                              )
                      || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                        '999999990.99S'
                                       ),
                               13,
                               ' '
                              )
                      || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                      || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                      || RPAD
                            (NVL (vidheader (i).ship_to_customer_name, ' '),
                             30,
                             ' '
                            )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                      || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                               30,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                               30,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).ship_to_city, ' '), 28, ' ')
                      || RPAD (NVL (vidheader (i).ship_to_state, ' '), 2, ' ')
                      || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                               11,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                               3,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                               25,
                               ' '
                              )
                      || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                      || RPAD (' ', 1, ' ')
                      || RPAD
                            (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                    --  || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.   -- Commented for defect 8867
                        || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                      || RPAD (' ', 1, ' ')
                      || RPAD (' ', 1, ' ')
                      || NVL
                            (vidheader (i).specl_handlg_cd,
                             RPAD (' ', 4, ' '))
                                 --cursor value queried with default 4 spaces.
                      || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                              RPAD (' ', 8, ' ')
                             )
                      || RPAD
                            (NVL
                                (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                 ' '
                                ),
                             9,
                             ' '
                            )                                --SHIP_TO_ADDR_ID
                      || RPAD (' ', 1, ' ')
                      || RPAD (' ', 4, ' ')
                      || RPAD
                            (NVL (vidheader (i).bill_to_name, ' '), 30, ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                      || RPAD
                            (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                      || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                               30,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                               30,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).bill_to_city, ' '), 28, ' ')
                      || RPAD (NVL (vidheader (i).bill_to_state, ' '), 2, ' ')
                      || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                               11,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                               3,
                               ' '
                              )
                      || RPAD (NVL (vidheader (i).bill_to_attn, ' '), 30, ' ')
                      || RPAD (' ', 9, ' ')
                      || RPAD (' ', 2, ' ')
                      || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                      || LPAD
                            (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                      || RPAD (' ', 5, ' ')
                                         --ELEC DETAIL SEQ NOT FOR HD REC TYPE
                      || RPAD (' ', 9, ' ')
                      || RPAD (' ', 5, ' ')
                      || RPAD (' ', 20, ' ')
                      || RPAD (' ', 20, ' ')
                      || RPAD (' ', 20, ' ')
                      || RPAD (' ', 3, ' ')
                      || RPAD (' ', 6, ' ')
                      || RPAD (' ', 14, ' ')
                      || RPAD (' ', 9, ' ')
                      || RPAD (' ', 30, ' ')
                      || RPAD (' ', 2, ' ')
                      || TO_CHAR (0, '09999S')
                      || TO_CHAR (0, '09999S')
                      || TO_CHAR (0, '09999S')
                      || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                      || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                      || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                      || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                      || LPAD (TO_CHAR (0, '999999990.99S'), 13, ' ')
                      || RPAD (' ', 1, ' ')
                      || RPAD (' ', 7, ' ')
                      || RPAD (' ', 5, ' ')
                      || RPAD (' ', 20, ' ')
                      || RPAD (' ', 1, ' ')
                      || RPAD (' ', 1, ' ')
                      || lc_comments
                      || RPAD (' ', 8, ' ')
                    /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                      || RPAD                                                          -- added for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_desc,
                                  ' '
                                 ),
                             25,
                             ' '
                            )
                      || RPAD (' ', 175, ' ')
                      || RPAD (NVL (vidheader (i).trx_number, ' '), 20, ' ')
                      || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                    ' '),
                               15,
                               ' '
                              )
					  || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					  || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                      || 'X'
                      ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                     );

--              fnd_file.put_line (fnd_file.LOG,'Extracted data for record type : '||lc_elecrectype);  --Commented for Defect # 1742

               EXCEPTION
                  WHEN OTHERS
                  THEN
/*                     fnd_file.put_line (fnd_file.output,
                                        'Error @ HD type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'|| SQLERRM
                                       ); */ --Commented for Defect # 1742
                     RAISE;      --Added for the defect 12435
               END;

--========================================================================
-- Insert the transactions into the custom table and update ar_cons_inv
--========================================================================
      ----==Commented for the defect 12435====----
                  /*
               IF (   (lc_prev_cbi_id = 0)
                   OR (lc_prev_cbi_id <> vidheader (i).cons_inv_id)
                  )
               THEN
                  lc_prev_cbi_id := vidheader (i).cons_inv_id;
               BEGIN
                     SAVEPOINT square1;

                     UPDATE ar_cons_inv
                        SET attribute4 = 'Y'||'|'||ln_request_id        --Added for Defect 10998
                      WHERE cons_inv_id = vidheader (i).cons_inv_id;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        fnd_file.put_line
                           (fnd_file.output,
                               'Problem during update of ar_cons_inv ,Consolidated Bill ID: '
                            || TO_CHAR (vidheader (i).cons_inv_id)
                           );
                        ROLLBACK TO square1;
                  END;
               ELSE
                  lc_prev_cbi_id := vidheader (i).cons_inv_id;
               END IF;
 */
               --fnd_file.put_line(fnd_file.output, 'After insert into history table...');

               -- =====================================================================================
-- Should be the first invoice detail line.
-- Process Tiered Discount, one line per Invoice.
-- We use record type MS. We copy the description "Tiered Discount" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_Tiered_Discount_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
               ln_detail_count := 0;
               lc_error_location := 'Opening lc_tiered_discount in generate_file';    --Added as a part of defect 11993
               lc_error_debug    := 'Tiered_discount for the transaction ID --'       --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_tiered_discount (vidheader (i).customer_trx_id,
                                        lc_trx_class,
                                        lc_invoice_source
                                       );

               FETCH lc_tiered_discount
                INTO lc_tiered_discount_rec;

               IF lc_tiered_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     --fnd_file.put_line(fnd_file.output ,'MS');
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                         -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                  --RPAD(NVL(lc_addraliasname ,' ') ,20 ,' ')  --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_tiered_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_tiered_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_tiered_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')  --custpolinenbr --Added for the defect 13488
                         /*|| RPAD(NVL(lc_tiered_discount_rec.custpolinenbr,
                                     ln_detail_count
                                     ),9,' ')  --custpolinenbr  */  -- Commented for the defect 13488
                         || RPAD (NVL (lc_tiered_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_tiered_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_tiered_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_tiered_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_tiered_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_tiered_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_tiered_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_tiered_discount_rec.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_tiered_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_tiered_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         --||lc_comments
                         || RPAD
                               (   'Tiered discount: '
                                || LPAD
                                      (TO_CHAR
                                          (NVL
                                              (lc_tiered_discount_rec.extended_amount,
                                               0
                                              ),
                                           '999999990.99S'
                                          ),
                                       13,
                                       ' '
                                      )
                                || ' has been applied to this order.',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                         /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					     || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
            /*            fnd_file.put_line
                                 (fnd_file.output,
                                     'Error @ MS type for Tiered Discount...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                  || SQLERRM
                                 );  */
                        RAISE;      --Added for the defect 12435
                  END;
               END IF;

               CLOSE lc_tiered_discount;

--               fnd_file.put_line (fnd_file.LOG,'Out of Tiered Discount'); --Commented for Defect # 1742

               --Defect 12673- Add bulk discount line to the EBL file
                     lc_error_location := 'Opening lc_bulk_discount in generate_file';      --Added as a part of defect 12673
               lc_error_debug    := 'Bulk_discount for the transaction ID --'         --Added as a part of defect 12673
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_bulk_discount (vidheader (i).customer_trx_id,
                                        lc_trx_class,
                                        lc_invoice_source
                                       );

               FETCH lc_bulk_discount
                INTO lc_bulk_discount_rec;

               IF lc_bulk_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_bulk_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_bulk_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_bulk_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')  --custpolinenbr --Added for the defect 13488
                         /*|| RPAD(NVL(lc_bulk_discount_rec.custpolinenbr,
                                     ln_detail_count
                                     ),9,' ')  --custpolinenbr  */  -- Commented for the defect 13488
                         || RPAD (NVL (lc_bulk_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_bulk_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_bulk_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_bulk_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_bulk_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_bulk_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_bulk_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_bulk_discount_rec.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_bulk_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_bulk_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         --||lc_comments
                         || RPAD
                               (   'Bulk discount: '
                                || LPAD
                                      (TO_CHAR
                                          (NVL
                                              (lc_bulk_discount_rec.extended_amount,
                                               0
                                              ),
                                           '999999990.99S'
                                          ),
                                       13,
                                       ' '
                                      )
                                || ' has been applied to this order.',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                         || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					     || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        fnd_file.put_line
                                 (fnd_file.output,
                                     'Error @ MS type for Bulk Discount...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                  || SQLERRM
                                 );
                        RAISE;
                  END;
               END IF;
               CLOSE lc_bulk_discount;
               --Defect#12673- Changes complete


-- Start of Changes for Prod Defect # 2025
-- =====================================================================================
-- Should be the second invoice detail line.
-- Process Coupon Discount, one line per Invoice.
-- We use record type MS. We copy the description "COUPON" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_coupon_discount_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
            IF (ln_total_coupon_amt <> 0) THEN
               lc_error_location := 'Opening lc_coupon_discount in generate_file';
               lc_error_debug    := 'Coupon_discount for the transaction ID --'
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_coupon_discount (vidheader (i).customer_trx_id,
                                        ln_total_coupon_amt
                                       );

               FETCH lc_coupon_discount
                INTO lc_coupon_discount_rec;

               IF lc_coupon_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                  --RPAD(NVL(lc_addraliasname ,' ') ,20 ,' ')  --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_coupon_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_coupon_discount_rec.custprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_coupon_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')  --custpolinenbr
                         || RPAD (NVL (lc_coupon_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_coupon_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_coupon_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_coupon_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_coupon_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_coupon_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_coupon_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_coupon_discount_rec.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_coupon_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_coupon_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         --||lc_comments
                         || RPAD
                               (   'Coupon discount: '
                                || LPAD
                                      (TO_CHAR
                                          (NVL
                                              (lc_coupon_discount_rec.extended_amount,
                                               0
                                              ),
                                           '999999990.99S'
                                          ),
                                       13,
                                       ' '
                                      )
                                || ' has been applied to this order.',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                        || RPAD
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					     || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        RAISE;
                  END;
               END IF;
               CLOSE lc_coupon_discount;
            END IF;
-- End of changes for Prod Defect # 2025

-- =====================================================================================
-- Should be the first invoice detail line.
-- Process Association Discount, one line per Invoice.
-- We use record type MS. We copy the description "Association Discount" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_Association_Discount_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
               --ln_detail_count := 0;  Commented for the defect 13486
               lc_error_location := 'Opening lc_association_discount in generate_file';    --Added as a part of defect 11993
               lc_error_debug    := 'Association discount for the transaction ID --'       --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_association_discount (vidheader (i).customer_trx_id,
                                             lc_trx_class,
                                             lc_invoice_source
                                            );

               FETCH lc_association_discount
                INTO lc_association_discount_rec;

               IF lc_association_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     --fnd_file.put_line(fnd_file.output ,'MS');
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                          -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )                              --lc_addrbusname
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                        -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_association_discount_rec.productcdentered,
                                    ' '
                                   ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL
                                   (lc_association_discount_rec.productcdentered,
                                    ' '
                                   ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL
                                   (lc_association_discount_rec.wholesaleprodcd,
                                    ' '
                                   ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')  --custpolinenbr --Added for the defect 13488
                         /*|| RPAD
                               (NVL
                                   (lc_association_discount_rec.custpolinenbr,
                                    ln_detail_count
                                   ),
                                9,
                                ' '
                               )  --custpolinenbr  */ -- Commented for the defect 13488
                         || RPAD
                               (NVL (lc_association_discount_rec.description,
                                     ' '
                                    ),
                                30,
                                ' '
                               )
                         || RPAD (NVL (lc_association_discount_rec.uom_code,
                                       ' '
                                      ),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL
                                   (lc_association_discount_rec.quantity_ordered,
                                    0
                                   ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL
                                   (lc_association_discount_rec.quantity_invoiced,
                                    0
                                   ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL
                                   (lc_association_discount_rec.backordered_qty,
                                    0
                                   ),
                                '09999S'
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_association_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_association_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_association_discount_rec.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_association_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD
                               (NVL (lc_association_discount_rec.taxable_flag,
                                     ' '
                                    ),
                                1,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         --||lc_comments
                         || RPAD
                               (   'Association discount: '
                                || LPAD
                                      (TO_CHAR
                                          (NVL
                                              (lc_association_discount_rec.extended_amount,
                                               0
                                              ),
                                           '999999990.99S'
                                          ),
                                       13,
                                       ' '
                                      )
                                || ' has been applied to this order.',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                         /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					     || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
              /*          fnd_file.put_line
                            (fnd_file.output,
                                'Error @ MS type for Association Discount...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                             || SQLERRM
                            );  */ --Commented for Defect # 1742
                        RAISE;      --Added for the defect 12435
                  END;
               END IF;

               CLOSE lc_association_discount;

        --       fnd_file.put_line (fnd_file.LOG,'Out of Association discount...');  --Commented for Defect # 1742

-- =====================================================================================
-- Should be the first invoice detail line.
-- Process GSA Comment, one line per Invoice.
-- We use record type MS. We copy the description "GSA Comment" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_GSA_Comment_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
               --ln_detail_count := 0;  Commented for the defect 13486
               lc_error_location := 'Opening lc_gsa_comment in generate_file';     --Added as a part of defect 11993
               lc_error_debug    := 'GSA Comments for the transaction ID --'       --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id;

               OPEN lc_gsa_comment (vidheader (i).customer_trx_id,
                                    lc_trx_class,
                                    lc_invoice_source
                                   );

               FETCH lc_gsa_comment
                INTO lc_gsa_comment_rec;

               IF lc_gsa_comment%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     --fnd_file.put_line(fnd_file.output ,'MS');
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                          -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )                              --lc_addrbusname
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_gsa_comment_rec.productcdentered, ' '),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_gsa_comment_rec.productcdentered, ' '),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_gsa_comment_rec.wholesaleprodcd, ' '),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                         /*|| RPAD
                               (NVL (lc_gsa_comment_rec.custpolinenbr,
                                     ln_detail_count
                                    ),
                                9,
                                ' '
                               ) --custpolinenbr*/  --Commented for the defect 13488
                         || RPAD (NVL (lc_gsa_comment_rec.description, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_gsa_comment_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                                   (NVL (lc_gsa_comment_rec.quantity_ordered,
                                         0
                                        ),
                                    '09999S'
                                   )
                         || TO_CHAR
                                  (NVL (lc_gsa_comment_rec.quantity_invoiced,
                                        0
                                       ),
                                   '09999S'
                                  )
                         || TO_CHAR (NVL (lc_gsa_comment_rec.backordered_qty,
                                          0
                                         ),
                                     '09999S'
                                    )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_gsa_comment_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                     (NVL (lc_gsa_comment_rec.sku_list_price,
                                           0
                                          ),
                                      '99999990.999S'
                                     ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                    (NVL (lc_gsa_comment_rec.extended_amount,
                                          0
                                         ),
                                     '999999990.99S'
                                    ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                                (NVL (lc_gsa_comment_rec.vendor_product_code,
                                      ' '
                                     ),
                                 20,
                                 ' '
                                )
                         || RPAD (NVL (lc_gsa_comment_rec.taxable_flag, ' '),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         -- ||lc_comments
                         || RPAD
                               ('GSA Y: On Federal Supply Schedule; GSA N: Not On Federal Supply Schedule',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                        /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					     || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
               /*         fnd_file.put_line
                                     (fnd_file.output,
                                         'Error @ MS type for GSA Comment...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                      || SQLERRM
                                     );  */ --Commented for Defect # 1742
                        RAISE;      --Added for the defect 12435
                  END;
               END IF;

               CLOSE lc_gsa_comment;

                 --     fnd_file.put_line (fnd_file.LOG,'Out of GSA Comments ');--Commented for Defect # 1742
--============================================================================
--Fetching the Miscellaneous charges if found and inserting then in the File
--============================================================================
               lc_error_location := 'Opening lcu_charges_lines in generate_file';           --Added as a part of defect 11993
               lc_error_debug    := 'Miscellaneous Charges for the transaction ID --'       --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id;

               OPEN lcu_charges_lines (vidheader (i).customer_trx_id,
                                       lc_misc_charges,
                                       lc_trx_class,
                                       lc_invoice_source
                                      );

               FETCH lcu_charges_lines
                INTO misc_charge_rec_type;

               IF lcu_charges_lines%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     --fnd_file.put_line(fnd_file.output ,'MS');
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                          -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )                              --lc_addrbusname
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (misc_charge_rec_type.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (misc_charge_rec_type.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (misc_charge_rec_type.wholesaleprodcd,
                                     ' '),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                         /*|| RPAD
                               (NVL (misc_charge_rec_type.custpolinenbr,
                                    ln_detail_count
                                    ),
                                9,
                                ' '
                               )       --custpolinenbr  */  -- Commented for the defect 13488
                         || RPAD (NVL (misc_charge_rec_type.description, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (misc_charge_rec_type.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                                 (NVL (misc_charge_rec_type.quantity_ordered,
                                       0
                                      ),
                                  '09999S'
                                 )
                         || TO_CHAR
                                (NVL (misc_charge_rec_type.quantity_invoiced,
                                      0
                                     ),
                                 '09999S'
                                )
                         || TO_CHAR
                                  (NVL (misc_charge_rec_type.backordered_qty,
                                        0
                                       ),
                                   '09999S'
                                  )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (misc_charge_rec_type.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL (misc_charge_rec_type.sku_list_price,
                                         0
                                        ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL (misc_charge_rec_type.extended_amount,
                                         0
                                        ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (misc_charge_rec_type.vendor_product_code,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (misc_charge_rec_type.taxable_flag, ' '),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_comments
                         || RPAD (' ', 8, ' ')
                         /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
					     || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
              /*          fnd_file.put_line (fnd_file.output,
                                           'Error @ MS type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..' || SQLERRM
                                          ); */ --Commented for Defect # 1742
                        RAISE;      --Added for the defect 12435
                END;
               END IF;

               CLOSE lcu_charges_lines;

--               fnd_file.put_line (fnd_file.LOG,'Out of LCU charge lines'); --Commented for Defect # 1742

--===============================================================
--Fetching the Line level data and inserting then in the File
--===============================================================
               ln_detail_line_count := 0;  --Added for the defect 13488
               lc_error_location := 'Opening lcu_line in generate_file';                            --Added as a part of defect 11993
               lc_error_debug    := 'Line level data from lcu_line for the transaction ID --'       --Added as a part of defect 11993
                                    ||vidheader (i).customer_trx_id;
               OPEN lcu_line (vidheader (i).customer_trx_id,
                              lc_trx_class,
                              lc_invoice_source
                             );

               LOOP
                  FETCH lcu_line
                  BULK COLLECT INTO vidline LIMIT 100;

                  EXIT WHEN vidline.COUNT = 0;

                  IF vidline.COUNT > 0
                  THEN
                     FOR j IN vidline.FIRST .. vidline.LAST
                     LOOP
                        lc_elecrectype := 'DT';
                        ln_common_count := ln_common_count + 1;
                        ln_detail_count := ln_detail_count + 1;
                        ln_detail_line_count  := ln_detail_line_count + 1;  --Added for the defect 13488

                        lc_error_location := 'Opening lcu_get_ship_date_item in generate_file';        --Added as a part of defect 11993
                        lc_error_debug    := 'Reconcile date and ordered item from lcu_get_ship_date_item for --' --Added as a part of defect 11993
                                             ||vidline (j).interface_line_attribute6;
                        OPEN lcu_get_ship_date_item
                               (TO_NUMBER
                                         (vidline (j).interface_line_attribute6
                                         )
                               );

                        FETCH lcu_get_ship_date_item
                         INTO ld_reconcile_date, lc_ordered_item;

                        CLOSE lcu_get_ship_date_item;
						
						ln_kit_extended_amt := NULL;
						ln_kit_unit_price   := NULL;
						IF vidline (j).bill_level = 'K'
		                THEN
						   lc_error_location := 'Calling package XX_AR_EBL_COMMON_UTIL_PKG.get_kit_extended_amount in generate_file';
						   lc_error_debug    := 'To get the KIT Extended Amount and KIT unit price for Customer Transaction ID :'||vidheader (i).customer_trx_id;
		                   XX_AR_EBL_COMMON_UTIL_PKG.get_kit_extended_amount( p_customer_trx_id      => vidheader (i).customer_trx_id,
		                                                                      p_sales_order_line_id  => vidline (j).interface_line_attribute6,
											                                  p_kit_quantity         => vidline (j).quantity,
											                                  x_kit_extended_amt     => ln_kit_extended_amt,
											                                  x_kit_unit_price       => ln_kit_unit_price
											                                );
			  
			               vidline (j).unit_selling_price := ln_kit_unit_price;
			               vidline (j).sku_list_price     := ln_kit_unit_price;
			               vidline (j).extended_amount    := ln_kit_extended_amt;
			 
		                END IF;
		                
						lc_kit_item_description := NULL;
						lc_kit_sku := NULL;
		                IF vidline (j).bill_level = 'D'
		                THEN
		                  BEGIN
						    lc_error_debug    := 'Get the KIT item description for KIT item :'||vidline (j).kit_item ;
		                    SELECT description, segment1
			                  INTO lc_kit_item_description, lc_kit_sku
			                  FROM mtl_system_items_b
			                 WHERE segment1 = vidline (j).kit_item
			                   AND organization_id = gn_item_master_org;
		                  EXCEPTION
						    WHEN OTHERS THEN
							lc_error_debug    := 'Unable to get the KIT item description for KIT item :'||vidline (j).kit_item ;
			                lc_kit_item_description := NULL;
							lc_kit_sku := NULL;
		                  END;
	                    END IF;

                        lc_get_warehouse_name :=
                           get_warehouse_name
                                        (vidline (j).interface_line_attribute10
                                        );
                    --   fnd_file.put_line(fnd_file.LOG,'Warehouse Name in generate_file'||lc_get_warehouse_name);  --Commented for Defect # 1742
                        BEGIN
                           --fnd_file.put_line(fnd_file.output ,'DT');
                           IF (    (NVL (vidline (j).backordered_qty, 0) > 0)
                               AND (NVL (ln_ordersub_total, 0) > 0)
                              )
                           THEN
                              lc_partial_shipment := 'Y';
                           ELSE
                              lc_partial_shipment := 'N';
                           END IF;
                           UTL_FILE.put_line
                              (lc_file_handle,
                                  RPAD
                                     (NVL
                                         (REPLACE
                                             (vidheader (i).orig_system_reference,
                                              '-',
                                              ''
                                             ),
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )                      --BILL_CUSTOMER_ID
                               || RPAD
                                      (NVL (vidheader (i).cons_billing_number,
                                            ' '
                                           ),
                                       9,
                                       ' '
                                      )
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     (NVL
                                         (vidheader (i).interface_header_attribute1,
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )
                              -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                               || RPAD (NVL (vidheader (i).phone_number, ' '),
                                        11,
                                        ' '
                                       )
                               || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                               || RPAD (' ', 18, ' ')                 --FILLER
                               || RPAD (NVL (lc_addrid, ' '), 9, ' ') --ADDRID
                               || RPAD
                                     (NVL (vidheader (i).invoice_currency_code,
                                           ' '
                                          ),
                                      3,
                                      ' '
                                     )
                               || RPAD
                                     (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                               || RPAD
                                     (NVL (vidheader (i).purchase_order_number,
                                           ' '
                                          ),
                                      22,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.release_number,
                                          ' '
                                         ),
                                      12,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.cost_center_dept,
                                          ' '
                                         ),
                                      20,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.desk_del_addr,
                                          ' '
                                         ),
                                      20,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (REPLACE
                                             (vidheader (i).orig_system_reference,
                                              '-',
                                              ''
                                             ),
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )                              --CHILD_ID
                               || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD (NVL (vidheader (i).bus_name, ' '),
                                        40,
                                        ' '
                                       )
                               || NVL (TO_CHAR (vidheader (i).due_date,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD (NVL (vidheader (i).NAME, ' '), 20,
                                        ' ')
                               || RPAD
                                     (NVL
                                         (vidheader (i).tax_registration_number,
                                          ' '
                                         ),
                                      10,
                                      ' '
                                     )
                               || RPAD (' ', 7, ' ')
                               || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || RPAD (' ', 1, ' ')
                               || lc_pos_acct_nbr               --SPC ACCT NBR
                               || lc_pos_tran_nbr           --SPC TRANS NUMBER
                               || lc_pos_reg_nbr              --SPC REG NUMBER
                               || NVL
                                     (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                      RPAD (' ', 8, ' ')
                                     )
                               || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD
                                     (NVL (vidheader (i).ordsourcecd, ' '),
                                      1,
                                      ' '
                                     )                           --ordsourcecd
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.ordcreateid,
                                          ' '
                                         ),
                                      10,
                                      ' '
                                     )                           --ordgreateid
                               || RPAD (' ', 5, ' ')
                               || RPAD (' ', 5, ' ')
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.placement_method_code,
                                          ' '
                                         ),
                                      1,
                                      ' '
                                     )
                               || NVL
                                     (TO_CHAR (ld_hd_ordcompletedate,
                                               'YYYYMMDD'
                                              ),
                                      RPAD (' ', 8, ' ')
                                     )                           --Pickup Date
                               || NVL
                                     (TO_CHAR (ld_hd_ordcompletedate,
                                               'YYYYMMDD'
                                              ),
                                      RPAD (' ', 8, ' ')
                                     )                        --Reconcile Date
                               || RPAD
                                     (NVL (get_om_details_rec_type.custtypecd,
                                           ' '
                                          ),
                                      1,
                                      ' '
                                     )                       --Order Type code
                               || RPAD
                                     (NVL (vidheader (i).primary_salesrep_name,
                                           ' '
                                          ),
                                      25,
                                      ' '
                                     )
                               || RPAD (' ', 12, ' ')
                               || RPAD (' ', 4, ' ')
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 1, ' ')
                               || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || RPAD (NVL (lc_ship_to_addr_flag, ' '),
                                        1,
                                        ' '
                                       )
                               || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                               || RPAD
                                     (NVL (vidheader (i).ship_to_customer_name,
                                           ' '
                                          ),
                                      30,
                                      ' '
                                     )                        --lc_addrbusname
                               || RPAD (NVL (vidheader (i).ship_to_address1,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_address2,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                        28,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                        2,
                                        ' '
                                       )
                               || RPAD
                                      (NVL (vidheader (i).ship_to_postal_code,
                                            ' '
                                           ),
                                       11,
                                       ' '
                                      )
                               || RPAD (NVL (vidheader (i).ship_to_country,
                                             ' '
                                            ),
                                        3,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_contact,
                                             ' '
                                            ),
                                        25,
                                        ' '
                                       )
                               || LPAD
                                     (NVL (TO_CHAR (ln_line_count), ' '),
                                      5,
                                      ' '
                                     )                            --nbroflines
                               || RPAD (' ', 1, ' ')
                               || RPAD
                                     (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                              -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 1, ' ')
                               || NVL
                                     (vidheader (i).specl_handlg_cd,
                                      RPAD (' ', 4, ' ')
                                     )
                                 --cursor value queried with default 4 spaces.
                               || NVL (TO_CHAR (vidheader (i).trx_date,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD
                                     (NVL
                                         (SUBSTR
                                             (vidheader (i).ship_to_location,
                                                INSTR
                                                   (vidheader (i).ship_to_location,
                                                    '-'
                                                   )
                                              + 1
                                             ),
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )                       --SHIP_TO_ADDR_ID
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 4, ' ')
                               || RPAD
                                     (NVL (vidheader (i).bill_to_name, ' '),
                                      30,
                                      ' '
                                     )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                               || RPAD
                                     (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                               || RPAD (NVL (vidheader (i).bill_to_address1,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_address2,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                        28,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                        2,
                                        ' '
                                       )
                               || RPAD
                                      (NVL (vidheader (i).bill_to_postal_code,
                                            ' '
                                           ),
                                       11,
                                       ' '
                                      )
                               || RPAD (NVL (vidheader (i).bill_to_country,
                                             ' '
                                            ),
                                        3,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                        30,
                                        ' '
                                       )
                               || RPAD (' ', 9, ' ')
                               || RPAD (' ', 2, ' ')
                               || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                               || LPAD
                                     (NVL (TO_CHAR (ln_common_count), ' '),
                                      6,
                                      ' '
                                     )                     --ELEC FILE REC NBR
                               || LPAD
                                     (NVL (TO_CHAR (ln_detail_count), ' '),
                                      5,
                                      ' '
                                     )                       --ELEC DETAIL SEQ
                               || RPAD
                                     (NVL (vidline (j).item_number, ' '),
                                      9,
                                      ' '
                                     )         --item number for DT records...
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     (NVL (vidline (j).productcdentered, ' '),
                                      20,
                                      ' '
                                     )                    --product_cd_entered
                               || RPAD
                                     (NVL (vidline (j).productcdentered, ' '),
                                      20,
                                      ' '
                                     )                       --cust_product_cd
                               || RPAD
                                     (NVL (vidline (j).wholesaleprodcd, ' '),
                                      20,
                                      ' '
                                     )                         --whsle_prod_cd
                               || RPAD (' ', 3, ' ')
                               || RPAD (' ', 6, ' ')
                               || RPAD (' ', 14, ' ')
                               || RPAD
                                     (NVL (vidline (j).custpolinenbr,
                                           ln_detail_line_count  --Added for the defect 13488
                                           --ln_detail_count     --Commented for the defect 13488
                                           ),
                                      9,
                                      ' '
                                     )                         --custpolinenbr
                               || RPAD (NVL (vidline (j).item_description,
                                             ' '),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidline (j).uom_code, ' '),
                                        2,
                                        ' '
                                       )
                               || TO_CHAR (NVL (vidline (j).quantity_ordered,
                                                0
                                               ),
                                           '09999S'
                                          )
                               || TO_CHAR (NVL (vidline (j).quantity, 0),
                                           '09999S'
                                          )
                               || TO_CHAR (NVL (vidline (j).backordered_qty,
                                                0),
                                           '09999S'
                                          )
                               || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                               || LPAD
                                     (TO_CHAR
                                         (NVL (vidline (j).unit_selling_price,
                                               0
                                              ),
                                          '99999990.999S'
                                         ),
                                      13,
                                      ' '
                                     )
                               || LPAD
                                     (TO_CHAR
                                             (NVL (vidline (j).sku_list_price,
                                                   0
                                                  ),
                                              '99999990.999S'
                                             ),
                                      13,
                                      ' '
                                     )
                               || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                               || LPAD
                                     (TO_CHAR
                                            (NVL (vidline (j).extended_amount,
                                                  0
                                                 ),
                                             '999999990.99S'
                                            ),
                                      13,
                                      ' '
                                     )
                               || RPAD (NVL (vidline (j).contract_cd, ' '),
                                        1,
                                        ' '
                                       )
                               || RPAD (NVL (vidline (j).contract_plan, ' '),
                                        7,
                                        ' '
                                       )
                               || RPAD (NVL (vidline (j).contract_seq, ' '),
                                        5,
                                        ' '
                                       )
                               || RPAD (NVL (vidline (j).vendor_product_code,
                                             ' '
                                            ),
                                        20,
                                        ' '
                                       )
                               || RPAD (NVL (vidline (j).taxable_flag, ' '),
                                        1,
                                        ' '
                                       )
                               || RPAD (' ', 1, ' ')
                               || RPAD (NVL (vidline (j).xxom_line_comments,
                                             ' '
                                            ),
                                        70,
                                        ' '
                                       )
                               || RPAD (' ', 8, ' ')
                            /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                               || RPAD (' ', 175, ' ')
                               || RPAD (NVL (vidheader (i).trx_number, ' '),
                                        20,
                                        ' '
                                       )
                               || RPAD
                                     (NVL
                                         (vidheader (i).bill_to_customer_number,
                                          ' '
                                         ),
                                      15,
                                      ' '
                                     )
							   || RPAD (NVL (lc_kit_sku, ' '),9,' ')  -- Added for Kitting, Defect# 37670
					           || RPAD (NVL (lc_kit_item_description, ' '),30,' ') -- Added for Kitting, Defect# 37670
                               || 'X'
                               ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                              );
                     EXCEPTION
                           WHEN OTHERS
                           THEN
/*                              fnd_file.put_line (fnd_file.output,
                                                    'Error @ DT type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                                 || SQLERRM
                                                ); */ ----Commented for Defect # 1742
                              RAISE;      --Added for the defect 12435
                        END;
                     END LOOP;
                  END IF;
               END LOOP;

               CLOSE lcu_line;

--               fnd_file.put_line (fnd_file.LOG,'Out of lcu_line...');  --Commented for Defect # 1742

--===================================================================
--Fetching the Delivery fee if found and inserting then in the File
--===================================================================
              lc_error_location := 'Opening lcu_charges_lines in generate_file';                   --Added as a part of defect 11993
              lc_error_debug    := 'Delivery Charges from lcu_charges_lines for Transaction ID --' --Added as a part of defect 11993
                                   ||vidheader (i).customer_trx_id;
               OPEN lcu_charges_lines (vidheader (i).customer_trx_id,
                                       lc_delivery,
                                       lc_trx_class,
                                       lc_invoice_source
                                      );

               FETCH lcu_charges_lines
                INTO delivery_charge_rec_type;

               IF lcu_charges_lines%FOUND
               THEN
                  lc_elecrectype := 'DL';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     --fnd_file.put_line(fnd_file.output ,'DL');
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                        -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )                              --lc_addrbusname
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         --||RPAD(NVL(delivery_charge_rec_type.productcdentered ,' ') ,20 ,' ') --product_cd_entered
                         --||RPAD(NVL(delivery_charge_rec_type.productcdentered ,' ') ,20 ,' ') --cust_product_cd
                         --||RPAD(NVL(delivery_charge_rec_type.wholesaleprodcd ,' ') ,20 ,' ')  --whsle_prod_cd
                         || RPAD ('DELIVERY CHARGE', 20, ' ')
                                                          --product_cd_entered
                         || RPAD ('DELIVERY CHARGE', 20, ' ')
                                                             --cust_product_cd
                         || RPAD ('DELIVERY CHARGE', 20, ' ')  --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                        /* || RPAD
                               (NVL (delivery_charge_rec_type.custpolinenbr,
                                     ln_detail_count
                                    ),
                                9,
                                ' '
                               ) --custpolinenbr  */  -- Commented for the defect 13488
                         --||RPAD(NVL(delivery_charge_rec_type.description ,' ') ,30 ,' ')
                         || RPAD ('DELIVERY CHARGE', 30, ' ')
                         || RPAD (NVL (delivery_charge_rec_type.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL
                                   (delivery_charge_rec_type.quantity_ordered,
                                    0
                                   ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL
                                   (delivery_charge_rec_type.quantity_invoiced,
                                    0
                                   ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (delivery_charge_rec_type.backordered_qty,
                                     0
                                    ),
                                '09999S'
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (delivery_charge_rec_type.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (delivery_charge_rec_type.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (delivery_charge_rec_type.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         --||RPAD(' ' ,20 ,' ')
                         || RPAD ('DELIVERY CHARGE', 20, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || lc_comments
                         || RPAD (' ', 8, ' ')
                         /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                 || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                /*        fnd_file.put_line (fnd_file.output,
                                           'Error @ DL type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..' || SQLERRM
                                          ); */ --Commented for Defect # 1742
                        RAISE;      --Added for the defect 12435
                  END;
               END IF;

               CLOSE lcu_charges_lines;

--               fnd_file.put_line (fnd_file.LOG,'Out of lcu_charges_lines...');--Commented for Defect # 1742

--============================================================
--Fetching the Tax information and inserting then in the File
--=============================================================
               IF ln_us_operating_unit = ln_operating_unit
               THEN
                  lc_error_location := 'Opening lcu_get_tax_details_us in generate_file';        --Added as a part of defect 11993
                  lc_error_debug    := 'Tax from lcu_get_tax_details_us for Transaction ID --'   --Added as a part of defect 11993
                                       ||vidheader (i).customer_trx_id;
                  OPEN lcu_get_tax_details_us (vidheader (i).customer_trx_id);

                  FETCH lcu_get_tax_details_us
                   INTO ln_tax_amount, lc_tax_code, lc_tax_rate;

                  EXIT WHEN lcu_get_tax_details_us%NOTFOUND;

                  IF lcu_get_tax_details_us%FOUND
                  THEN
                     IF ln_tax_amount <> 0
                     THEN
           --Changed the comparision operator from > to <> for Defect # 11741
                        lc_elecrectype := 'TX';
                        ln_common_count := ln_common_count + 1;
                        ln_detail_count := ln_detail_count + 1;
                        BEGIN
                           lc_tax_rate := TO_CHAR ((ln_tax_rate * 100));
                           --fnd_file.put_line(fnd_file.output ,'US TX amount >0...');
                           UTL_FILE.put_line
                              (lc_file_handle,
                                  RPAD
                                     (NVL
                                         (REPLACE
                                             (vidheader (i).orig_system_reference,
                                              '-',
                                              ''
                                             ),
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )                      --BILL_CUSTOMER_ID
                               || RPAD
                                      (NVL (vidheader (i).cons_billing_number,
                                            ' '
                                           ),
                                       9,
                                       ' '
                                      )
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     (NVL
                                         (vidheader (i).interface_header_attribute1,
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )
                                -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                               || RPAD (NVL (vidheader (i).phone_number, ' '),
                                        11,
                                        ' '
                                       )
                               || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                               || RPAD (' ', 18, ' ')                 --FILLER
                               || RPAD (NVL (lc_addrid, ' '), 9, ' ') --ADDRID
                               || RPAD
                                     (NVL (vidheader (i).invoice_currency_code,
                                           ' '
                                          ),
                                      3,
                                      ' '
                                     )
                               || RPAD
                                     (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                               || RPAD
                                     (NVL (vidheader (i).purchase_order_number,
                                           ' '
                                          ),
                                      22,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.release_number,
                                          ' '
                                         ),
                                      12,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.cost_center_dept,
                                          ' '
                                         ),
                                      20,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.desk_del_addr,
                                          ' '
                                         ),
                                      20,
                                      ' '
                                     )
                               || RPAD
                                     (NVL
                                         (REPLACE
                                             (vidheader (i).orig_system_reference,
                                              '-',
                                              ''
                                             ),
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )                              --CHILD_ID
                               || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD (NVL (vidheader (i).bus_name, ' '),
                                        40,
                                        ' '
                                       )
                               || NVL (TO_CHAR (vidheader (i).due_date,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD (NVL (vidheader (i).NAME, ' '), 20,
                                        ' ')
                               || RPAD
                                     (NVL
                                         (vidheader (i).tax_registration_number,
                                          ' '
                                         ),
                                      10,
                                      ' '
                                     )
                               || RPAD (' ', 7, ' ')
                               || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                                 '9999990.99S'
                                                ),
                                        11,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || RPAD (' ', 1, ' ')
                               || lc_pos_acct_nbr               --SPC ACCT NBR
                               || lc_pos_tran_nbr           --SPC TRANS NUMBER
                               || lc_pos_reg_nbr              --SPC REG NUMBER
                               || NVL
                                     (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                      RPAD (' ', 8, ' ')
                                     )
                               || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD
                                     (NVL (vidheader (i).ordsourcecd, ' '),
                                      1,
                                      ' '
                                     )                           --ordsourcecd
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.ordcreateid,
                                          ' '
                                         ),
                                      10,
                                      ' '
                                     )                           --ordgreateid
                               || RPAD (' ', 5, ' ')
                               || RPAD (' ', 5, ' ')
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     (NVL
                                         (get_om_details_rec_type.placement_method_code,
                                          ' '
                                         ),
                                      1,
                                      ' '
                                     )
                               || NVL
                                     (TO_CHAR (ld_hd_ordcompletedate,
                                               'YYYYMMDD'
                                              ),
                                      RPAD (' ', 8, ' ')
                                     )                           --Pickup Date
                               || NVL
                                     (TO_CHAR (ld_hd_ordcompletedate,
                                               'YYYYMMDD'
                                              ),
                                      RPAD (' ', 8, ' ')
                                     )                        --Reconcile Date
                               || RPAD
                                     (NVL (get_om_details_rec_type.custtypecd,
                                           ' '
                                          ),
                                      1,
                                      ' '
                                     )                       --Order Type code
                               || RPAD
                                     (NVL (vidheader (i).primary_salesrep_name,
                                           ' '
                                          ),
                                      25,
                                      ' '
                                     )
                               || RPAD (' ', 12, ' ')
                               || RPAD (' ', 4, ' ')
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 1, ' ')
                               || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                                 '999999990.99S'
                                                ),
                                        13,
                                        ' '
                                       )
                               || RPAD (NVL (lc_ship_to_addr_flag, ' '),
                                        1,
                                        ' '
                                       )
                               || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                               || RPAD
                                     (NVL (vidheader (i).ship_to_customer_name,
                                           ' '
                                          ),
                                      30,
                                      ' '
                                     )                        --lc_addrbusname
                               || RPAD (NVL (vidheader (i).ship_to_address1,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_address2,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                        28,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                        2,
                                        ' '
                                       )
                               || RPAD
                                      (NVL (vidheader (i).ship_to_postal_code,
                                            ' '
                                           ),
                                       11,
                                       ' '
                                      )
                               || RPAD (NVL (vidheader (i).ship_to_country,
                                             ' '
                                            ),
                                        3,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).ship_to_contact,
                                             ' '
                                            ),
                                        25,
                                        ' '
                                       )
                               || LPAD
                                     (NVL (TO_CHAR (ln_line_count), ' '),
                                      5,
                                      ' '
                                     )                            --nbroflines
                               || RPAD (' ', 1, ' ')
                               || RPAD
                                     (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                            -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 1, ' ')
                               || NVL
                                     (vidheader (i).specl_handlg_cd,
                                      RPAD (' ', 4, ' ')
                                     )
                                 --cursor value queried with default 4 spaces.
                               || NVL (TO_CHAR (vidheader (i).trx_date,
                                                'YYYYMMDD'
                                               ),
                                       RPAD (' ', 8, ' ')
                                      )
                               || RPAD
                                     (NVL
                                         (SUBSTR
                                             (vidheader (i).ship_to_location,
                                                INSTR
                                                   (vidheader (i).ship_to_location,
                                                    '-'
                                                   )
                                              + 1
                                             ),
                                          ' '
                                         ),
                                      9,
                                      ' '
                                     )                       --SHIP_TO_ADDR_ID
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 4, ' ')
                               || RPAD
                                     (NVL (vidheader (i).bill_to_name, ' '),
                                      30,
                                      ' '
                                     )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                               || RPAD
                                     (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                               || RPAD (NVL (vidheader (i).bill_to_address1,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_address2,
                                             ' '
                                            ),
                                        30,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                        28,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                        2,
                                        ' '
                                       )
                               || RPAD
                                      (NVL (vidheader (i).bill_to_postal_code,
                                            ' '
                                           ),
                                       11,
                                       ' '
                                      )
                               || RPAD (NVL (vidheader (i).bill_to_country,
                                             ' '
                                            ),
                                        3,
                                        ' '
                                       )
                               || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                        30,
                                        ' '
                                       )
                               || RPAD (' ', 9, ' ')
                               || RPAD (' ', 2, ' ')
                               || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                               || LPAD
                                     (NVL (TO_CHAR (ln_common_count), ' '),
                                      6,
                                      ' '
                                     )                     --ELEC FILE REC NBR
                               || LPAD
                                     (NVL (TO_CHAR (ln_detail_count), ' '),
                                      5,
                                      ' '
                                     )                       --ELEC DETAIL SEQ
                               || RPAD (' ', 9, ' ')
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     ('SALES TAX', 20, ' ')
                                     --COPY SALES TAX ON PRODUCT_CD_ENTERED...
                               || RPAD
                                     ('SALES TAX', 20, ' ')
                                        --COPY SALES TAX ON CUST_PRODUCT_CD...
                               || RPAD
                                     ('SALES TAX', 20, ' ')
                                       --COPY SALES TAX ON WHSLE_PRODUCT_CD...
                               || RPAD (' ', 3, ' ')
                               || LPAD (NVL (lc_tax_rate, ' '), 6, ' ')
                                                                    --tax rate
                               || RPAD (' ', 14, ' ')
                               || RPAD (' ', 9, ' ')
                               || RPAD
                                     ('SALES TAX', 30, ' ')
                                        --COPY SALES TAX ON SKU DESCRIPTION...
                               || RPAD (' ', 2, ' ')
                               || TO_CHAR (0, '09999S')
                               || TO_CHAR (0, '09999S')
                               || TO_CHAR (0, '09999S')
                               || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                               || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                               || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                               || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                               || LPAD
                                     (TO_CHAR (NVL (ln_tax_amount, 0),
                                               '999999990.99S'
                                              ),
                                      13,
                                      ' '
                                     )
                              --extended price stores tax amt for TX rec type.
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 7, ' ')
                               || RPAD (' ', 5, ' ')
                               || RPAD
                                     ('SALES TAX', 20, ' ')
                                      --COPY SALES TAX ON VENDOR_PRODUCT_CD...
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 1, ' ')
                               || RPAD (' ', 70, ' ')
                               || RPAD (' ', 8, ' ')
                               /*  || RPAD                                                 -- commented for defect 8927
                            (NVL (get_om_details_rec_type.cost_center_dept,
                                  ' '
                                 ),
                             25,
                             ' '
                            )                                 --cust_dept_desc*/
                        || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                               || RPAD (' ', 175, ' ')
                               || RPAD (NVL (vidheader (i).trx_number, ' '),
                                        20,
                                        ' '
                                       )
                               || RPAD
                                     (NVL
                                         (vidheader (i).bill_to_customer_number,
                                          ' '
                                         ),
                                      15,
                                      ' '
                                     )
							   || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                       || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                               || 'X'
                               ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                              );
                        EXCEPTION
                           WHEN OTHERS
                           THEN
               /*               fnd_file.put_line (fnd_file.output,
                                                    'Error @ US TX type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                                 || SQLERRM
                                                ); */ --Commented for Defect # 1742
                              RAISE;      --Added for the defect 12435
                        END;
                     END IF;
                  END IF;

                  CLOSE lcu_get_tax_details_us;
           --     fnd_file.put_line (fnd_file.LOG,'Out of lcu_get_tax_details_us...'); --Commented for Defect # 1742

               ELSIF ln_ca_operating_unit = ln_operating_unit
               THEN
                  lc_error_location := 'Opening lcu_tax_ca in generate_file';        --Added as a part of defect 11993
                  lc_error_debug    := 'Tax from lcu_tax_ca for Transaction ID --' --Added as a part of defect 11993
                                       ||vidheader (i).customer_trx_id;
                  OPEN lcu_tax_ca (vidheader (i).customer_trx_id);

                  FETCH lcu_tax_ca
                   INTO lcu_tax_ca_rec;

                  CLOSE lcu_tax_ca;

-- =================================================
-- Loop thru QST/PST AND GST tax records for CA.
-- =================================================
                  lc_error_location := 'Opening lcu_get_tax_details_ca in generate_file';                   --Added as a part of defect 11993
                  lc_error_debug    := 'Tax from lcu_get_tax_details_ca for Transaction ID and Province --' --Added as a part of defect 11993
                                       ||vidheader (i).customer_trx_id
                                       ||'-'
                                       ||lc_province;
                  OPEN lcu_get_tax_details_ca (vidheader (i).customer_trx_id,
                                               lc_province
                                              );

                  LOOP
                     FETCH lcu_get_tax_details_ca
                      INTO ln_tax_amount, lc_tax_code, lc_tax_rate;

                     EXIT WHEN lcu_get_tax_details_ca%NOTFOUND;

                     IF lcu_get_tax_details_ca%FOUND
                     THEN
                        IF ln_tax_amount <> 0
                        THEN
       --Changed the comparision operator from > to <> for the Defect # 11741
                           lc_elecrectype := 'TX';
                           ln_common_count := ln_common_count + 1;
                           ln_detail_count := ln_detail_count + 1;
                           BEGIN
                              lc_tax_rate := TO_CHAR ((ln_tax_rate * 100));
                              --fnd_file.put_line(fnd_file.output ,'CA TX...');
                              UTL_FILE.put_line
                                 (lc_file_handle,
                                     RPAD
                                        (NVL
                                            (REPLACE
                                                (vidheader (i).orig_system_reference,
                                                 '-',
                                                 ''
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                   --BILL_CUSTOMER_ID
                                  || RPAD
                                        (NVL
                                            (vidheader (i).cons_billing_number,
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL
                                            (vidheader (i).interface_header_attribute1,
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )
                                   -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                                  || RPAD (NVL (vidheader (i).phone_number,
                                                ' '
                                               ),
                                           11,
                                           ' '
                                          )
                                  || RPAD (NVL (lc_cust_phone_ext, ' '),
                                           4,
                                           ' '
                                          )
                                  || RPAD (' ', 18, ' ')              --FILLER
                                  || RPAD (NVL (lc_addrid, ' '), 9, ' ')
                                                                      --ADDRID
                                  || RPAD
                                        (NVL
                                            (vidheader (i).invoice_currency_code,
                                             ' '
                                            ),
                                         3,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL (lc_xaddr_alias_name, ' '),
                                         20,
                                         ' '
                                        )                      --ADDRALIASNAME
                                  || RPAD
                                        (NVL
                                            (vidheader (i).purchase_order_number,
                                             ' '
                                            ),
                                         22,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.release_number,
                                             ' '
                                            ),
                                         12,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.cost_center_dept,
                                             ' '
                                            ),
                                         20,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.desk_del_addr,
                                             ' '
                                            ),
                                         20,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (REPLACE
                                                (vidheader (i).orig_system_reference,
                                                 '-',
                                                 ''
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                           --CHILD_ID
                                  || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD (NVL (vidheader (i).bus_name, ' '),
                                           40,
                                           ' '
                                          )
                                  || NVL (TO_CHAR (vidheader (i).due_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD (NVL (vidheader (i).NAME, ' '),
                                           20,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).tax_registration_number,
                                             ' '
                                            ),
                                         10,
                                         ' '
                                        )
                                  || RPAD (' ', 7, ' ')
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_misc_chrg,
                                                         0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD
                                         (TO_CHAR (NVL (ln_total_deliv_chrg,
                                                        0),
                                                   '9999990.99S'
                                                  ),
                                          11,
                                          ' '
                                         )
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD
                                         (TO_CHAR (NVL (ln_total_coupon_amt,
                                                        0),
                                                   '9999990.99S'
                                                  ),
                                          11,
                                          ' '
                                         )
                                  || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || RPAD (' ', 1, ' ')
                                  || lc_pos_acct_nbr            --SPC ACCT NBR
                                  || lc_pos_tran_nbr        --SPC TRANS NUMBER
                                  || lc_pos_reg_nbr           --SPC REG NUMBER
                                  || NVL
                                        (TO_CHAR
                                            (get_shipping_rec_type.ordered_date,
                                             'YYYYMMDD'
                                            ),
                                         RPAD (' ', 8, ' ')
                                        )
                                  || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD
                                        (NVL (vidheader (i).ordsourcecd, ' '),
                                         1,
                                         ' '
                                        )                        --ordsourcecd
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.ordcreateid,
                                             ' '
                                            ),
                                         10,
                                         ' '
                                        )                        --ordgreateid
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.placement_method_code,
                                             ' '
                                            ),
                                         1,
                                         ' '
                                        )
                                  || NVL
                                        (TO_CHAR (ld_hd_ordcompletedate,
                                                  'YYYYMMDD'
                                                 ),
                                         RPAD (' ', 8, ' ')
                                        )                        --Pickup Date
                                  || NVL
                                        (TO_CHAR (ld_hd_ordcompletedate,
                                                  'YYYYMMDD'
                                                 ),
                                         RPAD (' ', 8, ' ')
                                        )                     --Reconcile Date
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.custtypecd,
                                             ' '
                                            ),
                                         1,
                                         ' '
                                        )                    --Order Type code
                                  || RPAD
                                        (NVL
                                            (vidheader (i).primary_salesrep_name,
                                             ' '
                                            ),
                                         25,
                                         ' '
                                        )
                                  || RPAD (' ', 12, ' ')
                                  || RPAD (' ', 4, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || RPAD (NVL (lc_ship_to_addr_flag, ' '),
                                           1,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                                  || RPAD
                                        (NVL
                                            (vidheader (i).ship_to_customer_name,
                                             ' '
                                            ),
                                         30,
                                         ' '
                                        )                     --lc_addrbusname
                                  || RPAD
                                         (NVL (vidheader (i).ship_to_address1,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD
                                         (NVL (vidheader (i).ship_to_address2,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD (NVL (vidheader (i).ship_to_city,
                                                ' '
                                               ),
                                           28,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).ship_to_state,
                                                ' '
                                               ),
                                           2,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).ship_to_postal_code,
                                             ' '
                                            ),
                                         11,
                                         ' '
                                        )
                                  || RPAD (NVL (vidheader (i).ship_to_country,
                                                ' '
                                               ),
                                           3,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).ship_to_contact,
                                                ' '
                                               ),
                                           25,
                                           ' '
                                          )
                                  || LPAD
                                        (NVL (TO_CHAR (ln_line_count), ' '),
                                         5,
                                         ' '
                                        )                         --nbroflines
                                  || RPAD (' ', 1, ' ')
                                  || RPAD
                                        (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                          -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || NVL
                                        (vidheader (i).specl_handlg_cd,
                                         RPAD (' ', 4, ' ')
                                        )
                                 --cursor value queried with default 4 spaces.
                                  || NVL (TO_CHAR (vidheader (i).trx_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD
                                        (NVL
                                            (SUBSTR
                                                (vidheader (i).ship_to_location,
                                                   INSTR
                                                      (vidheader (i).ship_to_location,
                                                       '-'
                                                      )
                                                 + 1
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                    --SHIP_TO_ADDR_ID
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 4, ' ')
                                  || RPAD
                                        (NVL (vidheader (i).bill_to_name, ' '),
                                         30,
                                         ' '
                                        )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                                  || RPAD
                                        (NVL (lc_xmail_site_name, ' '),
                                         30,
                                         ' '
                                        )
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                                  || RPAD
                                         (NVL (vidheader (i).bill_to_address1,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD
                                         (NVL (vidheader (i).bill_to_address2,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD (NVL (vidheader (i).bill_to_city,
                                                ' '
                                               ),
                                           28,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).bill_to_state,
                                                ' '
                                               ),
                                           2,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).bill_to_postal_code,
                                             ' '
                                            ),
                                         11,
                                         ' '
                                        )
                                  || RPAD (NVL (vidheader (i).bill_to_country,
                                                ' '
                                               ),
                                           3,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).bill_to_attn,
                                                ' '
                                               ),
                                           30,
                                           ' '
                                          )
                                  || RPAD (' ', 9, ' ')
                                  || RPAD (' ', 2, ' ')
                                  || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                                  || LPAD
                                        (NVL (TO_CHAR (ln_common_count), ' '),
                                         6,
                                         ' '
                                        )                  --ELEC FILE REC NBR
                                  || LPAD
                                        (NVL (TO_CHAR (ln_detail_count), ' '),
                                         5,
                                         ' '
                                        )                    --ELEC DETAIL SEQ
                                  || RPAD (' ', 9, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (NVL ('TAX - ' || lc_tax_code, ' '),
                                           20,
                                           ' '
                                          )                   --PST/QST/GST...
                                  || RPAD (NVL ('TAX - ' || lc_tax_code, ' '),
                                           20,
                                           ' '
                                          )                   --PST/QST/GST...
                                  || RPAD (NVL ('TAX - ' || lc_tax_code, ' '),
                                           20,
                                           ' '
                                          )                   --PST/QST/GST...
                                  || RPAD (' ', 3, ' ')
                                  || LPAD (NVL (lc_tax_rate, ' '), 6, ' ')
                                  || RPAD (' ', 14, ' ')
                                  || RPAD (' ', 9, ' ')
                                  || RPAD (NVL ('TAX - ' || lc_tax_code, ' '),
                                           30,
                                           ' '
                                          )                   --PST/QST/GST...
                                  || RPAD (' ', 2, ' ')
                                  || TO_CHAR (0, '09999S')
                                  || TO_CHAR (0, '09999S')
                                  || TO_CHAR (0, '09999S')
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD
                                        (TO_CHAR (NVL (ln_tax_amount, 0),
                                                  '999999990.99S'
                                                 ),
                                         13,
                                         ' '
                                        )
                               --copy tax amt into the extended price field...
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 7, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (NVL ('TAX - ' || lc_tax_code, ' '),
                                           20,
                                           ' '
                                          )                   --PST/QST/GST...
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 70, ' ')
                                  || RPAD (' ', 8, ' ')
                                  /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                                  || RPAD (' ', 175, ' ')
                                  || RPAD (NVL (vidheader (i).trx_number, ' '),
                                           20,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).bill_to_customer_number,
                                             ' '
                                            ),
                                         15,
                                         ' '
                                        )
								  || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                          || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                                  || 'X'
                                  ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                                 );
                           EXCEPTION
                              WHEN OTHERS
                              THEN
              /*                   fnd_file.put_line
                                                  (fnd_file.output,
                                                      'Error @ CA TX type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                                   || SQLERRM
                                                  ); */ --Commented for Defect # 1742
                                 RAISE;      --Added for the defect 12435
                           END;
                        END IF;
                     END IF;
                  END LOOP;

                  CLOSE lcu_get_tax_details_ca;
            --   fnd_file.put_line (fnd_file.LOG,'Out of lcu_get_tax_details_ca...'); --Commented for Defect # 1742

               ELSE
-- ======================================================
-- We exclude all other business units other than US/CA
-- ======================================================
                  NULL;
               END IF;
            --END IF;
--Start of changes for R1.1 defect # 1451 (CR 626)
--========================================================================
--Fetching the gift card details if found and inserting them in the File
--========================================================================
            IF (ln_total_gc_amt <> 0) THEN
               lc_error_location := 'Opening lc_gc_discount in generate_file';
               lc_error_debug    := 'Gift_Card_discount for the transaction ID --'
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_gc_discount (vidheader (i).customer_trx_id,
                                        lc_trx_class,
                                        lc_invoice_source
                                       );

               FETCH lc_gc_discount
                INTO lc_gc_discount_rec;

               IF lc_gc_discount%FOUND
               THEN
                  lc_tender_text := NULL;
-- Added FOR gift card text dynamically
                  IF  lc_trx_class = 'INV' THEN
                      lc_tender_text := lc_tender_text1||LTRIM(TO_CHAR( lc_gc_discount_rec.extended_amount, '999990D99'))||lc_tender_text2;
                  END IF;
                  IF  lc_trx_class = 'CM'  THEN
                     lc_tender_text :=  lc_tender_text3||LTRIM(TO_CHAR( lc_gc_discount_rec.extended_amount*-1, '999990D99'));
                  END IF;
--- end of gift text fetch
                  lc_elecrectype := 'MS';
                  ln_detail_count := ln_detail_count + 1;
                  ln_common_count := ln_common_count + 1;
                  BEGIN
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                                 (NVL (TO_CHAR (ln_common_count), ' '),
                                  6,
                                  ' '
                                 )                  --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_gc_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_gc_discount_rec.custprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_gc_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')
                         || RPAD (NVL (lc_gc_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_gc_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_gc_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_gc_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_gc_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_gc_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_gc_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       ((lc_gc_discount_rec.extended_amount*-1),
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_gc_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_gc_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         --gift card comments
                         || RPAD
                               (  lc_tender_text,
                                70,
                                ' '
                               )
--gift card comments
                         || RPAD (' ', 8, ' ')
                        || RPAD
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                 || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        RAISE;
                  END;
               END IF;
               CLOSE lc_gc_discount;
            END IF;
--End of changes for R1.1 Defect # 1451 (CR 626)

     --====Start of changes for the defect 12435====--
--========================================================================
-- Update ar_cons_inv for successful transactions
--========================================================================
               IF (   (lc_prev_cbi_id = 0)
                   OR (lc_prev_cbi_id <> vidheader (i).cons_inv_id)
                  )
               THEN
                  lc_prev_cbi_id := vidheader (i).cons_inv_id;
                 BEGIN
                     SAVEPOINT square1;
                     lc_error_location := 'Updating attribute4 in ar_cons_inv for CONS_INV_ID --';    --Added for the defect 11993
                     lc_error_debug    := 'Consolidated Billing Number'                              --Added for the defect 11993
                                          ||vidheader (i).cons_inv_id;
                     UPDATE ar_cons_inv
                        SET attribute4 = 'Y'||'|'||ln_request_id        -- Added for Defect 10998
                      -- start of defect 4760 and 4761
                            ,attribute15 = 'Y'
                            ,last_updated_by    = FND_GLOBAL.USER_ID
                            ,last_update_date = SYSDATE
                            ,last_update_login = FND_GLOBAL.USER_ID
                      -- End of defect 4760 and 4761
                      WHERE cons_inv_id = vidheader (i).cons_inv_id;
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                /*        fnd_file.put_line
                           (fnd_file.output,
                               'Problem during update of ar_cons_inv ,Consolidated Bill ID: '
                            || TO_CHAR (vidheader (i).cons_inv_id)
                           );  */ --Commented for Defect # 1742
                        ROLLBACK TO square1;
                  END;
                ELSE
                  lc_prev_cbi_id := vidheader (i).cons_inv_id;
               END IF;
     --====End of changes for the defect 12435====--
            END LOOP;
         END IF;
      END LOOP;

      CLOSE lcu_header;

     fnd_file.put_line (fnd_file.LOG,'Out of lcu_header...');
     fnd_file.put_line (fnd_file.LOG,'Calling generate_info_copy_file...');

      generate_info_copy_file (lc_file_handle,
                               ln_common_count,
                               ln_item_master_org,
                               ln_operating_unit,
                               ln_us_operating_unit,
                               ln_ca_operating_unit,
                               p_tax_id,
                               lc_status_code,          --Added for the defect 12435
                               lc_error_msg_info_cfile,  --Added for the defect 12435
                               p_cust_id_from,       --Added for the defect 1760
                               p_cust_id_to          --Added for the defect 1760
                              );
     fnd_file.put_line (fnd_file.LOG,'Out of generate_info_copy_file...');

   ---====Start of Changes added for the defect 12435====---
      IF (lc_status_code = 'E')
      THEN
        fnd_file.put_line
                         (fnd_file.LOG,
                                    'Generate_info_copy procedure Failed : '
                                    ||lc_error_msg_info_cfile
                         );
         RAISE e_infocopy_exception;
      ELSE
      fnd_file.put_line
                           (fnd_file.LOG,
                               'Generate_info_copy procedure successfully completed '
                           );
      END IF;
   ---====End of Changes for the defect 12435====---
      UTL_FILE.fclose (lc_file_handle);

--+=========================================
 -- Calling the common file copy program
--+=========================================
      BEGIN
         SELECT directory_path
           INTO lc_dba_dir_path
           FROM dba_directories
          WHERE directory_name = 'XXFIN_OUTBOUND';
      EXCEPTION
         WHEN OTHERS
         THEN
            lc_dba_dir_path := NULL;
      END;

      IF lc_dba_dir_path IS NOT NULL
      THEN
         fnd_file.put_line (fnd_file.LOG,'Calling OD common file copy...');    --Added as a part of defect 11993
         ln_req_id :=
            fnd_request.submit_request
               ('XXFIN',
              --  'XXCOMFILCOPY', -- Commented for the defect 15342
                'XXAREBILLCOPY',  -- Added for the defect 15342
                '',
                --'01-OCT-04 00:00:00', --Commented as a part of the defect#631
                TO_CHAR(SYSDATE,'DD-MON-YY HH24:MI:SS'),   --Added as a part of the defect#631
                FALSE,
                lc_dba_dir_path || '/' || p_file_name,
                '$XXFIN_DATA/ftp/out/arinvoice/ebilling/' || p_file_name,
                '',
                '',
                'N',
                '$XXFIN_DATA/archive/outbound'
                                              --Required to archive the files.
               );
         COMMIT;

         IF ln_req_id > 0
         THEN
            lc_wait :=
               fnd_concurrent.wait_for_request (ln_req_id,
                                                10,
                                                0,
                                                lc_conc_phase,
                                                lc_conc_status,
                                                lc_dev_phase,
                                                lc_dev_status,
                                                lc_conc_message
                                               );
         END IF;

         IF TRIM (lc_conc_status) = 'Error'
         THEN
            lc_err_status := 'Y';
            lc_err_msg :=
                  'File Copy of the Ebill File Failed : '
               || p_file_name
               || ': Please check the Log file for Request ID : '
               || ln_req_id;
            fnd_file.put_line (fnd_file.LOG,
                               lc_err_msg || ' : ' || SQLCODE || ' : '
                               || SQLERRM
                              );
         END IF;
      ELSE
-- =======================================================================
-- The output file path is blank. Hence we cannot
-- ftp the file to the XXFIN_DATA/ftp/out/arinvoice/ebilling
-- folder. Manual copy is possible by going to the XXFIN_OUTBOUND folder.
-- =======================================================================
         NULL;
      END IF;
      BEGIN
         lc_error_location := 'Inserting into xx_ar_ebill_done_stg';   --Added as a part of defect 11993
         lc_error_debug    := NULL;                                    --Added as a part of defect 11993
         INSERT INTO xx_ar_ebill_done_stg
                     (request_id, ebill_file_name, process_flag,
                      created_by, creation_date, last_updated_by,
                      last_update_date, last_update_login
                     )
              VALUES (fnd_global.conc_request_id (), p_file_name, 'N',
                      fnd_global.user_id, SYSDATE, fnd_global.user_id,
                      SYSDATE, fnd_global.login_id
                     );

         COMMIT;
      END;
   --generate_done_file;
   EXCEPTION
      WHEN UTL_FILE.access_denied
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' access_denied :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
       --====End of changes for the defect 12435====--
      WHEN UTL_FILE.charsetmismatch
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' charsetmismatch :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.delete_failed
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' delete_failed :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.file_open
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' file_open :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.internal_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' internal_error :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_filehandle
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_filehandle :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_filename
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_filename :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_maxlinesize
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_maxlinesize :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_mode
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_mode :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_offset
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_offset :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_operation
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_operation :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.invalid_path
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' invalid_path :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.read_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' read_error :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.rename_failed
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' rename_failed :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--
      WHEN UTL_FILE.write_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_file Errored :- '
             || ' write_error :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;

      WHEN e_infocopy_exception
      THEN
         lc_errormsg :=
            (   ' Generate_info_copy Errored :- '
             || lc_error_msg_info_cfile
            );
         fnd_file.put_line (fnd_file.LOG, lc_error_msg_info_cfile);

         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         x_retcode:=2;
         x_errbuf  := lc_errormsg;
      --====End of changes for the defect 12435====--

      WHEN OTHERS
      THEN
         lc_errormsg :=
              (' eBill generate_file Other Errors : ' || SQLERRM || SQLCODE
              );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);

      --====Start of changes as a part of defect 11993====--
        FND_FILE.PUT_LINE(FND_FILE.LOG,'Error Location: '||lc_error_location);
        FND_FILE.PUT_LINE(FND_FILE.LOG,'Error Debug:    '||lc_error_debug);
      --====End of changes as a part of defect 11993====--

      --====Start of changes for the defect 12435====--
         ROLLBACK;
         UTL_FILE.fclose_all;
         lc_file_handle := UTL_FILE.fopen (p_file_path, p_file_name, 'W', 32767);
         UTL_FILE.fclose(lc_file_handle);
         RAISE;
      --====End of changes for the defect 12435====--

   END generate_file;

   PROCEDURE generate_info_copy_file (
      p_file_handle     IN   UTL_FILE.file_type,
      p_last_line_seq   IN   NUMBER,
      p_item_org        IN   NUMBER,
      p_current_ou      IN   NUMBER,
      p_us_ou           IN   NUMBER,
      p_ca_ou           IN   NUMBER,
      p_tax_id          IN   VARCHAR2,
      p_status_code     OUT  VARCHAR2 ,   --Added for the defect 12435
      p_error_msg       OUT  VARCHAR2,    --Added for the defect 12435
      p_cust_id_from    IN   NUMBER,     --Added for the defect 1760
      p_cust_id_to      IN   NUMBER     --Added for the defect 1760
   )
   IS
--+==========================================================
-- Cursor for getting all the header level details
--+==========================================================
      CURSOR lcu_header(p_attr_group_id IN NUMBER   --Added as a part of the defect 13717
                       ,p_cust_id_from  IN NUMBER   -- Added as a part of Defect 1760
                       ,p_cust_id_to    IN NUMBER   -- Added as a part of Defect 1760
                       )
      IS
         SELECT   *
             FROM (SELECT TO_CHAR (NULL) trx_number,
                          aci.site_use_id billing_site_id,
                          aci.term_id term_id, aci.cons_inv_id cons_inv_id,
                          aci.cons_billing_number cbi_number,
                          acitl.customer_trx_id customer_trx_id,
                          TO_CHAR (NULL) interface_header_attribute1,
                          TO_CHAR (NULL) LOCATION, TO_CHAR (NULL)
                                                                 phone_number,
                          aci.currency_code invoice_currency_code,
                          TO_CHAR (NULL) orig_system_reference,
                          TO_CHAR (NULL) site_use_code,
                          TO_CHAR (NULL) purchase_order_number,
                          TO_CHAR (NULL) bill_to_customer_number,
                          aci.cut_off_date cut_off_date,
                          aci.issue_date issue_date,
                          TO_CHAR (NULL) bus_name      --bill_to_customer_name
                                                 ,
                          --aci.due_date due_date,    --commented for defect 12243
                          --TO_DATE (NULL) due_date,     -- Added for defect 12243  --Commented for the defect 13650
                          NULL   due_date,               --Added for the defect 13650
                          aci.term_name NAME,
                          TO_CHAR (NULL) interface_header_attribute2,
                          TO_CHAR (NULL) tax_registration_number,
                          TO_CHAR (NULL) primary_salesrep_name,
                          TO_CHAR (NULL) ship_to_customer_name,
                          TO_CHAR (NULL) ship_to_address1,
                          TO_CHAR (NULL) ship_to_address2,
                          TO_CHAR (NULL) ship_to_city,
                          TO_CHAR (NULL) ship_to_state,
                          TO_CHAR (NULL) ship_to_postal_code,
                          TO_CHAR (NULL) ship_to_country,
                          TO_CHAR (NULL) ship_to_contact
             --AIHV.ship_to_contact_first_name||AIHV.ship_to_contact_last_name
                                                        ,
                          TO_DATE (NULL) trx_date,
                          TO_CHAR (NULL) ship_to_location,
                          TO_CHAR (NULL) bill_to_name
                                                  --AIHV.bill_to_customer_name
                                                     ,
                          TO_CHAR (NULL) bill_to_location,
                          TO_CHAR (NULL) bill_to_address1,
                          TO_CHAR (NULL) bill_to_address2,
                          TO_CHAR (NULL) bill_to_city,
                          TO_CHAR (NULL) bill_to_state,
                          TO_CHAR (NULL) bill_to_postal_code,
                          TO_CHAR (NULL) bill_to_country,
                          TO_CHAR (NULL) default_bill_attn, aci.org_id org_id,
                          xcaebv.extension_id extension_id,
                          aci.customer_id customer_id,
                          TO_CHAR (NULL) ordsourcecd
                                                 --interface_header_attribute2
                                                    ,
                          RPAD (xcaebv.spl_handling, 4, ' ') specl_handlg_cd,
                          xcaebv.billing_term billing_term,
                          TO_DATE (NULL) invoice_date, NULL billing_id,
                          'PAYDOC_IC' billing_method,                           -- Added for R1.2 CR 466 Defect 1210
                          xcaebv.cust_doc_id cust_doc_id                                   -- Added for R1.2 CR 466 Defect 1210
                          ,xcaebv.creation_date                 -- Added for the Defect# 4136.
                     FROM (SELECT arci.customer_id,
                                  TRUNC (arci.due_date) due_date
                                                                --,TRUNC(arci.issue_date) issue_date
                                  ,
                                --TRUNC (arci.cut_off_date) issue_date,       --Commented for the defect 11993
                               --   TRUNC (arci.cut_off_date - 1) issue_date,   --Added for the defect 11993
                                                 -- Commented for Defect # 15063
                                  TO_DATE(arci.attribute1) - 1 issue_date,  -- Added for Defect # 15063
                                  arci.cons_billing_number, arci.cons_inv_id,
                                  hzcp.standard_terms term_id,
                                  SUBSTR (rt.description, 1, 15) term_name,
                                  arci.site_use_id,
                                  --TRUNC (arci.cut_off_date - 1) cut_off_date --Commented for the defect 11993
                                                                -- Defect 9043
                                  TRUNC(g_as_of_date)  cut_off_date, --Added for the defect 11993
                                  arci.currency_code, arci.org_id,
                                  arci.attribute2,                      -- Added for R1.3 CR 738 Defect 2766
                                  arci.attribute4,                      -- Added for R1.3 CR 738 Defect 2766
                                  arci.attribute10                      -- Added for R1.3 CR 738 Defect 2766
                                 ,ARCI.attribute15                      -- Added for R1.4 CR 586 Defect 2811
                             FROM ar_cons_inv arci,
                                  hz_customer_profiles hzcp,
                                  ra_terms_tl rt
                            WHERE hzcp.cust_account_id = arci.customer_id
                              AND arci.customer_id BETWEEN p_cust_id_from AND p_cust_id_to    -- Added for the defect 1760
                              AND hzcp.site_use_id = arci.site_use_id
                              AND rt.term_id = hzcp.standard_terms
                              AND rt.language =USERENV('LANG')
                              AND arci.status IN ( 'FINAL','ACCEPTED' )     -- Defect 8654
                                                          ) aci,
                          (SELECT   a.cons_inv_id, a.customer_trx_id
                               FROM ar_cons_inv_trx_lines_all a
                              WHERE 1 = 1
                           GROUP BY a.cons_inv_id, a.customer_trx_id) acitl,
                         /* (SELECT extension_id, cust_account_id,         --Commented as a part of the defect 13717
                                  billdocs_special_handling spl_handling,
                                  billdocs_payment_term billing_term
                             FROM xx_cdh_a_ext_billdocs_v
                            WHERE 1 = 1
                              AND billdocs_doc_type = 'Consolidated Bill'
                              AND billdocs_delivery_meth = 'ELEC'
                              AND NVL (billdocs_paydoc_ind, '?') != 'Y') xcaebv */
                             (SELECT extension_id,
                                     cust_account_id,
                                     c_ext_attr4  spl_handling,
                                     c_ext_attr14 billing_term,
                                     TRUNC(creation_date) creation_date,                       -- Added for prod defect # 2858
                                     n_ext_attr2 cust_doc_id,          -- Added for R1.2 Defect 1210 CR 466
                                     d_ext_attr1 effective_start_date  -- Added for R1.3 CR 738 Defect 2766
                              FROM xx_cdh_cust_acct_ext_b
                              WHERE c_ext_attr1= 'Consolidated Bill'
                                AND c_ext_attr3 = 'ELEC'
                                AND NVL(c_ext_attr2,'?') ! = 'Y'
                                AND attr_group_id = p_attr_group_id           --Added as a part of the defect 13717
                                -- Added the below conditions for R1.3 CR 738 Defect 2766
                                AND g_as_of_date  >= d_ext_attr1
                                AND (d_ext_attr2  IS NULL
                                     OR
                                     g_as_of_date <= d_ext_attr2))  xcaebv
                                -- End of changes for R1.3 CR 738 Defect 2766
                    WHERE 1 = 1
                      AND aci.cons_inv_id = acitl.cons_inv_id
                      AND aci.customer_id = xcaebv.cust_account_id
                      AND NOT EXISTS (
                               SELECT b.customer_trx_id
                                 FROM xx_ar_gen_bill_lines_all b
                                WHERE b.customer_trx_id =
                                                         acitl.customer_trx_id)
                      AND 'Y' =
                             (SELECT 'Y'
                                FROM ar_payment_schedules arps
                               WHERE 1 = 1
                                 AND arps.customer_trx_id =
                                                         acitl.customer_trx_id
                             --  AND arps.amount_due_original != 0  -- Commented for Defect# 631 (CR# 662)
                                 AND arps.amount_due_original NOT BETWEEN xx_ar_gen_ebill_pkg.ln_write_off_amt_low
                                         AND xx_ar_gen_ebill_pkg.ln_write_off_amt_high  -- Added for Defect# 631 (CR# 662)
                              )
/*
  AND NOT EXISTS
   (
     SELECT 1
     FROM   xx_ar_gen_bill_temp
     WHERE  1 =1
       AND  cons_billing_number LIKE '%'||aci.cons_billing_number||'%'
       AND  customer_id =aci.customer_id
       AND  billing_site_id =aci.site_use_id
   )
  AND NOT EXISTS
   (
     select 1
     from   xx_cdh_a_ext_billdocs_v b
     where  1 =1
       and b.cust_account_id        =xcaebv.cust_account_id
       and b.billdocs_doc_type      ='Consolidated Bill'
       and b.billdocs_delivery_meth ='ELEC'
       and b.billdocs_paydoc_ind    ='Y'
       and b.billdocs_payment_term  =xcaebv.billing_term
   )
*/
/*                      AND TO_NUMBER (TO_CHAR (g_as_of_date, 'DD')) =
                             TO_NUMBER
                                (TO_CHAR
                                    (xx_ar_inv_freq_pkg.compute_effective_date
                                                         (xcaebv.billing_term,
                                                          --g_as_of_date        --Commented for the defect 11993
                                                          TRUNC (aci.issue_date)--Added for the defect 11993
                                                         ),
                                     'DD'
                                    )
                                )*/   -- Commented for Defect # 869
/*
--------------------------------------------------------------------------------------------
--Commented to avoid Offcycle Bills and to handle newly added Infodoc for PAYDOC_IC Customer
--------------------------------------------------------------------------------------------
                      AND xx_ar_inv_freq_pkg.compute_effective_date
                                                        (xcaebv.billing_term,
                                                         TRUNC (aci.issue_date)
                                                        ) <= g_as_of_date
*/ --Commented on 16-NOV-09 for the defect #2858
-----------------------------------------------
--Start of Changes for the Defect #2858
-----------------------------------------------
                      AND xx_ar_inv_freq_pkg.compute_effective_date
                                                        (xcaebv.billing_term,
                                                         g_as_of_date
                                                        ) = g_as_of_date
-- Commented for R1.3 CR 738 Defect 2766 (Start of changes for R1.3 CR 738 Defect 2766)
/*                      AND  xx_ar_inv_freq_pkg.compute_effective_date
                                                        (xcaebv.billing_term
                                                         ,aci.issue_date
                                                        ) >= xcaebv.creation_date*/
-- Added below condition for R1.3 CR 738 Defect 2766
                      AND xx_ar_gen_ebill_pkg.xx_ar_infocopy_handling (aci.attribute2||aci.attribute4||aci.attribute10
                                                                      ||ACI.attribute15      -- Added for R1.4 CR# 586. In order to handle the ebill delivery methods.
                                                                      ,xcaebv.billing_term
                                                                      ,aci.issue_date
                                                                      ,xcaebv.effective_start_date
                                                                      ,g_as_of_date
                                                                      ) = 'Y'
-- End of changes for R1.3 CR 738 Defect 2766
-----------------------------------------------
--End of Changes for the Defect #2858
-----------------------------------------------
                   UNION ALL
                   SELECT /*+ LEADING(XCAEBV) USE_NL(XCAEBV , ACI) */ TO_CHAR (NULL) trx_number,  --Added hint for 1760
                          aci.site_use_id billing_site_id,
                          aci.term_id term_id, TO_NUMBER (NULL) cons_inv_id,
                          TO_CHAR (NULL) cbi_number,
                          aci.customer_trx_id customer_trx_id,
                          TO_CHAR (NULL) interface_header_attribute1,
                          TO_CHAR (NULL) LOCATION, TO_CHAR (NULL)
                                                                 phone_number,
                          aci.currency_code invoice_currency_code,
                          TO_CHAR (NULL) orig_system_reference,
                          TO_CHAR (NULL) site_use_code,
                          TO_CHAR (NULL) purchase_order_number,
                          TO_CHAR (NULL) bill_to_customer_number,
                          aci.cut_off_date cut_off_date,
                          aci.issue_date issue_date,
                          TO_CHAR (NULL) bus_name      --bill_to_customer_name
                                                 ,
                           ---   aci.due_date due_date,    --commented for defect 12243
                          --TO_DATE (NULL) due_date,     -- Added for defect 12243  --Commented for the defect 13650
                          NULL due_date,  --Added for the defect 13650
                          aci.term_name NAME,
                          TO_CHAR (NULL) interface_header_attribute2,
                          TO_CHAR (NULL) tax_registration_number,
                          TO_CHAR (NULL) primary_salesrep_name,
                          TO_CHAR (NULL) ship_to_customer_name,
                          TO_CHAR (NULL) ship_to_address1,
                          TO_CHAR (NULL) ship_to_address2,
                          TO_CHAR (NULL) ship_to_city,
                          TO_CHAR (NULL) ship_to_state,
                          TO_CHAR (NULL) ship_to_postal_code,
                          TO_CHAR (NULL) ship_to_country,
                          TO_CHAR (NULL) ship_to_contact
             --AIHV.ship_to_contact_first_name||AIHV.ship_to_contact_last_name
                                                        ,
                          TO_DATE (NULL) trx_date,
                          TO_CHAR (NULL) ship_to_location,
                          TO_CHAR (NULL) bill_to_name
                                                  --AIHV.bill_to_customer_name
                                                     ,
                          TO_CHAR (NULL) bill_to_location,
                          TO_CHAR (NULL) bill_to_address1,
                          TO_CHAR (NULL) bill_to_address2,
                          TO_CHAR (NULL) bill_to_city,
                          TO_CHAR (NULL) bill_to_state,
                          TO_CHAR (NULL) bill_to_postal_code,
                          TO_CHAR (NULL) bill_to_country,
                          TO_CHAR (NULL) default_bill_attn, aci.org_id org_id,
                          xcaebv.extension_id extension_id,
                          aci.customer_id customer_id,
                          TO_CHAR (NULL) ordsourcecd
                                                 --interface_header_attribute2
                                                    ,
                          RPAD (xcaebv.spl_handling, 4, ' ') specl_handlg_cd,
                          xcaebv.billing_term billing_term,
                          TO_DATE (NULL) invoice_date, NULL billing_id,
                          'INV_IC' billing_method,                                -- Added for R1.2 CR 466 Defect 1210
                          xcaebv.cust_doc_id cust_doc_id                                      -- Added for R1.2 CR 466 Defect 1210
                         ,xcaebv.creation_date     -- Added for the Defect# 4136.
                     FROM (SELECT rct.bill_to_customer_id customer_id,
                                  TO_DATE (NULL) due_date,
                                  --TRUNC (SYSDATE) issue_date   --Commented for the defect 11993
                                                        -- TRUNC(rct.trx_date)
                                  /*TRUNC(rct.trx_date)  trx_date,     --Added for the defect 11993
                                  */ --Commented for the defect #869
                                  TRUNC(rct.creation_date) creation_date,  --Added for the defect #869
                                  --TRUNC(g_as_of_date) issue_date,  --Commented for the defect 11993
                                  TRUNC(rct.trx_date) issue_date,    --Added for the defect 11993
                                  TO_CHAR (NULL) cons_billing_number,
                                  TO_NUMBER (NULL) cons_inv_id,
                                  hzcp.standard_terms term_id,
                                  SUBSTR (rt.description, 1, 15) term_name,
                                  rct.bill_to_site_use_id site_use_id,
                                  --TRUNC (SYSDATE - 1) cut_off_date,  --Commented for the defect 11993
                                  TRUNC(g_as_of_date)   cut_off_date,  --Added for the defect 11993
                                  rct.invoice_currency_code currency_code,
                                  rct.org_id org_id, rct.customer_trx_id
                             FROM ra_customer_trx rct,
                                  ra_cust_trx_types rctt,
                                  ra_batch_sources rbs,
                                  hz_customer_profiles hzcp,
                                  ra_terms_tl rt
                            WHERE rctt.cust_trx_type_id = rct.cust_trx_type_id
                              AND rbs.batch_source_id = rct.batch_source_id
                              AND hzcp.cust_account_id = rct.bill_to_customer_id
                              AND rct.bill_to_customer_id BETWEEN p_cust_id_from AND p_cust_id_to    -- Added for the Defect 1760
                              AND rt.term_id = hzcp.standard_terms
                              AND rt.language =USERENV('LANG')  -- added for 1760
                              AND hzcp.site_use_id = rct.bill_to_site_use_id
                              AND rct.complete_flag = 'Y'       -- Defect 8654
                              AND rbs.NAME NOT IN ('CONVERSION_OD')
                              AND rctt.TYPE IN
                                             ('INV', 'CM', 'DM', 'DEP', 'CB')
                              AND NOT EXISTS (
                                     SELECT 1
                                       FROM ar_cons_inv_trx_lines acit
                                      WHERE acit.customer_trx_id =
                                                           rct.customer_trx_id)
                              AND NOT EXISTS (
                                     SELECT b.customer_trx_id
                                       FROM xx_ar_gen_bill_lines_all b
                                      WHERE b.customer_trx_id =
                                                           rct.customer_trx_id)) aci,
                          /*(SELECT extension_id, cust_account_id,          --Commented as a part of the defect 13717
                                  billdocs_special_handling spl_handling,
                                  billdocs_payment_term billing_term
                             FROM xx_cdh_a_ext_billdocs_v
                            WHERE 1 = 1
                              AND billdocs_doc_type = 'Consolidated Bill'
                              AND billdocs_delivery_meth = 'ELEC'
                              AND NVL (billdocs_paydoc_ind, '?') != 'Y') xcaebv*/
                              (SELECT extension_id,
                                      cust_account_id,
                                      c_ext_attr4  spl_handling,
                                      c_ext_attr14 billing_term,
                                      TRUNC(creation_date) creation_date,                    -- Added for prod defect # 2858
                                      n_ext_attr2 cust_doc_id,          -- Added for R1.2 Defect 1210 CR 466
                                      d_ext_attr1 effective_start_date -- Added for R1.3 CR 738 Defect 2766
                               FROM xx_cdh_cust_acct_ext_b
                               WHERE c_ext_attr1= 'Consolidated Bill'
                                 AND c_ext_attr3 = 'ELEC'
                                 AND NVL(c_ext_attr2,'?') ! = 'Y'
                                 AND attr_group_id = p_attr_group_id            --Added as a part of the defect 13717
                                 -- Added the below conditions for R1.3 CR 738 Defect 2766
                                 AND g_as_of_date  >= d_ext_attr1
                                 AND (d_ext_attr2  IS NULL
                                      OR
                                      g_as_of_date <= d_ext_attr2))  xcaebv
                                 -- End of changes for R1.3 CR 738 Defect 2766
                    WHERE 1 = 1
                      AND aci.customer_id = xcaebv.cust_account_id
                      AND EXISTS (
                             SELECT 1
                               FROM xx_ar_invoice_freq_history b
                              WHERE 1 = 1
                                AND b.invoice_id = aci.customer_trx_id
                                AND xx_ar_inv_freq_pkg.compute_effective_date(xcaebv.billing_term
--                                                                             ,TRUNC(b.actual_print_date)    -- Commented for R1.3 CR 738 Defect 2766
                                                                              ,TRUNC(b.estimated_print_date)  -- Added for R1.3 CR 738 Defect 2766
--                                                                              ) >= xcaebv.creation_date --Added for the defect #2858
                                                                               ) >= xcaebv.effective_start_date   -- Added for R1.3 CR 738 Defect 2766
                                AND b.paydoc_flag = 'Y')
                      AND 'Y' =
                             (SELECT 'Y'
                                FROM ar_payment_schedules arps
                               WHERE 1 = 1
                                 AND arps.customer_trx_id =
                                                           aci.customer_trx_id
                             --  AND arps.amount_due_original != 0  -- Commented for Defect# 631 (CR# 662)
                                 AND arps.amount_due_original NOT BETWEEN xx_ar_gen_ebill_pkg.ln_write_off_amt_low
                                      AND xx_ar_gen_ebill_pkg.ln_write_off_amt_high  -- Added for Defect# 631 (CR# 662)
                               )
                     /* AND TO_NUMBER (TO_CHAR (g_as_of_date, 'DD')) =
                             TO_NUMBER
                                (TO_CHAR
                                    (xx_ar_inv_freq_pkg.compute_effective_date
                                                         (xcaebv.billing_term,
                                                          --g_as_of_date          --Commented for the defect 11993
                                                          TRUNC(aci.issue_date)   --Added for the defect 11993
                                                         ),
                                     'DD'
                                    )
                                )*/  --Commented for the defect #869
/*
-----------------------------------------------------------------------------------------
--Commented to avoid Offcycle Bills and to handle newly added Infodoc for INV_IC Customer
-----------------------------------------------------------------------------------------
                      AND xx_ar_inv_freq_pkg.compute_effective_date
                                                      (xcaebv.billing_term,
                                                       --TRUNC (aci.cut_off_date) Commented for the defect 11993
                                                       TRUNC(aci.trx_date) --Added for the defect 11993
                                                        -- Commented for the defect #869
                                                      TRUNC(aci.creation_date) --Added for the defect #869
                                                      ) <= g_as_of_date)
*/
-----------------------------------------------
--Start of Changes for the Defect #2858
-----------------------------------------------
                      AND xx_ar_inv_freq_pkg.compute_effective_date
                                                        (xcaebv.billing_term,
                                                         g_as_of_date
                                                        ) = g_as_of_date)
-----------------------------------------------
--End of Changes for the Defect #2858
-----------------------------------------------
         ORDER BY customer_id, billing_site_id, cons_inv_id, customer_trx_id;

/*
-- ===============================================
-- Deferred POST GO-LIVE...
-- ===============================================
UNION ALL
SELECT TO_CHAR(NULL)
      ,aci.site_use_id
      ,aci.term_id
      ,aci.cons_inv_id
      ,aci.cons_billing_number
      ,arps.customer_trx_id
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,aci.currency_code
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,aci.cut_off_date
      ,aci.issue_date
      ,TO_CHAR(NULL)
      ,aci.due_date
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_DATE(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,aci.org_id
      ,xcaebv.extension_id
      ,aci.customer_id
      ,TO_CHAR(NULL)
      ,RPAD(xcaebv.spl_handling ,4 ,' ')
      ,xcaebv.billing_term               billing_term
      ,to_date(null)                     invoice_date
FROM   (
         SELECT arci.customer_id
               ,TRUNC(arci.due_date) due_date
               ,TRUNC(arci.issue_date) issue_date
               ,arci.cons_billing_number
               ,arci.cons_inv_id
               ,arci.term_id
               ,arci.site_use_id
               ,TRUNC(arci.cut_off_date) cut_off_date
               ,arci.currency_code
               ,arci.org_id
         FROM   ar_cons_inv arci
         WHERE  NVL(arci.attribute4 ,'N') != 'Y'
       ) aci
      ,( SELECT extension_id
               ,cust_account_id
               ,billdocs_special_handling spl_handling
               ,billdocs_payment_term billing_term
         FROM  xx_cdh_a_ext_billdocs_v
         WHERE 1 =1
           AND billdocs_doc_type      ='Consolidated Bill'
           AND billdocs_delivery_meth ='ELEC'
           AND billdocs_paydoc_ind    ='Y'
       ) xcaebv
       ,ar_cons_inv_trx acit
       ,ar_payment_schedules arps
WHERE  1 =1
  AND  aci.customer_id       =xcaebv.cust_account_id
  AND  aci.cons_inv_id       = acit.cons_inv_id
  AND  acit.transaction_type ='ADJUSTMENT'
  AND  acit.adj_ps_id        =arps.payment_schedule_id
*/

      --+=================================================================
-- Cursor to fetch invoice related information.
--+=================================================================
      CURSOR lcu_invoices (p_trx_id IN NUMBER, p_tax_code IN VARCHAR2)
      IS
         SELECT aihv.trx_number, aihv.bill_to_site_use_id,
                aihv.ship_to_site_use_id, aihv.interface_header_attribute1,
                aihv.LOCATION, aihv.phone_number, aihv.orig_system_reference,
                aihv.site_use_code           --We are not using this any more.
                                  ,
                aihv.purchase_order_number, aihv.bill_to_customer_number,
                aihv.bus_name, aihv.term_name term_name,
                aihv.interface_header_attribute2,
                p_tax_code tax_registration_number,
                --aihv.primary_salesrep_name, aihv.ship_to_customer_name, -- Commented for ver 4.2 Defect Id: 45279 Updating sales person to null
                NULL primary_salesrep_name, aihv.ship_to_customer_name, -- Added for ver 4.2 Defect Id: 45279 Updting sales person to null
                aihv.ship_to_address1, aihv.ship_to_address2,
                aihv.ship_to_city, aihv.ship_to_state,
                aihv.ship_to_postal_code, aihv.ship_to_country,
                aihv.ship_to_contact, aihv.trx_date trx_date,
                aihv.ship_to_location, aihv.bill_to_name,
                aihv.bill_to_location, aihv.bill_to_address1,
                aihv.bill_to_address2, aihv.bill_to_city, aihv.bill_to_state,
                aihv.bill_to_postal_code, aihv.bill_to_province,
                aihv.bill_to_country,
                NVL (aihv.default_bill_attn,
                     'Attn: Accounts Payable'
                    ) bill_to_attn,
                aihv.ordsourcecd, aihv.ordcompletedate, aihv.orgordnbr,
                aihv.trx_class, aihv.invoice_source, aihv.invoice_source_id,
                aihv.order_header_id
           FROM xx_ar_ebill_trx_v aihv
          WHERE aihv.customer_trx_id = p_trx_id;

--+=================================================================
-- Cursor to get the ADDRID and ADDRALIASNAME for a BILL TO SITE ID
--+=================================================================
      CURSOR lcu_bill_siteuses (p_bill_to_site_use_id IN NUMBER)
      IS
         SELECT TO_CHAR (hzcsu.site_use_id) addrid,
                hzl.address_lines_phonetic xcust_name,
                hzcsu.LOCATION xmail_site_name
           FROM hz_locations hzl,
                hz_party_sites hzps,
                hz_cust_acct_sites hzcas,
                hz_cust_site_uses hzcsu
          WHERE 1 = 1
            AND hzcsu.site_use_id = p_bill_to_site_use_id
            AND hzcas.cust_acct_site_id = hzcsu.cust_acct_site_id
            AND hzps.party_site_id = hzcas.party_site_id
            AND hzl.location_id = hzps.location_id;

--+======================================================================
-- Cursor to get the AOPSSHIPTOSEQ and ADDRBUSNAME for a SHIP TO SITE ID
--+======================================================================
      CURSOR lcu_ship_siteuses (p_ship_to_site_use_id IN NUMBER)
      IS
         SELECT regexp_replace
                   (SUBSTR
                        (NVL (SUBSTR (hzcsu.orig_system_reference,
                                        INSTR (hzcsu.orig_system_reference,
                                               '-'
                                              )
                                      + 1,
                                        (  INSTR (hzcsu.orig_system_reference,
                                                  '-',
                                                  2,
                                                  2
                                                 )
                                         - INSTR (hzcsu.orig_system_reference,
                                                  '-',
                                                  2
                                                 )
                                        )
                                      - 1
                                     ),
                              hzcsu.orig_system_reference
                             ),
                         1,
                         9
                        ),
                    '^0*',
                    ''
                   ) aopsshiptoseq,
                hzl.address_lines_phonetic addrbusname,
                hzcsu.LOCATION xaddr_alias_name
           FROM hz_locations hzl,
                hz_party_sites hzps,
                hz_cust_acct_sites hzcas,
                hz_cust_site_uses hzcsu
          WHERE 1 = 1
            AND hzcsu.site_use_id = p_ship_to_site_use_id
            AND hzcas.cust_acct_site_id = hzcsu.cust_acct_site_id
            AND hzps.party_site_id = hzcas.party_site_id
            --and  hzl.location_id         =hzps.party_site_id   Defect 9966
            AND hzl.location_id = hzps.location_id;
                               -- Defect 9966 by Sarat Uppalapati on 21-AUG-08

      ln_item_master_org            NUMBER                             := NULL;

--+=================================================================
-- Cursor for getting all the lines other than the dummy items
--+=================================================================
      CURSOR lcu_line (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT ailv.interface_line_attribute10, xolaa.cust_item_number,
                UPPER
                   (SUBSTR
                       (xx_ar_gen_ebill_pkg.remove_special_char
                                                             (ailv.description),
                        1,
                        30
                       )
                   ) description,
                ailv.uom_code,
                --ailv.quantity_ordered,-- Commented for Defect # 2067
                -- ailv.quantity_invoiced  -- Commented for Defect # 2122
                DECODE(p_trx_class,'CM',ailv.quantity_credited
                                       ,ailv.quantity_ordered) ,     -- Added for the Defect # 2067
                DECODE(p_trx_class,'CM',ailv.quantity_credited
                                       ,ailv.quantity_invoiced) ,     -- Added for the Defect # 2122
                xolaa.backordered_qty, ailv.unit_selling_price,
                xolaa.sku_list_price, ailv.extended_amount,
                xolaa.vendor_product_code, xolaa.taxable_flag,
                ailv.interface_line_attribute6,
                SUBSTR (xolaa.contract_details,
                        1,
                        INSTR (xolaa.contract_details, '-') - 1
                       ),
                SUBSTR (xolaa.contract_details,
                        INSTR (xolaa.contract_details, '-') + 1,
                          INSTR (xolaa.contract_details, '-', -1)
                        - (INSTR (xolaa.contract_details, '-') + 1)
                       ),
                SUBSTR (xolaa.contract_details,
                        INSTR (xolaa.contract_details, '-', -1) + 1
                       ),
                msib.item_number, oeol.actual_shipment_date ordcompletedate
                                                                           --,oeol.user_item_description                    productcdentered -- Defect 9142
                ,
                ailv.translated_description productcdentered    -- Defect 9142
                                                            ,
                --TO_CHAR (TO_NUMBER (oeol.customer_line_number)) custpolinenbr, --Commented for Defect 10000
                NVL(TO_CHAR(TO_NUMBER(oeol.customer_line_number)),DECODE(SUBSTR(oeol.orig_sys_line_ref,1,1),'0',LTRIM(oeol.orig_sys_line_ref,'0'),SUBSTR(oeol.orig_sys_line_ref,1,9))) custpolinenbr, --Added for Defect 10000
                xolaa.wholesaler_item wholesaleprodcd,
                xolaa.line_comments xxom_line_comments,
				TRIM(ailv.attribute3) bill_level, -- Added for Kitting, Defect# 37670
				DECODE (TRIM(ailv.attribute3) ,'D', TRIM(ailv.attribute4) , NULL) kit_item -- Added for Kitting, Defect# 37670
           FROM ra_customer_trx_lines ailv,
                xx_om_line_attributes_all xolaa,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = p_item_org) msib,
                oe_order_lines oeol                              --Defect 5615
          WHERE 1 = 1
            AND ((    p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
                  AND ailv.customer_trx_id = p_trx_id
                  AND ailv.line_type != 'TAX'
                  AND TO_NUMBER (ailv.interface_line_attribute6) =
                                                                  oeol.line_id
                  AND ailv.interface_line_attribute11 = 0
                  AND ailv.interface_line_attribute6 = xolaa.line_id(+)
                  AND ailv.inventory_item_id = msib.inv_item_id(+)
                  /*AND ailv.inventory_item_id NOT IN (
                         SELECT TO_NUMBER (attribute6)
                           FROM fnd_lookup_values
                          WHERE lookup_type = 'OD_FEES_ITEMS'
                            AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                            AND LANGUAGE = USERENV ('LANG'))*/ --Commented for the defect #2067
                  AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
				  AND DECODE(ailv.attribute3,'K',DECODE(ailv.attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
                 )
                )
         UNION ALL
         SELECT ailv.interface_line_attribute10, TO_CHAR (NULL),
                UPPER
                   (SUBSTR
                       (xx_ar_gen_ebill_pkg.remove_special_char
                                                             (ailv.description),
                        1,
                        30
                       )
                   ) description,
                ailv.uom_code, ailv.quantity_ordered, ailv.quantity_invoiced,
                TO_NUMBER (NULL), ailv.unit_selling_price, TO_NUMBER (NULL),
                ailv.extended_amount, TO_CHAR (NULL), TO_CHAR (NULL),
                ailv.interface_line_attribute6, TO_CHAR (NULL),
                TO_CHAR (NULL), TO_CHAR (NULL), msib.item_number,
                TO_DATE (NULL) ordcompletedate
                                              --,oeol.user_item_description                    productcdentered -- Defect 9142
                ,
                ailv.translated_description productcdentered    -- Defect 9142
                                                            ,
                TO_CHAR (NULL) custpolinenbr, TO_CHAR (NULL) wholesaleprodcd,
                TO_CHAR (NULL) xxom_line_comments,
				TRIM(ailv.attribute3) bill_level, -- Added for Kitting, Defect# 37670
				DECODE (TRIM(ailv.attribute3) ,'D', TRIM(ailv.attribute4) , NULL) kit_item -- Added for Kitting, Defect# 37670
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = p_item_org) msib
          WHERE 1 = 1
            AND (    p_invoice_source NOT IN
                        ('SALES_ACCT_US',
                         'SALES_ACCT_CA',
                         'MANUAL_CA',
                         'MANUAL_US',
                         'SERVICE'
                        )
                 AND ailv.customer_trx_id = p_trx_id
                 AND ailv.line_type != 'TAX'
                 AND ailv.inventory_item_id = msib.inv_item_id(+)
                /* AND ailv.inventory_item_id NOT IN (
                        SELECT TO_NUMBER (attribute6)
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND LANGUAGE = USERENV ('LANG'))*/ --Commented for the defect #2067
                 AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
				 AND DECODE(ailv.attribute3,'K',DECODE(ailv.attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
                )
         UNION ALL
         SELECT ailv.interface_line_attribute10, TO_CHAR (NULL),
                UPPER
                   (SUBSTR
                       (xx_ar_gen_ebill_pkg.remove_special_char
                                                             (ailv.description),
                        1,
                        30
                       )
                   ) description,
                ailv.uom_code, ailv.quantity_ordered, ailv.quantity_invoiced,
                TO_NUMBER (NULL), ailv.unit_selling_price, TO_NUMBER (NULL),
                ailv.extended_amount, TO_CHAR (NULL), TO_CHAR (NULL),
                ailv.interface_line_attribute6, TO_CHAR (NULL),
                TO_CHAR (NULL), TO_CHAR (NULL), msib.item_number,
                TO_DATE (NULL) ordcompletedate,
                TO_CHAR (NULL) productcdentered, TO_CHAR (NULL) custpolinenbr,
                TO_CHAR (NULL) wholesaleprodcd,
                TO_CHAR (NULL) xxom_line_comments,
				TRIM(ailv.attribute3) bill_level, -- Added for Kitting, Defect# 37670
				DECODE (TRIM(ailv.attribute3) ,'D', TRIM(ailv.attribute4) , NULL) kit_item -- Added for Kitting, Defect# 37670
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = p_item_org) msib
          WHERE 1 = 1
            AND (    p_invoice_source IN
                                        ('MANUAL_US', 'MANUAL_CA', 'SERVICE')
                 AND (p_trx_class != 'CM')
                )
--  AND ((:p_trx_class !='CM') AND :p_invoice_source IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE'))
            AND ailv.line_type != 'TAX'
            AND ailv.customer_trx_id = p_trx_id
            AND ailv.inventory_item_id = msib.inv_item_id(+)
            /*AND ailv.inventory_item_id NOT IN (
                   SELECT TO_NUMBER (attribute6)
                     FROM fnd_lookup_values
                    WHERE lookup_type = 'OD_FEES_ITEMS'
                      AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                      AND LANGUAGE = USERENV ('LANG'))*/ --Commented for the defect #2067
            AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
			AND DECODE(ailv.attribute3,'K',DECODE(ailv.attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670

         UNION ALL
         SELECT TO_CHAR (NULL), TO_CHAR (NULL), 'MISC CREDIT MEMO',
                TO_CHAR (NULL), 1, 1, TO_NUMBER (NULL),
                misc_cm.cm_amount                           --unitsellingprice
                                 ,
                TO_NUMBER (NULL), misc_cm.cm_amount          --extended_amount
                                                   ,
                TO_CHAR (NULL), TO_CHAR (NULL), TO_CHAR (NULL),
                TO_CHAR (NULL), TO_CHAR (NULL), TO_CHAR (NULL),
                TO_CHAR (NULL), TO_DATE (NULL) ordcompletedate,
                TO_CHAR (NULL) productcdentered, TO_CHAR (NULL) custpolinenbr,
                TO_CHAR (NULL) wholesaleprodcd,
                TO_CHAR (NULL) xxom_line_comments,
				TO_CHAR (NULL) bill_level,  -- Added for Kitting, Defect# 37670
				TO_CHAR (NULL) kit_item  -- Added for Kitting, Defect# 37670
           FROM (
                 -- SELECT sum(extended_amount) cm_amount ,customer_trx_id
                 SELECT   SUM (NVL (extended_amount, 0)) cm_amount,
                          customer_trx_id
                     FROM ra_customer_trx_lines
                    WHERE customer_trx_id = p_trx_id AND line_type != 'TAX'
					  AND DECODE(attribute3,'K',DECODE(attribute5,'Y','1','2'),'1') = '1' -- Added for Kitting, Defect# 37670
                 GROUP BY customer_trx_id) misc_cm
          WHERE 1 = 1
            AND (    p_invoice_source IN
                                        ('MANUAL_US', 'MANUAL_CA', 'SERVICE')
                 AND (p_trx_class = 'CM')
                );
--+===================================================================================
-- Defect#12673- Add bulk discount line to the EBL file
-- Cursor to sum all the bulk discount lines into one line under eBill rec type MS
--+===================================================================================
    CURSOR lc_bulk_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'BULK DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ractl.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'BULK DISCOUNT' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'BULK DISCOUNT' wholesaleprodcd
             FROM ra_customer_trx_lines ractl,
                  ra_customer_trx ract,
                  oe_price_adjustments oepa
            WHERE 1 = 1
              AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              AND ractl.line_type != 'TAX'
              AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
              AND oepa.attribute8 = '21'
         GROUP BY ractl.customer_trx_id;

--+===================================================================================
-- Cursor to sum all the tiered discount lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_tiered_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'TIERED DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ractl.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'TIERED DISCOUNT' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'TIERED DISCOUNT' wholesaleprodcd
             FROM ra_customer_trx_lines ractl,
                  ra_customer_trx ract,
                  oe_price_adjustments oepa
            WHERE 1 = 1
              AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              AND ractl.line_type != 'TAX'
              AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
              AND oepa.attribute8 = 'TD'
         /*
           AND  (p_trx_class !='CM'
                 OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                    )
              )
         */
         GROUP BY ractl.customer_trx_id;
         --==== Start of changes for the defect 12435====--
/*
         UNION
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'TIERED DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ract.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  TO_CHAR (NULL) productcdentered,
                  TO_CHAR (NULL) custpolinenbr, TO_CHAR (NULL)
                                                              wholesaleprodcd
             FROM ra_customer_trx_lines ractl, ra_customer_trx ract
            WHERE 1 = 1
              AND p_invoice_source NOT IN
                     ('SALES_ACCT_US',
                      'SALES_ACCT_CA',
                      'MANUAL_CA',
                      'MANUAL_US',
                      'SERVICE'
                     )
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              --AND  NVL(ractl.interface_line_context, '?') != 'ORDER ENTRY'
              AND ractl.description = 'Tiered Discount'
         /*
          AND  (p_trx_class !='CM'
                    OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('SALES_ACCT_US' ,'SALES_ACCT_CA' ,'MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                       )
                 )
         GROUP BY ract.customer_trx_id;
         */
         --==== End of changes for the defect 12435====--
/*
SELECT  TO_CHAR(NULL)                      interface_line_attribute10
       ,TO_CHAR(NULL)                      cust_item_number
       ,UPPER('Tiered Discount')           description
       ,TO_CHAR(NULL)                      uom_code
       ,TO_NUMBER(NULL)                    quantity_ordered
       ,TO_NUMBER(NULL)                    quantity_invoiced
       ,TO_NUMBER(NULL)                    backordered_qty
       ,TO_NUMBER(NULL)                    unit_selling_price
       ,TO_NUMBER(NULL)                    sku_list_price
       ,SUM(consinv_lines.extended_amount) extended_amount
       ,TO_CHAR(NULL)                      vendor_product_code
       ,TO_CHAR(NULL)                      taxable_flag
       ,TO_CHAR(NULL)                      interface_line_attribute6
       ,consinv_lines.customer_trx_id      customer_trx_id
       ,TO_CHAR(NULL)                      item_number
       ,TO_DATE(NULL)                      ordcompletedate
       ,UPPER('Tiered Discount')           productcdentered
       ,TO_CHAR(NULL)                      custpolinenbr
       ,UPPER('Tiered Discount')           wholesaleprodcd
FROM   ar_cons_inv_trx_lines consinv_lines
        ,ar_cons_inv arcit
        ,ra_customer_trx_lines ractl
        ,ra_customer_trx       ract
        ,oe_price_adjustments  oepa
WHERE  arcit.cons_inv_id = consinv_lines.cons_inv_id
    AND  consinv_lines.customer_trx_id = p_trx_id
    AND  consinv_lines.customer_trx_line_id = ractl.customer_trx_line_id
    AND  consinv_lines.customer_trx_id      = ractl.customer_trx_id
    AND  ractl.customer_trx_id              = ract.customer_trx_id
    AND  ractl.interface_line_attribute11   = oepa.price_adjustment_id
    AND  oepa.attribute8 = 'TD'
    AND  (p_trx_class !='CM'
            OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
               )
         )
GROUP BY consinv_lines.customer_trx_id
UNION
SELECT  TO_CHAR(NULL)                      interface_line_attribute10
       ,TO_CHAR(NULL)                      cust_item_number
       ,UPPER('Tiered Discount')           description
       ,TO_CHAR(NULL)                      uom_code
       ,TO_NUMBER(NULL)                    quantity_ordered
       ,TO_NUMBER(NULL)                    quantity_invoiced
       ,TO_NUMBER(NULL)                    backordered_qty
       ,TO_NUMBER(NULL)                    unit_selling_price
       ,TO_NUMBER(NULL)                    sku_list_price
       ,SUM(consinv_lines.extended_amount) extended_amount
       ,TO_CHAR(NULL)                      vendor_product_code
       ,TO_CHAR(NULL)                      taxable_flag
       ,TO_CHAR(NULL)                      interface_line_attribute6
       ,consinv_lines.customer_trx_id      customer_trx_id
       ,TO_CHAR(NULL)                      item_number
       ,TO_DATE(NULL)                      ordcompletedate
       ,TO_CHAR(NULL)                      productcdentered
       ,TO_CHAR(NULL)                      custpolinenbr
       ,TO_CHAR(NULL)                      wholesaleprodcd
  FROM   ar_cons_inv_trx_lines consinv_lines
        ,ar_cons_inv arcit
        ,ra_customer_trx_lines ractl
        ,ra_customer_trx       ract
  WHERE  arcit.cons_inv_id = consinv_lines.cons_inv_id
    AND  consinv_lines.customer_trx_id = p_trx_id
    AND  consinv_lines.customer_trx_line_id = ractl.customer_trx_line_id
    AND  consinv_lines.customer_trx_id      = ractl.customer_trx_id
    AND  ractl.customer_trx_id              = ract.customer_trx_id
    AND  NVL(ractl.interface_line_context, '?') != 'ORDER ENTRY'
    AND  ractl.description = 'Tiered Discount'
    AND  (p_trx_class !='CM'
            OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
               )
         )
GROUP BY consinv_lines.customer_trx_id;
*/
--+===================================================================================
-- Cursor to sum all the Association discount lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_association_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'ASSOCIATION DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ract.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'ASSOCIATION DISCOUNT' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'ASSOCIATION DISCOUNT' wholesaleprodcd
             FROM ra_customer_trx_lines ractl,
                  ra_customer_trx ract,
                  oe_price_adjustments oepa
            WHERE 1 = 1
              AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              AND ractl.line_type != 'TAX'
              AND TO_NUMBER (ractl.interface_line_attribute11) =
                                                      oepa.price_adjustment_id
              AND oepa.attribute8 = 'AD'
         /*
           AND  (p_trx_class !='CM'
                   OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                      )
                )
         */
         GROUP BY ract.customer_trx_id;
         --==== Start of changes for the defect 12435====--
/*
         UNION
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'ASSOCIATION DISCOUNT' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  SUM (ractl.extended_amount) extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  ract.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  TO_CHAR (NULL) productcdentered,
                  TO_CHAR (NULL) custpolinenbr, TO_CHAR (NULL)
                                                              wholesaleprodcd
             FROM ra_customer_trx_lines ractl, ra_customer_trx ract
            WHERE 1 = 1
              AND p_invoice_source NOT IN
                     ('SALES_ACCT_US',
                      'SALES_ACCT_CA',
                      'MANUAL_CA',
                      'MANUAL_US',
                      'SERVICE'
                     )
              AND ract.customer_trx_id = p_trx_id
              AND ractl.customer_trx_id = ract.customer_trx_id
              --AND  NVL(ractl.interface_line_context, '?') !='ORDER ENTRY'
              AND ractl.description = 'Association Discount'
         /*
          AND  (p_trx_class !='CM'
                    OR (p_trx_class ='CM' AND p_invoice_source NOT IN ('SALES_ACCT_US' ,'SALES_ACCT_CA' ,'MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
                       )
                 )
         GROUP BY ract.customer_trx_id;
*/
         --==== End of changes for the defect 12435====--
--+===================================================================================
-- Cursor to sum all the GSA COMMENT lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_gsa_comment (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT TO_CHAR (NULL) interface_line_attribute10,
                TO_CHAR (NULL) cust_item_number, 'GSA COMMENT' description,
                TO_CHAR (NULL) uom_code, TO_NUMBER (NULL) quantity_ordered,
                TO_NUMBER (NULL) quantity_invoiced,
                TO_NUMBER (NULL) backordered_qty,
                TO_NUMBER (NULL) unit_selling_price,
                TO_NUMBER (NULL) sku_list_price,
                TO_NUMBER (NULL) extended_amount,
                TO_CHAR (NULL) vendor_product_code,
                TO_CHAR (NULL) taxable_flag,
                TO_CHAR (NULL) interface_line_attribute6,
                TO_NUMBER (NULL) customer_trx_id, TO_CHAR (NULL) item_number,
                TO_DATE (NULL) ordcompletedate,
                'GSA COMMENT' productcdentered, TO_CHAR (NULL) custpolinenbr,
                'GSA COMMENT' wholesaleprodcd
           FROM ra_customer_trx_lines ractl
          WHERE 1 = 1
            AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
            AND ractl.customer_trx_id = p_trx_id
            AND ractl.interface_line_context = 'ORDER ENTRY'
            AND ractl.line_type != 'TAX'
            AND EXISTS (
                   SELECT 1
                     FROM xx_om_line_attributes_all
                    WHERE line_id =
                                   TO_NUMBER (ractl.interface_line_attribute6)
                      AND gsa_flag IN (1, 2));

--+============================================================================
-- Cursor to fetch the lines with Miscellaneous or Delivery charges.
--+============================================================================
      CURSOR lcu_charges_lines (
         p_trx_id           IN   NUMBER,
         p_charge_type      IN   VARCHAR2,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT ailv.interface_line_attribute10, xolaa.cust_item_number
                                                                       --,UPPER(substr(xx_ar_gen_ebill_pkg.remove_special_char(AILV.description) ,1 ,30)) description
                ,
                UPPER ('MISCELLANEOUS') description, ailv.uom_code,
                ailv.quantity_ordered,
                NVL (ailv.quantity_invoiced,
                     ailv.quantity_credited
                    ) quantity_invoiced,
                xolaa.backordered_qty, ailv.unit_selling_price,
                xolaa.sku_list_price, ailv.extended_amount,
                xolaa.vendor_product_code, xolaa.taxable_flag,
                ailv.interface_line_attribute6, ailv.customer_trx_id,
                msib.item_number,
                TRUNC (oeol.actual_shipment_date) ordcompletedate
                                                                 --,oeol.user_item_description                    productcdentered
                ,
                UPPER ('MISCELLANEOUS') productcdentered,
                NULL    custpolinenbr --Added for the defect 13488
               -- TO_CHAR (TO_NUMBER (oeol.customer_line_number)) custpolinenbr  --Commented for Defect 10000
               --NVL(TO_CHAR(TO_NUMBER(oeol.customer_line_number)),DECODE(SUBSTR(oeol.orig_sys_line_ref,1,1),'0',LTRIM(oeol.orig_sys_line_ref,'0'),SUBSTR(oeol.orig_sys_line_ref,1,9))) custpolinenbr -- Added for Defect 10000  --Commented for the defect 13488
                 --,xolaa.wholesaler_item                         wholesaleprodcd
                , UPPER ('MISCELLANEOUS') wholesaleprodcd
           FROM ra_customer_trx_lines ailv,
                xx_om_line_attributes_all xolaa,
                oe_order_lines oeol                              --Defect 5615
                                   ,
                (SELECT DISTINCT TO_NUMBER (attribute6) odf_item_id
                            FROM fnd_lookup_values
                           WHERE lookup_type = 'OD_FEES_ITEMS'
                             AND attribute7 =
                                    p_charge_type
                                              --'MISCELLANEOUS'  OR 'DELIVERY'
                             AND LANGUAGE = USERENV ('LANG')) od_fees_item,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = p_item_org) msib
          WHERE 1 = 1
            AND p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
            AND ailv.customer_trx_id = p_trx_id
            AND ailv.line_type != 'TAX'
            AND TO_NUMBER (ailv.interface_line_attribute6) = xolaa.line_id(+)
            AND TO_NUMBER (ailv.interface_line_attribute6) = oeol.line_id
            AND ailv.inventory_item_id = od_fees_item.odf_item_id
            AND msib.inv_item_id = ailv.inventory_item_id;

--+=============================================================
-- Cursor for getting the count of the lines for a transaction
--+=============================================================
      CURSOR lcu_count_lines (
         p_trx_id           IN   NUMBER,
         p_invoice_source   IN   VARCHAR2,
         p_trx_class        IN   VARCHAR2
      )
      IS
         SELECT COUNT (ailv.customer_trx_line_id)
           FROM ra_customer_trx_lines ailv,
                (SELECT mtlsi.inventory_item_id inv_item_id,
                        mtlsi.segment1 item_number
                   FROM mtl_system_items mtlsi
                  WHERE 1 = 1 AND mtlsi.organization_id = p_item_org) msib
          WHERE 1 = 1
            AND ailv.line_type = 'LINE'
            AND ailv.interface_line_attribute11 = 0
            AND ailv.customer_trx_id = p_trx_id
            AND ailv.inventory_item_id = msib.inv_item_id(+)
           /* AND ailv.inventory_item_id NOT IN (
                   SELECT TO_NUMBER (attribute6)
                     FROM fnd_lookup_values
                    WHERE lookup_type = 'OD_FEES_ITEMS'
                      AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                      AND LANGUAGE = USERENV ('LANG'))*/--Commented for the defect #2067
           AND NOT EXISTS(
                        SELECT 1
                          FROM fnd_lookup_values
                         WHERE lookup_type = 'OD_FEES_ITEMS'
                           AND attribute7 IN ('MISCELLANEOUS', 'DELIVERY')
                           AND TO_NUMBER(attribute6)= ailv.inventory_item_id
                           AND LANGUAGE = USERENV ('LANG')) -- Added for the defect #2067
            AND (   p_trx_class != 'CM'
                 OR (    p_trx_class = 'CM'
                     AND p_invoice_source NOT IN
                                        ('MANUAL_CA', 'MANUAL_US', 'SERVICE')
                    )
                );

--+============================================================
-- Cursor for getting the previous billing date for a customer
--+============================================================
      CURSOR lcu_get_issue_date (
         p_customer_id   IN   NUMBER,
         p_site_id       IN   NUMBER,
         p_cons_inv_id   IN   NUMBER
      )
      IS
--Defect 9035 changed this query as cons_inv_id does not appear to be truly sequential
--by Sarat Uppalapati on 29-JUL-08
         SELECT MAX (cut_off_date)
           FROM xx_ar_gen_bill_temp
          WHERE customer_id = p_customer_id
            AND billing_site_id = p_site_id
            AND cons_inv_id != p_cons_inv_id;

/*
union
SELECT TO_DATE
     (   TO_CHAR(term.due_cutoff_day)
       ||'-'
       ||TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE), -termlines.DUE_MONTHS_FORWARD) ,'MON-RRRR')
      ,'DD-MON-RRRR'
     )
FROM ra_terms term
    ,ra_terms_lines termlines
WHERE term.term_id =p_term_id
  AND termlines.term_id =term.term_id
  AND 0 =
      ( SELECT COUNT(DISTINCT issue_date)
        FROM xx_ar_gen_bill_temp
        WHERE cons_inv_id = (
                      SELECT MAX(cons_inv_id)
                      FROM xx_ar_gen_bill_temp
                      WHERE customer_id     =p_customer_id
                        AND billing_site_id =p_site_id)
      );
*/
--+======================================
-- Cursor to fetch the US tax details
--+======================================
      CURSOR lcu_get_tax_details_us (p_trx_id IN NUMBER)
      IS
         SELECT SUM (aitsv.extended_amount) tax_amount, 'SALES TAX' tax_code,
--                (SUM (NVL (aitsv.tax_rate, 0)) / 100) tax_rate  --Commented for error character string buffer too small
                (SUM (NVL (SUBSTR(aitsv.tax_rate,1,8), 0)) / 100) tax_rate  --added substr for the above error
           FROM ra_customer_trx_lines aitsv
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND line_type = 'TAX'
            AND aitsv.extended_amount <> 0;         --Added for Defect # 11741

--+================================================================
-- Cursor to fetch the CANADIAN tax details at the invoice level
-- The field values are copied for both the PST/QST and GST lines.
--+================================================================
      CURSOR lcu_tax_ca (p_trx_id IN NUMBER)
      IS
         SELECT SUM (NVL (aitsv.extended_amount, 0)) xtotal_tax_amt,
                SUM
                   (CASE
                       --WHEN vat.tax = 'COUNTY'  	--commented for r12 retrofit
                       WHEN vat.tax in('COUNTY','COUNTY-SALES_TAX')
                          THEN NVL (aitsv.extended_amount, 0)
                       ELSE 0
                    END
                   ) xtotal_tax_pst_qst,
                SUM
                   (CASE
                       --WHEN vat.tax = 'STATE' 	--commented for r12 retrofit
                       WHEN vat.tax in('STATE','STATE-SALES_TAX')
                          THEN NVL (aitsv.extended_amount, 0)
                       ELSE 0
                    END
                   ) xtotal_tax_gst
           FROM ra_customer_trx_lines aitsv, zx_rates_b vat --ar_vat_tax_vl vat
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND aitsv.line_type = 'TAX'
            AND vat.tax_rate_id(+) = aitsv.vat_tax_id;

--+==================================================================================
-- Cursor to fetch the CANADIAN tax details at the invoice level by PST/QST and GST.
-- PST/QST and GST will be on two different TX tax records.
--+==================================================================================
      CURSOR lcu_get_tax_details_ca (
         p_trx_id             IN   NUMBER,
         p_billing_province   IN   VARCHAR2
      )
      IS
         SELECT SUM (NVL (aitsv.extended_amount, 0)) tax_amount,
                DECODE (p_billing_province, 'QC', 'QST', 'PST') tax_code,
                (SUM (NVL (vat.percentage_rate, 0))) tax_rate
           FROM ra_customer_trx_lines aitsv, zx_rates_b vat --  ar_vat_tax_vl vat
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND aitsv.line_type = 'TAX'
            AND vat.tax_rate_id(+) = aitsv.vat_tax_id
            --AND vat.tax = 'COUNTY'  			--commented for r12 retrofit
            AND vat.tax in('COUNTY','COUNTY-SALES_TAX')
            AND aitsv.extended_amount <> 0          --Added for Defect # 11741
         UNION ALL
         SELECT SUM (NVL (aitsv.extended_amount, 0)) tax_amount,
                'GST' tax_code, (SUM (NVL (vat.percentage_rate, 0))) tax_rate
           FROM ra_customer_trx_lines aitsv, zx_rates_b vat --ar_vat_tax_vl vat
          WHERE 1 = 1
            AND aitsv.customer_trx_id = p_trx_id
            AND aitsv.line_type = 'TAX'
            AND vat.tax_rate_id(+) = aitsv.vat_tax_id
            --AND vat.tax = 'STATE'  			--commented for r12 retrofit
            AND vat.tax in('STATE','STATE-SALES_TAX')
            AND aitsv.extended_amount <> 0;         --Added for Defect # 11741

--+========================================================
-- Cursor for getting the header level order details
--+========================================================
      CURSOR lcu_get_shipping_ins (
         p_header_id    IN   NUMBER,
         p_inv_source   IN   VARCHAR2
      )
      IS
         SELECT DECODE (p_inv_source,
                        'SALES_ACCT_US', SUBSTR (ooh.orig_sys_document_ref,
                                                 -3,
                                                 3
                                                ),
                        'SALES_ACCT_CA', SUBSTR (ooh.orig_sys_document_ref,
                                                 -3,
                                                 3
                                                ),
                        ''
                       ) subordernum,
                ooh.shipping_instructions, ooh.header_id,
                TRUNC (ooh.ordered_date) ordered_date,
                lkup.lookup_code ordsourcecd, oeos.NAME spc_order
           FROM oe_order_headers ooh,
                fnd_lookup_values lkup,
                oe_order_sources oeos
          WHERE 1 = 1
            AND ooh.header_id = p_header_id
            AND oeos.order_source_id = ooh.order_source_id
            AND lkup.lookup_type = 'OD_ORDER_SOURCE'
            AND lkup.attribute6 = TO_CHAR (ooh.order_source_id)
            AND lkup.enabled_flag = 'Y'
            AND lkup.start_date_active <= TRUNC (SYSDATE)
            AND NVL (lkup.end_date_active, TRUNC (SYSDATE)) >= TRUNC (SYSDATE)
            AND ROWNUM < 2;

--+========================================================
-- Cursor for getting the custom header level OM details
--+========================================================
      CURSOR lcu_get_om_details (p_header_id IN NUMBER
                                ,p_customer_id IN NUMBER      -- added for defect 8927
                                )
      IS
         SELECT xohaa.release_number, xohaa.cost_center_dept,
                xohaa.desk_del_addr, xohaa.placement_method_code,
                xohaa.created_by_id ordcreateid,
                xohaa.od_order_type custtypecd,
                xohaa.cust_contact_name aops_cust_contact,
                xohaa.cust_pref_phone aops_cust_phone,
                xohaa.cust_pref_phextn aops_cust_phone_ext,
                RPAD (NVL (SUBSTR (xohaa.spc_card_number, 1, 12), ' '),
                      12,
                      ' '
                     ) spc_card_num,
                SUBSTR (ooh.orig_sys_document_ref, 1, 4) spc_location_num,
                SUBSTR (ooh.orig_sys_document_ref, 5, 8) spc_trans_date,
                RPAD
                   (NVL (SUBSTR (ooh.orig_sys_document_ref, 13, 3), ' '),
                    5,
                    ' '
                   ) spc_register_num,
                RPAD (NVL (SUBSTR (ooh.orig_sys_document_ref, 16, 5), ' '),
                      5,
                      ' '
                     ) spc_trans_num,
                xohaa.tax_rate xxom_hdr_tax_rate,
                nvl(XCDH.cost_center_description,xohaa.cost_center_dept) cost_center_desc  -- added for defect 8927
           FROM xx_om_header_attributes_all xohaa
               ,oe_order_headers ooh
               ,XX_CDH_5TH_SOFT_HEADER_V XCDH    -- added for defect 8927
          WHERE
          1 = 1
          AND ooh.header_id = p_header_id
          AND xohaa.header_id(+) = ooh.header_id
          AND XCDH.cust_Account_id(+) = p_customer_id               -- added for defect 8927
          AND XCDH.cost_center_code (+)= xohaa.cost_center_dept     -- added for defect 8927
          AND rownum<2;

--+==================================================
-- Cursor for getting the discount and coupon amounts
--+==================================================
-- Commeneted for the Prod Defect # 2025
/*      CURSOR lcu_get_dis_amt (p_header_id IN NUMBER)
      IS
         SELECT SUM (NVL (opa.adjusted_amount, 0))
           FROM oe_price_adjustments opa, oe_order_headers ooh
          WHERE 1 = 1
            AND ooh.header_id = p_header_id
            AND opa.header_id = ooh.header_id;*/  -- Commented for the Prod Defect # 2025

--+==================================================
-- Cursor for getting the line level order details
--+==================================================
      CURSOR lcu_get_ship_date_item (p_line_id IN NUMBER)
      IS
         SELECT ool.schedule_ship_date, ool.ordered_item
           FROM oe_order_lines ool
          WHERE ool.line_id = p_line_id
         UNION
         SELECT TO_DATE (NULL), TO_CHAR (NULL)
           FROM DUAL
          WHERE 0 = (SELECT COUNT (1)
                       FROM oe_order_lines ool
                      WHERE ool.line_id = p_line_id);

-- Start of Changes for R1.1 Defect # 1451 (CR 626)
--+================================================================================
-- Cursor to sum all the gift card lines into one line under eBill rec type MS
--+================================================================================
      CURSOR lc_gc_discount (
         p_trx_id           IN   NUMBER,
         p_trx_class        IN   VARCHAR2,
         p_invoice_source   IN   VARCHAR2
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'GIFT CARD' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  'GIFT CARD' vendor_product_code,
                  xx_ar_gen_ebill_pkg.get_total_gc_chrg(p_trx_id) extended_amount,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  RCT.customer_trx_id customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'GIFT CARD' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'GIFT CARD' wholesaleprodcd,
                  'GIFT CARD' custprodcd
         FROM     ra_customer_trx_all RCT
         WHERE    p_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
         AND      RCT.customer_trx_id = p_trx_id;
-- End of Changes for R1.1 Defect # 1451 (CR 626)

-- Start of Changes for Prod Defect # 2025
--+===================================================================================
-- Cursor to sum all the coupon discount lines into one line under eBill rec type MS
--+===================================================================================
      CURSOR lc_coupon_discount (
         p_trx_id           IN   NUMBER,
         p_amount           IN   NUMBER
      )
      IS
         SELECT   TO_CHAR (NULL) interface_line_attribute10,
                  TO_CHAR (NULL) cust_item_number,
                  'COUPON' description, TO_CHAR (NULL) uom_code,
                  TO_NUMBER (NULL) quantity_ordered,
                  TO_NUMBER (NULL) quantity_invoiced,
                  TO_NUMBER (NULL) backordered_qty,
                  TO_NUMBER (NULL) unit_selling_price,
                  TO_NUMBER (NULL) sku_list_price,
                  p_amount extended_amount,
                  TO_CHAR (NULL) vendor_product_code,
                  TO_CHAR (NULL) taxable_flag,
                  TO_CHAR (NULL) interface_line_attribute6,
                  p_trx_id        customer_trx_id,
                  TO_CHAR (NULL) item_number, TO_DATE (NULL) ordcompletedate,
                  'COUPON' productcdentered,
                  TO_CHAR (NULL) custpolinenbr,
                  'COUPON' wholesaleprodcd,
                  'COUPON' custprodcd
             FROM DUAL
            WHERE 1 = 1;
-- End of Changes for Prod Defect # 2025

      lc_file_handle                UTL_FILE.file_type;
      TYPE idheader IS TABLE OF header_rec_type;

      TYPE idline IS TABLE OF line_rec_type;

      get_om_details_rec_type       lcu_get_om_details%ROWTYPE;
      get_shipping_rec_type         lcu_get_shipping_ins%ROWTYPE;
      delivery_charge_rec_type      lcu_charges_lines%ROWTYPE;
      misc_charge_rec_type          lcu_charges_lines%ROWTYPE;
      lcu_tax_ca_rec                lcu_tax_ca%ROWTYPE;
      lc_tiered_discount_rec        lc_tiered_discount%ROWTYPE;
      lc_bulk_discount_rec          lc_bulk_discount%ROWTYPE;
      lc_association_discount_rec   lc_association_discount%ROWTYPE;
      lc_gsa_comment_rec            lc_gsa_comment%ROWTYPE;
      lc_gc_discount_rec            lc_gc_discount%ROWTYPE;     --Added for R1.1 Defect # 1451 (CR 626)
      lc_coupon_discount_rec        lc_coupon_discount%ROWTYPE;  --Added for Prod Defect # 2025
      vidheader                     idheader;
      vidline                       idline;
      --lc_file_name                  VARCHAR2 (1000);          -- Commented as this local variable is not used.
      lc_errormsg                   VARCHAR2 (1000);
      lc_elecrectype                VARCHAR2 (20);
      ln_tax_amount                 NUMBER;
      lc_tax_code                   VARCHAR2 (40);
      lc_tax_rate                   VARCHAR2 (10);
      lc_ordered_item               VARCHAR2 (200);
      ld_reconcile_date             DATE;
      lc_release_number             VARCHAR2 (240);
      lc_cost_center_dept           VARCHAR2 (240);
      lc_desk_del_addr              VARCHAR2 (240);
      ln_line_count                 NUMBER;
      ln_totalorder_amt             NUMBER;
      ln_ordersub_total             NUMBER;
--      ln_dis_amt                    NUMBER;          -- Commented for Prod Defect # 2025
      lc_ordersub_total_sign        VARCHAR2 (10);
      lc_totalorder_amt_signs       VARCHAR2 (10);
      lc_totalorder_amt_sign        VARCHAR2 (10);
      lc_ordersub_total_signs       VARCHAR2 (10);
      lc_get_warehouse_name         VARCHAR2 (100);
      lc_ship_to_addr_flag          VARCHAR2 (20);
      ln_req_id                     NUMBER;
      lc_wait                       BOOLEAN;
      lc_conc_phase                 VARCHAR2 (50);
      lc_conc_status                VARCHAR2 (50);
      lc_dev_phase                  VARCHAR2 (50);
      lc_dev_status                 VARCHAR2 (50);
      lc_conc_message               VARCHAR2 (50);
      lc_err_status                 VARCHAR2 (10);
      lc_err_msg                    VARCHAR2 (1000);
      p_file_name                   VARCHAR2 (100);
      ld_get_date                   DATE;
      ld_issue_date                 DATE                     := TO_DATE (NULL);
      ld_cut_off_date               DATE                     := TO_DATE (NULL);
      ln_request_id                 NUMBER       := fnd_global.conc_request_id;
      ln_common_count               NUMBER                                := 0;
      ln_detail_count               NUMBER                                := 0;
      ln_detail_line_count          NUMBER                                := 0;  --Added for the defect 13488
      lc_delimiter                  VARCHAR2 (4)                        := '|';
      lc_line1                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line2                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line3                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line4                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_line5                      VARCHAR2 (5000)          := TO_CHAR (NULL);
      lc_dba_dir_path               VARCHAR2 (100)           := TO_CHAR (NULL);
      lc_delivery                   VARCHAR2 (40)                := 'DELIVERY';
      lc_misc_charges               VARCHAR2 (40)           := 'MISCELLANEOUS';
      lc_prev_cbi_id                ar_cons_inv_all.cons_inv_id%TYPE      := 0;
      lc_curr_cbi_id                ar_cons_inv_all.cons_inv_id%TYPE      := 0;
      lc_partial_shipment           VARCHAR2 (1)                       := NULL;
      lc_addrid                     VARCHAR2 (80)                      := NULL;
      lc_addraliasname              VARCHAR2 (80)                      := NULL;
      lc_aopsshiptoseq              VARCHAR2 (80)                      := NULL;
      lc_addrbusname                VARCHAR2 (80)                      := NULL;
      ld_hd_ordcompletedate         DATE;
      lc_orgordnbr                  VARCHAR2 (80)                      := NULL;
      lc_orgordsubnbr               VARCHAR2 (10)                      := NULL;
      lc_trx_class                  ra_cust_trx_types.TYPE%TYPE;
      lc_invoice_source             ra_batch_sources.NAME%TYPE;
      lc_invoice_source_id          ra_batch_sources.batch_source_id%TYPE;
      lc_province                   ar_invoice_header_v.bill_to_province%TYPE;
      ld_least_trx_date             DATE                     := TO_DATE (NULL);
      lc_cust_phone_ext             VARCHAR2 (10)                      := NULL;
      lc_spc_source                 VARCHAR2 (3)                      := 'SPC';
      lc_pos_acct_nbr               VARCHAR2 (12)                      := NULL;
      lc_pos_tran_nbr               VARCHAR2 (5)                       := NULL;
      lc_pos_reg_nbr                VARCHAR2 (5)                       := NULL;
      lc_comments                   VARCHAR2 (70)                      := NULL;
      ln_ord_id                     NUMBER                                := 0;
      ln_total_tax_amt              NUMBER;
      ln_total_disc_amt             NUMBER;
      ln_total_misc_chrg            NUMBER;
      ln_total_deliv_chrg           NUMBER;
      ln_total_tax_gst              NUMBER;
      ln_total_coupon_amt           NUMBER;
      ln_total_deposits             NUMBER;
      ln_total_tax_pst              NUMBER;
      ln_prev_customer_id           NUMBER                                := 0;
      ln_prev_site_id               NUMBER                                := 0;
      lc_prev_billing_id            ar_cons_inv_all.cons_billing_number%TYPE
                                                                          := 0;
      lc_xmail_site_name            VARCHAR2 (80)                      := NULL;
      lc_xaddr_alias_name           VARCHAR2 (80)                      := NULL;
      ln_tax_rate                   xx_om_header_attributes_all.tax_rate%TYPE
                                                                       := NULL;
      lc_error_location               VARCHAR2(4000) := NULL;
      lc_error_debug                  VARCHAR2(4000) := NULL;
      lc_error_location_info          VARCHAR2(4000)                   := NULL;  --Added as a part of defect 11993
      lc_error_debug_info             VARCHAR2(4000)                   := NULL;  --Added as a part of defect 11993
      ln_attr_group_id                NUMBER;  --Added as a part of the defect 13717
      ln_total_gc_amt                 NUMBER;   --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text1                 VARCHAR2 (180) ;  --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text2                 VARCHAR2 (180) ;  --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text3                 VARCHAR2 (180) ;  --Added for R1.1 Defect # 1451 (CR 626)
      lc_tender_text                  VARCHAR2 (250) ;  --Added for R1.1 Defect # 1451 (CR 626)
      ln_cbi_id                       NUMBER;           --Added for R1.2 Defect # 1210 (CR 466)
      lc_cbi_num                      VARCHAR2(30);     --Added for R1.2 Defect # 1210 (CR 466)
	  ln_kit_extended_amt             NUMBER;           -- Added for Kitting, Defect# 37670
	  ln_kit_unit_price               NUMBER;           -- Added for Kitting, Defect# 37670
	  lc_kit_item_description         VARCHAR2(240);    -- Added for Kitting, Defect# 37670
	  lc_kit_sku                      VARCHAR2(100);    -- Added for Kitting, Defect# 37670
   BEGIN
      p_status_code := 'S';

      fnd_file.put_line (fnd_file.output, 'Start Info Copies...');
      lc_file_handle := p_file_handle;

      FND_FILE.PUT_LINE(FND_FILE.LOG,'WRITEN_OFF_AMT_LOW_VALUE: '||xx_ar_gen_ebill_pkg.ln_write_off_amt_low);   --Added for the Defect# 631 (CR 662)
      FND_FILE.PUT_LINE(FND_FILE.LOG,'WRITEN_OFF_AMT_HIGH_VALUE: '||xx_ar_gen_ebill_pkg.ln_write_off_amt_high); --Added for the Defect# 631 (CR 662)

        SELECT attr_group_id     --Added as a part of the defect 13717
          INTO ln_attr_group_id
        FROM ego_attr_groups_v
        WHERE attr_group_type = 'XX_CDH_CUST_ACCOUNT'
           AND attr_group_name = 'BILLDOCS' ;

-- Start of Changes for R1.1 Defect # 1451 (CR 626)
 --Getting Gift card text
    BEGIN

        SELECT  SUBSTR(description,1,50)
        INTO    lc_tender_text1
        FROM    fnd_lookup_values_vl
        WHERE   lookup_type='OD_BILLING_TENDER_PAYMENT_TEXT'
        AND     lookup_code='TEXT1'
        AND     enabled_flag='Y'
        AND     TRUNC(SYSDATE) BETWEEN TRUNC(start_date_active) AND TRUNC(NVL(end_date_active,SYSDATE+1));

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
           lc_tender_text1  := NULL;
        WHEN OTHERS THEN
           lc_tender_text1  := NULL;
     END;

     BEGIN

        SELECT  SUBSTR(description,1,50)
        INTO    lc_tender_text2
        FROM    fnd_lookup_values_vl
        WHERE   lookup_type='OD_BILLING_TENDER_PAYMENT_TEXT'
        AND     lookup_code='TEXT2'
        AND     enabled_flag='Y'
        AND     trunc(SYSDATE) BETWEEN TRUNC(start_date_active) AND TRUNC(NVL(end_date_active,SYSDATE+1));

     EXCEPTION
        WHEN NO_DATA_FOUND THEN

           lc_tender_text2 := NULL;
        WHEN OTHERS THEN

            lc_tender_text2 := NULL;
      END;

     BEGIN
          SELECT  SUBSTR(description,1,50)
        INTO    lc_tender_text3
        FROM    fnd_lookup_values_vl
        WHERE   lookup_type='OD_BILLING_TENDER_PAYMENT_TEXT'
        AND     lookup_code='TEXT3'
        AND     enabled_flag='Y'
        AND     TRUNC(SYSDATE) BETWEEN TRUNC(start_date_active) AND TRUNC(NVL(end_date_active,SYSDATE+1));

     EXCEPTION
        WHEN NO_DATA_FOUND THEN

           lc_tender_text3 := NULL;
        WHEN OTHERS THEN

           lc_tender_text3 := NULL;
     END;
     -- End of changes for R1.1 Defect # 1451 (CR 626)


--==============================================================
--Fetching the header level data and inserting then in the File
--==============================================================
      lc_error_location_info := 'Opening lcu_header cursor in generate_info_copy_file';   --Added as a part of defect 11993
      OPEN lcu_header(ln_attr_group_id   --Added as a part of the defect 13717
                     ,p_cust_id_from
                     ,p_cust_id_to       -- Added as a part of Defect 1760
                     );

      LOOP
      --   fnd_file.put_line(fnd_file.LOG, 'Inside LCU-Header in generate_info_copy_file...'); --Commented for Defect # 1742
         --fnd_file.put_line(fnd_file.output, 'Inside LCU-Header...');
         FETCH lcu_header
         BULK COLLECT INTO vidheader LIMIT 100;

         EXIT WHEN vidheader.COUNT = 0;

--================================
--Load Invoice related information
--================================
         IF vidheader.COUNT > 0
         THEN
            FOR i IN vidheader.FIRST .. vidheader.LAST
            LOOP
--+==========================================================
     -- For getting the Total Tax Amount, GST and PST/QST
--+==========================================================
               IF p_us_ou = p_current_ou
               THEN
                  BEGIN
                     SELECT SUM (NVL (aitsv.extended_amount, 0)), 0,
                            0
                       INTO ln_total_tax_amt, ln_total_tax_pst,
                            ln_total_tax_gst
                       FROM ra_customer_trx_lines aitsv,zx_rates_b vat -- ar_vat_tax_vl vat
                      WHERE 1 = 1
                        AND aitsv.customer_trx_id =
                                                 vidheader (i).customer_trx_id
                        AND aitsv.line_type = 'TAX'
                        AND vat.tax_rate_id(+) = aitsv.vat_tax_id;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
                 /*       fnd_file.put_line                        --Added as a part of defect 11993
                                 (fnd_file.LOG,
                                     'In No data found, Total tax amount for US in generate_info_copy_file...:'
                                     ||'Transaction ID - '
                                     ||vidheader (i).customer_trx_id
                                      ); */ --Commented for Defect # 1742
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                     WHEN OTHERS
                     THEN
               /*         fnd_file.put_line                        --Added as a part of defect 11993
                                 (fnd_file.LOG,
                                    'Error in fetching the Total tax amount for US in generate_info_copy_file...'
                                    || SQLERRM
                                 ); */ --Commented for Defect # 1742
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                  END;
               ELSIF p_ca_ou = p_current_ou
               THEN
                  BEGIN
                     lc_error_location_info := 'Opening lcu_tax_ca cursor in generate_info_copy_file';   --Added as a part of defect 11993
                     lc_error_debug_info    := 'Tax amt for the Transaction_ID'                          --Added as a part of defect 11993
                                               ||vidheader (i).customer_trx_id;
                     OPEN lcu_tax_ca (vidheader (i).customer_trx_id);

                     FETCH lcu_tax_ca
                      INTO lcu_tax_ca_rec;

                     ln_total_tax_amt := lcu_tax_ca_rec.xtotal_tax_amt;
                     ln_total_tax_pst := lcu_tax_ca_rec.xtotal_tax_pst_qst;
                     ln_total_tax_gst := lcu_tax_ca_rec.xtotal_tax_gst;

                     IF lcu_tax_ca%NOTFOUND
                     THEN
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                     END IF;

                     CLOSE lcu_tax_ca;
                  EXCEPTION
                     WHEN NO_DATA_FOUND
                     THEN
            /*            fnd_file.put_line                        --Added as a part of defect 11993
                                 (fnd_file.LOG,
                                     'In No data found, Total tax amount for CA in generate_info_copy_file...:'
                                     ||'Transaction ID - '
                                     ||vidheader (i).customer_trx_id
                                      ); */ --Commented for Defect # 1742
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                     WHEN OTHERS
                     THEN
                        ln_total_tax_amt := 0;
                        ln_total_tax_pst := 0;
                        ln_total_tax_gst := 0;
                  END;
               ELSE
-- =========================
-- Not US or CANADA....
-- =========================
                  ln_total_tax_amt := 0;
                  ln_total_tax_pst := 0;
                  ln_total_tax_gst := 0;
               END IF;
              /*    fnd_file.put_line (fnd_file.LOG,' Tax totals  : Total Tax amount : '||ln_total_tax_amt
                                                  ||'  PST tax : '||ln_total_tax_pst
                                                  ||'  GST tax : '||ln_total_tax_gst
                                                  );           --Added as a part of defect 11993
             */ --Commented for Defect # 1742
--+==========================================================
     -- For getting the Total Discount Amount
--+==========================================================
               ln_total_disc_amt :=
                  xx_ar_gen_ebill_pkg.get_total_discount
                                                 (vidheader (i).customer_trx_id
                                                 );
            /*   fnd_file.put_line (fnd_file.LOG,'Info Copy : Total Discount Amount : '     --Added as a part of defect 11993
                                               ||ln_total_disc_amt
                                 ); */ --Commented for Defect # 1742

-- Start of changes for R1.1 Defect # 1451 (CR 626)
--+=================================================
     -- For getting the Total Gift Card Charges
--+=================================================
                     ln_total_gc_amt   :=
                        xx_ar_gen_ebill_pkg.get_total_gc_chrg
                                                 (vidheader (i).customer_trx_id
                                                 );
-- End of changes for R1.1 Defect # 1451 (CR 626)

--+==========================================================
     -- For getting the Total Miscellaneous Charges
--+==========================================================
               ln_total_misc_chrg :=
                  xx_ar_gen_ebill_pkg.get_total_misc_chrg
                                                 (vidheader (i).customer_trx_id
                                                 );
               ln_total_misc_chrg := ln_total_misc_chrg - ln_total_gc_amt;                    -- Added for R1.1 defect # 1451 (CR 626)
            /*   fnd_file.put_line (fnd_file.LOG,'Info Copy : Total Miscellaneous Charges : '    --Added as a part of defect 11993
                                               ||ln_total_misc_chrg
                                 ); */ --Commented for Defect # 1742
--+==========================================================
     -- For getting the Total Delivery Charges
--+==========================================================
               ln_total_deliv_chrg :=
                  xx_ar_gen_ebill_pkg.get_total_delivery
                                                 (vidheader (i).customer_trx_id
                                                 );
            /*   fnd_file.put_line (fnd_file.LOG,'Info Copy : Total Delivery Charges : '      --Added as a part of defect 11993
                                               ||ln_total_deliv_chrg
                                 );  */ --Commented for Defect # 1742
--+==========================================================
     -- For getting the Total Coupon Amount
--+==========================================================
               ln_total_coupon_amt :=
                  xx_ar_gen_ebill_pkg.get_total_coupon
                                                 (vidheader (i).customer_trx_id
                                                 );
           /*    fnd_file.put_line (fnd_file.LOG,'Info Copy : Total Coupon Amount : '         --Added as a part of defect 11993
                                               ||ln_total_coupon_amt
                                 );  */ --Commented for Defect # 1742
--+==========================================================
     -- For getting the Total deposits for Canadian
--+==========================================================
               ln_total_deposits := 0;

               --fnd_file.put_line(fnd_file.output, 'After Total Deposits Amount...');

               -- Start of changes for R1.2 Defect 1210 (CR 466)
               IF vidheader (i).billing_method = 'PAYDOC_IC' THEN
                  ln_cbi_id  := vidheader (i).cons_inv_id;
                  lc_cbi_num := vidheader (i).cons_billing_number;
               END IF;
               -- End of changes for R1.2 Defect 1210 (CR 466)

               IF (   (ln_prev_customer_id = 0 AND ln_prev_site_id = 0)
                   OR (    (ln_prev_customer_id <> vidheader (i).customer_id
                           )
                       AND (ln_prev_site_id <> vidheader (i).billing_site_id
                           )
                      )
                  )
               THEN
-- ====================================
--  get a new cons bill#.....
-- ====================================
                  SELECT xx_ar_ebill_info_doc_s.NEXTVAL
                    INTO lc_prev_billing_id
                    FROM DUAL;
          --        fnd_file.put_line(fnd_file.LOG,'Info Copy: Virtual billing Number : ' ||lc_prev_billing_id);  --Commented for Defect # 1742
                  vidheader (i).cons_billing_number := lc_prev_billing_id;
                  vidheader (i).cons_inv_id := lc_prev_billing_id;
                  ln_prev_customer_id := vidheader (i).customer_id;
                  ln_prev_site_id := vidheader (i).billing_site_id;
                  ld_issue_date := TO_DATE (NULL);
                  lc_error_location_info := 'Opening lcu_get_issue_date in generate_info_copy_file';   --Added as a part of defect 11993
                  lc_error_debug_info    := 'ld_issue_date from lcu_get_issue_date for'                --Added as a part of defect 11993
                                            ||'Customer ID' || vidheader (i).customer_id
                                            ||'Billing Site ID' || vidheader (i).billing_site_id
                                            ||'Cons inv ID' ||vidheader (i).cons_inv_id;
                  OPEN lcu_get_issue_date (vidheader (i).customer_id,
                                           vidheader (i).billing_site_id,
                                           vidheader (i).cons_inv_id
                                          );

                  FETCH lcu_get_issue_date
                   INTO ld_issue_date;

                  CLOSE lcu_get_issue_date;

                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_issue_date...');
                  IF ld_issue_date IS NULL
                  THEN
                  BEGIN
                       -- Start of changes for defect# 4136
                       /*SELECT TRUNC (MIN (rct.trx_date))                              --Commented for defect# 4136
                        INTO ld_issue_date
                       /*FROM (SELECT extension_id, cust_account_id,                  --Commented as a part of the defect 13717
                                    billdocs_special_handling spl_handling,
                                    billdocs_payment_term billing_term
                               FROM xx_cdh_a_ext_billdocs_v
                              WHERE 1 = 1
                                AND billdocs_doc_type = 'Consolidated Bill'
                                AND billdocs_delivery_meth = 'ELEC'
                                AND NVL (billdocs_paydoc_ind, '?') != 'Y') xcaebv,*/
                     /*FROM (SELECT extension_id,                                          --Added as a part of the defect 13717
                                  cust_account_id,
                                  c_ext_attr4  spl_handling,
                                  c_ext_attr14 billing_term
                           FROM xx_cdh_cust_acct_ext_b
                           WHERE c_ext_attr1= 'Consolidated Bill'
                             AND c_ext_attr3 = 'ELEC'
                             AND NVL(c_ext_attr2,'?') ! = 'Y'
                             AND attr_group_id = ln_attr_group_id) xcaebv,
                            ra_customer_trx rct,
                            ra_cust_trx_types rctt,
                            ra_batch_sources rbs
                      WHERE 1 = 1
                        AND rct.bill_to_customer_id =
                                                     vidheader (i).customer_id
                        AND rct.bill_to_site_use_id =
                                                 vidheader (i).billing_site_id
                        AND rctt.cust_trx_type_id = rct.cust_trx_type_id
                        AND rbs.batch_source_id = rct.batch_source_id
                        AND rbs.NAME NOT IN ('CONVERSION_OD')
                        AND rctt.TYPE IN ('INV', 'CM', 'DM', 'DEP', 'CB')
                        AND rct.complete_flag = 'Y'                    -- 9043
                        AND rct.bill_to_customer_id = xcaebv.cust_account_id
                        AND NOT EXISTS (
                               SELECT b.customer_trx_id
                                 FROM xx_ar_gen_bill_temp_all b
                                WHERE 1 = 1
                                  AND b.customer_trx_id = rct.customer_trx_id);
        -- Bill_from_date is being passed as NULL to differentiate PAYDOC_IC and INV_IC hence uncommented the below code for the defect 11993
        -- This may be reverted back to print the date values by commenting the below AND condition.
                        /*AND 0 =
                               (SELECT COUNT (1)
                                  FROM ar_cons_inv arci                          --Invalid condition
                                 WHERE arci.customer_id =                        --To get min(trx_date) for Bill From date
                                                       rct.bill_to_customer_id
                                   AND NVL (attribute2, 'N') != 'Y')*/         --Commented for the defect 13717
                     SELECT TRUNC (MIN (rct.trx_date))
                     INTO ld_issue_date
                     FROM ra_customer_trx RCT
                     WHERE rct.bill_to_customer_id = vidheader(i).customer_id
                     AND rct.bill_to_site_use_id = vidheader(i).billing_site_id
                     AND EXISTS (
                                  SELECT 1
                                  FROM   xx_ar_invoice_freq_history XAIFH
                                  WHERE  XAIFH.invoice_id = RCT.customer_trx_id
                                  AND    xx_ar_inv_freq_pkg.compute_effective_date(vidheader(i).billing_term
                                                                                   ,TRUNC(XAIFH.actual_print_date)
                                                                                   ) >= vidheader(i).creation_date
                                 )
                     AND NOT EXISTS (
                                     SELECT b.customer_trx_id
                                     FROM xx_ar_gen_bill_lines_all b
                                     WHERE b.customer_trx_id = rct.customer_trx_id
                                     );

                     IF ld_issue_date IS NULL
                     THEN
                             SELECT TRUNC (MIN(acit.transaction_date))
                             INTO ld_issue_date
                             FROM ar_cons_inv ACI
                                  ,ar_cons_inv_trx ACIT
                             WHERE ACI.cons_inv_id= ACIT.cons_inv_id
                             AND TO_DATE(ACI.attribute1)-1 = vidheader(i).issue_date
                             AND ACI.customer_id = vidheader(i).customer_id
                             AND ACI.site_use_id = vidheader(i).billing_site_id
                             AND xx_ar_inv_freq_pkg.compute_effective_date( vidheader(i).billing_term
                                                                ,vidheader(i).issue_date
                                                                ) >= vidheader(i).creation_date
                             AND NOT EXISTS (
                                             SELECT b.customer_trx_id
                                             FROM xx_ar_gen_bill_lines_all b
                                             WHERE b.customer_trx_id = ACIT.customer_trx_id
                                             );
                        END IF;
                   -- End of changes for defect# 4136

                   EXCEPTION
                        WHEN NO_DATA_FOUND -- Exception Handled for the defect 12435
                        THEN
                  /*         fnd_file.put_line
                                   (fnd_file.LOG, 'InfoCopy : In No Data Found, Least Invoice Date for --'
                                                  ||'Customer ID' || vidheader (i).customer_id
                                                  ||'Billing Site ID' || vidheader (i).billing_site_id
                                                  ||'Cons inv ID' ||vidheader (i).cons_inv_id
                                   ); */ --Commented for Defect # 1742
                           ld_issue_date := NULL;
                        WHEN OTHERS
                        THEN
                      /*     fnd_file.put_line
                              (fnd_file.LOG,
                                  'Error in fetching the least invoice date...'
                               || SQLERRM
                              ); */ --Commented for Defect # 1742
                           ld_issue_date :=  NULL;
                     END;
       --Commented for the defect 11993
                 /* ELSE
                     -- We got the bill from date.
                     NULL;*/
                  END IF;
               ELSE
                  vidheader (i).cons_billing_number := lc_prev_billing_id;
                  vidheader (i).cons_inv_id := lc_prev_billing_id;
                  ln_prev_customer_id := vidheader (i).customer_id;
                  ln_prev_site_id := vidheader (i).billing_site_id;
               END IF;

               -- Start of changes for R1.2 Defect 1210 (CR 466)
               IF vidheader (i).billing_method = 'INV_IC' THEN
                  ln_cbi_id  := TO_NUMBER(lc_prev_billing_id);
                  lc_cbi_num := lc_prev_billing_id;
               END IF;
               -- End of changes for R1.2 Defect 1210 (CR 466)

                  lc_error_location_info := 'Opening lcu_invoices in generate_info_copy_file';   --Added as a part of defect 11993
                  lc_error_debug_info    := 'Line level data from lcu_invoices for'              --Added as a part of defect 11993
                                            ||'Transaction ID'||vidheader (i).customer_trx_id;
               FOR lcu_invoices_rec IN
                  lcu_invoices (vidheader (i).customer_trx_id, p_tax_id)
               LOOP
            /*      fnd_file.put_line (fnd_file.LOG,
                                        'InfoCopy Invoice   : '
                                     || lcu_invoices_rec.trx_number
                                    ); */ --Commented for Defect # 1742
                  vidheader (i).trx_number := lcu_invoices_rec.trx_number;
                  vidheader (i).interface_header_attribute1 :=
                                  lcu_invoices_rec.interface_header_attribute1;
                  vidheader (i).LOCATION := lcu_invoices_rec.LOCATION;
                  vidheader (i).orig_system_reference :=
                                        lcu_invoices_rec.orig_system_reference;
                  vidheader (i).site_use_code :=
                                                lcu_invoices_rec.site_use_code;
                  vidheader (i).purchase_order_number :=
                                        lcu_invoices_rec.purchase_order_number;
                  vidheader (i).bill_to_customer_number :=
                                      lcu_invoices_rec.bill_to_customer_number;
                  vidheader (i).bus_name := lcu_invoices_rec.bus_name;
                  vidheader (i).interface_header_attribute2 :=
                                  lcu_invoices_rec.interface_header_attribute2;
                  vidheader (i).tax_registration_number :=
                                      lcu_invoices_rec.tax_registration_number;
                  vidheader (i).primary_salesrep_name :=
                                        lcu_invoices_rec.primary_salesrep_name;
                  vidheader (i).ship_to_customer_name :=
                                        lcu_invoices_rec.ship_to_customer_name;
                  vidheader (i).ship_to_address1 :=
                                             lcu_invoices_rec.ship_to_address1;
                  vidheader (i).ship_to_address2 :=
                                             lcu_invoices_rec.ship_to_address2;
                  vidheader (i).ship_to_city := lcu_invoices_rec.ship_to_city;
                  vidheader (i).ship_to_state :=
                                                lcu_invoices_rec.ship_to_state;
                  vidheader (i).ship_to_postal_code :=
                                          lcu_invoices_rec.ship_to_postal_code;
                  vidheader (i).ship_to_country :=
                                              lcu_invoices_rec.ship_to_country;
                  vidheader (i).ship_to_contact :=
                                              lcu_invoices_rec.ship_to_contact;
                  vidheader (i).trx_date := lcu_invoices_rec.trx_date;
                  vidheader (i).ship_to_location :=
                                             lcu_invoices_rec.ship_to_location;
                  vidheader (i).bill_to_name := lcu_invoices_rec.bill_to_name;
                  vidheader (i).bill_to_location :=
                                             lcu_invoices_rec.bill_to_location;
                  vidheader (i).bill_to_address1 :=
                                             lcu_invoices_rec.bill_to_address1;
                  vidheader (i).bill_to_address2 :=
                                             lcu_invoices_rec.bill_to_address2;
                  vidheader (i).bill_to_city := lcu_invoices_rec.bill_to_city;
                  vidheader (i).bill_to_state :=
                                                lcu_invoices_rec.bill_to_state;
                  vidheader (i).bill_to_postal_code :=
                                          lcu_invoices_rec.bill_to_postal_code;
                  vidheader (i).bill_to_country :=
                                              lcu_invoices_rec.bill_to_country;
                  vidheader (i).bill_to_attn := lcu_invoices_rec.bill_to_attn;
                  vidheader (i).ordsourcecd := lcu_invoices_rec.ordsourcecd;
                  ld_hd_ordcompletedate := lcu_invoices_rec.ordcompletedate;
                  lc_trx_class := lcu_invoices_rec.trx_class;
                  lc_orgordnbr :=TO_CHAR (TO_NUMBER (lcu_invoices_rec.orgordnbr));
                  lc_orgordsubnbr := NULL; --Added for the defect 13650
                   -- Start of changes for defect 8867

                 IF lc_orgordnbr IS NULL AND lc_trx_class='CM' THEN
                       BEGIN
--                          SELECT SUBSTR(ret_orig_order_num,1,9),            -- Commented for R1.3 CR 733 Defect 1212
--                                 SUBSTR(ret_orig_order_num,-3,3)            -- Commented for R1.3 CR 733 Defect 1212
                          SELECT -- ret_orig_order_num                           -- Added for R1.3 CR 733 Defect 1212 Commented for Defect 5846
                                 OOH1.order_number
                          INTO   lc_orgordnbr              -- added for defect 5846
--                                 lc_orgordsubnbr                             -- Commented for R1.3 CR 733 Defect 1212
                          FROM xx_om_line_attributes_all XOLA,
                               oe_order_lines_all OOL,
                               oe_order_headers_all OOH,
                               oe_order_headers_all OOH1
                          WHERE XOLA.line_id=OOL.line_id
                          AND   OOL.header_id=OOH.header_id
                          AND   OOH1.orig_sys_document_ref = XOLA.ret_orig_order_num -- added for defect 5846
                          AND   XOLA.ret_orig_order_num IS NOT NULL   -- added for defect 5846
                          AND   OOH.header_id=lcu_invoices_rec.order_header_id
                          AND   ROWNUM=1;
                    /*      fnd_file.put_line(fnd_file.LOG,'InfoCopy : lc_orgordnbr and lc_orgordsubnbr'             --Added as a part of the defect 11993
                                                         ||lc_orgordnbr || '-' || lc_orgordsubnbr
                                           );  */ --Commented for Defect # 1742
                       EXCEPTION
                        WHEN OTHERS THEN
                        --   fnd_file.put_line (fnd_file.log,'Could not derive lcorgordnum and lc_orgordsubnbr'||SQLERRM); --Commented for Defect # 1742
                           lc_orgordnbr :=NULL;    --Added for the defect 12435
                           lc_orgordsubnbr :=NULL; --Added for the defect 12435
                        END;
                   END IF;
                  -- End of Changes for defect 8867

                  lc_invoice_source := lcu_invoices_rec.invoice_source;
                  lc_invoice_source_id := lcu_invoices_rec.invoice_source_id;
                  lc_province := lcu_invoices_rec.bill_to_province;
                  ln_ord_id := lcu_invoices_rec.order_header_id;

                  lc_error_location_info := 'Opening lcu_bill_siteuses in generate_info_copy_file';   --Added as a part of defect 11993
                  lc_error_debug_info    := 'Bill_to_site_use_id for lcu_bill_siteuses :'             --Added as a part of defect 11993
                                            ||lcu_invoices_rec.bill_to_site_use_id;

                  OPEN lcu_bill_siteuses (lcu_invoices_rec.bill_to_site_use_id);

                  FETCH lcu_bill_siteuses
                   INTO lc_addrid, lc_addraliasname, lc_xmail_site_name;

                  CLOSE lcu_bill_siteuses;

                  lc_error_location_info := 'Opening lcu_ship_siteuses in generate_info_copy_file';   --Added as a part of defect 11993
                  lc_error_debug_info    := 'Ship_to_site_use_id for lcu_ship_siteuses :'             --Added as a part of defect 11993
                                            ||lcu_invoices_rec.ship_to_site_use_id;

                  OPEN lcu_ship_siteuses (lcu_invoices_rec.ship_to_site_use_id);

                  FETCH lcu_ship_siteuses
                   INTO lc_aopsshiptoseq, lc_addrbusname, lc_xaddr_alias_name;

                  CLOSE lcu_ship_siteuses;

                  get_om_details_rec_type.release_number := NULL;
                  get_om_details_rec_type.cost_center_dept := NULL;
                  get_om_details_rec_type.cost_center_desc := NULL;   -- added for defect 8927
                  get_om_details_rec_type.desk_del_addr := NULL;
                  get_om_details_rec_type.placement_method_code := NULL;
                  get_om_details_rec_type.ordcreateid := NULL;
                  get_om_details_rec_type.custtypecd := NULL;
                  get_om_details_rec_type.aops_cust_contact := NULL;
                  get_om_details_rec_type.aops_cust_phone := NULL;
                  get_om_details_rec_type.aops_cust_phone_ext := NULL;
                  get_om_details_rec_type.spc_card_num := NULL;
                  get_om_details_rec_type.spc_location_num := NULL;
                  get_om_details_rec_type.spc_trans_date := NULL;
                  get_om_details_rec_type.spc_register_num := NULL;
                  get_om_details_rec_type.spc_trans_num := NULL;
                  get_om_details_rec_type.xxom_hdr_tax_rate := NULL;   -- Added for the defect 13650
--Start of changes for SPC details as a part of defect 11993
                  get_shipping_rec_type.ordsourcecd           := NULL;
                  get_shipping_rec_type.subordernum           := NULL;
                  get_shipping_rec_type.spc_order             := NULL;
                  get_shipping_rec_type.shipping_instructions := NULL;
                  get_shipping_rec_type.ordered_date          := NULL;
--End of Changes for SPC details as a part of defect 11993
                  IF (lc_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
                     )
                  THEN
                     lc_error_location_info := 'InfoCopy : Opening lcu_get_om_details for SALES_ACCT_US and SALES_ACCT_CA invoices'; --Added as a part of defect 11993
                     lc_error_debug_info    := 'lcu_get_om_details for Order ID --'                                                           --Added as a part of defect 11993
                                               ||ln_ord_id ||'Customer ID -- '|| to_char(vidheader (i).customer_id);
                     OPEN lcu_get_om_details (ln_ord_id
                                              ,vidheader (i).customer_id);  -- added for defect#8927

                     FETCH lcu_get_om_details
                      INTO get_om_details_rec_type;

                     ln_tax_rate :=
                        NVL (get_om_details_rec_type.xxom_hdr_tax_rate,
                             TO_NUMBER (NULL)
                            );

                     CLOSE lcu_get_om_details;
                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_om_details...');
                  END IF;

                  IF get_om_details_rec_type.aops_cust_phone IS NOT NULL
                  THEN
                     vidheader (i).phone_number :=
                        RPAD (NVL (get_om_details_rec_type.aops_cust_phone,
                                   ' '
                                  ),
                              11,
                              ' '
                             );
                     lc_cust_phone_ext :=
                        RPAD
                           (NVL (get_om_details_rec_type.aops_cust_phone_ext,
                                 ' '
                                ),
                            4,
                            ' '
                           );
                  ELSE
                     vidheader (i).phone_number :=
                                                lcu_invoices_rec.phone_number;
                     lc_cust_phone_ext := NULL;
                  END IF;

               /*   fnd_file.put_line (fnd_file.LOG,'Customer Phone Number'               --Added as a part of defect 11993
                                                  ||vidheader (i).phone_number
                                                  ||'Customer Phone ext : '
                                                  ||lc_cust_phone_ext);
                */ --Commented for Defect # 1742
                  IF get_om_details_rec_type.aops_cust_contact IS NOT NULL
                  THEN
                     vidheader (i).ship_to_contact :=
                                    get_om_details_rec_type.aops_cust_contact;
                  ELSE
                     NULL;
                  END IF;
               END LOOP;

               ld_get_date :=
                  xx_ar_inv_freq_pkg.compute_effective_date
                                                   (vidheader (i).billing_term,
                                                    vidheader (i).issue_date
                                                   );

               --fnd_file.put_line(fnd_file.output, 'Out of get frequency...');
            --    fnd_file.put_line (fnd_file.LOG,'InfoCopy: Get date from frequency pkg : '||ld_get_date);--Commented for Defect # 1742

               IF ld_get_date <=
                               TRUNC (g_as_of_date)
                                                   -- Defect 9077 on 12-AUG-08
               THEN
                  lc_elecrectype := 'HD';

                  lc_error_location_info := 'Opening lcu_get_shipping_ins in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lcu_get_shipping_ins for --'                                 --Added as a part of defect 11993
                                             ||'Order header ID'
                                             ||ln_ord_id
                                             ||'Invoice Source'
                                             ||lc_invoice_source;

                   OPEN lcu_get_shipping_ins (ln_ord_id, lc_invoice_source);

                   FETCH lcu_get_shipping_ins
                   INTO get_shipping_rec_type;

                  vidheader (i).ordsourcecd :=
                                            get_shipping_rec_type.ordsourcecd;

                  CLOSE lcu_get_shipping_ins;

                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_shipping_ins...');
                  lc_error_location_info := 'Opening lcu_count_lines in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lcu_count_lines for Transaction ID--'                   --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lcu_count_lines (vidheader (i).customer_trx_id,
                                        lc_invoice_source,
                                        lc_trx_class
                                       );

                  FETCH lcu_count_lines
                   INTO ln_line_count;

                  CLOSE lcu_count_lines;
               /*   fnd_file.put_line (fnd_file.LOG,'InfoCopy : No of lines for trx id '
                                                  ||vidheader (i).customer_trx_id||' : '||ln_line_count);  --Added as a part of defect 11993
               */ --Commented for Defect # 1742
-- Commented for the Prod Defect # 2025
/*                  lc_error_location_info := 'Opening lcu_get_dis_amt in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lcu_get_dis_amt for --'                                 --Added as a part of defect 11993
                                            ||ln_ord_id;

                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_count_lines...');
                  OPEN lcu_get_dis_amt (ln_ord_id);

                  FETCH lcu_get_dis_amt
                   INTO ln_dis_amt;

                  CLOSE lcu_get_dis_amt;*/   -- Commented for the Prod Defect # 2025

                  --fnd_file.put_line(fnd_file.output, 'Out of lcu_get_dis_amt...');
                  IF lc_invoice_source IN ('SALES_ACCT_US', 'SALES_ACCT_CA')
                  THEN
                     BEGIN
                        lc_error_location_info := 'InfoCopy : Total order amount for SALES_ACCT_US and SALES_ACCT_CA invoices'; --Added as a part of defect 11993
                        lc_error_debug_info    :=  'Total order amount for--'                                                   --Added as a part of defect 11993
                                                   ||'Transaction ID'
                                                   ||vidheader (i).customer_trx_id;
                        ln_totalorder_amt :=
                           xx_ar_gen_ebill_pkg.get_inv_totals
                                                ('INVOICE',
                                                 p_item_org,
                                                 vidheader (i).customer_trx_id
                                                );
                        ln_totalorder_amt := ln_totalorder_amt - ln_total_gc_amt;   -- Added for the R1.1 defect # 1451 (CR 626)
                /*        fnd_file.put_line(fnd_file.output, 'Total Order Amount :'||ln_totalorder_amt); --Added as a part of defect 11993
                */ --Commented for Defect # 1742
                      --ln_totalorder_amt      := OE_TOTALS_GRP.get_order_total(ln_ord_id ,NULL ,'ALL');
                     --fnd_file.put_line(fnd_file.output, 'After xx_ar_gen_ebill_pkg.get_inv_totals...');
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                 /*          fnd_file.put_line
                              (fnd_file.output,
                               'Error in xx_ar_gen_ebill_pkg.get_inv_totals (Total Order Amount)...'||vidheader (i).customer_trx_id
                              );
                           fnd_file.put_line (fnd_file.output, SQLERRM);*/ --Commented for Defect # 1742
                           ln_totalorder_amt := 0;
                     END;

                     BEGIN
                        lc_error_location_info := 'InfoCopy : Sub Order Total for SALES_ACCT_US and SALES_ACCT_CA invoices'; --Added as a part of defect 11993
                        lc_error_debug_info    :=  'Sub Order Total for--'                                                   --Added as a part of defect 11993
                                                   ||'Transaction ID'
                                                   ||vidheader (i).customer_trx_id;
                        ln_ordersub_total :=
                           xx_ar_gen_ebill_pkg.get_inv_totals
                                                ('SKU',
                                                 p_item_org,
                                                 vidheader (i).customer_trx_id
                                                );
   /*                     fnd_file.put_line(fnd_file.output, 'Order Sub Total :'||ln_ordersub_total); --Added as a part of defect 11993
   */--Commented for Defect # 1742
                        --ln_ordersub_total      := OE_OE_TOTALS_SUMMARY.order_subtotals(ln_ord_id);
                     --fnd_file.put_line(fnd_file.output, 'After xx_ar_gen_ebill_pkg.get_inv_totals...');
                     EXCEPTION
                        WHEN OTHERS
                        THEN
            /*               fnd_file.put_line
                              (fnd_file.output,
                               'Error in xx_ar_gen_ebill_pkg.get_inv_totals (Order Sub Total)...'||vidheader (i).customer_trx_id
                              );
                           fnd_file.put_line (fnd_file.output, SQLERRM);  */ --Commented for Defect # 1742
                           ln_ordersub_total := 0;
                     END;
                  ELSE
                     ln_totalorder_amt := TO_NUMBER (NULL);
                     ln_ordersub_total := TO_NUMBER (NULL);
                  END IF;

                  IF vidheader (i).ship_to_location IS NOT NULL
                  THEN
                     lc_ship_to_addr_flag := 'Y';
                  ELSE
                     lc_ship_to_addr_flag := 'N';
                  END IF;

                 /* IF lc_trx_class = 'CM'
                  THEN
                     lc_orgordsubnbr :=
                        RPAD
                           (NVL
                               (TO_CHAR
                                   (TO_NUMBER
                                            (get_shipping_rec_type.subordernum)
                                   ),
                                ' '
                               ),                                               -- Commented for Defect 8867
                            5,
                            ' '
                           );
                  ELSE
                     lc_orgordsubnbr := RPAD (' ', 5, ' ');
                  END IF; */


               -- Start of changes for defect 8867
               IF lc_orgordsubnbr IS NULL AND lc_trx_class='CM'
               THEN
                 --lc_orgordsubnbr := TO_CHAR(TO_NUMBER(get_shipping_rec_type.subordernum)); --Commented for the defect 13650
                 lc_orgordsubnbr := get_shipping_rec_type.subordernum; --Added for the defect 13650
               END IF;
               -- End of changes for defect 8867

                  IF get_shipping_rec_type.spc_order = lc_spc_source
                  THEN
                     lc_pos_acct_nbr :=
                        NVL (get_om_details_rec_type.spc_card_num,
                             RPAD (' ', 12, ' ')
                            );
                     lc_pos_tran_nbr :=
                        NVL (get_om_details_rec_type.spc_trans_num,
                             RPAD (' ', 5, ' ')
                            );
                     lc_pos_reg_nbr :=
                        NVL (get_om_details_rec_type.spc_register_num,
                             RPAD (' ', 5, ' ')
                            );
                     lc_comments :=
                        RPAD
                           (NVL (   lc_spc_source
                                 || get_om_details_rec_type.spc_card_num
                                 || ' '
                                 || 'Date: '
                                 || get_om_details_rec_type.spc_trans_date
                                 || ' '
--                                 || 'Location:'  --Commented for Defect # 3561
                                 || 'Loc:'  --Added for Defect # 3561
                                 || get_om_details_rec_type.spc_location_num
                                 || ' '
                                 || 'Register:'
                                 || get_om_details_rec_type.spc_register_num
                                 || ' '
                                 || 'Trans#:'
                                 || get_om_details_rec_type.spc_trans_num,
                                 ' '
                                ),
                            70,
                            ' '
                           );
                    -- ADDED FOR DEFECT 13472 , Mohan
                       get_shipping_rec_type.subordernum := SUBSTR(vidheader (i).interface_header_attribute1,10,5) ;
                    --end  Defect 13472
                  ELSE
                     lc_pos_acct_nbr := RPAD (' ', 12, ' ');
                     lc_pos_tran_nbr := RPAD (' ', 5, ' ');
                     lc_pos_reg_nbr := RPAD (' ', 5, ' ');
                     lc_comments :=
                        RPAD
                           (NVL (get_shipping_rec_type.shipping_instructions,
                                 ' '
                                ),
                            70,
                            ' '
                           );
                  END IF;
          /*       fnd_file.put_line (fnd_file.LOG,'InfoCopy : Shipping Comments : '||lc_comments);        --Added for the defect 11993

                 fnd_file.put_line (fnd_file.LOG,'InfoCopy : Extracting the data for :'||lc_elecrectype); --Added for the defect 11993
          */ --Commented for Defect # 1742
                  BEGIN
                     IF ln_common_count = 0
                     THEN
                        ln_common_count := p_last_line_seq + 1;
                     ELSE
                        ln_common_count := ln_common_count + 1;
                     END IF;

                     --ln_paydoc_cbi_number :=vidheader(i).cons_billing_number;
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                         -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || RPAD (' ', 5, ' ')
                                         --ELEC DETAIL SEQ NOT FOR HD REC TYPE
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 20, ' ')
                         || RPAD (' ', 20, ' ')
                         || RPAD (' ', 20, ' ')
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 30, ' ')
                         || RPAD (' ', 2, ' ')
                         || TO_CHAR (0, '09999S')
                         || TO_CHAR (0, '09999S')
                         || TO_CHAR (0, '09999S')
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD (TO_CHAR (0, '999999990.99S'), 13, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 20, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || lc_comments
                         || RPAD (' ', 8, ' ')
                        /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                 || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
             /*     fnd_file.put_line (fnd_file.LOG,'InfoCopy : Extracted the data for :'||lc_elecrectype); --Added for the defect 11993
         */--Commented for Defect # 1742
                  EXCEPTION
                     WHEN OTHERS
                     THEN
             /*           fnd_file.put_line (fnd_file.output,
                                           'Error @ HD type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..' || SQLERRM
                                          );
              */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                        p_status_code := 'E';
                        p_error_msg := 'Error @ HD type...' || SQLERRM;
                        RAISE;
     --====End of Changes for the defect 12435====--
                  END;
        ---====Commented for the defect 12435====---
/*
--========================================================================
-- Insert the transactions into the custom table and update ar_cons_inv
--========================================================================
                  IF (   (lc_prev_cbi_id = 0)
                      OR (lc_prev_cbi_id <> vidheader (i).cons_inv_id)
                     )
                  THEN
                     lc_prev_cbi_id := vidheader (i).cons_inv_id;

                     BEGIN
                        SAVEPOINT square1;

                        --fnd_file.put_line(fnd_file.output ,'Insert of history record ,Consolidated Bill ID: '||TO_CHAR(vidheader(i).cons_inv_id));
                        INSERT INTO xx_ar_gen_bill_temp
                                    (cons_inv_id,
                                     cons_billing_number,
                                     cut_off_date,
                                     due_date,
                                     trx_number, processed_flag,
                                     customer_trx_id,
                                     created_by, creation_date,
                                     last_updated_by, last_update_date,
                                     last_update_login, request_id,
                                     org_id,
                                     issue_date,
                                     customer_id,
                                     billing_site_id
                                    )
                             VALUES (vidheader (i).cons_inv_id,
                                     vidheader (i).cons_billing_number,
                                     vidheader (i).cut_off_date + 1,
                                     vidheader (i).due_date,
                                     vidheader (i).trx_number, 'Y',
                                     vidheader (i).customer_trx_id,
                                     fnd_global.user_id, SYSDATE,
                                     fnd_global.user_id, SYSDATE,
                                     fnd_global.login_id, ln_request_id,
                                     vidheader (i).org_id,
                                     SYSDATE        -- vidheader(i).issue_date
                                            ,
                                     vidheader (i).customer_id,
                                     vidheader (i).billing_site_id
                                    );
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                           fnd_file.put_line
                              (fnd_file.output,
                                  'Problem during insert of history record ,Consolidated Bill ID: '
                               || TO_CHAR (vidheader (i).cons_inv_id)
                              );
                           ROLLBACK TO square1;
                     END;
                  ELSE
                     lc_prev_cbi_id := vidheader (i).cons_inv_id;
                  END IF;

                  -- Begin Defect 9140
                  BEGIN
                     SAVEPOINT square1;

                     --fnd_file.put_line(fnd_file.output ,'Insert of history record ,Consolidated Bill ID: '||TO_CHAR(vidheader(i).cons_inv_id));
                     INSERT INTO xxfin.xx_ar_gen_bill_lines_all
                                 (cons_inv_id,
                                  cons_billing_number,
                                  cut_off_date,
                                  due_date,
                                  trx_number, processed_flag,
                                  customer_trx_id,
                                  created_by, creation_date,
                                  last_updated_by, last_update_date,
                                  last_update_login, request_id,
                                  org_id,
                                  issue_date,
                                  customer_id,
                                  billing_site_id
                                 )
                          VALUES (vidheader (i).cons_inv_id,
                                  vidheader (i).cons_billing_number,
                                  vidheader (i).cut_off_date + 1,
                                  vidheader (i).due_date,
                                  vidheader (i).trx_number, 'Y',
                                  vidheader (i).customer_trx_id,
                                  fnd_global.user_id, SYSDATE,
                                  fnd_global.user_id, SYSDATE,
                                  fnd_global.login_id, ln_request_id,
                                  vidheader (i).org_id,
                                  vidheader (i).issue_date,
                                  vidheader (i).customer_id,
                                  vidheader (i).billing_site_id
                                 );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        fnd_file.put_line
                           (fnd_file.output,
                               'Problem during insert of history record ,Consolidated Bill ID: '
                            || TO_CHAR (vidheader (i).cons_inv_id)
                           );
                        ROLLBACK TO square1;
                  END;
*/
                  -- End Defect 9140

                  --fnd_file.put_line(fnd_file.output, 'After insert into history table...');

                  -- =====================================================================================
-- Should be the first invoice detail line.
-- Process Tiered Discount, one line per Invoice.
-- We use record type MS. We copy the description "Tiered Discount" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_Tiered_Discount_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
                  ln_detail_count := 0;

                  lc_error_location_info := 'Opening lc_tiered_discount in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lc_tiered_discount for --'                                 --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lc_tiered_discount (vidheader (i).customer_trx_id,
                                           lc_trx_class,
                                           lc_invoice_source
                                          );

                  FETCH lc_tiered_discount
                   INTO lc_tiered_discount_rec;

                  IF lc_tiered_discount%FOUND
                  THEN
                     lc_elecrectype := 'MS';
                     ln_common_count := ln_common_count + 1;
                     ln_detail_count := ln_detail_count + 1;

                     BEGIN
                        --fnd_file.put_line(fnd_file.output ,'MS');
                        UTL_FILE.put_line
                           (lc_file_handle,
                               RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                         --BILL_CUSTOMER_ID
                            || RPAD (NVL (vidheader (i).cons_billing_number,
                                          ' '
                                         ),
                                     9,
                                     ' '
                                    )
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (vidheader (i).interface_header_attribute1,
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )
                            -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                            || RPAD (NVL (vidheader (i).phone_number, ' '),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                            || RPAD (' ', 18, ' ')                    --FILLER
                            || RPAD (NVL (lc_addrid, ' '), 9, ' ')    --ADDRID
                            || RPAD (NVL (vidheader (i).invoice_currency_code,
                                          ' '
                                         ),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                            || RPAD (NVL (vidheader (i).purchase_order_number,
                                          ' '
                                         ),
                                     22,
                                     ' '
                                    )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.release_number,
                                       ' '
                                      ),
                                   12,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL (get_om_details_rec_type.desk_del_addr,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                                 --CHILD_ID
                            || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).bus_name, ' '),
                                     40,
                                     ' '
                                    )
                            || NVL (TO_CHAR (vidheader (i).due_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                            || RPAD
                                  (NVL (vidheader (i).tax_registration_number,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )
                            || RPAD (' ', 7, ' ')
                            || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            || lc_pos_acct_nbr                  --SPC ACCT NBR
                            || lc_pos_tran_nbr              --SPC TRANS NUMBER
                            || lc_pos_reg_nbr                 --SPC REG NUMBER
                            || NVL
                                  (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                   RPAD (' ', 8, ' ')
                                  )
                            || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                             'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL (vidheader (i).ordsourcecd, ' '),
                                   1,
                                   ' '
                                  )                              --ordsourcecd
                            || RPAD
                                  (NVL (get_om_details_rec_type.ordcreateid,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )                              --ordgreateid
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.placement_method_code,
                                       ' '
                                      ),
                                   1,
                                   ' '
                                  )
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                              --Pickup Date
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                           --Reconcile Date
                            || RPAD
                                  (NVL (get_om_details_rec_type.custtypecd,
                                        ' '
                                       ),
                                   1,
                                   ' '
                                  )                          --Order Type code
                            || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                          ' '
                                         ),
                                     25,
                                     ' '
                                    )
                            || RPAD (' ', 12, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                            || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                            || RPAD
                                  (NVL (vidheader (i).ship_to_customer_name,
                                        ' '
                                       ),
                                   30,
                                   ' '
                                  )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                            || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                     25,
                                     ' '
                                    )
                            || LPAD (NVL (TO_CHAR (ln_line_count), ' '),
                                     5,
                                     ' '
                                    )                             --nbroflines
                            || RPAD (' ', 1, ' ')
                            || RPAD
                                  (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                          -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || NVL
                                  (vidheader (i).specl_handlg_cd,
                                   RPAD (' ', 4, ' ')
                                  )
                                 --cursor value queried with default 4 spaces.
                            || NVL (TO_CHAR (vidheader (i).trx_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL
                                      (SUBSTR
                                          (vidheader (i).ship_to_location,
                                             INSTR
                                                (vidheader (i).ship_to_location,
                                                 '-'
                                                )
                                           + 1
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                          --SHIP_TO_ADDR_ID
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD
                                  (NVL (vidheader (i).bill_to_name, ' '),
                                   30,
                                   ' '
                                  )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                            || RPAD
                                  (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                            || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 2, ' ')
                            || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                            || LPAD
                                  (NVL (TO_CHAR (ln_common_count), ' '),
                                   6,
                                   ' '
                                  )                        --ELEC FILE REC NBR
                            || LPAD
                                  (NVL (TO_CHAR (ln_detail_count), ' '),
                                   5,
                                   ' '
                                  )                          --ELEC DETAIL SEQ
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (lc_tiered_discount_rec.productcdentered,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )                       --product_cd_entered
                            || RPAD
                                  (NVL
                                      (lc_tiered_discount_rec.productcdentered,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )                          --cust_product_cd
                            || RPAD
                                  (NVL
                                      (lc_tiered_discount_rec.wholesaleprodcd,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )                            --whsle_prod_cd
                            || RPAD (' ', 3, ' ')
                            || RPAD (' ', 6, ' ')
                            || RPAD (' ', 14, ' ')
                            || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                            /*|| RPAD
                                  (NVL (lc_tiered_discount_rec.custpolinenbr,
                                        ln_detail_count
                                       ),
                                   9,
                                   ' '
                                  )--custpolinenbr  */  -- Commented for the defect 13488
                            || RPAD (NVL (lc_tiered_discount_rec.description,
                                          ' '
                                         ),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (lc_tiered_discount_rec.uom_code,
                                          ' '),
                                     2,
                                     ' '
                                    )
                            || TO_CHAR
                                  (NVL
                                      (lc_tiered_discount_rec.quantity_ordered,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (lc_tiered_discount_rec.quantity_invoiced,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (lc_tiered_discount_rec.backordered_qty,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_tiered_discount_rec.unit_selling_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_tiered_discount_rec.sku_list_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_tiered_discount_rec.extended_amount,
                                           0
                                          ),
                                       '999999990.99S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 7, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (lc_tiered_discount_rec.vendor_product_code,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                   (NVL (lc_tiered_discount_rec.taxable_flag,
                                         ' '
                                        ),
                                    1,
                                    ' '
                                   )
                            || RPAD (' ', 1, ' ')
                            --||lc_comments
                            || RPAD
                                  (   'Tiered discount: '
                                   || LPAD
                                         (TO_CHAR
                                             (NVL
                                                 (lc_tiered_discount_rec.extended_amount,
                                                  0
                                                 ),
                                              '999999990.99S'
                                             ),
                                          13,
                                          ' '
                                         )
                                   || ' has been applied to this order.',
                                   70,
                                   ' '
                                  )
                            || RPAD (' ', 8, ' ')
                            /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                            || RPAD (' ', 175, ' ')
                            || RPAD (NVL (vidheader (i).trx_number, ' '),
                                     20,
                                     ' '
                                    )
                            || RPAD
                                  (NVL (vidheader (i).bill_to_customer_number,
                                        ' '
                                       ),
                                   15,
                                   ' '
                                  )
							|| RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                    || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                            || 'X'
                            ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                           );
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                        /*   fnd_file.put_line
                                 (fnd_file.output,
                                     'Error @ MS type for Tiered Discount...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                  || SQLERRM
                                 ); */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                           p_status_code := 'E';
                           p_error_msg := 'Error @ MS type for Tiered Discount...' || SQLERRM;
                           RAISE;
     --====End of Changes for the defect 12435====--
                     END;
                  END IF;

                  CLOSE lc_tiered_discount;

lc_error_location := 'Opening lc_bulk_discount in generate_file';      --Added as a part of defect 12673
               lc_error_debug    := 'Bulk_discount for the transaction ID --'         --Added as a part of defect 12673
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_bulk_discount (vidheader (i).customer_trx_id,
                                        lc_trx_class,
                                        lc_invoice_source
                                       );

               FETCH lc_bulk_discount
                INTO lc_bulk_discount_rec;

               IF lc_bulk_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;

                  fnd_file.put_line (fnd_file.log, ' Starting the file Cursor '); --Testing
                  fnd_file.put_line (fnd_file.output, ' Starting the file Cursor '); --Testing

                  BEGIN
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_bulk_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_bulk_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_bulk_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')  --custpolinenbr --Added for the defect 13488
                         /*|| RPAD(NVL(lc_bulk_discount_rec.custpolinenbr,
                                     ln_detail_count
                                     ),9,' ')  --custpolinenbr  */  -- Commented for the defect 13488
                         || RPAD (NVL (lc_bulk_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_bulk_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_bulk_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_bulk_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_bulk_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_bulk_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_bulk_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_bulk_discount_rec.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_bulk_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_bulk_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         --||lc_comments
                         || RPAD
                               (   'Bulk discount: '
                                || LPAD
                                      (TO_CHAR
                                          (NVL
                                              (lc_bulk_discount_rec.extended_amount,
                                               0
                                              ),
                                           '999999990.99S'
                                          ),
                                       13,
                                       ' '
                                      )
                                || ' has been applied to this order.',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                         || RPAD                                                          -- added for defect 8927
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                 || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        fnd_file.put_line
                                 (fnd_file.output,
                                     'Error @ MS type for Bulk Discount...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                  || SQLERRM
                                 );
                        RAISE;
                  END;
               END IF;
               CLOSE lc_bulk_discount;
     --Defect#12673- Changes complete

-- Start of Changes for Prod Defect # 2025
-- =====================================================================================
-- Should be the second invoice detail line.
-- Process Coupon Discount, one line per Invoice.
-- We use record type MS. We copy the description "COUPON" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_coupon_discount_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
            IF (ln_total_coupon_amt <> 0) THEN
               lc_error_location_info := 'Opening lc_coupon_discount in generate_file';
               lc_error_debug_info    := 'Coupon_discount for the transaction ID --'
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_coupon_discount (vidheader (i).customer_trx_id,
                                        ln_total_coupon_amt
                                       );

               FETCH lc_coupon_discount
                INTO lc_coupon_discount_rec;

               IF lc_coupon_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_common_count := ln_common_count + 1;
                  ln_detail_count := ln_detail_count + 1;
                  BEGIN
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                  --RPAD(NVL(lc_addraliasname ,' ') ,20 ,' ')  --ADDRALIASNAME
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                               (NVL (TO_CHAR (ln_common_count), ' '), 6, ' ')
                                                           --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_coupon_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_coupon_discount_rec.custprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_coupon_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')  --custpolinenbr
                         || RPAD (NVL (lc_coupon_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_coupon_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_coupon_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_coupon_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_coupon_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_coupon_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_coupon_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_coupon_discount_rec.extended_amount,
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_coupon_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_coupon_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         --||lc_comments
                         || RPAD
                               (   'Coupon discount: '
                                || LPAD
                                      (TO_CHAR
                                          (NVL
                                              (lc_coupon_discount_rec.extended_amount,
                                               0
                                              ),
                                           '999999990.99S'
                                          ),
                                       13,
                                       ' '
                                      )
                                || ' has been applied to this order.',
                                70,
                                ' '
                               )
                         || RPAD (' ', 8, ' ')
                        || RPAD
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                 || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        RAISE;
                  END;
               END IF;
               CLOSE lc_coupon_discount;
            END IF;
-- End of changes for Prod Defect # 2025

-- =====================================================================================
-- Should be the first invoice detail line.
-- Process Association Discount, one line per Invoice.
-- We use record type MS. We copy the description "Association Discount" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_Association_Discount_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
                  --ln_detail_count := 0;  Commented for the defect 13486

                  lc_error_location_info := 'Opening lc_association_discount in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lc_association_discount for --'                                 --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lc_association_discount (vidheader (i).customer_trx_id,
                                                lc_trx_class,
                                                lc_invoice_source
                                               );

                  FETCH lc_association_discount
                   INTO lc_association_discount_rec;

                  IF lc_association_discount%FOUND
                  THEN
                     lc_elecrectype := 'MS';
                     ln_common_count := ln_common_count + 1;
                     ln_detail_count := ln_detail_count + 1;

                     BEGIN
                        --fnd_file.put_line(fnd_file.output ,'MS');
                        UTL_FILE.put_line
                           (lc_file_handle,
                               RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                         --BILL_CUSTOMER_ID
                            || RPAD (NVL (vidheader (i).cons_billing_number,
                                          ' '
                                         ),
                                     9,
                                     ' '
                                    )
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (vidheader (i).interface_header_attribute1,
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )
                             -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                            || RPAD (NVL (vidheader (i).phone_number, ' '),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                            || RPAD (' ', 18, ' ')                    --FILLER
                            || RPAD (NVL (lc_addrid, ' '), 9, ' ')    --ADDRID
                            || RPAD (NVL (vidheader (i).invoice_currency_code,
                                          ' '
                                         ),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                            || RPAD (NVL (vidheader (i).purchase_order_number,
                                          ' '
                                         ),
                                     22,
                                     ' '
                                    )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.release_number,
                                       ' '
                                      ),
                                   12,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL (get_om_details_rec_type.desk_del_addr,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                                 --CHILD_ID
                            || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).bus_name, ' '),
                                     40,
                                     ' '
                                    )
                            || NVL (TO_CHAR (vidheader (i).due_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                            || RPAD
                                  (NVL (vidheader (i).tax_registration_number,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )
                            || RPAD (' ', 7, ' ')
                            || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            || lc_pos_acct_nbr                  --SPC ACCT NBR
                            || lc_pos_tran_nbr              --SPC TRANS NUMBER
                            || lc_pos_reg_nbr                 --SPC REG NUMBER
                            || NVL
                                  (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                   RPAD (' ', 8, ' ')
                                  )
                            || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                             'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL (vidheader (i).ordsourcecd, ' '),
                                   1,
                                   ' '
                                  )                              --ordsourcecd
                            || RPAD
                                  (NVL (get_om_details_rec_type.ordcreateid,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )                              --ordgreateid
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.placement_method_code,
                                       ' '
                                      ),
                                   1,
                                   ' '
                                  )
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                              --Pickup Date
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                           --Reconcile Date
                            || RPAD
                                  (NVL (get_om_details_rec_type.custtypecd,
                                        ' '
                                       ),
                                   1,
                                   ' '
                                  )                          --Order Type code
                            || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                          ' '
                                         ),
                                     25,
                                     ' '
                                    )
                            || RPAD (' ', 12, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                            || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                            || RPAD
                                  (NVL (vidheader (i).ship_to_customer_name,
                                        ' '
                                       ),
                                   30,
                                   ' '
                                  )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                            || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                     25,
                                     ' '
                                    )
                            || LPAD (NVL (TO_CHAR (ln_line_count), ' '),
                                     5,
                                     ' '
                                    )                             --nbroflines
                            || RPAD (' ', 1, ' ')
                            || RPAD
                                  (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                           -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || NVL
                                  (vidheader (i).specl_handlg_cd,
                                   RPAD (' ', 4, ' ')
                                  )
                                 --cursor value queried with default 4 spaces.
                            || NVL (TO_CHAR (vidheader (i).trx_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL
                                      (SUBSTR
                                          (vidheader (i).ship_to_location,
                                             INSTR
                                                (vidheader (i).ship_to_location,
                                                 '-'
                                                )
                                           + 1
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                          --SHIP_TO_ADDR_ID
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD
                                  (NVL (vidheader (i).bill_to_name, ' '),
                                   30,
                                   ' '
                                  )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                            || RPAD
                                  (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                            || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 2, ' ')
                            || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                            || LPAD
                                  (NVL (TO_CHAR (ln_common_count), ' '),
                                   6,
                                   ' '
                                  )                        --ELEC FILE REC NBR
                            || LPAD
                                  (NVL (TO_CHAR (ln_detail_count), ' '),
                                   5,
                                   ' '
                                  )                          --ELEC DETAIL SEQ
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (lc_association_discount_rec.productcdentered,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )                       --product_cd_entered
                            || RPAD
                                  (NVL
                                      (lc_association_discount_rec.productcdentered,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )                          --cust_product_cd
                            || RPAD
                                  (NVL
                                      (lc_association_discount_rec.wholesaleprodcd,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )                            --whsle_prod_cd
                            || RPAD (' ', 3, ' ')
                            || RPAD (' ', 6, ' ')
                            || RPAD (' ', 14, ' ')
                            || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                           /* || RPAD
                                  (NVL
                                      (lc_association_discount_rec.custpolinenbr,
                                       ln_detail_count
                                      ),
                                   9,
                                   ' '
                                  ) --custpolinenbr  */  -- Commented for the defect 13488
                            || RPAD
                                  (NVL
                                      (lc_association_discount_rec.description,
                                       ' '
                                      ),
                                   30,
                                   ' '
                                  )
                            || RPAD
                                  (NVL (lc_association_discount_rec.uom_code,
                                        ' '
                                       ),
                                   2,
                                   ' '
                                  )
                            || TO_CHAR
                                  (NVL
                                      (lc_association_discount_rec.quantity_ordered,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (lc_association_discount_rec.quantity_invoiced,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (lc_association_discount_rec.backordered_qty,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_association_discount_rec.unit_selling_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_association_discount_rec.sku_list_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_association_discount_rec.extended_amount,
                                           0
                                          ),
                                       '999999990.99S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 7, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (lc_association_discount_rec.vendor_product_code,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (lc_association_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                   1,
                                   ' '
                                  )
                            || RPAD (' ', 1, ' ')
                            --||lc_comments
                            || RPAD
                                  (   'Association discount: '
                                   || LPAD
                                         (TO_CHAR
                                             (NVL
                                                 (lc_association_discount_rec.extended_amount,
                                                  0
                                                 ),
                                              '999999990.99S'
                                             ),
                                          13,
                                          ' '
                                         )
                                   || ' has been applied to this order.',
                                   70,
                                   ' '
                                  )
                            || RPAD (' ', 8, ' ')
                            /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                            || RPAD (' ', 175, ' ')
                            || RPAD (NVL (vidheader (i).trx_number, ' '),
                                     20,
                                     ' '
                                    )
                            || RPAD
                                  (NVL (vidheader (i).bill_to_customer_number,
                                        ' '
                                       ),
                                   15,
                                   ' '
                                  )
							|| RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                    || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                            || 'X'
                            ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                           );
                    EXCEPTION
                        WHEN OTHERS
                        THEN
               /*            fnd_file.put_line
                              (fnd_file.output,
                                  'Error @ MS type for Association Discount...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                               || SQLERRM
                              );
                */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                           p_status_code := 'E';
                           p_error_msg := 'Error @ MS type for Association Discount...' || SQLERRM;
                           RAISE;
     --====End of Changes for the defect 12435====--
                     END;
                  END IF;

                  CLOSE lc_association_discount;

-- =====================================================================================
-- Should be the first invoice detail line.
-- Process GSA Comment, one line per Invoice.
-- We use record type MS. We copy the description "GSA Comment" into the
-- SKU Description field.
-- Cursor record variable: RPAD(NVL(lc_GSA_Comment_rec.description ,' ') ,30 ,' ')
-- =====================================================================================
                  --ln_detail_count := 0;  Commented for the defect 13486

                  lc_error_location_info := 'Opening lc_gsa_comment in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lc_gsa_comment for --'                                 --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lc_gsa_comment (vidheader (i).customer_trx_id,
                                       lc_trx_class,
                                       lc_invoice_source
                                      );

                  FETCH lc_gsa_comment
                   INTO lc_gsa_comment_rec;

                  IF lc_gsa_comment%FOUND
                  THEN
                     lc_elecrectype := 'MS';
                     ln_common_count := ln_common_count + 1;
                     ln_detail_count := ln_detail_count + 1;

                     BEGIN
                        --fnd_file.put_line(fnd_file.output ,'MS');
                        UTL_FILE.put_line
                           (lc_file_handle,
                               RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                         --BILL_CUSTOMER_ID
                            || RPAD (NVL (vidheader (i).cons_billing_number,
                                          ' '
                                         ),
                                     9,
                                     ' '
                                    )
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (vidheader (i).interface_header_attribute1,
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )
                           -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                            || RPAD (NVL (vidheader (i).phone_number, ' '),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                            || RPAD (' ', 18, ' ')                    --FILLER
                            || RPAD (NVL (lc_addrid, ' '), 9, ' ')    --ADDRID
                            || RPAD (NVL (vidheader (i).invoice_currency_code,
                                          ' '
                                         ),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                            || RPAD (NVL (vidheader (i).purchase_order_number,
                                          ' '
                                         ),
                                     22,
                                     ' '
                                    )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.release_number,
                                       ' '
                                      ),
                                   12,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL (get_om_details_rec_type.desk_del_addr,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                                 --CHILD_ID
                            || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).bus_name, ' '),
                                     40,
                                     ' '
                                    )
                            || NVL (TO_CHAR (vidheader (i).due_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                            || RPAD
                                  (NVL (vidheader (i).tax_registration_number,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )
                            || RPAD (' ', 7, ' ')
                            || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            || lc_pos_acct_nbr                  --SPC ACCT NBR
                            || lc_pos_tran_nbr              --SPC TRANS NUMBER
                            || lc_pos_reg_nbr                 --SPC REG NUMBER
                            || NVL
                                  (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                   RPAD (' ', 8, ' ')
                                  )
                            || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                             'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL (vidheader (i).ordsourcecd, ' '),
                                   1,
                                   ' '
                                  )                              --ordsourcecd
                            || RPAD
                                  (NVL (get_om_details_rec_type.ordcreateid,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )                              --ordgreateid
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.placement_method_code,
                                       ' '
                                      ),
                                   1,
                                   ' '
                                  )
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                              --Pickup Date
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                           --Reconcile Date
                            || RPAD
                                  (NVL (get_om_details_rec_type.custtypecd,
                                        ' '
                                       ),
                                   1,
                                   ' '
                                  )                          --Order Type code
                            || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                          ' '
                                         ),
                                     25,
                                     ' '
                                    )
                            || RPAD (' ', 12, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                            || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                            || RPAD
                                  (NVL (vidheader (i).ship_to_customer_name,
                                        ' '
                                       ),
                                   30,
                                   ' '
                                  )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                            || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                     25,
                                     ' '
                                    )
                            || LPAD (NVL (TO_CHAR (ln_line_count), ' '),
                                     5,
                                     ' '
                                    )                             --nbroflines
                            || RPAD (' ', 1, ' ')
                            || RPAD
                                  (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                            -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || NVL
                                  (vidheader (i).specl_handlg_cd,
                                   RPAD (' ', 4, ' ')
                                  )
                                 --cursor value queried with default 4 spaces.
                            || NVL (TO_CHAR (vidheader (i).trx_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL
                                      (SUBSTR
                                          (vidheader (i).ship_to_location,
                                             INSTR
                                                (vidheader (i).ship_to_location,
                                                 '-'
                                                )
                                           + 1
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                          --SHIP_TO_ADDR_ID
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD
                                  (NVL (vidheader (i).bill_to_name, ' '),
                                   30,
                                   ' '
                                  )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                            || RPAD
                                  (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                            || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 2, ' ')
                            || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                            || LPAD
                                  (NVL (TO_CHAR (ln_common_count), ' '),
                                   6,
                                   ' '
                                  )                        --ELEC FILE REC NBR
                            || LPAD
                                  (NVL (TO_CHAR (ln_detail_count), ' '),
                                   5,
                                   ' '
                                  )                          --ELEC DETAIL SEQ
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL (lc_gsa_comment_rec.productcdentered,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )                       --product_cd_entered
                            || RPAD
                                  (NVL (lc_gsa_comment_rec.productcdentered,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )                          --cust_product_cd
                            || RPAD
                                  (NVL (lc_gsa_comment_rec.wholesaleprodcd,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )                            --whsle_prod_cd
                            || RPAD (' ', 3, ' ')
                            || RPAD (' ', 6, ' ')
                            || RPAD (' ', 14, ' ')
                            || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                            /*|| RPAD
                                  (NVL (lc_gsa_comment_rec.custpolinenbr,
                                        ln_detail_count
                                       ),
                                   9,
                                   ' '
                                  )  --custpolinenbr  */  -- Commented for the defect 13488
                            || RPAD (NVL (lc_gsa_comment_rec.description, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (lc_gsa_comment_rec.uom_code, ' '),
                                     2,
                                     ' '
                                    )
                            || TO_CHAR
                                   (NVL (lc_gsa_comment_rec.quantity_ordered,
                                         0
                                        ),
                                    '09999S'
                                   )
                            || TO_CHAR
                                  (NVL (lc_gsa_comment_rec.quantity_invoiced,
                                        0
                                       ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                    (NVL (lc_gsa_comment_rec.backordered_qty,
                                          0
                                         ),
                                     '09999S'
                                    )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_gsa_comment_rec.unit_selling_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD
                                  (TO_CHAR
                                      (NVL (lc_gsa_comment_rec.sku_list_price,
                                            0
                                           ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (lc_gsa_comment_rec.extended_amount,
                                           0
                                          ),
                                       '999999990.99S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 7, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (lc_gsa_comment_rec.vendor_product_code,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD (NVL (lc_gsa_comment_rec.taxable_flag,
                                          ' '),
                                     1,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            -- ||lc_comments
                            || RPAD
                                  ('GSA Y: On Federal Supply Schedule; GSA N: Not On Federal Supply Schedule',
                                   70,
                                   ' '
                                  )
                            || RPAD (' ', 8, ' ')
                            /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                            || RPAD (' ', 175, ' ')
                            || RPAD (NVL (vidheader (i).trx_number, ' '),
                                     20,
                                     ' '
                                    )
                            || RPAD
                                  (NVL (vidheader (i).bill_to_customer_number,
                                        ' '
                                       ),
                                   15,
                                   ' '
                                  )
							|| RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                    || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                            || 'X'
                            ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                           );
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                  /*         fnd_file.put_line
                                     (fnd_file.output,
                                         'Error @ MS type for GSA Comment...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                      || SQLERRM
                                     );  */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                           p_status_code := 'E';
                           p_error_msg := 'Error @ MS type for GSA Comment...' || SQLERRM;
                           RAISE;
     --====End of Changes for the defect 12435====--
                     END;
                  END IF;

                  CLOSE lc_gsa_comment;

--============================================================================
--Fetching the Miscellaneous charges if found and inserting then in the File
--============================================================================

                  lc_error_location_info := 'Opening lcu_charges_lines in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lcu_charges_lines for --'                                 --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lcu_charges_lines (vidheader (i).customer_trx_id,
                                          lc_misc_charges,
                                          lc_trx_class,
                                          lc_invoice_source
                                         );

                  FETCH lcu_charges_lines
                   INTO misc_charge_rec_type;

                  IF lcu_charges_lines%FOUND
                  THEN
                     lc_elecrectype := 'MS';
                     ln_common_count := ln_common_count + 1;
                     ln_detail_count := ln_detail_count + 1;

                     BEGIN
                        --fnd_file.put_line(fnd_file.output ,'MS');
                        UTL_FILE.put_line
                           (lc_file_handle,
                               RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                         --BILL_CUSTOMER_ID
                            || RPAD (NVL (vidheader (i).cons_billing_number,
                                          ' '
                                         ),
                                     9,
                                     ' '
                                    )
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (vidheader (i).interface_header_attribute1,
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )
                              -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                            || RPAD (NVL (vidheader (i).phone_number, ' '),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                            || RPAD (' ', 18, ' ')                    --FILLER
                            || RPAD (NVL (lc_addrid, ' '), 9, ' ')    --ADDRID
                            || RPAD (NVL (vidheader (i).invoice_currency_code,
                                          ' '
                                         ),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                            || RPAD (NVL (vidheader (i).purchase_order_number,
                                          ' '
                                         ),
                                     22,
                                     ' '
                                    )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.release_number,
                                       ' '
                                      ),
                                   12,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL (get_om_details_rec_type.desk_del_addr,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                                 --CHILD_ID
                            || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).bus_name, ' '),
                                     40,
                                     ' '
                                    )
                            || NVL (TO_CHAR (vidheader (i).due_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                            || RPAD
                                  (NVL (vidheader (i).tax_registration_number,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )
                            || RPAD (' ', 7, ' ')
                            || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            || lc_pos_acct_nbr                  --SPC ACCT NBR
                            || lc_pos_tran_nbr              --SPC TRANS NUMBER
                            || lc_pos_reg_nbr                 --SPC REG NUMBER
                            || NVL
                                  (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                   RPAD (' ', 8, ' ')
                                  )
                            || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                             'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL (vidheader (i).ordsourcecd, ' '),
                                   1,
                                   ' '
                                  )                              --ordsourcecd
                            || RPAD
                                  (NVL (get_om_details_rec_type.ordcreateid,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )                              --ordgreateid
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.placement_method_code,
                                       ' '
                                      ),
                                   1,
                                   ' '
                                  )
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                              --Pickup Date
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                           --Reconcile Date
                            || RPAD
                                  (NVL (get_om_details_rec_type.custtypecd,
                                        ' '
                                       ),
                                   1,
                                   ' '
                                  )                          --Order Type code
                            || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                          ' '
                                         ),
                                     25,
                                     ' '
                                    )
                            || RPAD (' ', 12, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                            || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                            || RPAD
                                  (NVL (vidheader (i).ship_to_customer_name,
                                        ' '
                                       ),
                                   30,
                                   ' '
                                  )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                            || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                     25,
                                     ' '
                                    )
                            || LPAD (NVL (TO_CHAR (ln_line_count), ' '),
                                     5,
                                     ' '
                                    )                             --nbroflines
                            || RPAD (' ', 1, ' ')
                            || RPAD
                                  (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                            -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || NVL
                                  (vidheader (i).specl_handlg_cd,
                                   RPAD (' ', 4, ' ')
                                  )
                                 --cursor value queried with default 4 spaces.
                            || NVL (TO_CHAR (vidheader (i).trx_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL
                                      (SUBSTR
                                          (vidheader (i).ship_to_location,
                                             INSTR
                                                (vidheader (i).ship_to_location,
                                                 '-'
                                                )
                                           + 1
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                          --SHIP_TO_ADDR_ID
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD
                                  (NVL (vidheader (i).bill_to_name, ' '),
                                   30,
                                   ' '
                                  )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                            || RPAD
                                  (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                            || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 2, ' ')
                            || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                            || LPAD
                                  (NVL (TO_CHAR (ln_common_count), ' '),
                                   6,
                                   ' '
                                  )                        --ELEC FILE REC NBR
                            || LPAD
                                  (NVL (TO_CHAR (ln_detail_count), ' '),
                                   5,
                                   ' '
                                  )                          --ELEC DETAIL SEQ
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL (misc_charge_rec_type.productcdentered,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )                       --product_cd_entered
                            || RPAD
                                  (NVL (misc_charge_rec_type.productcdentered,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )                          --cust_product_cd
                            || RPAD
                                  (NVL (misc_charge_rec_type.wholesaleprodcd,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )                            --whsle_prod_cd
                            || RPAD (' ', 3, ' ')
                            || RPAD (' ', 6, ' ')
                            || RPAD (' ', 14, ' ')
                            || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                            /*|| RPAD
                                  (NVL (misc_charge_rec_type.custpolinenbr,
                                        ln_detail_count
                                       ),
                                   9,
                                   ' '
                                  )--custpolinenbr  */  -- Commented for the defect 13488
                            || RPAD (NVL (misc_charge_rec_type.description,
                                          ' '
                                         ),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (misc_charge_rec_type.uom_code, ' '),
                                     2,
                                     ' '
                                    )
                            || TO_CHAR
                                  (NVL (misc_charge_rec_type.quantity_ordered,
                                        0
                                       ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (misc_charge_rec_type.quantity_invoiced,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL (misc_charge_rec_type.backordered_qty,
                                        0
                                       ),
                                   '09999S'
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (misc_charge_rec_type.unit_selling_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (misc_charge_rec_type.sku_list_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (misc_charge_rec_type.extended_amount,
                                           0
                                          ),
                                       '999999990.99S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 7, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (misc_charge_rec_type.vendor_product_code,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD (NVL (misc_charge_rec_type.taxable_flag,
                                          ' '
                                         ),
                                     1,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            || lc_comments
                            || RPAD (' ', 8, ' ')
                            /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                            || RPAD (' ', 175, ' ')
                            || RPAD (NVL (vidheader (i).trx_number, ' '),
                                     20,
                                     ' '
                                    )
                            || RPAD
                                  (NVL (vidheader (i).bill_to_customer_number,
                                        ' '
                                       ),
                                   15,
                                   ' '
                                  )
							|| RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                    || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                            || 'X'
                            ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                           );
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                      /*     fnd_file.put_line (fnd_file.output,
                                              'Error @ MS type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..' || SQLERRM
                                             );
                     */ --Commented for Defect # 1742

     --====Start of Changes for the defect 12435====--
                           p_status_code := 'E';
                           p_error_msg := 'Error @ MS type...' || SQLERRM;
                           RAISE;
     --====End of Changes for the defect 12435====--
                     END;
                  END IF;

                  CLOSE lcu_charges_lines;

--===============================================================
--Fetching the Line level data and inserting then in the File
--===============================================================
                  ln_detail_line_count := 0;  --Added for the defect 13488
                  lc_error_location_info := 'Opening lcu_line in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lcu_line for --'                                 --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lcu_line (vidheader (i).customer_trx_id,
                                 lc_trx_class,
                                 lc_invoice_source
                                );

                  LOOP
                     FETCH lcu_line
                     BULK COLLECT INTO vidline LIMIT 100;

                     EXIT WHEN vidline.COUNT = 0;

                     IF vidline.COUNT > 0
                     THEN
                        FOR j IN vidline.FIRST .. vidline.LAST
                        LOOP
                           lc_elecrectype := 'DT';
                           ln_common_count := ln_common_count + 1;
                           ln_detail_count := ln_detail_count + 1;
                           ln_detail_line_count  := ln_detail_line_count + 1;  --Added for the defect 13488

                           lc_error_location_info := 'Opening lcu_get_ship_date_item in generate_info_copy_file';    --Added as a part of defect 11993
                           lc_error_debug_info    := 'lcu_get_ship_date_item for --'                                 --Added as a part of defect 11993
                                                      ||TO_NUMBER(vidline (j).interface_line_attribute6);

                           OPEN lcu_get_ship_date_item
                                  (TO_NUMBER
                                         (vidline (j).interface_line_attribute6
                                         )
                                  );

                           FETCH lcu_get_ship_date_item
                            INTO ld_reconcile_date, lc_ordered_item;

                           CLOSE lcu_get_ship_date_item;
			-- Start of Kitting Changes , Defect # 37670
                        ln_kit_extended_amt := NULL;
			            ln_kit_unit_price   := NULL;			
					    IF vidline (j).bill_level = 'K'
		                   THEN
		                      lc_error_location := 'Calling package XX_AR_EBL_COMMON_UTIL_PKG.get_kit_extended_amount in generate_file';
			                  lc_error_debug    := 'To get the KIT Extended Amount and KIT unit price for Customer Transaction ID :'||vidheader (i).customer_trx_id;
		                      XX_AR_EBL_COMMON_UTIL_PKG.get_kit_extended_amount( p_customer_trx_id      => vidheader (i).customer_trx_id,
		                                                                         p_sales_order_line_id  => vidline (j).interface_line_attribute6,
											                                     p_kit_quantity         => vidline (j).quantity,
											                                     x_kit_extended_amt     => ln_kit_extended_amt,
											                                     x_kit_unit_price       => ln_kit_unit_price
											                                   );
			  
			                  vidline (j).unit_selling_price := ln_kit_unit_price;
			                  vidline (j).sku_list_price     := ln_kit_unit_price;
			                  vidline (j).extended_amount    := ln_kit_extended_amt;
			 
		                END IF;
		                
						lc_kit_item_description := NULL;
						lc_kit_sku := NULL;
		                IF vidline (j).bill_level = 'D'
		                  THEN
		                   BEGIN
		                      lc_error_debug    := 'Get the KIT item description for KIT item :'||vidline (j).kit_item ;
		                      SELECT description, segment1
			                    INTO lc_kit_item_description, lc_kit_sku
			                    FROM mtl_system_items_b
			                   WHERE segment1 = vidline (j).kit_item
			                     AND organization_id = gn_item_master_org;
		                  EXCEPTION
		                    WHEN OTHERS THEN
			                lc_error_debug    := 'Unable to get the KIT item description for KIT item :'||vidline (j).kit_item ;
			                lc_kit_item_description := NULL;
							lc_kit_sku := NULL;
		                  END;
	                    END IF;
            -- End of Kitting Changes , Defect #37670
                           lc_get_warehouse_name :=
                              get_warehouse_name
                                        (vidline (j).interface_line_attribute10
                                        );
              /*             fnd_file.put_line(fnd_file.output ,'Warehouse Name'||lc_get_warehouse_name);  --Added as a part of defect 11993
              */ --Commented for Defect # 1742
                           BEGIN
                              --fnd_file.put_line(fnd_file.output ,'DT');
                              IF (    (NVL (vidline (j).backordered_qty, 0) >
                                                                             0
                                      )
                                  AND (NVL (ln_ordersub_total, 0) > 0)
                                 )
                              THEN
                                 lc_partial_shipment := 'Y';
                              ELSE
                                 lc_partial_shipment := 'N';
                              END IF;

                              UTL_FILE.put_line
                                 (lc_file_handle,
                                     RPAD
                                        (NVL
                                            (REPLACE
                                                (vidheader (i).orig_system_reference,
                                                 '-',
                                                 ''
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                   --BILL_CUSTOMER_ID
                                  || RPAD
                                        (NVL
                                            (vidheader (i).cons_billing_number,
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL
                                            (vidheader (i).interface_header_attribute1,
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )
                                -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                                  || RPAD (NVL (vidheader (i).phone_number,
                                                ' '
                                               ),
                                           11,
                                           ' '
                                          )
                                  || RPAD (NVL (lc_cust_phone_ext, ' '),
                                           4,
                                           ' '
                                          )
                                  || RPAD (' ', 18, ' ')              --FILLER
                                  || RPAD (NVL (lc_addrid, ' '), 9, ' ')
                                                                      --ADDRID
                                  || RPAD
                                        (NVL
                                            (vidheader (i).invoice_currency_code,
                                             ' '
                                            ),
                                         3,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL (lc_xaddr_alias_name, ' '),
                                         20,
                                         ' '
                                        )                      --ADDRALIASNAME
                                  || RPAD
                                        (NVL
                                            (vidheader (i).purchase_order_number,
                                             ' '
                                            ),
                                         22,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.release_number,
                                             ' '
                                            ),
                                         12,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.cost_center_dept,
                                             ' '
                                            ),
                                         20,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.desk_del_addr,
                                             ' '
                                            ),
                                         20,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (REPLACE
                                                (vidheader (i).orig_system_reference,
                                                 '-',
                                                 ''
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                           --CHILD_ID
                                  || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD (NVL (vidheader (i).bus_name, ' '),
                                           40,
                                           ' '
                                          )
                                  || NVL (TO_CHAR (vidheader (i).due_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD (NVL (vidheader (i).NAME, ' '),
                                           20,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).tax_registration_number,
                                             ' '
                                            ),
                                         10,
                                         ' '
                                        )
                                  || RPAD (' ', 7, ' ')
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_misc_chrg,
                                                         0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD
                                         (TO_CHAR (NVL (ln_total_deliv_chrg,
                                                        0),
                                                   '9999990.99S'
                                                  ),
                                          11,
                                          ' '
                                         )
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD
                                         (TO_CHAR (NVL (ln_total_coupon_amt,
                                                        0),
                                                   '9999990.99S'
                                                  ),
                                          11,
                                          ' '
                                         )
                                  || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || RPAD (' ', 1, ' ')
                                  || lc_pos_acct_nbr            --SPC ACCT NBR
                                  || lc_pos_tran_nbr        --SPC TRANS NUMBER
                                  || lc_pos_reg_nbr           --SPC REG NUMBER
                                  || NVL
                                        (TO_CHAR
                                            (get_shipping_rec_type.ordered_date,
                                             'YYYYMMDD'
                                            ),
                                         RPAD (' ', 8, ' ')
                                        )
                                  || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD
                                        (NVL (vidheader (i).ordsourcecd, ' '),
                                         1,
                                         ' '
                                        )                        --ordsourcecd
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.ordcreateid,
                                             ' '
                                            ),
                                         10,
                                         ' '
                                        )                        --ordgreateid
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.placement_method_code,
                                             ' '
                                            ),
                                         1,
                                         ' '
                                        )
                                  || NVL
                                        (TO_CHAR (ld_hd_ordcompletedate,
                                                  'YYYYMMDD'
                                                 ),
                                         RPAD (' ', 8, ' ')
                                        )                        --Pickup Date
                                  || NVL
                                        (TO_CHAR (ld_hd_ordcompletedate,
                                                  'YYYYMMDD'
                                                 ),
                                         RPAD (' ', 8, ' ')
                                        )                     --Reconcile Date
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.custtypecd,
                                             ' '
                                            ),
                                         1,
                                         ' '
                                        )                    --Order Type code
                                  || RPAD
                                        (NVL
                                            (vidheader (i).primary_salesrep_name,
                                             ' '
                                            ),
                                         25,
                                         ' '
                                        )
                                  || RPAD (' ', 12, ' ')
                                  || RPAD (' ', 4, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || RPAD (NVL (lc_ship_to_addr_flag, ' '),
                                           1,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                                  || RPAD
                                        (NVL
                                            (vidheader (i).ship_to_customer_name,
                                             ' '
                                            ),
                                         30,
                                         ' '
                                        )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                                  || RPAD
                                         (NVL (vidheader (i).ship_to_address1,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD
                                         (NVL (vidheader (i).ship_to_address2,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD (NVL (vidheader (i).ship_to_city,
                                                ' '
                                               ),
                                           28,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).ship_to_state,
                                                ' '
                                               ),
                                           2,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).ship_to_postal_code,
                                             ' '
                                            ),
                                         11,
                                         ' '
                                        )
                                  || RPAD (NVL (vidheader (i).ship_to_country,
                                                ' '
                                               ),
                                           3,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).ship_to_contact,
                                                ' '
                                               ),
                                           25,
                                           ' '
                                          )
                                  || LPAD
                                        (NVL (TO_CHAR (ln_line_count), ' '),
                                         5,
                                         ' '
                                        )                         --nbroflines
                                  || RPAD (' ', 1, ' ')
                                  || RPAD
                                        (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                            -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || NVL
                                        (vidheader (i).specl_handlg_cd,
                                         RPAD (' ', 4, ' ')
                                        )
                                 --cursor value queried with default 4 spaces.
                                  || NVL (TO_CHAR (vidheader (i).trx_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD
                                        (NVL
                                            (SUBSTR
                                                (vidheader (i).ship_to_location,
                                                   INSTR
                                                      (vidheader (i).ship_to_location,
                                                       '-'
                                                      )
                                                 + 1
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                    --SHIP_TO_ADDR_ID
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 4, ' ')
                                  || RPAD
                                        (NVL (vidheader (i).bill_to_name, ' '),
                                         30,
                                         ' '
                                        )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                                  || RPAD
                                        (NVL (lc_xmail_site_name, ' '),
                                         30,
                                         ' '
                                        )
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                                  || RPAD
                                         (NVL (vidheader (i).bill_to_address1,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD
                                         (NVL (vidheader (i).bill_to_address2,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD (NVL (vidheader (i).bill_to_city,
                                                ' '
                                               ),
                                           28,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).bill_to_state,
                                                ' '
                                               ),
                                           2,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).bill_to_postal_code,
                                             ' '
                                            ),
                                         11,
                                         ' '
                                        )
                                  || RPAD (NVL (vidheader (i).bill_to_country,
                                                ' '
                                               ),
                                           3,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).bill_to_attn,
                                                ' '
                                               ),
                                           30,
                                           ' '
                                          )
                                  || RPAD (' ', 9, ' ')
                                  || RPAD (' ', 2, ' ')
                                  || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                                  || LPAD
                                        (NVL (TO_CHAR (ln_common_count), ' '),
                                         6,
                                         ' '
                                        )                  --ELEC FILE REC NBR
                                  || LPAD
                                        (NVL (TO_CHAR (ln_detail_count), ' '),
                                         5,
                                         ' '
                                        )                    --ELEC DETAIL SEQ
                                  || RPAD
                                        (NVL (vidline (j).item_number, ' '),
                                         9,
                                         ' '
                                        )      --item number for DT records...
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL (vidline (j).productcdentered,
                                              ' '
                                             ),
                                         20,
                                         ' '
                                        )                 --product_cd_entered
                                  || RPAD
                                        (NVL (vidline (j).productcdentered,
                                              ' '
                                             ),
                                         20,
                                         ' '
                                        )                    --cust_product_cd
                                  || RPAD
                                        (NVL (vidline (j).wholesaleprodcd,
                                              ' '),
                                         20,
                                         ' '
                                        )                      --whsle_prod_cd
                                  || RPAD (' ', 3, ' ')
                                  || RPAD (' ', 6, ' ')
                                  || RPAD (' ', 14, ' ')
                                  || RPAD
                                        (NVL (vidline (j).custpolinenbr,
                                              ln_detail_line_count  --Added for the defect 13488
                                              --ln_detail_count     --Commented for the defect 13488
                                             ),
                                         9,
                                         ' '
                                        )                      --custpolinenbr
                                  || RPAD (NVL (vidline (j).item_description,
                                                ' '
                                               ),
                                           30,
                                           ' '
                                          )
                                  || RPAD (NVL (vidline (j).uom_code, ' '),
                                           2,
                                           ' '
                                          )
                                  || TO_CHAR
                                           (NVL (vidline (j).quantity_ordered,
                                                 0
                                                ),
                                            '09999S'
                                           )
                                  || TO_CHAR (NVL (vidline (j).quantity, 0),
                                              '09999S'
                                             )
                                  || TO_CHAR
                                            (NVL (vidline (j).backordered_qty,
                                                  0
                                                 ),
                                             '09999S'
                                            )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD
                                        (TO_CHAR
                                            (NVL
                                                (vidline (j).unit_selling_price,
                                                 0
                                                ),
                                             '99999990.999S'
                                            ),
                                         13,
                                         ' '
                                        )
                                  || LPAD
                                        (TO_CHAR
                                             (NVL (vidline (j).sku_list_price,
                                                   0
                                                  ),
                                              '99999990.999S'
                                             ),
                                         13,
                                         ' '
                                        )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD
                                        (TO_CHAR
                                            (NVL (vidline (j).extended_amount,
                                                  0
                                                 ),
                                             '999999990.99S'
                                            ),
                                         13,
                                         ' '
                                        )
                                  || RPAD (NVL (vidline (j).contract_cd, ' '),
                                           1,
                                           ' '
                                          )
                                  || RPAD (NVL (vidline (j).contract_plan,
                                                ' '),
                                           7,
                                           ' '
                                          )
                                  || RPAD (NVL (vidline (j).contract_seq, ' '),
                                           5,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL (vidline (j).vendor_product_code,
                                              ' '
                                             ),
                                         20,
                                         ' '
                                        )
                                  || RPAD (NVL (vidline (j).taxable_flag, ' '),
                                           1,
                                           ' '
                                          )
                                  || RPAD (' ', 1, ' ')
                                  || RPAD
                                        (NVL (vidline (j).xxom_line_comments,
                                              ' '
                                             ),
                                         70,
                                         ' '
                                        )                        --lc_comments
                                  || RPAD (' ', 8, ' ')
                                  /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                                  || RPAD (' ', 175, ' ')
                                  || RPAD (NVL (vidheader (i).trx_number, ' '),
                                           20,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).bill_to_customer_number,
                                             ' '
                                            ),
                                         15,
                                         ' '
                                        )
								  || RPAD (NVL (lc_kit_sku, ' '),9,' ')  -- Added for Kitting, Defect# 37670
					              || RPAD (NVL (lc_kit_item_description, ' '),30,' ') -- Added for Kitting, Defect# 37670
                                  || 'X'
                                  ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                                 );
                           EXCEPTION
                              WHEN OTHERS
                              THEN
                          /*       fnd_file.put_line (fnd_file.output,
                                                       'Error @ DT type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                                    || SQLERRM
                                                   );  */ --Commented for Defect # 1742

     --====Start of Changes for the defect 12435====--
                                 p_status_code := 'E';
                                 p_error_msg := 'Error @ DT type...' || SQLERRM;
                                 RAISE;
     --====End of Changes for the defect 12435====--
                           END;
                        END LOOP;
                     END IF;
                  END LOOP;

                  CLOSE lcu_line;

--===================================================================
--Fetching the Delivery fee if found and inserting then in the File
--===================================================================

                  lc_error_location_info := 'Opening lcu_charges_lines in generate_info_copy_file';    --Added as a part of defect 11993
                  lc_error_debug_info    := 'lcu_charges_lines for --'                                 --Added as a part of defect 11993
                                            ||vidheader (i).customer_trx_id;

                  OPEN lcu_charges_lines (vidheader (i).customer_trx_id,
                                          lc_delivery,
                                          lc_trx_class,
                                          lc_invoice_source
                                         );

                  FETCH lcu_charges_lines
                   INTO delivery_charge_rec_type;

                  IF lcu_charges_lines%FOUND
                  THEN
                     lc_elecrectype := 'DL';
                     ln_common_count := ln_common_count + 1;
                     ln_detail_count := ln_detail_count + 1;

                     BEGIN
                        --fnd_file.put_line(fnd_file.output ,'DL');
                        UTL_FILE.put_line
                           (lc_file_handle,
                               RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                         --BILL_CUSTOMER_ID
                            || RPAD (NVL (vidheader (i).cons_billing_number,
                                          ' '
                                         ),
                                     9,
                                     ' '
                                    )
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (vidheader (i).interface_header_attribute1,
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )
                            -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                            || RPAD (NVL (vidheader (i).phone_number, ' '),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                            || RPAD (' ', 18, ' ')                    --FILLER
                            || RPAD (NVL (lc_addrid, ' '), 9, ' ')    --ADDRID
                            || RPAD (NVL (vidheader (i).invoice_currency_code,
                                          ' '
                                         ),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                                                               --ADDRALIASNAME
                            || RPAD (NVL (vidheader (i).purchase_order_number,
                                          ' '
                                         ),
                                     22,
                                     ' '
                                    )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.release_number,
                                       ' '
                                      ),
                                   12,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL (get_om_details_rec_type.desk_del_addr,
                                        ' '
                                       ),
                                   20,
                                   ' '
                                  )
                            || RPAD
                                  (NVL
                                      (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                                 --CHILD_ID
                            || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).bus_name, ' '),
                                     40,
                                     ' '
                                    )
                            || NVL (TO_CHAR (vidheader (i).due_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                            || RPAD
                                  (NVL (vidheader (i).tax_registration_number,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )
                            || RPAD (' ', 7, ' ')
                            || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                              '9999990.99S'
                                             ),
                                     11,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (' ', 1, ' ')
                            || lc_pos_acct_nbr                  --SPC ACCT NBR
                            || lc_pos_tran_nbr              --SPC TRANS NUMBER
                            || lc_pos_reg_nbr                 --SPC REG NUMBER
                            || NVL
                                  (TO_CHAR
                                          (get_shipping_rec_type.ordered_date,
                                           'YYYYMMDD'
                                          ),
                                   RPAD (' ', 8, ' ')
                                  )
                            || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                             'YYYYMMDD'),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL (vidheader (i).ordsourcecd, ' '),
                                   1,
                                   ' '
                                  )                              --ordsourcecd
                            || RPAD
                                  (NVL (get_om_details_rec_type.ordcreateid,
                                        ' '
                                       ),
                                   10,
                                   ' '
                                  )                              --ordgreateid
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD
                                  (NVL
                                      (get_om_details_rec_type.placement_method_code,
                                       ' '
                                      ),
                                   1,
                                   ' '
                                  )
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                              --Pickup Date
                            || NVL
                                  (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                   RPAD (' ', 8, ' ')
                                  )                           --Reconcile Date
                            || RPAD
                                  (NVL (get_om_details_rec_type.custtypecd,
                                        ' '
                                       ),
                                   1,
                                   ' '
                                  )                          --Order Type code
                            || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                          ' '
                                         ),
                                     25,
                                     ' '
                                    )
                            || RPAD (' ', 12, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                              '999999990.99S'
                                             ),
                                     13,
                                     ' '
                                    )
                            || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                            || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                            || RPAD
                                  (NVL (vidheader (i).ship_to_customer_name,
                                        ' '
                                       ),
                                   30,
                                   ' '
                                  )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                            || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                     25,
                                     ' '
                                    )
                            || LPAD (NVL (TO_CHAR (ln_line_count), ' '),
                                     5,
                                     ' '
                                    )                             --nbroflines
                            || RPAD (' ', 1, ' ')
                            || RPAD
                                  (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                            -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || NVL
                                  (vidheader (i).specl_handlg_cd,
                                   RPAD (' ', 4, ' ')
                                  )
                                 --cursor value queried with default 4 spaces.
                            || NVL (TO_CHAR (vidheader (i).trx_date,
                                             'YYYYMMDD'
                                            ),
                                    RPAD (' ', 8, ' ')
                                   )
                            || RPAD
                                  (NVL
                                      (SUBSTR
                                          (vidheader (i).ship_to_location,
                                             INSTR
                                                (vidheader (i).ship_to_location,
                                                 '-'
                                                )
                                           + 1
                                          ),
                                       ' '
                                      ),
                                   9,
                                   ' '
                                  )                          --SHIP_TO_ADDR_ID
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 4, ' ')
                            || RPAD
                                  (NVL (vidheader (i).bill_to_name, ' '),
                                   30,
                                   ' '
                                  )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                            || RPAD
                                  (NVL (lc_xmail_site_name, ' '), 30, ' ')
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                            || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                     28,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                     2,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_postal_code,
                                          ' '
                                         ),
                                     11,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                     3,
                                     ' '
                                    )
                            || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                     30,
                                     ' '
                                    )
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 2, ' ')
                            || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                            || LPAD
                                  (NVL (TO_CHAR (ln_common_count), ' '),
                                   6,
                                   ' '
                                  )                        --ELEC FILE REC NBR
                            || LPAD
                                  (NVL (TO_CHAR (ln_detail_count), ' '),
                                   5,
                                   ' '
                                  )                          --ELEC DETAIL SEQ
                            || RPAD (' ', 9, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD ('DELIVERY CHARGE', 20, ' ')
                                                          --product_cd_entered
                            || RPAD ('DELIVERY CHARGE', 20, ' ')
                                                             --cust_product_cd
                            || RPAD ('DELIVERY CHARGE', 20, ' ')
                                                               --whsle_prod_cd
                            || RPAD (' ', 3, ' ')
                            || RPAD (' ', 6, ' ')
                            || RPAD (' ', 14, ' ')
                            || RPAD (' ', 9,' ') --custpolinenbr --Added for the defect 13488
                            /*|| RPAD
                                  (NVL
                                      (delivery_charge_rec_type.custpolinenbr,
                                       ln_detail_count
                                      ),
                                   9,
                                   ' '
                                  ) --custpolinenbr  */  -- Commented for the defect 13488
                            || RPAD ('DELIVERY CHARGE', 30, ' ')
                            || RPAD (NVL (delivery_charge_rec_type.uom_code,
                                          ' '
                                         ),
                                     2,
                                     ' '
                                    )
                            || TO_CHAR
                                  (NVL
                                      (delivery_charge_rec_type.quantity_ordered,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (delivery_charge_rec_type.quantity_invoiced,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || TO_CHAR
                                  (NVL
                                      (delivery_charge_rec_type.backordered_qty,
                                       0
                                      ),
                                   '09999S'
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (delivery_charge_rec_type.unit_selling_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (delivery_charge_rec_type.sku_list_price,
                                           0
                                          ),
                                       '99999990.999S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                            || LPAD
                                  (TO_CHAR
                                      (NVL
                                          (delivery_charge_rec_type.extended_amount,
                                           0
                                          ),
                                       '999999990.99S'
                                      ),
                                   13,
                                   ' '
                                  )
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 7, ' ')
                            || RPAD (' ', 5, ' ')
                            || RPAD ('DELIVERY CHARGE', 20, ' ')
                            || RPAD (' ', 1, ' ')
                            || RPAD (' ', 1, ' ')
                            || lc_comments
                            || RPAD (' ', 8, ' ')
                            /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                            || RPAD (' ', 175, ' ')
                            || RPAD (NVL (vidheader (i).trx_number, ' '),
                                     20,
                                     ' '
                                    )
                            || RPAD
                                  (NVL (vidheader (i).bill_to_customer_number,
                                        ' '
                                       ),
                                   15,
                                   ' '
                                  )
							|| RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                    || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                            || 'X'
                            ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                           );
                     EXCEPTION
                        WHEN OTHERS
                        THEN
                     /*      fnd_file.put_line (fnd_file.output,
                                              'Error @ DL type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..' || SQLERRM
                                             );
                   */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                           p_status_code := 'E';
                           p_error_msg := 'Error @ DL type...' || SQLERRM;
                           RAISE;
     --====End of Changes for the defect 12435====--
                     END;
                  END IF;

                  CLOSE lcu_charges_lines;

--============================================================
--Fetching the Tax information and inserting then in the File
--=============================================================
                  IF p_us_ou = p_current_ou
                  THEN
--xx_fin_country_defaults_pkg.f_org_id('US') =FND_PROFILE.VALUE('ORG_ID') THEN

                     lc_error_location_info := 'Opening lcu_get_tax_details_us in generate_info_copy_file';    --Added as a part of defect 11993
                     lc_error_debug_info    := 'lcu_get_tax_details_us for --'                                 --Added as a part of defect 11993
                                               ||vidheader (i).customer_trx_id;

                     OPEN lcu_get_tax_details_us
                                                (vidheader (i).customer_trx_id
                                                );

                     FETCH lcu_get_tax_details_us
                      INTO ln_tax_amount, lc_tax_code, lc_tax_rate;

                     EXIT WHEN lcu_get_tax_details_us%NOTFOUND;

                     IF lcu_get_tax_details_us%FOUND
                     THEN
                        IF ln_tax_amount <> 0
                        THEN
                           lc_tax_rate := TO_CHAR ((ln_tax_rate * 100));
                           lc_elecrectype := 'TX';
                           ln_common_count := ln_common_count + 1;
                           ln_detail_count := ln_detail_count + 1;

                           BEGIN
                              --fnd_file.put_line(fnd_file.output ,'US TX amount >0...');
                              UTL_FILE.put_line
                                 (lc_file_handle,
                                     RPAD
                                        (NVL
                                            (REPLACE
                                                (vidheader (i).orig_system_reference,
                                                 '-',
                                                 ''
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                   --BILL_CUSTOMER_ID
                                  || RPAD
                                        (NVL
                                            (vidheader (i).cons_billing_number,
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL
                                            (vidheader (i).interface_header_attribute1,
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )
                                  -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                                  || RPAD (NVL (vidheader (i).phone_number,
                                                ' '
                                               ),
                                           11,
                                           ' '
                                          )
                                  || RPAD (NVL (lc_cust_phone_ext, ' '),
                                           4,
                                           ' '
                                          )
                                  || RPAD (' ', 18, ' ')              --FILLER
                                  || RPAD (NVL (lc_addrid, ' '), 9, ' ')
                                                                      --ADDRID
                                  || RPAD
                                        (NVL
                                            (vidheader (i).invoice_currency_code,
                                             ' '
                                            ),
                                         3,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL (lc_xaddr_alias_name, ' '),
                                         20,
                                         ' '
                                        )                      --ADDRALIASNAME
                                  || RPAD
                                        (NVL
                                            (vidheader (i).purchase_order_number,
                                             ' '
                                            ),
                                         22,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.release_number,
                                             ' '
                                            ),
                                         12,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.cost_center_dept,
                                             ' '
                                            ),
                                         20,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.desk_del_addr,
                                             ' '
                                            ),
                                         20,
                                         ' '
                                        )
                                  || RPAD
                                        (NVL
                                            (REPLACE
                                                (vidheader (i).orig_system_reference,
                                                 '-',
                                                 ''
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                           --CHILD_ID
                                  || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD (NVL (vidheader (i).bus_name, ' '),
                                           40,
                                           ' '
                                          )
                                  || NVL (TO_CHAR (vidheader (i).due_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD (NVL (vidheader (i).NAME, ' '),
                                           20,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).tax_registration_number,
                                             ' '
                                            ),
                                         10,
                                         ' '
                                        )
                                  || RPAD (' ', 7, ' ')
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_misc_chrg,
                                                         0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD
                                         (TO_CHAR (NVL (ln_total_deliv_chrg,
                                                        0),
                                                   '9999990.99S'
                                                  ),
                                          11,
                                          ' '
                                         )
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                                    '9999990.99S'
                                                   ),
                                           11,
                                           ' '
                                          )
                                  || LPAD
                                         (TO_CHAR (NVL (ln_total_coupon_amt,
                                                        0),
                                                   '9999990.99S'
                                                  ),
                                          11,
                                          ' '
                                         )
                                  || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || RPAD (' ', 1, ' ')
                                  || lc_pos_acct_nbr            --SPC ACCT NBR
                                  || lc_pos_tran_nbr        --SPC TRANS NUMBER
                                  || lc_pos_reg_nbr           --SPC REG NUMBER
                                  || NVL
                                        (TO_CHAR
                                            (get_shipping_rec_type.ordered_date,
                                             'YYYYMMDD'
                                            ),
                                         RPAD (' ', 8, ' ')
                                        )
                                  || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD
                                        (NVL (vidheader (i).ordsourcecd, ' '),
                                         1,
                                         ' '
                                        )                        --ordsourcecd
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.ordcreateid,
                                             ' '
                                            ),
                                         10,
                                         ' '
                                        )                        --ordgreateid
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.placement_method_code,
                                             ' '
                                            ),
                                         1,
                                         ' '
                                        )
                                  || NVL
                                        (TO_CHAR (ld_hd_ordcompletedate,
                                                  'YYYYMMDD'
                                                 ),
                                         RPAD (' ', 8, ' ')
                                        )                        --Pickup Date
                                  || NVL
                                        (TO_CHAR (ld_hd_ordcompletedate,
                                                  'YYYYMMDD'
                                                 ),
                                         RPAD (' ', 8, ' ')
                                        )                     --Reconcile Date
                                  || RPAD
                                        (NVL
                                            (get_om_details_rec_type.custtypecd,
                                             ' '
                                            ),
                                         1,
                                         ' '
                                        )                    --Order Type code
                                  || RPAD
                                        (NVL
                                            (vidheader (i).primary_salesrep_name,
                                             ' '
                                            ),
                                         25,
                                         ' '
                                        )
                                  || RPAD (' ', 12, ' ')
                                  || RPAD (' ', 4, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                                    '999999990.99S'
                                                   ),
                                           13,
                                           ' '
                                          )
                                  || RPAD (NVL (lc_ship_to_addr_flag, ' '),
                                           1,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                                  || RPAD
                                        (NVL
                                            (vidheader (i).ship_to_customer_name,
                                             ' '
                                            ),
                                         30,
                                         ' '
                                        )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                                  || RPAD
                                         (NVL (vidheader (i).ship_to_address1,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD
                                         (NVL (vidheader (i).ship_to_address2,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD (NVL (vidheader (i).ship_to_city,
                                                ' '
                                               ),
                                           28,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).ship_to_state,
                                                ' '
                                               ),
                                           2,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).ship_to_postal_code,
                                             ' '
                                            ),
                                         11,
                                         ' '
                                        )
                                  || RPAD (NVL (vidheader (i).ship_to_country,
                                                ' '
                                               ),
                                           3,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).ship_to_contact,
                                                ' '
                                               ),
                                           25,
                                           ' '
                                          )
                                  || LPAD
                                        (NVL (TO_CHAR (ln_line_count), ' '),
                                         5,
                                         ' '
                                        )                         --nbroflines
                                  || RPAD (' ', 1, ' ')
                                  || RPAD
                                        (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                                 -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || NVL
                                        (vidheader (i).specl_handlg_cd,
                                         RPAD (' ', 4, ' ')
                                        )
                                 --cursor value queried with default 4 spaces.
                                  || NVL (TO_CHAR (vidheader (i).trx_date,
                                                   'YYYYMMDD'
                                                  ),
                                          RPAD (' ', 8, ' ')
                                         )
                                  || RPAD
                                        (NVL
                                            (SUBSTR
                                                (vidheader (i).ship_to_location,
                                                   INSTR
                                                      (vidheader (i).ship_to_location,
                                                       '-'
                                                      )
                                                 + 1
                                                ),
                                             ' '
                                            ),
                                         9,
                                         ' '
                                        )                    --SHIP_TO_ADDR_ID
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 4, ' ')
                                  || RPAD
                                        (NVL (vidheader (i).bill_to_name, ' '),
                                         30,
                                         ' '
                                        )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                                  || RPAD
                                        (NVL (lc_xmail_site_name, ' '),
                                         30,
                                         ' '
                                        )
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                                  || RPAD
                                         (NVL (vidheader (i).bill_to_address1,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD
                                         (NVL (vidheader (i).bill_to_address2,
                                               ' '
                                              ),
                                          30,
                                          ' '
                                         )
                                  || RPAD (NVL (vidheader (i).bill_to_city,
                                                ' '
                                               ),
                                           28,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).bill_to_state,
                                                ' '
                                               ),
                                           2,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).bill_to_postal_code,
                                             ' '
                                            ),
                                         11,
                                         ' '
                                        )
                                  || RPAD (NVL (vidheader (i).bill_to_country,
                                                ' '
                                               ),
                                           3,
                                           ' '
                                          )
                                  || RPAD (NVL (vidheader (i).bill_to_attn,
                                                ' '
                                               ),
                                           30,
                                           ' '
                                          )
                                  || RPAD (' ', 9, ' ')
                                  || RPAD (' ', 2, ' ')
                                  || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                                  || LPAD
                                        (NVL (TO_CHAR (ln_common_count), ' '),
                                         6,
                                         ' '
                                        )                  --ELEC FILE REC NBR
                                  || LPAD
                                        (NVL (TO_CHAR (ln_detail_count), ' '),
                                         5,
                                         ' '
                                        )                    --ELEC DETAIL SEQ
                                  || RPAD (' ', 9, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        ('SALES TAX', 20, ' ')
                                     --COPY SALES TAX ON PRODUCT_CD_ENTERED...
                                  || RPAD
                                        ('SALES TAX', 20, ' ')
                                        --COPY SALES TAX ON CUST_PRODUCT_CD...
                                  || RPAD
                                        ('SALES TAX', 20, ' ')
                                       --COPY SALES TAX ON WHSLE_PRODUCT_CD...
                                  || RPAD (' ', 3, ' ')
                                  || LPAD (NVL (lc_tax_rate, ' '), 6, ' ')
                                                                    --tax rate
                                  || RPAD (' ', 14, ' ')
                                  || RPAD (' ', 9, ' ')
                                  || RPAD
                                        ('SALES TAX', 30, ' ')
                                        --COPY SALES TAX ON SKU DESCRIPTION...
                                  || RPAD (' ', 2, ' ')
                                  || TO_CHAR (0, '09999S')
                                  || TO_CHAR (0, '09999S')
                                  || TO_CHAR (0, '09999S')
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD (TO_CHAR (0, '99999990.999S'),
                                           13,
                                           ' '
                                          )
                                  || LPAD
                                        (TO_CHAR (NVL (ln_tax_amount, 0),
                                                  '999999990.99S'
                                                 ),
                                         13,
                                         ' '
                                        )
                              --extended price stores tax amt for TX rec type.
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 7, ' ')
                                  || RPAD (' ', 5, ' ')
                                  || RPAD
                                        ('SALES TAX', 20, ' ')
                                      --COPY SALES TAX ON VENDOR_PRODUCT_CD...
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 1, ' ')
                                  || RPAD (' ', 70, ' ')
                                  || RPAD (' ', 8, ' ')
                                  /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                                  || RPAD (' ', 175, ' ')
                                  || RPAD (NVL (vidheader (i).trx_number, ' '),
                                           20,
                                           ' '
                                          )
                                  || RPAD
                                        (NVL
                                            (vidheader (i).bill_to_customer_number,
                                             ' '
                                            ),
                                         15,
                                         ' '
                                        )
								  || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                          || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                                  || 'X'
                                  ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                                 );
                           EXCEPTION
                              WHEN OTHERS
                              THEN
                       /*          fnd_file.put_line
                                                  (fnd_file.output,
                                                      'Error @ US TX type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                                   || SQLERRM
                                                  );  */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                                 p_status_code := 'E';
                                 p_error_msg := 'Error @ US TX type...' || SQLERRM;
                                 RAISE;
     --====End of Changes for the defect 12435====--
                           END;
                        END IF;
                     END IF;

                     CLOSE lcu_get_tax_details_us;
                  ELSIF p_ca_ou = p_current_ou
                  THEN
--xx_fin_country_defaults_pkg.f_org_id('CA') =FND_PROFILE.VALUE('ORG_ID') THEN

                     lc_error_location_info := 'Opening lcu_tax_ca in generate_info_copy_file';    --Added as a part of defect 11993
                     lc_error_debug_info    := 'lcu_tax_ca for --'                                 --Added as a part of defect 11993
                                               ||vidheader (i).customer_trx_id;

                     OPEN lcu_tax_ca (vidheader (i).customer_trx_id);

                     FETCH lcu_tax_ca
                      INTO lcu_tax_ca_rec;

                     CLOSE lcu_tax_ca;

                     --Fields for the cursor lcu_tax_CA listed in order ==> xtotal_tax_amt ,xtotal_tax_PST_QST ,xtotal_tax_GST

                     -- =================================================
-- Loop thru QST/PST AND GST tax records for CA.
-- =================================================

                     lc_error_location_info := 'Opening lcu_get_tax_details_ca in generate_info_copy_file';    --Added as a part of defect 11993
                     lc_error_debug_info    := 'lcu_get_tax_details_ca for --'                                 --Added as a part of defect 11993
                                               ||'Customer Trx ID :' || vidheader (i).customer_trx_id
                                               ||'Province :'|| lc_province;

                     OPEN lcu_get_tax_details_ca
                                               (vidheader (i).customer_trx_id,
                                                lc_province
                                               );

                     LOOP
                        FETCH lcu_get_tax_details_ca
                         INTO ln_tax_amount, lc_tax_code, lc_tax_rate;

                        EXIT WHEN lcu_get_tax_details_ca%NOTFOUND;

                        IF lcu_get_tax_details_ca%FOUND
                        THEN
                           IF ln_tax_amount <> 0
                           THEN
                              lc_elecrectype := 'TX';
                              ln_common_count := ln_common_count + 1;
                              ln_detail_count := ln_detail_count + 1;

                              BEGIN
                                 lc_tax_rate :=
                                               TO_CHAR ((ln_tax_rate * 100));
                                 --fnd_file.put_line(fnd_file.output ,'CA TX...');
                                 UTL_FILE.put_line
                                    (lc_file_handle,
                                        RPAD
                                           (NVL
                                               (REPLACE
                                                   (vidheader (i).orig_system_reference,
                                                    '-',
                                                    ''
                                                   ),
                                                ' '
                                               ),
                                            9,
                                            ' '
                                           )                --BILL_CUSTOMER_ID
                                     || RPAD
                                           (NVL
                                               (vidheader (i).cons_billing_number,
                                                ' '
                                               ),
                                            9,
                                            ' '
                                           )
                                     || RPAD (' ', 5, ' ')
                                     || RPAD
                                           (NVL
                                               (vidheader (i).interface_header_attribute1,
                                                ' '
                                               ),
                                            9,
                                            ' '
                                           )
                                      -- added for defect 13472
                               /*
                         || RPAD
                               (NVL
                                   (TO_CHAR
                                       (TO_NUMBER (get_shipping_rec_type.subordernum)
                                       ),
                                    ' '
                                   ),
                                5,
                                ' '
                               )
                               */
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                                -- added for defect 13472
                                     || RPAD (NVL (vidheader (i).phone_number,
                                                   ' '
                                                  ),
                                              11,
                                              ' '
                                             )
                                     || RPAD (NVL (lc_cust_phone_ext, ' '),
                                              4,
                                              ' '
                                             )
                                     || RPAD (' ', 18, ' ')           --FILLER
                                     || RPAD (NVL (lc_addrid, ' '), 9, ' ')
                                                                      --ADDRID
                                     || RPAD
                                           (NVL
                                               (vidheader (i).invoice_currency_code,
                                                ' '
                                               ),
                                            3,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL (lc_xaddr_alias_name, ' '),
                                            20,
                                            ' '
                                           )                   --ADDRALIASNAME
                                     || RPAD
                                           (NVL
                                               (vidheader (i).purchase_order_number,
                                                ' '
                                               ),
                                            22,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL
                                               (get_om_details_rec_type.release_number,
                                                ' '
                                               ),
                                            12,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL
                                               (get_om_details_rec_type.cost_center_dept,
                                                ' '
                                               ),
                                            20,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL
                                               (get_om_details_rec_type.desk_del_addr,
                                                ' '
                                               ),
                                            20,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL
                                               (REPLACE
                                                   (vidheader (i).orig_system_reference,
                                                    '-',
                                                    ''
                                                   ),
                                                ' '
                                               ),
                                            9,
                                            ' '
                                           )                        --CHILD_ID
                                     || NVL
                                           (TO_CHAR
                                                   (vidheader (i).cut_off_date,
                                                    'YYYYMMDD'
                                                   ),
                                            RPAD (' ', 8, ' ')
                                           )
                                     || NVL (TO_CHAR (ld_issue_date,
                                                      'YYYYMMDD'
                                                     ),
                                             RPAD (' ', 8, ' ')
                                            )
                                     || RPAD (NVL (vidheader (i).bus_name,
                                                   ' '),
                                              40,
                                              ' '
                                             )
                                     || NVL (TO_CHAR (vidheader (i).due_date,
                                                      'YYYYMMDD'
                                                     ),
                                             RPAD (' ', 8, ' ')
                                            )
                                     || RPAD (NVL (vidheader (i).NAME, ' '),
                                              20,
                                              ' '
                                             )
                                     || RPAD
                                           (NVL
                                               (vidheader (i).tax_registration_number,
                                                ' '
                                               ),
                                            10,
                                            ' '
                                           )
                                     || RPAD (' ', 7, ' ')
                                     || LPAD
                                            (TO_CHAR (NVL (ln_total_tax_amt,
                                                           0),
                                                      '9999990.99S'
                                                     ),
                                             11,
                                             ' '
                                            )
                                     || LPAD
                                           (TO_CHAR (NVL (ln_total_disc_amt,
                                                          0),
                                                     '9999990.99S'
                                                    ),
                                            11,
                                            ' '
                                           )
                                     || LPAD
                                           (TO_CHAR (NVL (ln_total_misc_chrg,
                                                          0
                                                         ),
                                                     '9999990.99S'
                                                    ),
                                            11,
                                            ' '
                                           )
                                     || LPAD
                                           (TO_CHAR
                                                   (NVL (ln_total_deliv_chrg,
                                                         0
                                                        ),
                                                    '9999990.99S'
                                                   ),
                                            11,
                                            ' '
                                           )
                                     || LPAD
                                            (TO_CHAR (NVL (ln_total_tax_gst,
                                                           0),
                                                      '9999990.99S'
                                                     ),
                                             11,
                                             ' '
                                            )
                                     || LPAD
                                           (TO_CHAR
                                                   (NVL (ln_total_coupon_amt,
                                                         0
                                                        ),
                                                    '9999990.99S'
                                                   ),
                                            11,
                                            ' '
                                           )
                                     || LPAD
                                           (TO_CHAR (NVL (ln_total_deposits,
                                                          0),
                                                     '999999990.99S'
                                                    ),
                                            13,
                                            ' '
                                           )
                                     || LPAD
                                            (TO_CHAR (NVL (ln_total_tax_pst,
                                                           0),
                                                      '999999990.99S'
                                                     ),
                                             13,
                                             ' '
                                            )
                                     || RPAD (' ', 1, ' ')
                                     || lc_pos_acct_nbr         --SPC ACCT NBR
                                     || lc_pos_tran_nbr     --SPC TRANS NUMBER
                                     || lc_pos_reg_nbr        --SPC REG NUMBER
                                     || NVL
                                           (TO_CHAR
                                               (get_shipping_rec_type.ordered_date,
                                                'YYYYMMDD'
                                               ),
                                            RPAD (' ', 8, ' ')
                                           )
                                     || NVL (TO_CHAR (ld_hd_ordcompletedate,
                                                      'YYYYMMDD'
                                                     ),
                                             RPAD (' ', 8, ' ')
                                            )
                                     || RPAD
                                           (NVL (vidheader (i).ordsourcecd,
                                                 ' '
                                                ),
                                            1,
                                            ' '
                                           )                     --ordsourcecd
                                     || RPAD
                                           (NVL
                                               (get_om_details_rec_type.ordcreateid,
                                                ' '
                                               ),
                                            10,
                                            ' '
                                           )                     --ordgreateid
                                     || RPAD (' ', 5, ' ')
                                     || RPAD (' ', 5, ' ')
                                     || RPAD (' ', 5, ' ')
                                     || RPAD
                                           (NVL
                                               (get_om_details_rec_type.placement_method_code,
                                                ' '
                                               ),
                                            1,
                                            ' '
                                           )
                                     || NVL
                                           (TO_CHAR (ld_hd_ordcompletedate,
                                                     'YYYYMMDD'
                                                    ),
                                            RPAD (' ', 8, ' ')
                                           )                     --Pickup Date
                                     || NVL
                                           (TO_CHAR (ld_hd_ordcompletedate,
                                                     'YYYYMMDD'
                                                    ),
                                            RPAD (' ', 8, ' ')
                                           )                  --Reconcile Date
                                     || RPAD
                                           (NVL
                                               (get_om_details_rec_type.custtypecd,
                                                ' '
                                               ),
                                            1,
                                            ' '
                                           )                 --Order Type code
                                     || RPAD
                                           (NVL
                                               (vidheader (i).primary_salesrep_name,
                                                ' '
                                               ),
                                            25,
                                            ' '
                                           )
                                     || RPAD (' ', 12, ' ')
                                     || RPAD (' ', 4, ' ')
                                     || RPAD (' ', 1, ' ')
                                     || RPAD (' ', 1, ' ')
                                     || LPAD
                                           (TO_CHAR (NVL (ln_ordersub_total,
                                                          0),
                                                     '999999990.99S'
                                                    ),
                                            13,
                                            ' '
                                           )
                                     || LPAD
                                           (TO_CHAR (NVL (ln_totalorder_amt,
                                                          0),
                                                     '999999990.99S'
                                                    ),
                                            13,
                                            ' '
                                           )
                                     || RPAD (NVL (lc_ship_to_addr_flag, ' '),
                                              1,
                                              ' '
                                             )
                                     || RPAD
                                           (NVL (lc_aopsshiptoseq, ' '),
                                            9,
                                            ' '
                                           )                   --AOPSSHIPTOSEQ
                                     || RPAD
                                           (NVL
                                               (vidheader (i).ship_to_customer_name,
                                                ' '
                                               ),
                                            30,
                                            ' '
                                           )
                      --RPAD(NVL(lc_addrbusname ,' ')  ,30 ,' ') --ADDRBUSNAME
                                     || RPAD
                                           (NVL
                                               (vidheader (i).ship_to_address1,
                                                ' '
                                               ),
                                            30,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL
                                               (vidheader (i).ship_to_address2,
                                                ' '
                                               ),
                                            30,
                                            ' '
                                           )
                                     || RPAD (NVL (vidheader (i).ship_to_city,
                                                   ' '
                                                  ),
                                              28,
                                              ' '
                                             )
                                     || RPAD
                                            (NVL (vidheader (i).ship_to_state,
                                                  ' '
                                                 ),
                                             2,
                                             ' '
                                            )
                                     || RPAD
                                           (NVL
                                               (vidheader (i).ship_to_postal_code,
                                                ' '
                                               ),
                                            11,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL (vidheader (i).ship_to_country,
                                                 ' '
                                                ),
                                            3,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL (vidheader (i).ship_to_contact,
                                                 ' '
                                                ),
                                            25,
                                            ' '
                                           )
                                     || LPAD
                                           (NVL (TO_CHAR (ln_line_count), ' '),
                                            5,
                                            ' '
                                           )                      --nbroflines
                                     || RPAD (' ', 1, ' ')
                                     || RPAD
                                           (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                                    -- || lc_orgordsubnbr
                        --orig_order_sub_nbr for the corresponding creditmemo.  --Commented for Defect 8867
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')   -- Added for Defect 8867
                                     || RPAD (' ', 1, ' ')
                                     || RPAD (' ', 1, ' ')
                                     || NVL
                                           (vidheader (i).specl_handlg_cd,
                                            RPAD (' ', 4, ' ')
                                           )
                                 --cursor value queried with default 4 spaces.
                                     || NVL (TO_CHAR (vidheader (i).trx_date,
                                                      'YYYYMMDD'
                                                     ),
                                             RPAD (' ', 8, ' ')
                                            )
                                     || RPAD
                                           (NVL
                                               (SUBSTR
                                                   (vidheader (i).ship_to_location,
                                                      INSTR
                                                         (vidheader (i).ship_to_location,
                                                          '-'
                                                         )
                                                    + 1
                                                   ),
                                                ' '
                                               ),
                                            9,
                                            ' '
                                           )                 --SHIP_TO_ADDR_ID
                                     || RPAD (' ', 1, ' ')
                                     || RPAD (' ', 4, ' ')
                                     || RPAD
                                           (NVL (vidheader (i).bill_to_name,
                                                 ' '
                                                ),
                                            30,
                                            ' '
                                           )
                                   --RPAD(NVL(lc_addraliasname ,' ') ,30 ,' ')
                                     || RPAD
                                           (NVL (lc_xmail_site_name, ' '),
                                            30,
                                            ' '
                                           )
                      --RPAD(NVL(vidheader(i).bill_to_location ,' ') ,30 ,' ')
                                     || RPAD
                                           (NVL
                                               (vidheader (i).bill_to_address1,
                                                ' '
                                               ),
                                            30,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL
                                               (vidheader (i).bill_to_address2,
                                                ' '
                                               ),
                                            30,
                                            ' '
                                           )
                                     || RPAD (NVL (vidheader (i).bill_to_city,
                                                   ' '
                                                  ),
                                              28,
                                              ' '
                                             )
                                     || RPAD
                                            (NVL (vidheader (i).bill_to_state,
                                                  ' '
                                                 ),
                                             2,
                                             ' '
                                            )
                                     || RPAD
                                           (NVL
                                               (vidheader (i).bill_to_postal_code,
                                                ' '
                                               ),
                                            11,
                                            ' '
                                           )
                                     || RPAD
                                           (NVL (vidheader (i).bill_to_country,
                                                 ' '
                                                ),
                                            3,
                                            ' '
                                           )
                                     || RPAD (NVL (vidheader (i).bill_to_attn,
                                                   ' '
                                                  ),
                                              30,
                                              ' '
                                             )
                                     || RPAD (' ', 9, ' ')
                                     || RPAD (' ', 2, ' ')
                                     || RPAD (NVL (lc_elecrectype, ' '),
                                              2,
                                              ' '
                                             )
                                     || LPAD
                                           (NVL (TO_CHAR (ln_common_count),
                                                 ' '
                                                ),
                                            6,
                                            ' '
                                           )               --ELEC FILE REC NBR
                                     || LPAD
                                           (NVL (TO_CHAR (ln_detail_count),
                                                 ' '
                                                ),
                                            5,
                                            ' '
                                           )                 --ELEC DETAIL SEQ
                                     || RPAD (' ', 9, ' ')
                                     || RPAD (' ', 5, ' ')
                                     || RPAD
                                           (NVL ('TAX - ' || lc_tax_code, ' '),
                                            20,
                                            ' '
                                           )                  --PST/QST/GST...
                                     || RPAD
                                           (NVL ('TAX - ' || lc_tax_code, ' '),
                                            20,
                                            ' '
                                           )                  --PST/QST/GST...
                                     || RPAD
                                           (NVL ('TAX - ' || lc_tax_code, ' '),
                                            20,
                                            ' '
                                           )                  --PST/QST/GST...
                                     || RPAD (' ', 3, ' ')
                                     || LPAD (NVL (lc_tax_rate, ' '), 6, ' ')
                                     || RPAD (' ', 14, ' ')
                                     || RPAD (' ', 9, ' ')
                                     || RPAD
                                           (NVL ('TAX - ' || lc_tax_code, ' '),
                                            30,
                                            ' '
                                           )                  --PST/QST/GST...
                                     || RPAD (' ', 2, ' ')
                                     || TO_CHAR (0, '09999S')
                                     || TO_CHAR (0, '09999S')
                                     || TO_CHAR (0, '09999S')
                                     || LPAD (TO_CHAR (0, '99999990.999S'),
                                              13,
                                              ' '
                                             )
                                     || LPAD (TO_CHAR (0, '99999990.999S'),
                                              13,
                                              ' '
                                             )
                                     || LPAD (TO_CHAR (0, '99999990.999S'),
                                              13,
                                              ' '
                                             )
                                     || LPAD (TO_CHAR (0, '99999990.999S'),
                                              13,
                                              ' '
                                             )
                                     || LPAD
                                           (TO_CHAR (NVL (ln_tax_amount, 0),
                                                     '999999990.99S'
                                                    ),
                                            13,
                                            ' '
                                           )
                               --copy tax amt into the extended price field...
                                     || RPAD (' ', 1, ' ')
                                     || RPAD (' ', 7, ' ')
                                     || RPAD (' ', 5, ' ')
                                     || RPAD
                                           (NVL ('TAX - ' || lc_tax_code, ' '),
                                            20,
                                            ' '
                                           )                  --PST/QST/GST...
                                     || RPAD (' ', 1, ' ')
                                     || RPAD (' ', 1, ' ')
                                     || RPAD (' ', 70, ' ')
                                     || RPAD (' ', 8, ' ')
                                     /*  || RPAD                                                 -- commented for defect 8927
                                 (NVL (get_om_details_rec_type.cost_center_dept,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )                                 --cust_dept_desc*/
                                  || RPAD                                                          -- added for defect 8927
                                   (NVL (get_om_details_rec_type.cost_center_desc,
                                         ' '
                                        ),
                                    25,
                                    ' '
                                   )
                                     || RPAD (' ', 175, ' ')
                                     || RPAD (NVL (vidheader (i).trx_number,
                                                   ' '
                                                  ),
                                              20,
                                              ' '
                                             )
                                     || RPAD
                                           (NVL
                                               (vidheader (i).bill_to_customer_number,
                                                ' '
                                               ),
                                            15,
                                            ' '
                                           )
									 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                             || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                                     || 'X'
                                     ||CHR(13)   --Added for the defect 15342 (To add carriage return and line feed)
                                    );
                              EXCEPTION
                                 WHEN OTHERS
                                 THEN
                        /*            fnd_file.put_line
                                                  (fnd_file.output,
                                                      'Error @ CA TX type...Cons Bill No: '||vidheader (i).cons_billing_number ||'..Trx No: '||vidheader (i).trx_number||'..'
                                                   || SQLERRM
                                                  );  */ --Commented for Defect # 1742
     --====Start of Changes for the defect 12435====--
                                   p_status_code := 'E';
                                   p_error_msg := 'Error @ CA TX type...' || SQLERRM;
                                   RAISE;
     --====End of Changes for the defect 12435====--
                              END;
                           END IF;
                        END IF;
                     END LOOP;

                     CLOSE lcu_get_tax_details_ca;
                  ELSE
-- ======================================================
-- We exclude all other business units other than US/CA
-- ======================================================
                     NULL;
                  END IF;
               END IF;

--Start of changes for R1.1 defect # 1451 (CR 626)
--========================================================================
--Fetching the gift card details if found and inserting them in the File
--========================================================================
            IF (ln_total_gc_amt <> 0) THEN
               lc_error_location_info := 'Opening lc_gc_discount in generate_file';
               lc_error_debug_info    := 'Gift_Card_discount for the transaction ID --'
                                    ||vidheader (i).customer_trx_id;
               OPEN lc_gc_discount (vidheader (i).customer_trx_id,
                                        lc_trx_class,
                                        lc_invoice_source
                                       );

               FETCH lc_gc_discount
                INTO lc_gc_discount_rec;

               IF lc_gc_discount%FOUND
               THEN
                  lc_elecrectype := 'MS';
                  ln_detail_count := ln_detail_count + 1;
                  ln_common_count := ln_common_count + 1;
                  lc_tender_text  := NULL;

-- Added FOR gift card text dynamically
                  IF lc_trx_class = 'INV' THEN
                      lc_tender_text := lc_tender_text1||LTRIM(TO_CHAR( lc_gc_discount_rec.extended_amount, '999990D99'))||lc_tender_text2;
                  END IF;
                  IF lc_trx_class = 'CM'  THEN
                     lc_tender_text :=  lc_tender_text3||LTRIM(TO_CHAR( lc_gc_discount_rec.extended_amount*-1, '999990D99'));
                  END IF;
--- end of gift text fetch
                  BEGIN
                     UTL_FILE.put_line
                        (lc_file_handle,
                            RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                            --BILL_CUSTOMER_ID
                         || RPAD (NVL (vidheader (i).cons_billing_number, ' '),
                                  9,
                                  ' '
                                 )
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (vidheader (i).interface_header_attribute1,
                                     ' '
                                    ),
                                9,
                                ' '
                               )
                                || RPAD(NVL(get_shipping_rec_type.subordernum,' ' ), 5,' ')
                         || RPAD (NVL (vidheader (i).phone_number, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (lc_cust_phone_ext, ' '), 4, ' ')
                         || RPAD (' ', 18, ' ')                       --FILLER
                         || RPAD (NVL (lc_addrid, ' '), 9, ' ')       --ADDRID
                         || RPAD (NVL (vidheader (i).invoice_currency_code,
                                       ' '
                                      ),
                                  3,
                                  ' '
                                 )
                         || RPAD
                               (NVL (lc_xaddr_alias_name, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).purchase_order_number,
                                       ' '
                                      ),
                                  22,
                                  ' '
                                 )
                         || RPAD
                                (NVL (get_om_details_rec_type.release_number,
                                      ' '
                                     ),
                                 12,
                                 ' '
                                )
                         || RPAD
                               (NVL (get_om_details_rec_type.cost_center_dept,
                                     ' '
                                    ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (get_om_details_rec_type.desk_del_addr,
                                       ' '
                                      ),
                                  20,
                                  ' '
                                 )
                         || RPAD
                               (NVL
                                   (REPLACE
                                          (vidheader (i).orig_system_reference,
                                           '-',
                                           ''
                                          ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                                    --CHILD_ID
                         || NVL (TO_CHAR (vidheader (i).cut_off_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_issue_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).bus_name, ' '), 40, ' ')
                         || NVL (TO_CHAR (vidheader (i).due_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).NAME, ' '), 20, ' ')
                         || RPAD (NVL (vidheader (i).tax_registration_number,
                                       ' '
                                      ),
                                  10,
                                  ' '
                                 )
                         || RPAD (' ', 7, ' ')
                         || LPAD (TO_CHAR (NVL (ln_total_tax_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_disc_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_misc_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deliv_chrg, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_gst, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_coupon_amt, 0),
                                           '9999990.99S'
                                          ),
                                  11,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_deposits, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_total_tax_pst, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
                         || lc_pos_acct_nbr                     --SPC ACCT NBR
                         || lc_pos_tran_nbr                 --SPC TRANS NUMBER
                         || lc_pos_reg_nbr                    --SPC REG NUMBER
                         || NVL (TO_CHAR (get_shipping_rec_type.ordered_date,
                                          'YYYYMMDD'
                                         ),
                                 RPAD (' ', 8, ' ')
                                )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD (NVL (vidheader (i).ordsourcecd, ' '), 1,
                                  ' ')                           --ordsourcecd
                         || RPAD
                               (NVL (get_om_details_rec_type.ordcreateid, ' '),
                                10,
                                ' '
                               )                                 --ordgreateid
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (get_om_details_rec_type.placement_method_code,
                                    ' '
                                   ),
                                1,
                                ' '
                               )
                         || NVL (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )                                --Pickup Date
                         || NVL
                               (TO_CHAR (ld_hd_ordcompletedate, 'YYYYMMDD'),
                                RPAD (' ', 8, ' ')
                               )                              --Reconcile Date
                         || RPAD
                               (NVL (get_om_details_rec_type.custtypecd, ' '),
                                1,
                                ' '
                               )                             --Order Type code
                         || RPAD (NVL (vidheader (i).primary_salesrep_name,
                                       ' '
                                      ),
                                  25,
                                  ' '
                                 )
                         || RPAD (' ', 12, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || LPAD (TO_CHAR (NVL (ln_ordersub_total, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || LPAD (TO_CHAR (NVL (ln_totalorder_amt, 0),
                                           '999999990.99S'
                                          ),
                                  13,
                                  ' '
                                 )
                         || RPAD (NVL (lc_ship_to_addr_flag, ' '), 1, ' ')
                         || RPAD (NVL (lc_aopsshiptoseq, ' '), 9, ' ')
                                                               --AOPSSHIPTOSEQ
                         || RPAD
                               (NVL (vidheader (i).ship_to_customer_name, ' '),
                                30,
                                ' '
                               )
                         || RPAD (NVL (vidheader (i).ship_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).ship_to_contact, ' '),
                                  25,
                                  ' '
                                 )
                         || LPAD (NVL (TO_CHAR (ln_line_count), ' '), 5, ' ')
                                                                  --nbroflines
                         || RPAD (' ', 1, ' ')
                         || RPAD
                               (NVL (lc_orgordnbr, ' '), 9, ' ')
                            --orig_order_nbr for the corresponding creditmemo.
                         -- || lc_orgordsubnbr
                         || RPAD
                            (NVL (lc_orgordsubnbr, ' '), 5, ' ')
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 1, ' ')
                         || NVL
                               (vidheader (i).specl_handlg_cd,
                                RPAD (' ', 4, ' ')
                               ) --cursor value queried with default 4 spaces.
                         || NVL (TO_CHAR (vidheader (i).trx_date, 'YYYYMMDD'),
                                 RPAD (' ', 8, ' ')
                                )
                         || RPAD
                               (NVL
                                   (SUBSTR
                                       (vidheader (i).ship_to_location,
                                          INSTR
                                               (vidheader (i).ship_to_location,
                                                '-'
                                               )
                                        + 1
                                       ),
                                    ' '
                                   ),
                                9,
                                ' '
                               )                             --SHIP_TO_ADDR_ID
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 4, ' ')
                         || RPAD
                               (NVL (vidheader (i).bill_to_name, ' '), 30,
                                ' ')
                         || RPAD
                               (NVL (lc_xmail_site_name, ' '), 30, ' ')
                         || RPAD (NVL (vidheader (i).bill_to_address1, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_address2, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_city, ' '),
                                  28,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_state, ' '),
                                  2,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_postal_code, ' '),
                                  11,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_country, ' '),
                                  3,
                                  ' '
                                 )
                         || RPAD (NVL (vidheader (i).bill_to_attn, ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 2, ' ')
                         || RPAD (NVL (lc_elecrectype, ' '), 2, ' ')
                         || LPAD
                                 (NVL (TO_CHAR (ln_common_count), ' '),
                                  6,
                                  ' '
                                 )                          --ELEC FILE REC NBR
                         || LPAD
                               (NVL (TO_CHAR (ln_detail_count), ' '), 5, ' ')
                                                             --ELEC DETAIL SEQ
                         || RPAD (' ', 9, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL (lc_gc_discount_rec.productcdentered,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                          --product_cd_entered
                         || RPAD
                               (NVL (lc_gc_discount_rec.custprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                             --cust_product_cd
                         || RPAD
                               (NVL (lc_gc_discount_rec.wholesaleprodcd,
                                     ' '
                                    ),
                                20,
                                ' '
                               )                               --whsle_prod_cd
                         || RPAD (' ', 3, ' ')
                         || RPAD (' ', 6, ' ')
                         || RPAD (' ', 14, ' ')
                         || RPAD (' ', 9,' ')
                         || RPAD (NVL (lc_gc_discount_rec.description,
                                       ' '),
                                  30,
                                  ' '
                                 )
                         || RPAD (NVL (lc_gc_discount_rec.uom_code, ' '),
                                  2,
                                  ' '
                                 )
                         || TO_CHAR
                               (NVL (lc_gc_discount_rec.quantity_ordered,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                               (NVL (lc_gc_discount_rec.quantity_invoiced,
                                     0
                                    ),
                                '09999S'
                               )
                         || TO_CHAR
                                (NVL (lc_gc_discount_rec.backordered_qty,
                                      0
                                     ),
                                 '09999S'
                                )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_gc_discount_rec.unit_selling_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       (lc_gc_discount_rec.sku_list_price,
                                        0
                                       ),
                                    '99999990.999S'
                                   ),
                                13,
                                ' '
                               )
                         || LPAD (TO_CHAR (0, '99999990.999S'), 13, ' ')
                         || LPAD
                               (TO_CHAR
                                   (NVL
                                       ((lc_gc_discount_rec.extended_amount*-1),
                                        0
                                       ),
                                    '999999990.99S'
                                   ),
                                13,
                                ' '
                               )
                         || RPAD (' ', 1, ' ')
                         || RPAD (' ', 7, ' ')
                         || RPAD (' ', 5, ' ')
                         || RPAD
                               (NVL
                                   (lc_gc_discount_rec.vendor_product_code,
                                    ' '
                                   ),
                                20,
                                ' '
                               )
                         || RPAD (NVL (lc_gc_discount_rec.taxable_flag,
                                       ' '
                                      ),
                                  1,
                                  ' '
                                 )
                         || RPAD (' ', 1, ' ')
--gift card comments
                         || RPAD
                               (  lc_tender_text ,
                                70,
                                ' '
                               )
--gift card comment
                         || RPAD (' ', 8, ' ')
                        || RPAD
                              (NVL (get_om_details_rec_type.cost_center_desc,
                                    ' '
                                   ),
                               25,
                               ' '
                              )
                         || RPAD (' ', 175, ' ')
                         || RPAD (NVL (vidheader (i).trx_number, ' '), 20,
                                  ' ')
                         || RPAD (NVL (vidheader (i).bill_to_customer_number,
                                       ' '
                                      ),
                                  15,
                                  ' '
                                 )
						 || RPAD (' ', 9, ' ')  -- Added for Kitting, Defect# 37670
		                 || RPAD (' ', 30, ' ') -- Added for Kitting, Defect# 37670
                         || 'X'
                         ||CHR(13)
                        );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        RAISE;
                  END;
               END IF;
                 CLOSE lc_gc_discount;
            END IF;

--End of changes for R1.1 Defect # 1451 (CR 626)

           --====Start of changes for the defect 12435====--
--========================================================================
-- Insert the transactions into the custom table
--========================================================================
                  IF (   (lc_prev_cbi_id = 0)
                      OR (lc_prev_cbi_id <> vidheader (i).cons_inv_id)
                     )
                  THEN
                     lc_prev_cbi_id := vidheader (i).cons_inv_id;

                     BEGIN
                        SAVEPOINT square1;

                        --fnd_file.put_line(fnd_file.output ,'Insert of history record ,Consolidated Bill ID: '||TO_CHAR(vidheader(i).cons_inv_id));
                        INSERT INTO xx_ar_gen_bill_temp
                                    (cons_inv_id,
                                     cons_billing_number,
                                     cut_off_date,
                                     due_date,
                                     trx_number, processed_flag,
                                     customer_trx_id,
                                     created_by, creation_date,
                                     last_updated_by, last_update_date,
                                     last_update_login, request_id,
                                     org_id,
                                     issue_date,
                                     customer_id,
                                     billing_site_id,
                                     c_ext_attr1,                    -- Added for R1.2 CR 466 Defect 1210
                                     c_ext_attr2,                    -- Added for R1.2 CR 466 Defect 1210
                                     n_ext_attr1,                     -- Added for R1.2 CR 466 Defect 1210
                                     n_ext_attr2                     -- Added for R1.2 CR 466 Defect 1210
                                    )
                             VALUES (vidheader (i).cons_inv_id,
                                     vidheader (i).cons_billing_number,
                                     vidheader (i).cut_off_date + 1,
                                     vidheader (i).due_date,
                                     vidheader (i).trx_number, 'Y',
                                     vidheader (i).customer_trx_id,
                                     fnd_global.user_id, SYSDATE,
                                     fnd_global.user_id, SYSDATE,
                                     fnd_global.login_id, ln_request_id,
                                     vidheader (i).org_id,
                                     --SYSDATE        Commented for the defect 11993 -- vidheader(i).issue_date
                                     g_as_of_date,  --Added for the defect 11993
                                     vidheader (i).customer_id,
                                     vidheader (i).billing_site_id,
                                     vidheader (i).billing_method,          -- Added for R1.2 CR 466 Defect 1210
                                     lc_cbi_num,                            -- Added for R1.2 CR 466 Defect 1210
                                     vidheader (i).cust_doc_id,              -- Added for R1.2 CR 466 Defect 1210
                                     ln_cbi_id                               -- Added for R1.2 CR 466 Defect 1210
                                    );
                     EXCEPTION
                        WHEN OTHERS
                        THEN
              /*             fnd_file.put_line
                              (fnd_file.output,
                                  'Problem during insert of history record ,Consolidated Bill ID: '
                               || TO_CHAR (vidheader (i).cons_inv_id)
                              );  */ --Commented for Defect # 1742
                           ROLLBACK TO square1;
                     END;
                  ELSE
                     lc_prev_cbi_id := vidheader (i).cons_inv_id;
                  END IF;
                  -- Begin Defect 9140
                  BEGIN
                     SAVEPOINT square1;
                     --fnd_file.put_line(fnd_file.output ,'Insert of history record ,Consolidated Bill ID: '||TO_CHAR(vidheader(i).cons_inv_id));
                     INSERT INTO xx_ar_gen_bill_lines_all
                                 (cons_inv_id,
                                  cons_billing_number,
                                  cut_off_date,
                                  due_date,
                                  trx_number, processed_flag,
                                  customer_trx_id,
                                  created_by, creation_date,
                                  last_updated_by, last_update_date,
                                  last_update_login, request_id,
                                  org_id,
                                  issue_date,
                                  customer_id,
                                  billing_site_id,
                                  c_ext_attr1,                   -- Added for R1.2 CR 466 Defect 1210
                                  c_ext_attr2,                   -- Added for R1.2 CR 466 Defect 1210
                                  n_ext_attr1,                    -- Added for R1.2 CR 466 Defect 1210
                                  n_ext_attr2                    -- Added for R1.2 CR 466 Defect 1210
                                 )
                          VALUES (vidheader (i).cons_inv_id,
                                  vidheader (i).cons_billing_number,
                                  vidheader (i).cut_off_date + 1,
                                  vidheader (i).due_date,
                                  vidheader (i).trx_number, 'Y',
                                  vidheader (i).customer_trx_id,
                                  fnd_global.user_id, SYSDATE,
                                  fnd_global.user_id, SYSDATE,
                                  fnd_global.login_id, ln_request_id,
                                  vidheader (i).org_id,
                                  --vidheader (i).issue_date, Commented for the defect 11993
                                  g_as_of_date,              --Added for the defect 11993
                                  vidheader (i).customer_id,
                                  vidheader (i).billing_site_id,
                                  vidheader (i).billing_method,          -- Added for R1.2 CR 466 Defect 1210
                                  lc_cbi_num,                             -- Added for R1.2 CR 466 Defect 1210
                                  vidheader (i).cust_doc_id,              -- Added for R1.2 CR 466 Defect 1210
                                  ln_cbi_id                                -- Added for R1.2 CR 466 Defect 1210
                                 );
                  EXCEPTION
                     WHEN OTHERS
                     THEN
                        fnd_file.put_line
                           (fnd_file.output,
                               'Problem during insert of history record ,Consolidated Bill ID: '
                            || TO_CHAR (vidheader (i).cons_inv_id)
                           );
                        ROLLBACK TO square1;
                  END;
           --====End of changes for the defect 12435====--
            END LOOP;
         END IF;
      END LOOP;

      CLOSE lcu_header;
   EXCEPTION
      WHEN UTL_FILE.access_denied
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' access_denied :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.charsetmismatch
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' charsetmismatch :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.delete_failed
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' delete_failed :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.file_open
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' file_open :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.internal_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' internal_error :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_filehandle
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_filehandle :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_filename
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_filename :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_maxlinesize
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_maxlinesize :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_mode
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_mode :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_offset
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_offset :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_operation
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_operation :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.invalid_path
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' invalid_path :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.read_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' read_error :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.rename_failed
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' rename_failed :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN UTL_FILE.write_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Errored :- '
             || ' write_error :: '
             || SQLERRM
             || SQLCODE
            );

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
      WHEN OTHERS
      THEN
         lc_errormsg :=
            (   ' eBill generate_info_copy_file Other Errors : '
             || SQLERRM
             || SQLCODE
            );
      --====Start of changes as a part of defect 11993====--
        FND_FILE.PUT_LINE(FND_FILE.LOG,'Error Location: '||lc_error_location_info);
        FND_FILE.PUT_LINE(FND_FILE.LOG,'Error Debug:    '||lc_error_debug_info);
      --====End of changes as a part of defect 11993====--

         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
         ROLLBACK;   --Added for the defect 12435
   END generate_info_copy_file;
----====Commented For the defect 12435====----
--==================================================
--Done procedure that extracts the data into a file
--===================================================
/*
   PROCEDURE generate_done_file
   IS
      CURSOR lc_ebill_done
      IS
         SELECT ROWID, request_id, ebill_file_name, process_flag
           FROM xxfin.xx_ar_ebill_done_stg
          WHERE process_flag = 'N';

      lc_file_handle    UTL_FILE.file_type;
      lc_errormsg       VARCHAR2 (1000);
      lc_file_name      VARCHAR2 (100);
      lc_file_path      VARCHAR2 (100)     := 'XXFIN_OUTBOUND';
      lc_dba_dir_path   VARCHAR2 (100)     := TO_CHAR (NULL);
      ln_req_id         NUMBER;
      lc_wait           BOOLEAN;
      lc_conc_phase     VARCHAR2 (50);
      lc_conc_status    VARCHAR2 (50);
      lc_dev_phase      VARCHAR2 (50);
      lc_dev_status     VARCHAR2 (50);
      lc_conc_message   VARCHAR2 (50);
      lc_err_status     VARCHAR2 (10);
      lc_err_msg        VARCHAR2 (1000);
   BEGIN
      fnd_file.put_line (fnd_file.output, 'Start Done File...');
      lc_file_name :=
             'DONE_EBILL_' || TO_CHAR (SYSDATE, 'DDMONYYYYHH24MISS')
             || '.txt';
      fnd_file.put_line (fnd_file.output,
                         'Done Filename is :' || lc_file_name
                        );
      lc_file_handle :=
                       UTL_FILE.fopen (lc_file_path, lc_file_name, 'W', 32767);

      FOR lc_ebill_done_rec IN lc_ebill_done
      LOOP
         UTL_FILE.put_line (lc_file_handle,
                            lc_ebill_done_rec.ebill_file_name);

         UPDATE xxfin.xx_ar_ebill_done_stg
            SET process_flag = 'Y'
          WHERE ROWID = lc_ebill_done_rec.ROWID;
      END LOOP;

      COMMIT;
      UTL_FILE.fclose (lc_file_handle);

--+=========================================
 -- Calling the common file copy program
--+=========================================
      BEGIN
         SELECT directory_path
           INTO lc_dba_dir_path
           FROM dba_directories
          WHERE directory_name = 'XXFIN_OUTBOUND';
      EXCEPTION
         WHEN OTHERS
         THEN
            lc_dba_dir_path := NULL;
      END;

      IF lc_dba_dir_path IS NOT NULL
      THEN
         ln_req_id :=
            fnd_request.submit_request
               ('XXFIN',
                'XXCOMFILCOPY',
                '',
                '01-OCT-04 00:00:00',
                FALSE,
                lc_dba_dir_path || '/' || lc_file_name,
                '$XXFIN_DATA/ftp/out/arinvoice/ebilling/' || lc_file_name,
                '',
                '',
                'N',
                '$XXFIN_DATA/archive/outbound'
                                              --Required to archive the files.
               );
         COMMIT;

         IF ln_req_id > 0
         THEN
            lc_wait :=
               fnd_concurrent.wait_for_request (ln_req_id,
                                                10,
                                                0,
                                                lc_conc_phase,
                                                lc_conc_status,
                                                lc_dev_phase,
                                                lc_dev_status,
                                                lc_conc_message
                                               );
         END IF;

         IF TRIM (lc_conc_status) = 'Error'
         THEN
            lc_err_status := 'Y';
            lc_err_msg :=
                  'File Copy of the Ebill Done File Failed : '
               || lc_file_name
               || ': Please check the Log file for Request ID : '
               || ln_req_id;
            fnd_file.put_line (fnd_file.LOG,
                               lc_err_msg || ' : ' || SQLCODE || ' : '
                               || SQLERRM
                              );
         END IF;
      ELSE
-- =======================================================================
-- The output file path is blank. Hence we cannot
-- ftp the file to the XXFIN_DATA/ftp/out/arinvoice/ebilling
-- folder. Manual copy is possible by going to the XXFIN_OUTBOUND folder.
-- =======================================================================
         NULL;
      END IF;
   EXCEPTION
      WHEN UTL_FILE.access_denied
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' access_denied :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' access_denied :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.charsetmismatch
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' charsetmismatch :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' charsetmismatch :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.delete_failed
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' delete_failed :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' delete_failed :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.file_open
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' file_open :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (' Errored :-' || ' file_open :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.internal_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' internal_error :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' internal_error:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_filehandle
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_filehandle :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_filehandle :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_filename
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_filename :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_filename:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_maxlinesize
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_maxlinesize :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_maxlinesize :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_mode
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_mode :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_mode:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_offset
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_offset :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_offset:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_operation
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_operation :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_operation :: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.invalid_path
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' invalid_path :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' invalid_path:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.read_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' read_error :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (' Errored :-' || ' read_error:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.rename_failed
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' rename_failed :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (   ' Errored :-'
                               || ' rename_failed:: '
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN UTL_FILE.write_error
      THEN
         lc_errormsg :=
            (   ' eBill generate_done_file Errored :- '
             || ' write_error :: '
             || SQLERRM
             || SQLCODE
            );
         DBMS_OUTPUT.put_line (' Errored :-' || ' write_error::'
                               || lc_errormsg
                              );
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
      WHEN OTHERS
      THEN
         lc_errormsg :=
            (' eBill generate_done_file Other Errors : ' || SQLERRM || SQLCODE
            );
         DBMS_OUTPUT.put_line (' Errored :-' || ' :: ' || lc_errormsg);
         fnd_file.put_line (fnd_file.LOG, lc_errormsg);
   END generate_done_file;
*/
----====Commented For the defect 12435====----
   -- Start of New Procedure for Defect 12468
-- +===================================================================+
-- | Name : UPDATE_BPEL_STATUS                                         |
-- | Description : update the  process flag field of                   |
-- | XX_AR_EBILL_DONE_STG with 'Y' after the done file has been        |
-- | created by BPEL Server                                            |
-- |                                                                   |
-- |                                                                   |
-- | Parameters : p_file_name, x_return_status                         |
-- |                                                                   |
-- | Returns : Return Status                                           |
-- |                                                                   |
-- +===================================================================+
   PROCEDURE UPDATE_BPEL_STATUS( p_file_name      IN   VARCHAR2
                                ,x_return_status  OUT  VARCHAR2)
   AS


   BEGIN

      UPDATE xx_ar_ebill_done_stg
      SET    process_flag = 'Y'
  -- Start of Defect #4761
            ,last_updated_by    = FND_GLOBAL.USER_ID
            ,last_update_date   = SYSDATE
            ,request_id         = FND_GLOBAL.CONC_REQUEST_ID
            ,last_update_login  = FND_GLOBAL.USER_ID
  -- End of Defect #4761
      WHERE  ebill_file_name = p_file_name;

      IF (SQL%ROWCOUNT = 1) THEN
         x_return_status := 'S';
      ELSE
         x_return_status := 'E';
      END IF;

      COMMIT;

    EXCEPTION
       WHEN OTHERS THEN
          x_return_status := 'E';

   END UPDATE_BPEL_STATUS;

END xx_ar_gen_ebill_pkg;
/
SHOW ERRORS;