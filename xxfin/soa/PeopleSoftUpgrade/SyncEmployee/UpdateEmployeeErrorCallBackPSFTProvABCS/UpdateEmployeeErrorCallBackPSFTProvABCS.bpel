<?xml version = "1.0" encoding = "UTF-8" ?>
<!--
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  Oracle JDeveloper BPEL Designer 
  
  Created: Mon Jun 11 20:48:35 IST 2012
  Type: BPEL 2.0 Process
  Purpose: One Way BPEL Process
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
-->
<process name="UpdateEmployeeErrorCallBackPSFTProvABCS"
         targetNamespace="http://xmlns.oracle.com/PeopleSoftMigration/UpdateEmployeeErrorCallBackPSFTProvABCS/UpdateEmployeeErrorCallBackPSFTProvABCS"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:client="http://xmlns.oracle.com/PeopleSoftMigration/UpdateEmployeeErrorCallBackPSFTProvABCS/UpdateEmployeeErrorCallBackPSFTProvABCS"
         xmlns:ora="http://schemas.oracle.com/xpath/extension"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://xmlns.oracle.com/Enterprise/Tools/services/OD_EMPDATA_ASYNC.1"
         xmlns:bpelx="http://schemas.oracle.com/bpel/extension"
         xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/jms/EmpSynchDev/UpdateEmployeeErrorCallBackPSFTProvABCS/CommonErrorLoggingService"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:xp20="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.Xpath20"
         xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:ns5="http://www.officedepot.com/officedepot/ODComnErrorStructure/1.0"
         xmlns:ns8="http://www.officedepot.com/officedepot/ODComnErrorStructure/1.0"
         xmlns:oraext="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.ExtFunc"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:dvm="http://www.oracle.com/XSL/Transform/java/oracle.tip.dvm.LookupValue"
         xmlns:hwf="http://xmlns.oracle.com/bpel/workflow/xpath"
         xmlns:ids="http://xmlns.oracle.com/bpel/services/IdentityService/xpath"
         xmlns:bpm="http://xmlns.oracle.com/bpmn20/extensions"
         xmlns:xdk="http://schemas.oracle.com/bpel/extension/xpath/function/xdk"
         xmlns:xref="http://www.oracle.com/XSL/Transform/java/oracle.tip.xref.xpath.XRefXPathFunctions"
         xmlns:ns3="http://xmlns.officedepot.com/PeopleSoftMigration/UpdateEmployeeErrorCallBackPSFTProvABCS/UpdateEmployeeErrorToPSFTEBM"
         xmlns:ns4="http://xmlns.oracle.com/Enterprise/Tools/schemas/OD_EMPDATA_ASYNC_SUB.V2"
         xmlns:ldap="http://schemas.oracle.com/xpath/extension/ldap"
         xmlns:ns6="http://xmlns.oracle.com/pcbpel/adapter/jms/10GTo11G/OTMCOSOrderReleaseABCS/InsertErrorLoggerJMSPublisher"
         xmlns:ns7="ODError"
         xmlns:aia="http://www.oracle.com/XSL/Transform/java/oracle.apps.aia.core.xpath.AIAFunctions">
  <import namespace="http://xmlns.oracle.com/PeopleSoftMigration/UpdateEmployeeErrorCallBackPSFTProvABCS/UpdateEmployeeErrorCallBackPSFTProvABCS"
          location="UpdateEmployeeErrorCallBackPSFTProvABCS.wsdl"
          importType="http://schemas.xmlsoap.org/wsdl/"/>
  <!-- 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      PARTNERLINKS                                                      
      List of services participating in this BPEL process               
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <partnerLinks>
    <!-- 
      The 'client' role represents the requester of this service. It is 
      used for callback. The location and correlation information associated
      with the client role are automatically set using WS-Addressing.
    -->
    <partnerLink name="UpdateEmployeeErrorCallBackPSFTProvABCSImpl_client_ep"
                 partnerLinkType="client:UpdateEmployeeErrorCallBackPSFTProvABCS"
                 myRole="UpdateEmployeeErrorCallBackPSFTProvABCSProvider"/>
    <partnerLink name="PeopleSoftCallBackService"
                 partnerLinkType="ns1:OD_EMPDATA_ASYNC_PartnerLinkType"
                 partnerRole="OD_EMPDATA_ASYNC_Provider"/>
    <partnerLink name="InsertErrorLoggerJMSPublisher"
                 partnerLinkType="ns6:Produce_Message_plt"
                 partnerRole="Produce_Message_role"/>
  </partnerLinks>
  <!-- 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      VARIABLES                                                        
      List of messages and XML documents used within this BPEL process 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <variables>
    <!-- Reference to the message passed as input during initiation -->
    <variable name="inputVariable"
              messageType="client:UpdateEmployeeErrorCallBackPSFTProvABCSRequestMessage"/>
    <variable name="InvokePSFTCallBackService_OD_EMPDATA_CALLBACK_InputVariable"
              messageType="ns1:OD_EMPDATA_ASYNC_SUB.V2"/>
    <variable name="FailedEmpList" type="xsd:string"/>
    <variable name="InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable"
              messageType="ns6:Produce_Message_msg"/>
    <variable name="InvokeInsertErrorLoggerApp_Produce_Message_InputVariable"
              messageType="ns6:Produce_Message_msg"/>
  </variables>
  <!-- 
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     ORCHESTRATION LOGIC                                               
     Set of activities coordinating the flow of messages across the    
     services integrated within this business process                  
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <sequence name="main">
    <!-- Receive input from requestor. (Note: This maps to operation defined in UpdateEmployeeErrorCallBackPSFTProvABCS.wsdl) -->
    <receive name="receiveInput"
             partnerLink="UpdateEmployeeErrorCallBackPSFTProvABCSImpl_client_ep"
             portType="client:UpdateEmployeeErrorCallBackPSFTProvABCS"
             operation="updateEmployeeErrorDetailsToPSFT"
             variable="inputVariable" createInstance="yes"/>
    <assign name="TransformToPSFTCallBackFormat">
      <bpelx:annotation>
        <bpelx:pattern patternName="bpelx:transformation"/>
      </bpelx:annotation>
      <copy>
        <from>ora:doXSLTransformForDoc("xsl/Emp_CB_To_PSFT_CB_Map.xsl", $inputVariable.payload)</from>
        <to variable="InvokePSFTCallBackService_OD_EMPDATA_CALLBACK_InputVariable"
            part="parameter"/>
      </copy>
    </assign>
    <assign name="CreateFailedEmpList">
      <copy>
        <from>oraext:create-delimited-string($inputVariable.payload/ns3:EmployeeErrorDetails/ns3:EmployeeID,',')</from>
        <to>$FailedEmpList</to>
      </copy>
    </assign>
    <scope name="Scope1">
      <variables>
        <variable name="tempString" type="xsd:string"/>
        <variable name="messagePayload" type="xsd:string"/>
        <variable name="emailSubject" type="xsd:string"/>
        <variable name="errorText" type="xsd:string"/>
        <variable name="systemName" type="xsd:string"/>
        <variable name="messageOperation" type="xsd:string"/>
        <variable name="applicationTeamErrorText" type="xsd:string"/>
      </variables>
      <faultHandlers>
        <catchAll>
          <sequence name="Sequence2">
            <assign name="AssignInsertErrorLoggerData">
              <copy>
                <from>ora:getPreference('SOA_ADMIN_APP_NAME')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessName</to>
              </copy>
              <copy>
                <from>ora:getCompositeInstanceId()</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessId</to>
              </copy>
              <copy>
                <from>ora:getPreference('CATCH_ALL_PROCESS_STEP')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessStep</to>
              </copy>
              <copy>
                <from>ora:getPreference('DOMAIN')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessDomain</to>
              </copy>
              <copy>
                <from>ora:getCompositeURL()</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:SystemName</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:TradingPartnerDetails/ns7:TPFrom</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:TradingPartnerDetails/ns7:TPTo</to>
              </copy>
              <copy>
                <from>ora:getPreference('ENTITY_ID')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:Entity/ns7:EntityID</to>
              </copy>
              <copy>
                <from>ora:getFaultName()</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorCode</to>
              </copy>
              <copy>
                <from>concat(ora:getPreference('SOA_ADMIN_ERROR_MESSAGE'),$inputVariable.payload/ns3:EmployeeErrorDetails[1]/ns3:ProcessDateTime)</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorDescription</to>
              </copy>
              <copy>
                <from>substring(ora:getFaultAsString(),1,4000)</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorText</to>
              </copy>
              <copy>
                <from>ora:getPreference('ERROR_TYPE')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorType</to>
              </copy>
              <copy>
                <from>ora:getPreference('ERROR_SEVERITY')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorSeverity</to>
              </copy>
              <copy>
                <from>ora:getCurrentDateTime()</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorDateTime</to>
              </copy>
              <copy>
                <from>ora:getPreference('NOTIFICATION_FLAG')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:Notification/ns7:sendNotification</to>
              </copy>
              <copy>
                <from>concat(ora:getPreference('SOA_ADMIN_ERROR_MESSAGE'),$inputVariable.payload/ns3:EmployeeErrorDetails[1]/ns3:ProcessDateTime)</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:Notification/ns7:Subject</to>
              </copy>
              <copy>
                <from>ora:getCompositeInstanceId()</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageId</to>
              </copy>
              <copy>
                <from>ora:getCurrentDateTime()</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageDateTime</to>
              </copy>
              <copy>
                <from>ora:getPreference('MESSAGE_TYPE')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageType</to>
              </copy>
              <copy>
                <from>ora:getPreference('MESSAGE_VERSION')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageVersion</to>
              </copy>
              <copy>
                <from>ora:getPreference('MESSAGE_OPERATION')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageOperation</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageSourceSystem</to>
              </copy>
            </assign>
            <invoke name="InvokeInsertErrorLoggerAdmin"
                    partnerLink="InsertErrorLoggerJMSPublisher"
                    portType="ns6:Produce_Message_ptt"
                    operation="Produce_Message"
                    inputVariable="InvokeInsertErrorLoggerAdmin_Produce_Message_InputVariable"
                    bpelx:invokeAsDetail="no"/>
            <assign name="AssignInsertErrorLoggerData">
              <copy>
                <from>ora:getPreference('SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessName</to>
              </copy>
              <copy>
                <from>ora:getCompositeInstanceId()</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessId</to>
              </copy>
              <copy>
                <from>ora:getPreference('CATCH_ALL_PROCESS_STEP')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessStep</to>
              </copy>
              <copy>
                <from>ora:getPreference('DOMAIN')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:BusinessProcessDomain</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:SystemName</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:TradingPartnerDetails/ns7:TPFrom</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ProcessInfo/ns7:TradingPartnerDetails/ns7:TPTo</to>
              </copy>
              <copy>
                <from>ora:getPreference('ENTITY_ID')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:Entity/ns7:EntityID</to>
              </copy>
              <copy>
                <from>ora:getFaultName()</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorCode</to>
              </copy>
              <copy>
                <from>concat(ora:getPreference('APPLICATION_ERROR_MESSAGE'),$FailedEmpList)</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorDescription</to>
              </copy>
              <copy>
                <from>concat(ora:getPreference('APPLICATION_ERROR_MESSAGE'),$FailedEmpList)</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorText</to>
              </copy>
              <copy>
                <from>ora:getPreference('ERROR_TYPE')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorType</to>
              </copy>
              <copy>
                <from>ora:getPreference('ERROR_SEVERITY')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorSeverity</to>
              </copy>
              <copy>
                <from>ora:getCurrentDateTime()</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:ErrorDetails/ns7:ErrorDateTime</to>
              </copy>
              <copy>
                <from>ora:getPreference('NOTIFICATION_FLAG')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:Notification/ns7:sendNotification</to>
              </copy>
              <copy>
                <from>concat(ora:getPreference('SOA_ADMIN_ERROR_MESSAGE'),$inputVariable.payload/ns3:EmployeeErrorDetails[1]/ns3:ProcessDateTime)</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:Notification/ns7:Subject</to>
              </copy>
              <copy>
                <from>ora:getCompositeInstanceId()</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageId</to>
              </copy>
              <copy>
                <from>ora:getCurrentDateTime()</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageDateTime</to>
              </copy>
              <copy>
                <from>ora:getPreference('MESSAGE_TYPE')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageType</to>
              </copy>
              <copy>
                <from>ora:getPreference('MESSAGE_VERSION')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageVersion</to>
              </copy>
              <copy>
                <from>ora:getPreference('MESSAGE_OPERATION')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageOperation</to>
              </copy>
              <copy>
                <from>ora:getPreference('SOURCE_SYSTEM_NAME')</from>
                <to>$InvokeInsertErrorLoggerApp_Produce_Message_InputVariable.body/ns7:MessageDetails/ns7:MessageSourceSystem</to>
              </copy>
            </assign>
            <invoke name="InvokeInsertErrorLoggerApp"
                    partnerLink="InsertErrorLoggerJMSPublisher"
                    portType="ns6:Produce_Message_ptt"
                    operation="Produce_Message"
                    inputVariable="InvokeInsertErrorLoggerApp_Produce_Message_InputVariable"
                    bpelx:invokeAsDetail="no"/>
          </sequence>
        </catchAll>
      </faultHandlers>
      <sequence name="Sequence1">
        <invoke name="InvokePSFTCallBackService"
                partnerLink="PeopleSoftCallBackService"
                portType="ns1:OD_EMPDATA_ASYNC_PortType"
                operation="OD_EMPDATA_CALLBACK"
                inputVariable="InvokePSFTCallBackService_OD_EMPDATA_CALLBACK_InputVariable"
                bpelx:invokeAsDetail="no"/>
      </sequence>
    </scope>
  </sequence>
</process>