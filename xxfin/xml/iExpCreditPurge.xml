<dataTemplate name="iExpenseCreditReport" description="" defaultPackage="XX_AP_IEXP_CREDIT_ALERT" Version="1.0">
<properties>
  <property name="scalable_mode" value="on" /> 
  <property name="rtf-output-default-font">Arial:8</property>
  <property name="debug_mode" value="on" />
</properties>
<parameters>
<parameter name="p_end_date" datatype="varchar2" /> 
</parameters>
<dataQuery>
<sqlStatement name="Q_ALERT">
<![CDATA[
SELECT EMPLOYEE_NUMBER AS EMPLOYEE_NUMBER,
EMPLOYEE_NAME AS EMPLOYEE_NAME,
INVOICE_NUM        AS INVOICE_NUM,
DESCRIPTION        AS DESCRIPTION,
TRANSACTION_TYPE   AS TRANSACTION_TYPE,
TRANSACTION_AMOUNT AS TRANSACTION_AMOUNT,
to_char(POSTED_DATE,'DD-MON-YYYY')   AS POSTED_DATE,
to_char(CREATION_DATE,'DD-MON-YYYY') AS CREATION_DATE,
MERCHANT_NAME      AS MERCHANT_NAME,
PAYMENT_FLAG       AS PAYMENT_FLAG,
REQUEST_ID         AS TRANSACTION_REQUEST_ID,
PURGE_DATE        AS PURGE_DATE
from
( 
SELECT 
per.employee_number as EMPLOYEE_NUMBER
,Aca.CARDMEMBER_NAME as EMPLOYEE_NAME
,AIA.INVOICE_NUM as INVOICE_NUM
,APC.DESCRIPTION 
,apc.transaction_type as TRANSACTION_TYPE
,apc.TRANSACTION_AMOUNT
,apc.POSTED_DATE
,apc.creation_date
,apc.merchant_name1 as MERCHANT_NAME
,apc.payment_flag
,apc.request_id
,AIA.attribute15 as PURGE_DATE
FROM AP_INVOICES_ALL AIA,
AP_CREDIT_CARD_TRXNS_ALL APC,
ap_cards_all aca,
per_people_f per
wHERE INVOICE_AMOUNT <'0'
AND APC.DESCRIPTION  = AIA.INVOICE_NUM
AND APC.CARD_ID  = ACA.CARD_ID
AND apc.payment_flag = 'Y'
AND per.person_id = aca.employee_id
UNION
SELECT 
per.employee_number
,ACA.CARDMEMBER_NAME as EMPLOYEE_NAME
,(SELECT aia.INVOICE_NUM
FROM AP_INVOICES_ALL AIA,
ap_expense_report_headers_all aer
WHERE AIA.VENDOR_ID         = 162007
aND AIA.INVOICE_AMOUNT      <'0'
AND aia.invoice_num         = aer.invoice_num
AND ABS(AIA.INVOICE_AMOUNT) = apc.TRANSACTION_AMOUNT
aND aer.employee_id         = aca.employee_id
)INVOICE_NUM 
,APC.DESCRIPTION
,apc.transaction_type
,apc.TRANSACTION_AMOUNT
,apc.POSTED_DATE
,apc.creation_date
,apc.merchant_name1 as MERCHANT_NAME
,apc.payment_Flag 
,apc.request_id
,(SELECT aia.attribute15
FROM AP_INVOICES_ALL AIA,
ap_expense_report_headers_all aer
WHERE AIA.VENDOR_ID         = 162007
AND AIA.INVOICE_AMOUNT      <'0'
AND aia.invoice_num         = aer.invoice_num
AND ABS(AIA.INVOICE_AMOUNT) = apc.TRANSACTION_AMOUNT
AND aer.employee_id         = aca.employee_id
)PURGE_DATE 
FROM AP_CREDIT_CARD_TRXNS_ALL APC,
ap_cards_all aca,
per_people_f per
where APC.DESCRIPTION in ('CREDIT BALANCE REFUND','DEBIT PER COMPANY')
AND APC.CARD_ID   = ACA.CARD_ID
AND per.person_id = aca.employee_id
AND apc.payment_flag  = 'Y'
)
where invoice_num is not null
AND trunc(fnd_conc_date.string_to_date(PURGE_DATE))  = trunc (fnd_conc_date.string_to_date (:p_end_date))
]]> 
</sqlStatement>
</dataQuery>
<dataStructure>
<group name="G_ALERT" source="Q_ALERT">
<element name="EMPLOYEE_NUMBER" value="EMPLOYEE_NUMBER" function="" />
<element name="EMPLOYEE_NAME" value="EMPLOYEE_NAME" function="" />
<element name="INVOICE_NUM" value="INVOICE_NUM" function="" />
<element name="DESCRIPTION" value="DESCRIPTION" function="" />
<element name="TRANSACTION_TYPE" value="TRANSACTION_TYPE" function="" />
<element name="TRANSACTION_AMOUNT" value="TRANSACTION_AMOUNT" function="" />
<element name="POSTED_DATE" value="POSTED_DATE" function="" />
<element name="CREATION_DATE" value="CREATION_DATE" function="" />
<element name="MERCHANT_NAME" value="MERCHANT_NAME" function="" />
<element name="PAYMENT_FLAG" value="PAYMENT_FLAG" function="" />
<element name="TRANSACTION_REQUEST_ID" value="TRANSACTION_REQUEST_ID" function="" />
<element name="PURGE_DATE" value="PURGE_DATE" function="" />
</group>
</dataStructure>
</dataTemplate>