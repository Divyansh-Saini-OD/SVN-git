<?xml version="1.0" encoding="WINDOWS-1252" ?>
<dataTemplate name="XXAPIEXTRXSPENDQRYRPT" description="OD: Employee TE CC Spend Analytics Report" defaultPackage="" Version="1.0">
<properties>
   <property name="include_parameters" value="true" />
   <property name="xml_tag_case" value="as_are" />
</properties>
<parameters>
 <parameter name="p_empl_name" datatype="character" />
 <parameter name="p_empl_num" datatype="character" />
 <parameter name="p_card_num" datatype="number" />
 <parameter name="p_year" datatype="number" />
 <parameter name="p_bill_type" datatype="character" />
</parameters>
<dataQuery>
<sqlStatement name="Q_SPEND">
<![CDATA[
WITH
    dateRange as (select startDate JAN_START, add_months(startDate, 1) -1 JAN_END
        ,ADD_MONTHS(startDate, 1) FEB_START, ADD_MONTHS(startDate, 2)-1 FEB_END
        ,ADD_MONTHS(startDate, 2) MAR_START, ADD_MONTHS(startDate, 3)-1 MAR_END
        ,ADD_MONTHS(startDate, 3) APR_START, ADD_MONTHS(startDate, 4)-1 APR_END
        ,ADD_MONTHS(startDate, 4) MAY_START, ADD_MONTHS(startDate, 5)-1 MAY_END
        ,ADD_MONTHS(startDate, 5) JUN_START, ADD_MONTHS(startDate, 6)-1 JUN_END
        ,ADD_MONTHS(startDate, 6) JUL_START, ADD_MONTHS(startDate, 7)-1 JUL_END
        ,ADD_MONTHS(startDate, 7) AUG_START, ADD_MONTHS(startDate, 8)-1 AUG_END
        ,ADD_MONTHS(startDate, 8) SEP_START, ADD_MONTHS(startDate, 9)-1 SEP_END
        ,ADD_MONTHS(startDate, 9) OCT_START, ADD_MONTHS(startDate, 10)-1 OCT_END
        ,ADD_MONTHS(startDate, 10) NOV_START, ADD_MONTHS(startDate, 11)-1 NOV_END
        ,ADD_MONTHS(startDate, 11) DEC_START, ADD_MONTHS(startDate, 12)-1 DEC_END
      from (select to_date(decode(NVL(:p_bill_type, 'Calendar Month'), 'Calendar Month', '01-JAN-'||:p_year, 'Billing Cycle', '16-DEC-'||(:p_year-1)), 'DD-MON-RRRR') as startDate from dual) dateTable)  
    
    ,iexp_data as (

      SELECT iex_tbl.employee_number, iex_tbl.full_name, iex_tbl.masked_cc_number, iex_tbl.job_name job_name
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.JAN_START and dateRange.JAN_END THEN iex_tbl.expensed_amt ELSE 0 END) JAN_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.FEB_START and dateRange.FEB_END THEN iex_tbl.expensed_amt ELSE 0 END) FEB_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.MAR_START and dateRange.MAR_END THEN iex_tbl.expensed_amt ELSE 0 END) MAR_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.APR_START and dateRange.APR_END THEN iex_tbl.expensed_amt ELSE 0 END) APR_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.MAY_START and dateRange.MAY_END THEN iex_tbl.expensed_amt ELSE 0 END) MAY_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.JUN_START and dateRange.JUN_END THEN iex_tbl.expensed_amt ELSE 0 END) JUN_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.JUL_START and dateRange.JUL_END THEN iex_tbl.expensed_amt ELSE 0 END) JUL_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.AUG_START and dateRange.AUG_END THEN iex_tbl.expensed_amt ELSE 0 END) AUG_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.SEP_START and dateRange.SEP_END THEN iex_tbl.expensed_amt ELSE 0 END) SEP_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.OCT_START and dateRange.OCT_END THEN iex_tbl.expensed_amt ELSE 0 END) OCT_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.NOV_START and dateRange.NOV_END THEN iex_tbl.expensed_amt ELSE 0 END) NOV_AMT
          ,SUM(CASE WHEN iex_tbl.check_date between dateRange.DEC_START and dateRange.DEC_END THEN iex_tbl.expensed_amt ELSE 0 END) DEC_AMT
       FROM 
       (
          SELECT rslt.employee_number,rslt.full_name,sum(rslt.expensed_amount) as expensed_amt,rslt.check_date,rslt.masked_cc_number,rslt.job_name
          from (
              SELECT a.employee_number,a.full_name,rh.invoice_num,txn.expensed_amount,trunc(ac.check_date) check_date,icc.masked_cc_number,
                     j.name job_name
                 FROM per_jobs j,
                      per_all_assignments_f ps,
                      iby_creditcard icc,
                      ap_cards_all card,
                      ap_checks_all ac,
                      ap_invoice_payments_all aip,   
                      ap_invoices_all ai,
                      ap_credit_card_trxns_all txn,
                      ap_expense_report_headers_all rh1,
                      ap_expense_report_headers_all rh,
                      (select distinct papf.person_id, papf.employee_number, papf.full_name 
                         from per_all_people_f papf 
                         where papf.person_id = NVL(:p_empl_name,papf.person_id)
                           AND papf.person_id = NVL(:p_empl_num ,papf.person_id)) a,
                      dateRange
                WHERE rh.employee_id=a.person_id
                --  AND rh.report_header_id in (3486435,3487167,174005,212011)
                  AND rh1.bothpay_parent_id=rh.report_header_id 
                  AND rh.expense_status_code='PAID'
                  AND ai.invoice_id = rh1.vouchno
                  AND aip.invoice_id=ai.invoice_id
                  AND aip.check_id = ac.check_id
                  AND txn.report_header_id=rh.report_header_id
                  AND txn.category='BUSINESS'
                  AND txn.card_id = nvl(:p_card_num, txn.card_id)
                  AND card.card_id=txn.card_id
                  AND card.card_reference_id = icc.instrid
                  AND ps.person_id=a.person_id
                  AND j.job_id=ps.job_id
                  AND txn.expensed_amount<>0
              --    AND a.person_id = NVL(:p_empl_name,a.person_id)
              --    AND a.person_id = NVL(:p_empl_num ,a.person_id)
                  AND ac.check_date between dateRange.JAN_START and dateRange.DEC_END
                  AND ps.assignment_id IN (select max(assignment_id)
                                             from per_all_assignments_f
                                            where person_id=a.person_id)
          ) rslt
          group by rslt.employee_number,rslt.full_name,rslt.check_date,rslt.masked_cc_number,rslt.job_name              
       ) iex_tbl, dateRange
       group by iex_tbl.employee_number, iex_tbl.full_name, iex_tbl.masked_cc_number, iex_tbl.job_name                        
)
SELECT 
    iexp_sum_calc.employee_number as C_EMPLOYEE_NUM, iexp_sum_calc.full_name as C_FULL_NAME, iexp_sum_calc.masked_cc_number as C_TRX_CARD_NUMBER, iexp_sum_calc.job_name as C_JOB_NAME
  , iexp_sum_calc.JAN_AMT C_JAN_AMT, iexp_sum_calc.FEB_AMT C_FEB_AMT, iexp_sum_calc.MAR_AMT C_MAR_AMT, iexp_sum_calc.APR_AMT C_APR_AMT, iexp_sum_calc.MAY_AMT C_MAY_AMT, iexp_sum_calc.JUN_AMT C_JUN_AMT
  , iexp_sum_calc.JUL_AMT C_JUL_AMT, iexp_sum_calc.AUG_AMT C_AUG_AMT, iexp_sum_calc.SEP_AMT C_SEP_AMT, iexp_sum_calc.OCT_AMT C_OCT_AMT, iexp_sum_calc.NOV_AMT C_NOV_AMT, iexp_sum_calc.DEC_AMT C_DEC_AMT
  , round(iexp_sum_calc.TOTAL_EXP_AMT, 2) as C_TOT_AMT  
  , round(iexp_sum_calc.TOTAL_EXP_AMT/decode(iexp_sum_calc.SPEND_MON, 0, 1,iexp_sum_calc.SPEND_MON), 2) as C_SPEND_AVG
  , round(iexp_sum_calc.TOTAL_EXP_AMT/anu_avg_tbl.ANNUAL_MONTH, 2) as C_ANU_AVG
FROM  
(SELECT iexp.*
        ,(JAN_AMT + FEB_AMT + MAR_AMT + APR_AMT + MAY_AMT + JUN_AMT + JUL_AMT + AUG_AMT + SEP_AMT + OCT_AMT + NOV_AMT + DEC_AMT)   as TOTAL_EXP_AMT 
      ,  (decode(JAN_AMT, 0, 0, 1)
        +decode(FEB_AMT, 0, 0, 1)
        +decode(MAR_AMT, 0, 0, 1)
        +decode(APR_AMT, 0, 0, 1)
        +decode(MAY_AMT, 0, 0, 1)
        +decode(JUN_AMT, 0, 0, 1)
        +decode(JUL_AMT, 0, 0, 1)
        +decode(AUG_AMT, 0, 0, 1)
        +decode(SEP_AMT, 0, 0, 1)
        +decode(OCT_AMT, 0, 0, 1)
        +decode(NOV_AMT, 0, 0, 1)
        +decode(DEC_AMT, 0, 0, 1) )  as SPEND_MON                     
FROM   iexp_data iexp ) iexp_sum_calc
       , (  select decode(ANUAL_MON, 0, 1, ANUAL_MON) ANNUAL_MONTH   from 
            (
              select ceil(MONTHS_BETWEEN(decode(:p_year, extract(year from sysdate), sysdate, DEC_END), JAN_START)) as ANUAL_MON from  dateRange) 
            ) anu_avg_tbl    -- Table to get Annual months(Strat date to enddate(sysdate/yearEndDate)) in that year
ORDER BY UPPER(iexp_sum_calc.full_name)  	]]>
</sqlStatement>
</dataQuery>
<dataStructure>
<group name="G_TOTAL" source="Q_SPEND">
<element name="TOTAL_JAN_AMT" value="G_SPEND.C_JAN_AMT" function="SUM()"/>
<element name="TOTAL_FEB_AMT" value="G_SPEND.C_FEB_AMT" function="SUM()"/>
<element name="TOTAL_MAR_AMT" value="G_SPEND.C_MAR_AMT" function="SUM()"/>
<element name="TOTAL_APR_AMT" value="G_SPEND.C_APR_AMT" function="SUM()"/>
<element name="TOTAL_MAY_AMT" value="G_SPEND.C_MAY_AMT" function="SUM()"/>
<element name="TOTAL_JUN_AMT" value="G_SPEND.C_JUN_AMT" function="SUM()"/>
<element name="TOTAL_JUL_AMT" value="G_SPEND.C_JUL_AMT" function="SUM()"/>
<element name="TOTAL_AUG_AMT" value="G_SPEND.C_AUG_AMT" function="SUM()"/>
<element name="TOTAL_SEP_AMT" value="G_SPEND.C_SEP_AMT" function="SUM()"/>
<element name="TOTAL_OCT_AMT" value="G_SPEND.C_OCT_AMT" function="SUM()"/>
<element name="TOTAL_NOV_AMT" value="G_SPEND.C_NOV_AMT" function="SUM()"/>
<element name="TOTAL_DEC_AMT" value="G_SPEND.C_DEC_AMT" function="SUM()"/>
<element name="TOTAL_TOT_AMT" value="G_SPEND.C_TOT_AMT" function="SUM()"/>
<element name="TOTAL_SPEND_AVG" value="G_SPEND.C_SPEND_AVG" function="SUM()"/>
<element name="TOTAL_ANU_AVG" value="G_SPEND.C_ANU_AVG" function="SUM()"/>
<group name="G_SPEND" source="Q_SPEND">
<element name="C_EMPLOYEE_NUM" value="C_EMPLOYEE_NUM" />
<element name="C_FULL_NAME" value="C_FULL_NAME" />
<element name="C_TRX_CARD_NUMBER" value="C_TRX_CARD_NUMBER" />
<element name="C_JOB_NAME" value="C_JOB_NAME" />
<element name="C_JAN_AMT" value="C_JAN_AMT" />
<element name="C_FEB_AMT" value="C_FEB_AMT" />
<element name="C_MAR_AMT" value="C_MAR_AMT" />
<element name="C_APR_AMT" value="C_APR_AMT" />
<element name="C_MAY_AMT" value="C_MAY_AMT" />
<element name="C_JUN_AMT" value="C_JUN_AMT" />
<element name="C_JUL_AMT" value="C_JUL_AMT" />
<element name="C_AUG_AMT" value="C_AUG_AMT" />
<element name="C_SEP_AMT" value="C_SEP_AMT" />
<element name="C_OCT_AMT" value="C_OCT_AMT" />
<element name="C_NOV_AMT" value="C_NOV_AMT" />
<element name="C_DEC_AMT" value="C_DEC_AMT" />
<element name="C_TOT_AMT" value="C_TOT_AMT" />
<element name="C_SPEND_AVG" value="C_SPEND_AVG" />
<element name="C_ANU_AVG" value="C_ANU_AVG" />
</group>
</group>
</dataStructure>
</dataTemplate>