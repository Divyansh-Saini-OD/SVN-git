<?xml version="1.0" encoding="UTF-8"?>
<dataTemplate name="XXAPRTVCONXML" defaultPackage="XX_AP_RTVCONS_PKG" Version="1.0">
<parameters>
  <parameter name="P_FREQUENCY" dataType="string" />
  <parameter name="P_START_DATE" dataType="date" />
  <parameter name="P_END_DATE" dataType="date" />
</parameters>
  <dataQuery>
<sqlStatement name="Q1">
 <![CDATA[ SELECT :G_SMTP_SERVER SMTP_SERVER,
   :G_EMAIL_SUBJECT EMAIL_SUBJECT, :G_EMAIL_CONTENT EMAIL_CONTENT,
 ASA.VENDOR_SITE_CODE ORACLE_SUPPLIER_SITE, asa.vendor_site_id VENDOR_SITE_IDQ2,
  ASA.VENDOR_SITE_CODE_ALT SUPPLIER_SITE_ALT,
  ASU.VENDOR_NAME SUPPLIER_NAME,
  ASU.SEGMENT1 ORACLE_SUPPLIER_NUMBER,
  ASA.EMAIL_ADDRESS EMAIL,
  TO_CHAR(sysdate,'MM/DD/YYYY') CURRENT_DATE
from XX_PO_VENDOR_SITES_KFF XPVS,  
  MTL_MATERIAL_TRANSACTIONS MMT,  
  AP_SUPPLIERS ASU,
  AP_SUPPLIER_SITES_ALL ASA
WHERE 1                                 =1
&G_WHERE_CLAUSE
AND XPVS.SEGMENT43 <> '100'
AND MMT.TRANSACTION_SOURCE_NAME         = 'OD CONSIGNMENT RTV'
AND MMT.ATTRIBUTE1                     IS NOT NULL
AND MMT.ATTRIBUTE2                     IS NOT NULL
AND MMT.ATTRIBUTE3                     IS NOT NULL
AND LTRIM(ASA.vendor_site_code_alt,'0') = LTRIM(MMT.ATTRIBUTE1,'0')
AND ASA.PAY_SITE_FLAG                   ='Y'
AND ASU.VENDOR_ID                       = ASA.VENDOR_ID
AND ASA.ATTRIBUTE12                     = XPVS.VS_KFF_ID
GROUP BY 
:G_SMTP_SERVER,
   :G_EMAIL_SUBJECT, :G_EMAIL_CONTENT,
   ASA.VENDOR_SITE_CODE ,asa.vendor_site_id,
  ASA.VENDOR_SITE_CODE_ALT,
  ASU.VENDOR_NAME,
  ASU.SEGMENT1, 
  ASA.EMAIL_ADDRESS,
  TO_CHAR(sysdate,'MM/DD/YYYY')]]> 
</sqlStatement>
 <sqlStatement name="Q2">
 <![CDATA[ 
  SELECT  DISTINCT  TO_CHAR(MMT.TRANSACTION_DATE,'MM/DD/YYYY') ENTRY_DATE,  
  ASA.VENDOR_SITE_CODE ORACLE_SUPPLIER_SITE2, 
  asa.vendor_site_id VENDOR_SITE_IDQ3,
  ASA.VENDOR_SITE_CODE_ALT SUPPLIER_SITE_ALT2,
  ASU.VENDOR_NAME SUPPLIER_NAME2,
  ASU.SEGMENT1 ORACLE_SUPPLIER_NUMBER2,
  ASA.EMAIL_ADDRESS EMAIL2,  
  TO_CHAR(sysdate,'MM/DD/YYYY') CURRENT_DATE2,
  SUBSTR(ASA.ADDRESS_LINE1,1,30) ADDRESS1,
  SUBSTR(ASA.ADDRESS_LINE2,1,30) ADDRESS2,
  SUBSTR(ASA.ADDRESS_LINE3,1,30) ADDRESS3,
  ASA.CITY CITY,
  ASA.STATE STATE,
  ASA.ZIP ZIP,
  ASA.COUNTRY COUNTRY,
  XARH.INVOICE_NUM  RTV, --AI.INVOICE_NUM RTV,
  (SELECT DECODE(SUBSTR(asp.base_currency_code,1,2),'US','USTRA','CA','CATRA',NULL)
  FROM ap_system_parameters_all asp
  WHERE asp.org_id=asa.org_id --AI.ORG_ID
  ) BU,
  XARH.INVOICE_NUM   --AI.INVOICE_NUM
  ||'-'
  ||ASA.ATTRIBUTE9 DISPOSITION_DOCUMENT,
  XX_AP_RTVCONS_PKG.findDispCode(XARH.INVOICE_NUM) DISPOSITION_CODE,
  --XARH.CARRIER_NAME FREIGHT_CARRIER,  
  TO_CHAR(MMT.TRANSACTION_DATE) TRANSACTION_DATE1,
  HOU.NAME STORE,
  (SELECT SUBSTR(ADDRESS_LINE_1,1,30)
  FROM HR_LOCATIONS
  WHERE LOCATION_ID=HOU.LOCATION_ID
  ) STORE_LINE1,
  (SELECT SUBSTR(ADDRESS_LINE_2,1,30)
  FROM HR_LOCATIONS
  WHERE LOCATION_ID=HOU.LOCATION_ID
  ) STORE_LINE2,
  (SELECT SUBSTR(ADDRESS_LINE_3,1,30)
  FROM HR_LOCATIONS
  WHERE LOCATION_ID=HOU.LOCATION_ID
  ) STORE_LINE3,
  (SELECT SUBSTR(TOWN_OR_CITY,1,30)
  FROM HR_LOCATIONS
  WHERE LOCATION_ID=HOU.LOCATION_ID
  ) TOWN_OR_CITY,
  (SELECT COUNTRY 
  FROM HR_LOCATIONS 
  WHERE LOCATION_ID=HOU.LOCATION_ID
  ) STORE_COUNTRY,
  (SELECT POSTAL_CODE
  FROM HR_LOCATIONS
  WHERE LOCATION_ID=HOU.LOCATION_ID
  ) STORE_PO,
  MMT.ATTRIBUTE1 SUPPLIER_SITE,
  MMT.ATTRIBUTE2 ORIGINAL_RTV,
  MMT.ATTRIBUTE4 FREIGHT_BILL,
  MMT.ATTRIBUTE5 FREIGHT_CARRIER,  
  MMT.ATTRIBUTE3 RGA,
  xarh.ship_name ,
  xarh.Ship_address1 ,
  xarh.Ship_address2 ,
  xarh.Ship_address3 ,
  trim(rtrim(SUBSTR( xarh.SHIP_ADDRESS4 ,1,instr(xarh.SHIP_ADDRESS4,',')), ',')) ,
  trim(Ltrim(SUBSTR( xarh.SHIP_ADDRESS4 ,instr(xarh.SHIP_ADDRESS4,','), LENGTH(xarh.SHIP_ADDRESS4)),',')) Ship_address4,
  xarh.Ship_address5
FROM XX_PO_VENDOR_SITES_KFF XPVS, 
  XX_AP_RTV_HDR_ATTR XARH,  
  MTL_MATERIAL_TRANSACTIONS MMT,
  AP_SUPPLIERS ASU,
  AP_SUPPLIER_SITES_ALL ASA,
  HR_ORGANIZATION_UNITS HOU
WHERE 1                                 =1
&G_WHERE_CLAUSE
AND XPVS.SEGMENT43 <> '100'
AND MMT.TRANSACTION_SOURCE_NAME         = 'OD CONSIGNMENT RTV'
AND MMT.ATTRIBUTE1                     IS NOT NULL
AND MMT.ATTRIBUTE2                     IS NOT NULL
AND MMT.ATTRIBUTE3                     IS NOT NULL
AND LTRIM(ASA.vendor_site_code_alt,'0') = LTRIM(MMT.ATTRIBUTE1,'0')
AND asa.vendor_Site_ID = :VENDOR_SITE_IDQ2 
AND ASA.PAY_SITE_FLAG                     ='Y'
AND ASU.VENDOR_ID                         = ASA.VENDOR_ID
AND HOU.ORGANIZATION_ID                   = MMT.ORGANIZATION_ID
AND XARH.RTV_NUMBER                       = MMT.ATTRIBUTE2
--AND XARL.HEADER_ID                      = XARH.HEADER_ID
--AND XARL.RTV_NUMBER                     = XARH.RTV_NUMBER
AND XARH.RECORD_STATUS                    ='C'
AND ASA.ATTRIBUTE12                       =XPVS.VS_KFF_ID
order by MMT.ATTRIBUTE3,MMT.ATTRIBUTE4,HOU.NAME
	]]> 
</sqlStatement>	
<sqlStatement name="Q3">
 <![CDATA[ SELECT distinct
(SELECT distinct mc.segment3     
      FROM mtl_item_categories mic, mtl_categories_b mc, mtl_system_items_b msib1
      WHERE msib1.inventory_item_id = mic.inventory_item_id
      AND mic.category_id = mc.category_id
      AND msib1.inventory_item_id    = MMT.INVENTORY_ITEM_ID
      AND MSIB1.ORGANIZATION_ID+0   = MMT.ORGANIZATION_ID
      AND mc.segment3 IS NOT NULL) DEPT,
  XARL.SERIAL_NUM SERIAL_NUMBER,
MSIB.SEGMENT1 SKU,
  MMT.ATTRIBUTE6 VENDOR_PRODUCT,
  MSIB.DESCRIPTION DESCRIPTION,
  MMT.TRANSACTION_QUANTITY RTV_QTY,
  MMT.TRANSACTION_COST RTV_ITEM_COST,
  (MMT.TRANSACTION_COST * MMT.TRANSACTION_QUANTITY) RTV_EXTENDED_COST
  FROM 
  XX_AP_RTV_HDR_ATTR XARH,
  MTL_MATERIAL_TRANSACTIONS MMT,
  MTL_SYSTEM_ITEMS_B MSIB,
  XX_AP_RTV_LINES_ATTR XARL
  WHERE 1 = 1
  AND trunc(mmt.transaction_date) = :TRANSACTION_DATE1 --to_Date(:TRANSACTION_DATE1,'DD/MM/YYYY')
  AND XARL.HEADER_ID                      = XARH.HEADER_ID
AND XARL.RTV_NUMBER                     = XARH.RTV_NUMBER
AND XARH.RECORD_STATUS                  ='C'  
  AND NVL(xarl.rga_number,'Y') =NVL(:RGA,NVL(xarl.rga_number,'Y'))
  AND mmt.attribute2= xarh.rtv_number
  AND mmt.ATTRIBUTE3 = xarl.rga_number
  AND NVL(mmt.ATTRIBUTE5,'XX') = NVL(:FREIGHT_CARRIER,'XX')
  AND NVL(mmt.ATTRIBUTE4 ,'XX') = NVL( :FREIGHT_BILL ,'XX') 
  AND MSIB.INVENTORY_ITEM_ID              = MMT.INVENTORY_ITEM_ID
  AND MSIB.ORGANIZATION_ID+0              = MMT.ORGANIZATION_ID]]> 
</sqlStatement>
   </dataQuery> 
<dataTrigger name="beforeReport" source="XX_AP_RTVCONS_PKG.beforeReport()"/>
  <dataStructure>
<group name="G_CONSIGNMENT_RTV" source="Q1">
<element name="ORACLE_SUPPLIER_NUMBER" value="ORACLE_SUPPLIER_NUMBER"/> 
<element name="SMTP_SERVER" value= "SMTP_SERVER" />
	<element name="EMAIL_SUBJECT" value= "EMAIL_SUBJECT" />
	<element name="EMAIL_CONTENT" value= "EMAIL_CONTENT" />
<element name="ORACLE_SUPPLIER_SITE" value="ORACLE_SUPPLIER_SITE"/> 
<element name="VENDOR_SITE_IDQ2" value="VENDOR_SITE_IDQ2"/>
<element name="SUPPLIER_SITE_ALT" value="SUPPLIER_SITE_ALT"/>
<element name="SUPPLIER_NAME" value="SUPPLIER_NAME"/>
<element name="EMAIL_ADDRESS" value="EMAIL"/> 
<element name="CURRENT_DATE" value="CURRENT_DATE"/> 
<group name="G_CONSIGNMENT_RTV_HDR" source="Q2">
<element name="ENTRY_DATE" value="ENTRY_DATE"/>
<element name="ORACLE_SUPPLIER_NUMBER2" value="ORACLE_SUPPLIER_NUMBER2"/>
<element name="ORACLE_SUPPLIER_SITE2" value="ORACLE_SUPPLIER_SITE2"/> 
<element name="VENDOR_SITE_IDQ3" value="VENDOR_SITE_IDQ3"/>
<element name="SUPPLIER_SITE_ALT2" value="SUPPLIER_SITE_ALT2"/>
<element name="SUPPLIER_NAME2" value="SUPPLIER_NAME2"/>
<element name="EMAIL_ADDRESS2" value="EMAIL2"/>
<element name="CURRENT_DATE2" value="CURRENT_DATE2"/>  
<element name="ADDRESS1" value="ADDRESS1"/>
<element name="ADDRESS2" value="ADDRESS2"/>
<element name="ADDRESS3" value="ADDRESS3"/>
<element name="CITY" value="CITY"/> 
<element name="STATE" value="STATE"/> 
<element name="ZIP" value="ZIP"/> 
<element name="COUNTRY" value="COUNTRY"/> 
<element name="RTV" value="ORIGINAL_RTV"/>
<element name="BU" value="BU"/>
<element name="DISPOSITION_DOCUMENT" value="DISPOSITION_DOCUMENT"/>
<element name="DISPOSITION_CODE" value="DISPOSITION_CODE"/>
<element name="TRANSACTION_DATE1" value="TRANSACTION_DATE1"/>
<element name="STORE" value="STORE"/>
<element name="STORE_LINE1" value="STORE_LINE1"/>
<element name="STORE_LINE2" value="STORE_LINE2"/>
<element name="STORE_LINE3" value="STORE_LINE3"/>
<element name="TOWN_OR_CITY" value="TOWN_OR_CITY"/>
<element name="STORE_COUNTRY" value="STORE_COUNTRY"/>
<element name="STORE_PO" value="STORE_PO"/>
<element name="SHIP_NAME" value="SHIP_NAME"/>
<element name="SHIP_ADDRESS1" value="SHIP_ADDRESS1"/>
<element name="SHIP_ADDRESS2" value="SHIP_ADDRESS2"/>
<element name="SHIP_ADDRESS3" value="SHIP_ADDRESS3"/>
<element name="SHIP_ADDRESS4" value="SHIP_ADDRESS4"/>
<element name="SHIP_ADDRESS5" value="SHIP_ADDRESS5"/>
<element name="FREIGHT_BILL" value="FREIGHT_BILL"/>
<element name="FREIGHT_CARRIER" value="FREIGHT_CARRIER"/>
<element name="RGA" value="RGA"/>
<group name="G_CONSIGNMENT_RTV_LINES" source="Q3">
<element name="DEPT" value="DEPT"/>
<element name="SERIAL_NUMBER" value="SERIAL_NUMBER"/>
<element name="RGA_NUMBER" value="RGA_NUMBER"/>
<element name="SKU" value="SKU"/>
<element name="VENDOR_PRODUCT" value="VENDOR_PRODUCT"/> 
<element name="DESCRIPTION" value="DESCRIPTION"/>
<element name="RTV_QTY" value="RTV_QTY"/>
<element name="RTV_ITEM_COST" value="RTV_ITEM_COST"/>
<element name="RTV_EXTENDED_COST" value="RTV_EXTENDED_COST"/>
</group>
<element name="AMTSUM" value="G_CONSIGNMENT_RTV_LINES.RTV_EXTENDED_COST" function="SUM()"/>
<element name="QTYSUM" value="G_CONSIGNMENT_RTV_LINES.RTV_QTY" function="SUM()"/>
</group>
</group>
  </dataStructure>
<dataTrigger name="afterReport"  source="XX_AP_RTVCONS_PKG.afterReport()"/>
</dataTemplate>  
