<?xml version="1.0" encoding="WINDOWS-1252" ?>
<dataTemplate name="XXARCBIDTL_SPEC" description="SPECIAL HANDLING CONSOLIDATED BILLING-DETAIL" Version="1.0">
<parameters>
 <parameter name="P_SUMM_BILL_NUM" dataType="character" />
 <parameter name="P_SUMM_BILL_NUM_TO" dataType="character" />
 <parameter name="P_CUST_ACCOUNT_ID" dataType="number" />
 <parameter name="P_MBS_DOCUMENT_ID" dataType="number" />
 <parameter name="P_MBS_EXTENSION_ID" dataType="number" />
 <parameter name="P_SPEC_HANDLING_FLAG" dataType="character" />
 <parameter name="P_SELECT_LIST" dataType="character" />
 <parameter name="P_ORDER_LIST" dataType="character" />
</parameters>
<dataQuery>
<sqlStatement name="Q_SPL_HANDLING_COMMENTS">
<![CDATA[
select a.billdocs_comments1||' ,'||a.billdocs_comments2||' ,'||
       a.billdocs_comments3||' ,'||a.billdocs_comments4 COMMENT_TEXT
      ,b.account_number customer_no  
      ,c.doc_sort_order doc_desc        
from   xx_cdh_a_ext_billdocs_v a
      ,hz_cust_accounts b
      ,xx_cdh_mbs_document_master c
where  a.cust_account_id =:p_cust_account_id
  and  a.extension_id    =:p_mbs_extension_id
  and  a.cust_account_id =b.cust_account_id
  and  a.BILLDOCS_DOC_ID =c.document_id
]]>
</sqlStatement>
<sqlStatement name="Q_SUMMARIZE">
<![CDATA[
SELECT *
FROM  APPS.XX_AR_CBI_REPRINT_V
WHERE BILLING_NO BETWEEN NVL(:P_SUMM_BILL_NUM, BILLING_NO) AND NVL(:P_SUMM_BILL_NUM_TO, BILLING_NO)
  AND CUSTOMER_ID =:P_CUST_ACCOUNT_ID
ORDER BY CUSTOMER_NUMBER
]]>
</sqlStatement>
<sqlStatement name="Q_CONS_INV_TOTALS"> 
<![CDATA[ 
SELECT 
       SUM(DECODE(LINE_TYPE, 'LINE', NVL(AMOUNT, 0), 0)) LINE_AMOUNT
      ,SUM(DECODE(LINE_TYPE, 'TAX',  NVL(AMOUNT, 0), 0)) TAX_AMOUNT
      ,SUM(DECODE(LINE_TYPE, 'DISC', NVL(AMOUNT, 0), 0)) DISC_AMOUNT
      ,SUM(NVL(AMOUNT,0))                                TOTAL_AMOUNT
      ,:CURRENCY                                         CIT_CURRENCY
FROM (
SELECT
       'DISC'                                           LINE_TYPE
      ,SUM(RACTL.EXTENDED_AMOUNT)                       AMOUNT
FROM   
       AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX_LINES RACTL
      ,OE_PRICE_ADJUSTMENTS  OEPA
WHERE ARCIT.CONS_INV_ID                  = :CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          = ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER = ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACTL.CUSTOMER_TRX_ID
  AND RACTL.INTERFACE_LINE_ATTRIBUTE11   = OEPA.PRICE_ADJUSTMENT_ID
  --AND OEPA.ATTRIBUTE8 IN ('TD', '21', '10')
  AND ARCIT.TRANSACTION_TYPE IN 
  (
   'INVOICE'
  ,'CREDIT_MEMO'
  )
UNION
SELECT
       RACTL.LINE_TYPE                                  LINE_TYPE
      ,SUM(RACTL.EXTENDED_AMOUNT)                       LINE_TOT_AMT
FROM   
       AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX_LINES RACTL
WHERE ARCIT.CONS_INV_ID                  = :CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          = ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER = ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACTL.CUSTOMER_TRX_ID
  AND RACTL.LINE_TYPE = 'LINE'
  AND ARCIT.TRANSACTION_TYPE IN 
  (
   'INVOICE'
  ,'CREDIT_MEMO'
  )
  AND (CONSINV_LINES.CUSTOMER_TRX_ID ,CONSINV_LINES.CUSTOMER_TRX_LINE_ID) NOT IN
  (
     SELECT ARCITLI.CUSTOMER_TRX_ID
           ,ARCITLI.CUSTOMER_TRX_LINE_ID
     FROM   RA_CUSTOMER_TRX_LINES  RACTL
           ,OE_PRICE_ADJUSTMENTS OEPA
           ,AR_CONS_INV_TRX_LINES ARCITLI
     WHERE  1 = 1
     AND RACTL.INTERFACE_LINE_ATTRIBUTE11 = OEPA.PRICE_ADJUSTMENT_ID
     --AND OEPA.ATTRIBUTE8 IN ('TD', '10', '21')
     AND ARCITLI.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
     AND ARCITLI.CUSTOMER_TRX_ID = RACTL.CUSTOMER_TRX_ID
     AND ARCIT.CONS_INV_ID = ARCIT.CONS_INV_ID
  )  
GROUP BY RACTL.LINE_TYPE
UNION ALL
SELECT
       RACTL.LINE_TYPE                                  LINE_TYPE
      ,SUM(RACTL.EXTENDED_AMOUNT)                       LINE_TOT_AMT
FROM   
       AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX_LINES RACTL
WHERE ARCIT.CONS_INV_ID                  = :CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          = ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER = ARCIT.CONS_INV_LINE_NUMBER
--  AND CONSINV_LINES.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACTL.CUSTOMER_TRX_ID
  AND RACTL.LINE_TYPE = 'TAX'
  AND ARCIT.TRANSACTION_TYPE IN 
  (
   'INVOICE'
  ,'CREDIT_MEMO'
  )
GROUP BY RACTL.LINE_TYPE
UNION ALL
SELECT
       'LINE'
      ,SUM(ARCIT.AMOUNT_ORIGINAL)
FROM   AR_CONS_INV_TRX       ARCIT 
WHERE ARCIT.CONS_INV_ID =:CONS_INV_ID
  AND ARCIT.TRANSACTION_TYPE ='ADJUSTMENT'
UNION ALL
SELECT
       'TAX'
      ,SUM(ARCIT.TAX_ORIGINAL)
FROM   AR_CONS_INV_TRX       ARCIT 
WHERE ARCIT.CONS_INV_ID =:CONS_INV_ID
  AND ARCIT.TRANSACTION_TYPE ='ADJUSTMENT'
)
]]> 
</sqlStatement>
<sqlStatement name="Q_TRANSACTIONS">
<![CDATA[ 
SELECT
       1                                                        DATA_REC_TYPE
      ,ARCIT.TRX_NUMBER                                         INVOICE_NUMBER
      ,ARCIT.CONS_INV_ID                                        CONSINV_ID
      ,ARCIT.CONS_INV_LINE_NUMBER                               CONSINV_LNUM
      ,NULL  CONS_LINES_LNUM --CONSINV_LINES.LINE_NUMBER                                CONS_LINES_LNUM
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             INV_DATE
      ,DECODE
         (
          ARCIT.TRANSACTION_TYPE
          ,'INVOICE'
          ,'INV'
          ,'CREDIT_MEMO'
          ,'CM'
          ,NULL
         )                                                      TYPE     
      ,NULL PO_NUMBER --XX_AR_REPRINT_SUMMBILL.GET_PO_NUMBER( ARCIT.CONS_INV_ID,ARCIT.CONS_INV_LINE_NUMBER) PO_NUMBER 
      ,CONSINV_LINES.CUSTOMER_TRX_ID                            TRX_ID
      ,NULL                       TRX_LINE_ID
      ,NULL INVENTORY_ITEM_ID
      ,NULL ITEM_NUMBER --XX_AR_REPRINT_SUMMBILL.GET_ITEM_NUMBER(CONSINV_LINES.INVENTORY_ITEM_ID) ITEM_NUMBER
      ,'Tiered Discount'                                        DESCRIPTION
      ,NULL UNIT_OF_MEASURE --CONSINV_LINES.UOM_CODE                                   UNIT_OF_MEASURE        
      ,TO_CHAR(SUM(CONSINV_LINES.TAX_AMOUNT),'999990.90')       LINE_TAX_AMT
      ,SUM(CONSINV_LINES.QUANTITY_INVOICED)                     QUANTITY      
      ,TO_CHAR(SUM(CONSINV_LINES.UNIT_SELLING_PRICE),'999990.90') PRICE      
      ,TO_CHAR(SUM(CONSINV_LINES.EXTENDED_AMOUNT),'999990.90')  EACH_LINE_AMOUNT
      ,TO_CHAR
       (
        (  SUM(CONSINV_LINES.EXTENDED_AMOUNT)
          +
           SUM(CONSINV_LINES.TAX_AMOUNT)
        ),'999990.90'
       )                                                        LINE_TOT_AMT
FROM   
       AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX_LINES RACTL
      ,RA_CUSTOMER_TRX       RACT
      ,OE_PRICE_ADJUSTMENTS  OEPA
WHERE ARCIT.CONS_INV_ID                  = :CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          = ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER = ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACTL.CUSTOMER_TRX_ID
  AND RACTL.CUSTOMER_TRX_ID              = RACT.CUSTOMER_TRX_ID
  AND RACTL.INTERFACE_LINE_ATTRIBUTE11   = OEPA.PRICE_ADJUSTMENT_ID
  AND OEPA.ATTRIBUTE8 = 'TD'
  AND (ARCIT.TRANSACTION_TYPE = 'INVOICE' OR  
       ARCIT.TRANSACTION_TYPE = 'CREDIT_MEMO' AND NOT EXISTS (
           SELECT rabs.batch_source_id
           FROM   ra_batch_sources rabs
           WHERE  batch_source_id = ract.batch_source_id
                  AND rabs.name IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
           )       
      )
GROUP BY
       ARCIT.CONS_INV_ID                                        
      ,ARCIT.CONS_INV_LINE_NUMBER                               
--      ,CONSINV_LINES.LINE_NUMBER                                
      ,ARCIT.TRX_NUMBER                                         
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             
      ,DECODE
         (
          ARCIT.TRANSACTION_TYPE
          ,'INVOICE'
          ,'INV'
          ,'CREDIT_MEMO'
          ,'CM'
          ,NULL
         )                                                           
--      ,APPS.XX_AR_REPRINT_SUMMBILL.GET_PO_NUMBER ( ARCIT.CONS_INV_ID,ARCIT.CONS_INV_LINE_NUMBER)                                                       
      ,CONSINV_LINES.CUSTOMER_TRX_ID                            
--      ,CONSINV_LINES.CUSTOMER_TRX_LINE_ID                       
--      ,CONSINV_LINES.INVENTORY_ITEM_ID
--      ,APPS.XX_AR_REPRINT_SUMMBILL.GET_ITEM_NUMBER(CONSINV_LINES.INVENTORY_ITEM_ID)                                                       
      ,CONSINV_LINES.DESCRIPTION                                
--      ,CONSINV_LINES.UOM_CODE                                   
UNION 
SELECT
       1                                                        DATA_REC_TYPE
      ,ARCIT.TRX_NUMBER                                         INVOICE_NUMBER
      ,ARCIT.CONS_INV_ID                                        CONSINV_ID
      ,ARCIT.CONS_INV_LINE_NUMBER                               CONSINV_LNUM
      ,NULL  CONS_LINES_LNUM --CONSINV_LINES.LINE_NUMBER                                CONS_LINES_LNUM
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             INV_DATE
      ,DECODE
         (
          ARCIT.TRANSACTION_TYPE
          ,'INVOICE'
          ,'INV'
          ,'CREDIT_MEMO'
          ,'CM'
          ,NULL
         )                                                      TYPE     
      ,NULL PO_NUMBER --XX_AR_REPRINT_SUMMBILL.GET_PO_NUMBER( ARCIT.CONS_INV_ID,ARCIT.CONS_INV_LINE_NUMBER) PO_NUMBER 
      ,CONSINV_LINES.CUSTOMER_TRX_ID                            TRX_ID
      ,NULL                       TRX_LINE_ID
      ,NULL INVENTORY_ITEM_ID
      ,NULL ITEM_NUMBER --XX_AR_REPRINT_SUMMBILL.GET_ITEM_NUMBER(CONSINV_LINES.INVENTORY_ITEM_ID) ITEM_NUMBER
      ,'Tiered Discount'                                        DESCRIPTION
      ,NULL UNIT_OF_MEASURE --CONSINV_LINES.UOM_CODE                                   UNIT_OF_MEASURE        
      ,TO_CHAR(SUM(CONSINV_LINES.TAX_AMOUNT),'999990.90')       LINE_TAX_AMT
      ,SUM(CONSINV_LINES.QUANTITY_INVOICED)                     QUANTITY      
      ,TO_CHAR(SUM(CONSINV_LINES.UNIT_SELLING_PRICE),'999990.90') PRICE      
      ,TO_CHAR(SUM(CONSINV_LINES.EXTENDED_AMOUNT),'999990.90')  EACH_LINE_AMOUNT
      ,TO_CHAR
       (
        (  SUM(CONSINV_LINES.EXTENDED_AMOUNT)
          +
           SUM(CONSINV_LINES.TAX_AMOUNT)
        ),'999990.90'
       )                                                        LINE_TOT_AMT
FROM   
       AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX_LINES  RACTL
      ,RA_CUSTOMER_TRX        RACT
WHERE ARCIT.CONS_INV_ID                  = :CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          = ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER = ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACTL.CUSTOMER_TRX_ID
  AND RACTL.CUSTOMER_TRX_ID              = RACT.CUSTOMER_TRX_ID
  AND NVL(RACTL.INTERFACE_LINE_CONTEXT, '?') != 'ORDER ENTRY'
  AND ractl.DESCRIPTION = 'Tiered Discount'  
  AND (ARCIT.TRANSACTION_TYPE = 'INVOICE' OR  
       ARCIT.TRANSACTION_TYPE = 'CREDIT_MEMO' AND NOT EXISTS (
           SELECT rabs.batch_source_id
           FROM   ra_batch_sources rabs
           WHERE  batch_source_id = ract.batch_source_id
                  AND rabs.name IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
           )       
      )
GROUP BY
       ARCIT.CONS_INV_ID                                        
      ,ARCIT.CONS_INV_LINE_NUMBER                               
--      ,CONSINV_LINES.LINE_NUMBER                                
      ,ARCIT.TRX_NUMBER                                         
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             
      ,DECODE
         (
          ARCIT.TRANSACTION_TYPE
          ,'INVOICE'
          ,'INV'
          ,'CREDIT_MEMO'
          ,'CM'
          ,NULL
         )                                                           
--      ,APPS.XX_AR_REPRINT_SUMMBILL.GET_PO_NUMBER ( ARCIT.CONS_INV_ID,ARCIT.CONS_INV_LINE_NUMBER)                                                       
      ,CONSINV_LINES.CUSTOMER_TRX_ID                            
--      ,CONSINV_LINES.CUSTOMER_TRX_LINE_ID                       
--      ,CONSINV_LINES.INVENTORY_ITEM_ID
--      ,APPS.XX_AR_REPRINT_SUMMBILL.GET_ITEM_NUMBER(CONSINV_LINES.INVENTORY_ITEM_ID)                                                       
      ,CONSINV_LINES.DESCRIPTION                                
--      ,CONSINV_LINES.UOM_CODE                                   
UNION 
SELECT
       3                                                        DATA_REC_TYPE
      ,ARCIT.TRX_NUMBER                                         INVOICE_NUMBER
      ,ARCIT.CONS_INV_ID                                        CONSINV_ID
      ,ARCIT.CONS_INV_LINE_NUMBER                               CONSINV_LNUM
      ,CONSINV_LINES.LINE_NUMBER                                CONS_LINES_LNUM
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             INV_DATE
      ,DECODE
         (
          ARCIT.TRANSACTION_TYPE
          ,'INVOICE'
          ,'INV'
          ,'CREDIT_MEMO'
          ,'CM'
          ,NULL
         )                                                      TYPE     
      ,XX_AR_REPRINT_SUMMBILL.GET_PO_NUMBER
         ( ARCIT.CONS_INV_ID
          ,ARCIT.CONS_INV_LINE_NUMBER
         )                                                      PO_NUMBER 
      ,CONSINV_LINES.CUSTOMER_TRX_ID                            TRX_ID
      ,CONSINV_LINES.CUSTOMER_TRX_LINE_ID                       TRX_LINE_ID
      ,CONSINV_LINES.INVENTORY_ITEM_ID
      ,XX_AR_REPRINT_SUMMBILL.GET_ITEM_NUMBER
        (
          CONSINV_LINES.INVENTORY_ITEM_ID 
        )                                                       ITEM_NUMBER
      ,CONSINV_LINES.DESCRIPTION                                DESCRIPTION
      ,CONSINV_LINES.UOM_CODE                                   UNIT_OF_MEASURE        
      ,TO_CHAR(CONSINV_LINES.TAX_AMOUNT,'999990.90')            LINE_TAX_AMT
      ,CONSINV_LINES.QUANTITY_INVOICED                          QUANTITY      
      ,TO_CHAR(CONSINV_LINES.UNIT_SELLING_PRICE,'999990.90')    PRICE      
      ,TO_CHAR(CONSINV_LINES.EXTENDED_AMOUNT,'999990.90')       EACH_LINE_AMOUNT
      ,TO_CHAR
       (
        (  CONSINV_LINES.EXTENDED_AMOUNT
          +
           CONSINV_LINES.TAX_AMOUNT
        ),'999990.90'
       )                                                        LINE_TOT_AMT            
FROM   
       AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX       RACT
WHERE ARCIT.CONS_INV_ID                  =:CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          =ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER =ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.DESCRIPTION != 'Tiered Discount'
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACT.CUSTOMER_TRX_ID
  AND (ARCIT.TRANSACTION_TYPE = 'INVOICE' OR  
       ARCIT.TRANSACTION_TYPE = 'CREDIT_MEMO' AND NOT EXISTS (
           SELECT rabs.batch_source_id
           FROM   ra_batch_sources rabs
           WHERE  batch_source_id = ract.batch_source_id
                  AND rabs.name IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
           )       
      )
  AND (CONSINV_LINES.CUSTOMER_TRX_ID ,CONSINV_LINES.CUSTOMER_TRX_LINE_ID) NOT IN
  (
     SELECT ARCITLI.CUSTOMER_TRX_ID
           ,ARCITLI.CUSTOMER_TRX_LINE_ID
     FROM   RA_CUSTOMER_TRX_LINES  RACTL
           ,OE_PRICE_ADJUSTMENTS OEPA
           ,AR_CONS_INV_TRX_LINES ARCITLI
     WHERE  1 = 1
     AND RACTL.INTERFACE_LINE_ATTRIBUTE11 = OEPA.PRICE_ADJUSTMENT_ID
     AND OEPA.ATTRIBUTE8 = 'TD'
     AND ARCITLI.CUSTOMER_TRX_LINE_ID = RACTL.CUSTOMER_TRX_LINE_ID
     AND ARCITLI.CUSTOMER_TRX_ID = RACTL.CUSTOMER_TRX_ID
     AND ARCIT.CONS_INV_ID = ARCIT.CONS_INV_ID
  )  
UNION ALL
SELECT
       2                                                        DATA_REC_TYPE
      ,ARCIT.TRX_NUMBER                                         
      ,ARCIT.CONS_INV_ID                                        
      ,TO_NUMBER(NULL)                                          
      ,TO_NUMBER(NULL)                                          
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             
      ,DECODE
         (
          ARCIT.TRANSACTION_TYPE
          ,'ADJUSTMENT'
          ,'ADJ'
          ,NULL
         )                                                          
      ,TO_CHAR(NULL)  
      ,TO_NUMBER(NULL)
      ,TO_NUMBER(NULL)
      ,TO_NUMBER(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)
      ,TO_CHAR(NULL)        
      ,TO_CHAR(ARCIT.TAX_ORIGINAL, '999990.90')
      ,TO_NUMBER(NULL)      
      ,TO_CHAR(NULL)      
      ,TO_CHAR(ARCIT.AMOUNT_ORIGINAL,'999990.90')
      ,TO_CHAR( (ARCIT.AMOUNT_ORIGINAL + ARCIT.TAX_ORIGINAL),'999990.90')                                                                                                        
FROM   AR_CONS_INV_TRX       ARCIT 
WHERE ARCIT.CONS_INV_ID =:CONS_INV_ID
  AND ARCIT.TRANSACTION_TYPE ='ADJUSTMENT'
UNION
SELECT
       6                                                        DATA_REC_TYPE
      ,ARCIT.TRX_NUMBER                                         INVOICE_NUMBER
      ,ARCIT.CONS_INV_ID                                        CONSINV_ID
      ,ARCIT.CONS_INV_LINE_NUMBER                               CONSINV_LNUM
      ,NULL                                                     CONS_LINES_LNUM
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             INV_DATE
      ,'CM'                                                     TYPE     
      ,TO_CHAR(NULL)  
      ,TO_NUMBER(NULL)
      ,TO_NUMBER(NULL)
      ,TO_NUMBER(NULL)
      ,TO_CHAR(NULL)
      ,'Misc CR Memo'                                           DESCRIPTION
      ,NULL                                                     UNIT_OF_MEASURE        
      ,NULL                                                     LINE_TAX_AMT
      ,1                                                        QUANTITY      
      ,TO_CHAR(lines_tbl.cr_line_amount, '999990.90')           PRICE      
      ,TO_CHAR(lines_tbl.cr_line_amount, '999990.90')           EACH_LINE_AMOUNT
      ,TO_CHAR(lines_tbl.cr_line_amount, '999990.90')           LINE_TOT_AMT            
FROM   (
         SELECT customer_trx_id trx_id1,sum(extended_amount) cr_line_amount
         FROM   ra_customer_trx_lines
         WHERE  line_type ='LINE'
         GROUP BY customer_trx_id          
       ) lines_tbl        
      ,AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX       RACT
WHERE ARCIT.CONS_INV_ID                  =:CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          =ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER =ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.DESCRIPTION != 'Tiered Discount'
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACT.CUSTOMER_TRX_ID
  AND lines_tbl.trx_id1 = RACT.CUSTOMER_TRX_ID
  AND ARCIT.TRANSACTION_TYPE = 'CREDIT_MEMO' 
  AND EXISTS (
           SELECT rabs.batch_source_id
           FROM   ra_batch_sources rabs
           WHERE  batch_source_id = ract.batch_source_id
                  AND rabs.name IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
           )       
GROUP BY ARCIT.TRX_NUMBER                                
      ,ARCIT.CONS_INV_ID                                        
      ,ARCIT.CONS_INV_LINE_NUMBER                               
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')
      ,lines_tbl.cr_line_amount             
UNION
SELECT
       5                                                        DATA_REC_TYPE
      ,ARCIT.TRX_NUMBER                                         INVOICE_NUMBER
      ,ARCIT.CONS_INV_ID                                        CONSINV_ID
      ,ARCIT.CONS_INV_LINE_NUMBER                               CONSINV_LNUM
      ,null                                                    CONS_LINES_LNUM
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             INV_DATE
      ,'CM'                                                     TYPE     
      ,TO_CHAR(NULL)  
      ,TO_NUMBER(NULL)
      ,TO_NUMBER(NULL)
      ,TO_NUMBER(NULL)
      ,TO_CHAR(NULL)
      ,'Tax'                                                    DESCRIPTION
      ,NULL                                                     UNIT_OF_MEASURE        
      ,TO_CHAR(tax_tbl.cr_line_amount, '999990.90')             LINE_TAX_AMT
      ,TO_NUMBER(NULL)                                          QUANTITY      
      ,TO_CHAR(NULL)                                            PRICE      
      ,TO_CHAR(NULL)                                            EACH_LINE_AMOUNT
      ,TO_CHAR(tax_tbl.cr_line_amount, '999990.90')             LINE_TOT_AMT            
  FROM   (
           SELECT customer_trx_id trx_id1,sum(extended_amount) cr_line_amount
           FROM   ra_customer_trx_lines
           WHERE  line_type ='TAX'
           GROUP BY customer_trx_id          
         ) tax_tbl        
      ,AR_CONS_INV_TRX       ARCIT 
      ,AR_CONS_INV_TRX_LINES CONSINV_LINES
      ,RA_CUSTOMER_TRX       RACT
WHERE ARCIT.CONS_INV_ID                  =:CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_ID          =ARCIT.CONS_INV_ID
  AND CONSINV_LINES.CONS_INV_LINE_NUMBER =ARCIT.CONS_INV_LINE_NUMBER
  AND CONSINV_LINES.DESCRIPTION != 'Tiered Discount'
  AND CONSINV_LINES.CUSTOMER_TRX_ID      = RACT.CUSTOMER_TRX_ID
  AND tax_tbl.trx_id1 = RACT.CUSTOMER_TRX_ID
  AND ARCIT.TRANSACTION_TYPE = 'CREDIT_MEMO' 
  AND EXISTS (
           SELECT rabs.batch_source_id
           FROM   ra_batch_sources rabs
           WHERE  batch_source_id = ract.batch_source_id
                  AND rabs.name IN ('MANUAL_CA' ,'MANUAL_US' ,'SERVICE')
           )       
GROUP BY ARCIT.TRX_NUMBER                                
      ,ARCIT.CONS_INV_ID                                        
      ,ARCIT.CONS_INV_LINE_NUMBER                               
      ,TO_CHAR(ARCIT.TRANSACTION_DATE,'MM/DD/RRRR')             
      ,tax_tbl.cr_line_amount
ORDER BY 2, 1 DESC, 5
]]> 
</sqlStatement>
<sqlStatement name="Q_SUBTOTAL">
<![CDATA[
SELECT SUBTOT_DESC   SUBTOTAL1
      ,SUBTOT_AMOUNT SUBTOTAL1_AMOUNT
FROM   XX_AR_CBI_SORT
WHERE  RPT_TYPE ='SPL-DTL'
  AND  CUSTOMER_ID =:CUSTOMER_ID
  AND  CONS_INV_ID =:CONS_INV_ID
ORDER BY TRX_ID
]]>
</sqlStatement>
<sqlStatement name="Q_TAXES">
<![CDATA[
SELECT 
       DECODE 
        ( 
         ARITS.TAX_CODE_NAME
        ,'COUNTY'
        ,DECODE
         (
          :CURRENCY
         ,'CAD'
          ,DECODE
           (
             :PROVINCE
            ,'QC'
            ,'QST'
            ,'PST'           
           )
           ,'USD'
           ,'USDPR'
         )                           
         ,'STATE'
          ,DECODE
           (
             :CURRENCY
            ,'CAD'
            ,'GST'
            ,'USDST'           
           )
         )   TAX_DESC
      ,SUM(ARITS.TAX_AMOUNT) TAX_AMT
FROM  AR_INVOICE_TAX_SUMMARY_V ARITS
WHERE ARITS.CUSTOMER_TRX_ID 
  =(
    SELECT ARCITL.CUSTOMER_TRX_ID
    FROM   AR_CONS_INV_TRX_LINES ARCITL
    WHERE  ARCITL.CONS_INV_ID =:CONS_INV_ID
      AND  ARCITL.CUSTOMER_TRX_ID =ARITS.CUSTOMER_TRX_ID
    GROUP BY ARCITL.CUSTOMER_TRX_ID   
   )
AND ARITS.TAX_CODE_NAME !='CITY'
GROUP BY ARITS.TAX_CODE_NAME
]]>
</sqlStatement>
</dataQuery>
<dataStructure>
<group name="G_SPL_CUSTOMERS" source="Q_SPL_HANDLING_COMMENTS">
<element name="CUSTOMER_ID" value="CUSTOMER_NO" />
<element name="COMMENT" value="COMMENT_TEXT" />
<element name="SORT_DESC" value="DOC_DESC" />
<group name="G_CUSTOMER_NUMBER" source="Q_SUMMARIZE">
<element name="CONS_ID" value="CONS_INV_ID" />
<element name="BILLING_POSTAL_CODE" value="BILLING_POSTAL_CODE" />
<element name="REMIT_POSTAL_CODE" value="REMIT_POSTAL_CODE" />
<element name="FLO_CODE" value="FLO_CODE" />
<element name="COMMENT" value="COMMENT_TEXT" />
<element name="ADDR1" value="ADDRESS1" />
<element name="ADDR2" value="ADDRESS2" />
<element name="CITYSTATEPOSTALCODE" value="CITY" />
<element name="TAX_ID_DESC" value="TAX_ID_DESC" />
<element name="TAX_ID" value="TAX_ID" />
<element name="ACCOUNT_CONTACT" value="ACCOUNT_CONTACT" />
<element name="ORDER_CONTACT" value="ORDER_CONTACT" />
<element name="BILLING_NO" value="BILLING_NO" />
<element name="BILLING_NO1" value="BILLING_NO" />
<element name="ISSUE_DATE" value="ISSUE_DATE" />
<element name="ISSUE_DATE1" value="ISSUE_DATE" />
<element name="CUT_OFF_DATE" value="CUT_OFF_DATE" />
<element name="DUE_DATE" value="DUE_DATE" />
<element name="CUSTOMER_NAME" value="CUSTOMER_NAME" />
<element name="CUSTOMER_NAME1" value="CUSTOMER_NAME" />
<element name="ACCOUNT_NUMBER" value="ACCOUNT_NUMBER" />
<element name="BILLING_ID" value="CUSTOMER_NUMBER" />
<element name="BILLING_ID1" value="CUSTOMER_NUMBER" />
<element name="ADDRESS1" value="ADDRESS1" />
<element name="ADDRESS2" value="ADDRESS2" />
<element name="CITY" value="CITY" />
<element name="COUNTRY" value="COUNTRY" />
<element name="PROVINCE" value="PROVINCE" />
<element name="CURRENCY" value="CURRENCY" />
<element name="RADDRESS1" value="RADDRESS1" />
<element name="RADDRESS2" value="RADDRESS2" />
<element name="RCITY" value="RCITY" />
<element name="RCOUNTRY" value="RCOUNTRY" />
<element name="CD_BEGINNING_BALANCE" value="CD_BEGINNING_BALANCE" />
<element name="CD_ENDING_BALANCE" value="CD_ENDING_BALANCE" />
<element name="CD_ENDING_BALANCE1" value="CD_ENDING_BALANCE" />
<element name="CD_ENDING_BALANCE2" value="CD_ENDING_BALANCE" />
<element name="CD_PERIOD_RECEIPTS" value="CD_PERIOD_RECEIPTS" />
<element name="CD_PERIOD_TAX" value="CD_PERIOD_TAX" />
<element name="CD_PERIOD_BILLED" value="CD_PERIOD_BILLED" />
<element name="RADDRESS1C" value="RADDRESS1" />
<element name="RADDRESS2C" value="RADDRESS2" />
<element name="RCITYC" value="RCITY" />
<group name="G_INVOICES" source="Q_TRANSACTIONS">
<element name="INVOICE_NUMBER" value="INVOICE_NUMBER" />
<element name="INV_DATE" value="INV_DATE" />
<element name="TYPE" value="TYPE" />
<element name="PO_NUMBER" value="PO_NUMBER" />
<group name="G_ITEMS" source="Q_TRANSACTIONS">
<element name="DATA_REC_TYPE" value="DATA_REC_TYPE" />
<element name="ITEM_NUMBER" value="ITEM_NUMBER" />
<element name="DESCRIPTION" value="DESCRIPTION" />
<element name="QUANTITY" value="QUANTITY" />
<element name="UNIT_OF_MEASURE" value="UNIT_OF_MEASURE" />
<element name="PRICE" value="PRICE" />
<element name="EACH_LINE_AMOUNT" value="EACH_LINE_AMOUNT" />
<element name="LINE_TAX_AMT" value="LINE_TAX_AMT" />
<element name="LINE_TOT_AMT" value="LINE_TOT_AMT" />
</group>
<element name="LINE_AMOUNT" value="G_ITEMS.EACH_LINE_AMOUNT" function="SUM()"/>
<element name="TAX_AMOUNT" value="G_ITEMS.LINE_TAX_AMT" function="SUM()"/>
<element name="TOTAL_AMOUNT" value="G_ITEMS.LINE_TOT_AMT" function="SUM()"/>
</group>
<group name="G_SUBTOTAL1" source="Q_SUBTOTAL">
<element name="SUBTOTAL1" value="SUBTOTAL1" />
<element name="SUBTOTAL1_AMOUNT" value="SUBTOTAL1_AMOUNT" />
</group>
<group name="G_CONS_INV_TOTALS" source="Q_CONS_INV_TOTALS"> 
<element name="CIT_LINE_AMOUNT" value="LINE_AMOUNT" /> 
<element name="CIT_TAX_AMOUNT" value="TAX_AMOUNT" /> 
<element name="CIT_DISC_AMOUNT" value="DISC_AMOUNT" /> 
<element name="CIT_TOTAL_AMOUNT" value="TOTAL_AMOUNT" /> 
<element name="CIT_CURRENCY" value="CIT_CURRENCY" /> 
</group>
<element name="CD_BEGINNING_BALANCE" value="CD_BEGINNING_BALANCE" />
<element name="CD_ENDING_BALANCE" value="CD_ENDING_BALANCE" />
<element name="CD_ENDING_BALANCE1" value="CD_ENDING_BALANCE" />
<element name="CD_ENDING_BALANCE2" value="CD_ENDING_BALANCE" />
<element name="CD_PERIOD_RECEIPTS" value="CD_PERIOD_RECEIPTS" />
<element name="CD_PERIOD_TAX" value="CD_PERIOD_TAX" />
<element name="CD_PERIOD_BILLED" value="CD_PERIOD_BILLED" />
<element name="PRINT_INSTANCE" value="SPL_PRINT_INSTANCE" />
<element name="PAYSTUB_UPPER_TEXT" value="PAYSTUB_UPPER_TEXT" />
</group>
</group>
</dataStructure>
</dataTemplate>