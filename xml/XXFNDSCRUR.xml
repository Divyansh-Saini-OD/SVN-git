<dataTemplate name="XXFNDSCRUR" description="Custom report in EXCEL format to obtain users of a responsibility with option of passing multiple parameters" Version="1.0">
<properties>
  <property name="scalable_mode" value="on" /> 
  <property name="rtf-output-default-font">Arial:8</property> 
</properties>
<parameters>
  <parameter name="P_APPLICATION_ID" datatype="number" />
  <parameter name="P_RESPONSIBILITY_ID" datatype="number" /> 
  <parameter name="P_USER_ID" datatype="character" /> 
  <parameter name="P_SUPERVISOR_ID" datatype="character" /> 
  <parameter name="P_RESP_ACTIVE" datatype="character" /> 
  <parameter name="P_USER_ACTIVE" datatype="character" /> 
  <parameter name="P_USER_RESP_ACTIVE" datatype="character" /> 
</parameters>

<dataQuery>

<sqlStatement name="Q_HEADER_DATE">
<![CDATA[ 
SELECT TO_CHAR(SYSDATE, 'DD-MON-YYYY HH:MM:SS') AS V_DATE
from dual
]]> 
</sqlStatement>

<sqlStatement name="Q_USER_ID">
<![CDATA[ 
SELECT nvl(max(u.user_id),-1) as v_user_id
from fnd_user u
where 
u.user_name = :P_USER_ID
]]> 
</sqlStatement>
<sqlStatement name="Q_SUP_USER_ID">
<![CDATA[ 
SELECT nvl(max(u.employee_id),-1) as v_sup_user_id
from fnd_user u
where 
u.user_name = :P_SUPERVISOR_ID
]]> 
</sqlStatement>
<sqlStatement name="Q_USER_NAME">
<![CDATA[ 
SELECT u.user_name v_user_name,p.full_name AS v_person_name
from fnd_user u, per_people_f p
where u.user_id = fnd_global.user_id
and p.person_id(+) = u.employee_id
and (p.EFFECTIVE_END_DATE > SYSDATE OR p.EFFECTIVE_END_DATE IS NULL)
]]> 
</sqlStatement>
<sqlStatement name="Q_APP_NAME">
<![CDATA[ 
SELECT application_name V_APP_NAME
FROM fnd_application_tl
WHERE application_id = :P_APPLICATION_ID
]]> 
</sqlStatement>
<sqlStatement name="Q_RESP_NAME">
<![CDATA[ 
SELECT responsibility_name V_RESP_NAME
FROM fnd_responsibility_vl
WHERE responsibility_id = :P_RESPONSIBILITY_ID
]]> 
</sqlStatement>
<sqlStatement name="Q_MAIN">
<![CDATA[
SELECT FA.application_name qr_application_name, 
FU.USER_NAME  qr_user_name, 
FRV.RESPONSIBILITY_NAME qr_responsibility_name,
TO_CHAR(FRV.START_DATE, 'DD-MON-YYYY') qr_resp_start_date,
TO_CHAR(FRV.END_DATE, 'DD-MON-YYYY') qr_resp_end_date, 
TO_CHAR(FUR.START_DATE, 'DD-MON-YYYY') qr_resp_assign_effective_from,
TO_CHAR(FUR.END_DATE, 'DD-MON-YYYY') qr_resp_assign_effective_to,
PAPF.full_name qr_full_name,
PAPF.employee_number qr_employee_number,
TO_CHAR(FU.start_date, 'DD-MON-YYYY') qr_user_effective_from,
TO_CHAR(FU.end_date, 'DD-MON-YYYY') qr_user_effective_to,
FU.email_address qr_email_address,
PAPF.last_name qr_last_name,
PAPF.first_name qr_first_name,
REPLACE(paaf.ass_attribute1,'&',' ') qr_country,
REPLACE(PAAF.ASS_ATTRIBUTE6,'&',' ') qr_functional_area,
REPLACE(PAAF.ASS_ATTRIBUTE7,'&',' ') qr_person_org,
REPLACE(PAAF.ASS_ATTRIBUTE11,'&',' ') qr_job_title,
PAAF.EFFECTIVE_START_DATE qr_assgn_eff_start,
paaf.EFFECTIVE_END_DATE qr_assgn_eff_end,
papf.EFFECTIVE_START_DATE qr_empl_eff_start,
PAPF.EFFECTIVE_END_DATE qr_empl_eff_end,
REPLACE(HAOU.NAME,'&',' ')  qr_organization_cost_center,
REPLACE(GSB.NAME,'&',' ') qr_set_of_books,
REPLACE(LOCTL.LOCATION_CODE,'&',' ') qr_location_code,
PAAF.ASSIGNMENT_ID qr_assignment_id,
papf_sup.FULL_NAME  qr_supervisor_name,
fu_sup.user_name qr_supervisor_user_name,
fu_sup.email_address qr_supervisor_email
FROM
(SELECT USER_NAME,
USER_ID,
EMPLOYEE_ID, 
start_date,
end_date,
email_address, 
CASE
      WHEN :P_USER_ACTIVE = 'Active' and NVL(end_date,sysdate+1) > sysdate
      THEN 'Active'
      WHEN :P_USER_ACTIVE = 'Inactive' and end_date <= sysdate
      THEN 'Inactive'
      ELSE 'All'
    END act_val
  FROM fnd_user) FU,
  (SELECT user_id,
    responsibility_id,
    responsibility_application_id,
    start_date,
    end_date,
    CASE
      WHEN :P_USER_RESP_ACTIVE = 'Active' and NVL(end_date,sysdate+1) > sysdate
      THEN 'Active'
      WHEN :P_USER_RESP_ACTIVE = 'Inactive' and end_date <= sysdate
      THEN 'Inactive'
      ELSE 'All'
    END act_val,
    RESPONSIBILITY_ID||RESPONSIBILITY_APPLICATION_ID Resp_application_id
  FROM fnd_user_resp_groups_all) FUR,
  (SELECT responsibility_id,
    application_id,
    start_date,
    end_date,
    responsibility_name,
    CASE
      WHEN :P_RESP_ACTIVE = 'Active' and NVL(end_date,sysdate+1) > sysdate
      THEN 'Active'
      WHEN :P_RESP_ACTIVE = 'Inactive' and end_date <= sysdate
      THEN 'Inactive'
      ELSE 'All'
    END act_val,
    RESPONSIBILITY_ID||APPLICATION_ID Resp_application_id
  FROM fnd_responsibility_vl
  ) FRV,
fnd_application_tl FA,
per_all_people_f PAPF,
PER_ALL_ASSIGNMENTS_F paaf,
HR_ALL_ORGANIZATION_UNITS HAOU,
--GL_SETS_OF_BOOKS GSB,
GL_LEDGERS GSB,                                             -- Commented/Added for R12 Upgrade Retrofit by Veronica on 13-Aug-13
HR_LOCATIONS_ALL_TL LOCTL,
per_all_people_f PAPF_SUP,
fnd_user fu_sup
WHERE  FA.application_id                 = NVL(:P_APPLICATION_ID,FA.application_id)
AND NVL(PAAF.supervisor_id,-99)          = NVL2(:P_SUPERVISOR_ID,:v_sup_user_id,NVL(PAAF.supervisor_id,-99))
and FU.USER_ID                           = NVL2(:P_USER_ID,:v_user_id,FU.USER_ID)
AND FUR.RESPONSIBILITY_ID                = NVL(:P_RESPONSIBILITY_ID,FUR.RESPONSIBILITY_ID)
AND FRV.act_val                          = DECODE(:P_RESP_ACTIVE,'Active','Active','Inactive','Inactive','All')
AND FU.act_val                           = DECODE(:P_USER_ACTIVE,'Active','Active','Inactive','Inactive','All')
AND FUR.act_val                          = DECODE(:P_USER_RESP_ACTIVE,'Active','Active','Inactive','Inactive','All')
AND FU.USER_ID                           = FUR.USER_ID(+)                  
AND FUR.Resp_application_id           = FRV.Resp_application_id(+)
AND FRV.application_id                = FA.application_id (+)
AND FU.employee_id                    = PAPF.person_id(+) 
AND PAPF.PERSON_ID                    = PAAF.PERSON_ID(+)                  
AND PAAF.ORGANIZATION_ID              = HAOU.ORGANIZATION_ID(+)
--AND PAAF.SET_OF_BOOKS_ID              = GSB.SET_OF_BOOKS_ID(+)
AND paaf.SET_OF_BOOKS_ID			  = GSB.LEDGER_ID(+)     -- Commented/Added for R12 Upgrade Retrofit by Veronica on 13-Aug-13
AND PAAF.LOCATION_ID                  = LOCTL.location_id(+)
AND PAAF.supervisor_id                = PAPF_SUP.person_id(+)
AND PAPF_SUP.person_id                = FU_SUP.employee_id(+)
AND trunc(NVL(PAPF.EFFECTIVE_END_DATE,SYSDATE)) = NVL((SELECT MAX(trunc(paf1.EFFECTIVE_END_DATE))
                                        FROM   per_all_people_f paf1
                                        WHERE  paf1.PERSON_ID = PAPF.PERSON_ID),TRUNC(SYSDATE))
AND trunc(NVL(PAAF.EFFECTIVE_END_DATE,SYSDATE)) = NVL((SELECT MAX(trunc(paf1.EFFECTIVE_END_DATE))
                                        FROM   PER_ALL_ASSIGNMENTS_F paf1
                                        WHERE  paf1.PERSON_ID = PAAF.PERSON_ID),TRUNC(SYSDATE))
AND trunc(NVL(PAPF_SUP.EFFECTIVE_END_DATE,SYSDATE)) = NVL((SELECT MAX(trunc(paf1.EFFECTIVE_END_DATE))
                                        FROM   per_all_people_f paf1
                                        WHERE  paf1.PERSON_ID = PAPF_SUP.PERSON_ID),TRUNC(SYSDATE))
AND LENGTH(FU.USER_NAME(+))     	<= 19		--Replaced 6 to 19 to include Oracle Service Accounts
AND LENGTH(FU_SUP.USER_NAME(+)) 	<= 19		--Replaced 6 to 19 to include Oracle Service Accounts
ORDER BY FA.application_name,FRV.responsibility_name,PAPF.full_name
]]> 
</sqlStatement>
</dataQuery>

<dataStructure>
<group name="G_HEADER_DATE" source="Q_HEADER_DATE">
<element name="V_DATE" value="v_date" function="" /> 
</group>
<group name="G_USER_ID" source="Q_USER_ID">
<element name="V_USER_ID" value="v_user_id" function="" /> 
</group>
<group name="G_SUP_USER_ID" source="Q_SUP_USER_ID">
<element name="V_SUP_USER_ID" value="v_sup_user_id" function="" /> 
</group>
<group name="G_USER_NAME" source="Q_USER_NAME">
<element name="V_PERSON_NAME" value="v_person_name" function="" />
<element name="V_USER_NAME" value="v_user_name" function="" />
</group>
<group name="G_APP_NAME" source="Q_APP_NAME">
<element name="V_APP_NAME" value="V_APP_NAME" function="" /> 
</group>
<group name="G_RESP_NAME" source="Q_RESP_NAME">
<element name="V_RESP_NAME" value="V_RESP_NAME" function="" /> 
</group>
<group name="G_MAIN" source="Q_MAIN">
<element name="USER_ID" value="qr_user_name" function="" />
<element name="EMPLOYEE_NUMBER" value="qr_employee_number" function="" />
<element name="RESPONSIBILITY" value="qr_responsibility_name" function="" />
<element name="APPLICATION" value="qr_application_name" function="" />
<element name="USER_EFFECTIVE_FROM" value="qr_user_effective_from" function="" />
<element name="USER_EFFECTIVE_TO" value="qr_user_effective_to" function="" />
<element name="RESP_EFFECTIVE_FROM" value="qr_resp_start_date" function="" />
<element name="RESP_EFFECTIVE_TO" value="qr_resp_end_date" function="" />
<element name="RESP_ASSIGN_EFFECTIVE_FROM" value="qr_resp_assign_effective_from" function="" />
<element name="RESP_ASSIGN_EFFECTIVE_TO" value="qr_resp_assign_effective_to" function="" />
<element name="EMAIL_ADDRESS" value="qr_email_address" function="" />
<element name="LAST_NAME" value="qr_last_name" function="" />
<element name="FIRST_NAME" value="qr_first_name" function="" />
<element name="PERSON" value="qr_full_name" function="" />
<element name="COUNTRY" value="qr_country" function="" />
<element name="FUNCTIONAL_AREA" value="qr_functional_area" function="" />
<element name="PERSON_ORG" value="qr_person_org" function="" />
<element name="JOB_TITLE" value="qr_job_title" function="" />
<element name="ORG_COST_CENTER" value="qr_organization_cost_center" function="" />
<element name="SET_OF_BOOKS" value="qr_set_of_books" function="" />
<element name="LOCATION_CODE" value="qr_location_code" function="" />
<element name="SUPERVISOR_NAME" value="qr_supervisor_name" function="" />
<element name="SUPERVISOR_ID" value="qr_supervisor_user_name" function="" />
<element name="SUPERVISOR_EMAIL_ADDRESS" value="qr_supervisor_email" function="" />
</group>
</dataStructure>
</dataTemplate>

