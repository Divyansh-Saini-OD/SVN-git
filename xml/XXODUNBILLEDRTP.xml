<?xml version="1.0" encoding="UTF-8"?>
<dataTemplate name="XXODUNBILLEDRTP" description="Unbilled Trx Report" defaultPackage="XXOD_UNBILLED_RPT_BURST_PKG" version="1.0">
   <parameters>
     <parameter name="P_DATE" datatype="character"/>
   </parameters>
  <dataQuery>
    <sqlStatement name="DATA_QUERY">
         <![CDATA[ 
		 SELECT  
	   b.FROM_MAIL
	 , b.TO_MAIL
	 , b.CC 
	 , b.MAIL_SUBJECT
	 , b.MAIL_TEXT
	 , b.SMTP_DETAIL
	 , a.CUST_NAME
     , a.LEGACY_CUST_NAME
     , a.CUST_DOC_ID
     , a.MBS_DOC_ID
     , a.BILLING_FREQUENCY 
     , a.DOC_TYPE
	 , a.ORI_PAY_DOC
     , a.DELIVERY_METHOD
     , a.TRX_NUMBER
     , a.TRX_DATE
     , a.ORDERED_DATE
     , a.BILLING_DATE
     , a.TRX_TYPE_NAME 
     , a.TRX_CLASS
     , a.BATCH_SOURCE_NAME
	 , a.AMOUNT_DUE_ORIGINAL
	 , a.AMOUNT_DUE_REMAINING
	 , a.PARENT_ORDER_NUM
FROM
(SELECT 
	  hp.party_name CUST_NAME
     , hca.orig_system_reference LEGACY_CUST_NAME
     , xce.n_ext_attr2 CUST_DOC_ID
     , xce.n_ext_attr1 MBS_DOC_ID
     , xce.c_ext_attr14  BILLING_FREQUENCY 
     , 'DOC_TYPE' DOC_TYPE
	 , DECODE(xce.c_ext_attr2,'Y','Pay Doc','') ORI_PAY_DOC
     , DECODE(xce.c_ext_attr3
              ,'ELEC' ,'EBILL'
              ,'PRINT' , DECODE( xce.c_ext_attr4
                               , NULL , 'CERTEGY'
                               , 'SPL Handle'
							   )
              ,xce.c_ext_attr3                                      
     	     ) DELIVERY_METHOD
     , rct.trx_number TRX_NUMBER
     , TO_CHAR(rct.trx_date,'DD-MON-YYYY') TRX_DATE
     , TO_CHAR(ooha.ordered_date,'DD-MON-YYYY') ORDERED_DATE
     , TO_CHAR(rct.billing_date,'DD-MON-YYYY') BILLING_DATE
     , rctt.name TRX_TYPE_NAME 
     , rctt.type TRX_CLASS
     , rbsa.name BATCH_SOURCE_NAME
	 , ar_pay.amount_due_original  AMOUNT_DUE_ORIGINAL
	 , ar_pay.amount_due_remaining AMOUNT_DUE_REMAINING
	 , xoha.parent_order_num PARENT_ORDER_NUM
	 , 1 X
from apps.oe_order_headers_All ooha 
   , apps.oe_order_sources oos 
   , apps.ra_customer_trx_all rct 
   , apps.ra_batch_sources_all rbsa
   , apps.xx_om_header_attributes_all xoha 
   , apps.xx_cdh_cust_acct_ext_b xce 
   , apps.hz_cust_accounts hca 
   , apps.hz_parties hp
--   , apps.hz_customer_profiles hcp
   , apps.ra_cust_trx_types_all rctt
   , apps.ar_payment_schedules_all ar_pay 
WHERE 1=1
AND ooha.order_source_id = oos.order_source_id
AND xoha.header_id = ooha.header_id
AND TO_CHAR(ooha.order_number) = (rct.interface_header_attribute1)
AND rct.attribute14        = ooha.header_id
AND rct.batch_source_id = rbsa.batch_source_id 
AND xce.cust_account_id=rct.bill_to_customer_id
AND hca.party_id = hp.party_id
--AND hca.cust_account_id = hcp.cust_account_id
--AND hcp.attribute6 IN ('B','Y')
--AND hcp.site_use_id is null
AND rctt.cust_trx_type_id(+) = rct.cust_trx_type_id
AND xoha.bill_comp_flag   IN( 'Y','B')
AND xce.c_ext_attr1  = 'Consolidated Bill' --Modified for NAIT-114375
AND xce.c_ext_attr2               = 'Y' --Modified for NAIT-114375
AND xce.attr_group_id                      = 166
AND xce.d_ext_attr1 <= SYSDATE 
AND NVL(xce.d_ext_attr2,SYSDATE)  >= SYSDATE
AND xce.BC_POD_FLAG IN ('Y','P','B') --Added for NAIT-114375
--AND TRUNC(NVL(rct.billing_date,SYSDATE+37))>=TRUNC(SYSDATE+37) --Commented for NAIT-114375
AND TRUNC(ooha.creation_date) <= TRUNC (TO_DATE ( :P_DATE, 'YYYY/MM/DD HH24:MI:SS')) -7
AND hca.cust_account_id       = rct.bill_to_customer_id
And Parent_Order_Num     IS NOT NULL
AND ar_pay.customer_trx_id = rct.customer_trx_id
AND ar_pay.amount_due_original = ar_pay.amount_due_remaining
AND ar_pay.status = 'OP'
AND NOT EXISTS
  (SELECT 1
  FROM apps.xx_scm_bill_signal
  WHERE 1                =1
  AND child_order_number = ooha.order_number
  )) a 
  , (SELECT  
			 target_value1 FROM_MAIL
			, target_value2 TO_MAIL
			, target_value3 CC 
			, target_value4 MAIL_SUBJECT
			, target_value5 MAIL_TEXT
			, NVL(target_value6,'localhost') SMTP_DETAIL
			, 1 Y
		FROM  XX_FIN_TRANSLATEVALUES VALS
			,XX_FIN_TRANSLATEDEFINITION DEFN
	   WHERE 1=1
		 AND DEFN.TRANSLATE_ID=VALS.TRANSLATE_ID
		 AND DEFN.TRANSLATION_NAME = 'XX_AR_BC_UNBILLED_EMAIL'
		 AND SOURCE_VALUE1 = 'BC_UNBILLED_RPT_EMAIL'
		 AND VALS.ENABLED_FLAG = 'Y'
		 AND SYSDATE between VALS.START_DATE_ACTIVE and nvl(VALS.END_DATE_ACTIVE, SYSDATE+1)
) b
where a.x = b.y(+)
ORDER BY 
 FROM_MAIL
 ,TO_MAIL
 ,CC 
 ,MAIL_SUBJECT
 ,MAIL_TEXT
 ,CUST_NAME , TRX_NUMBER
 ]]>
    </sqlStatement>
  </dataQuery>
  <dataStructure>
  <group name="DATA_GROUP" source="DATA_QUERY">
	    <element name="FROM_MAIL" value="FROM_MAIL"/>
		<element name="TO_MAIL" value="TO_MAIL"/>
		<element name="CC" value="CC"/>
		<element name="MAIL_SUBJECT" value="MAIL_SUBJECT"/>
		<element name="MAIL_TEXT" value="MAIL_TEXT"/>
		<element name="SMTP_DETAIL" value="SMTP_DETAIL"/>
		<element name="CUST_NAME" value="CUST_NAME"/>
		<element name="LEGACY_CUST_NAME" value="LEGACY_CUST_NAME"/>
		<element name="CUST_DOC_ID" value="CUST_DOC_ID"/>
		<element name="MBS_DOC_ID" value="MBS_DOC_ID"/>
		<element name="BILLING_FREQUENCY" value="BILLING_FREQUENCY"/>
		<element name="ORI_PAY_DOC" value="ORI_PAY_DOC"/>
		<element name="PARENT_ORDER_NUM" value="PARENT_ORDER_NUM"/>
		<element name="DELIVERY_METHOD" value="DELIVERY_METHOD"/>
		<element name="TRX_NUMBER" value="TRX_NUMBER"/>
		<element name="TRX_DATE" value="TRX_DATE"/>
		<element name="ORDERED_DATE" value="ORDERED_DATE"/>
		<element name="AMOUNT_DUE_ORIGINAL" value="AMOUNT_DUE_ORIGINAL"/>
		<element name="AMOUNT_DUE_REMAINING" value="AMOUNT_DUE_REMAINING"/>
		<element name="BILLING_DATE" value="BILLING_DATE"/>
		<element name="TRX_TYPE_NAME" value="TRX_TYPE_NAME"/>
		<element name="TRX_CLASS" value="TRX_CLASS"/>
		<element name="BATCH_SOURCE_NAME" value="BATCH_SOURCE_NAME"/>
	</group>
  </dataStructure>
  <dataTrigger name="afterReport" source="XXOD_UNBILLED_RPT_BURST_PKG.AfterReport"/>
</dataTemplate>