<?xml version="1.0" encoding="WINDOWS-1252" ?>
<dataTemplate name="XXARCBISUM" description="Reprint Summary Billing -SUMMARIZE" defaultPackage="xx_ar_reprint_summbill" Version="1.0">
	<properties>
		<property name="scalable_mode" value="on" />
		<property name="rtf-output-default-font">Arial:8</property>
	</properties>
	<parameters>
		<parameter name="P_SUMM_BILL_NUM" datatype="character" />
		<parameter name="P_SUMM_BILL_NUM_TO" datatype="character" />
		<parameter name="P_CUST_ACCOUNT_ID" datatype="number" />
		<parameter name="P_MBS_DOCUMENT_ID" datatype="number" />
		<parameter name="P_MBS_EXTENSION_ID" datatype="number" />
		<parameter name="P_SPEC_HANDLING_FLAG" datatype="character" />
		<parameter name="p_request_id" datatype="number" /> 
		<parameter name="P_ORIGIN" datatype="character" /> 
		<parameter name="P_DOC_DETAIL" datatype="character" />
		<parameter name="P_AS_OF_DATE1" datatype="character" />
		<parameter name="P_SEND_TO" datatype="character" />
		<parameter name="P_CM_TEXT1" datatype="character" />
		<parameter name="P_CM_TEXT2" datatype="character" />
		<parameter name="P_GIFT_CARD_TEXT1" dataType="character"/>
		<!--Added for R1.1 Defect # 1451 (CR 626)-->
		<parameter name="P_GIFT_CARD_TEXT2" dataType="character"/>
		<!--Added for R1.1 Defect # 1451 (CR 626)-->
		<parameter name="P_GIFT_CARD_TEXT3" dataType="character"/>
		<!--Added for R1.1 Defect # 1451 (CR 626)-->
		<parameter name="P_CUST_DOC_ID" dataType="number"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_INFOCOPY_FLAG" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_VIRTUAL_BILL_FLAG" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_VIRTUAL_BILL_NUM" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_MULTIPLE_BILL" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_DATE_FROM" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_DATE_TO" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_EMAIL_OPTION" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="P_EMAIL_ADDRESS" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
		<parameter name="DataTemplateCode" dataType="character"/>
		<!--Added for R1.2 Defect # 1210 (CR 466)-->
	</parameters>
	<dataQuery>
		<sqlStatement name="Q_DOC_DESC">
			<![CDATA[
SELECT doc_desc DOC_DESCRIPTION 
  FROM xx_cdh_mbs_document_master 
  WHERE document_id = :P_MBS_DOCUMENT_ID;
]]>
		</sqlStatement>
		<sqlStatement name="Q_BILL_TO_SITES">
			<![CDATA[
with xx_temp as          -- Added for the defect#31838
(  
  select  DISTINCT 
          UPPER(XX_AR_REPRINT_SUMMBILL.XX_BILL_TO_ADDRESS(xx_bill_to.bill_to_tmp)) BILL_TO       
       ,  UPPER(XX_AR_REPRINT_SUMMBILL.XX_REMIT_TO_ADDRESS(xx_bill_to.bill_to_tmp))  REMIT_TO        
       ,  xx_ar_print_summbill.get_mail_to_attn( :P_CUST_ACCOUNT_ID
                                              ,:P_CUST_DOC_ID
                                              ,xx_bill_to.bill_to_tmp
                                              )    MAIL_TO_ATTN  
        , xx_ar_reprint_summbill.xx_return_address() RETURN_ADDRESS  
        , xx_bill_to.BILL_TO_TMP
        , xx_bill_to.cons_inv_id        
        , b.term_id                 
from (
  SELECT distinct XACRT.attribute3 BILL_TO_TMP,
                  XACRT.cons_inv_id
  from XX_AR_CBI_RPRN_TRX_all           XACRT
  WHERE XACRT.REQUEST_ID = :p_request_id
    AND XACRT.inv_type  NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
  ) xx_bill_to
  , ar_cons_inv_all b 
where xx_bill_to.cons_inv_id = b.cons_inv_id
)
SELECT  --DISTINCT UPPER(xx_ar_reprint_summbill.xx_bill_to_address(XACRT.attribute3))       BILL_TO Commented for Defect 31838
        TMP.bill_to -- Added for Defect 31838                           
       --,UPPER(xx_ar_reprint_summbill.xx_remit_to_address(XACRT.attribute3))               REMIT_TO Commented for Defect 31838
       ,tmp.REMIT_TO -- Added for Defect 31838                         
       --, xx_ar_reprint_summbill.xx_return_address()                                       RETURN_ADDRESS Commented for Defect 31838
       ,tmp.RETURN_ADDRESS
        --XASI.tax_id                                                                       TAX_ID  Commented for Defect 31838
       --,XASI.tax_id_desc                                                                  TAX_ID_DESC  Commented for Defect 31838
       ,DECODE																			  -- Added for the defect#31838
           (
              ASP.tax_currency_code
             ,'USD'
             ,'Federal ID #:'
             ,'CAD'
             ,'GST Registration #:'
           )                                                                              TAX_ID_DESC  -- Added for the defect#31838
      ,TRIM(SUBSTR(ASP.tax_registration_number ,1 ,16))                                   TAX_ID
       ,HCA.account_number                                                                BILLING_ID
       ,TRIM (SUBSTR (HCA.orig_system_reference, 1, 8))                                   ACCOUNT_NUMBER
       ,SUBSTR(NVL(HL.address_lines_phonetic,HP.party_name),1,40)                         CUSTOMER_NAME
       ,xx_ar_print_summbill.get_od_contact_info( HCA.attribute18
                                                 ,HL.country
                                                 ,'ACCOUNT'
                                                 )                                        ACCOUNT_CONTACT
       ,xx_ar_print_summbill.get_od_contact_info( HCA.attribute18
                                                 ,HL.country
                                                 ,'ORDER'
                                                 )                                        ORDER_CONTACT
       ,HL.county                                                                         BILL_TO_COUNTRY
       ,REPLACE (HL.postal_code, '-', '')                                                 BILL_TO_POSTAL_CODE
       ,'N'                                                                               SPL_HANDLING
       ,XCMDM.doc_desc                                                                    DOC_DESCRIPTION
       ,NULL                                                                              SPL_HANDLING_COMMENTS
       ,:P_MBS_DOCUMENT_ID                                                                DOC_ID
       /* Commented for code 31838
                   ,DECODE( RCT.org_id
               ,ASP.org_id,ASP.tax_currency_code
               )                                                                          CURRENCY_CODE
       */
                   ,DECODE( FND_PROFILE.VALUE('ORG_ID')
               ,ASP.org_id,ASP.tax_currency_code
               )                                                                          CURRENCY_CODE
                   ,SUBSTR(RT.description ,1 ,15)                                         TERMS
       ,HL.province                                                                       BILL_TO_PROVINCE
       ,HCA.CUST_ACCOUNT_ID                                                               CUST_ACCOUNT_ID
       --,XACRT.attribute3                                                                BILL_TO_ID   Commented for defect 31838
	   ,TMP.BILL_TO_TMP																	  BILL_TO_ID  -- Added for defect 31838
     ,TMP.MAIL_TO_ATTN
       /* Commented for defect 31838
                   ,xx_ar_print_summbill.get_mail_to_attn( HCA.cust_account_id
                                              ,:P_CUST_DOC_ID
                                              ,XACRT.attribute3
                                              )                                           MAIL_TO_ATTN*/   -- Added as part of R1.4 CR# 547 DEfect# 2424
FROM   -- ra_customer_trx_all          RCT Commented for defect 31838
       --xx_ar_cbi_rprn_trx           XACRT
       hz_cust_accounts             HCA
       ,XX_CDH_MBS_DOCUMENT_MASTER   XCMDM
       ,ar_system_parameters         ASP
       ,HZ_LOCATIONS                 HL
       ,HZ_CUST_SITE_USES            HCASU
       ,HZ_PARTY_SITES               HPS
       ,hz_cust_acct_sites           HCAS
       ,ra_terms                     RT
       ,HZ_PARTIES                   HP
       --,XX_AR_SYS_INFO               XASI    Commented for defect 31838
        ,XX_TEMP                     TMP   -- Added for defect 31838
WHERE   1=1 --XACRT.request_id             = :p_request_id Commented for defect 31838
AND     XCMDM.DOCUMENT_ID            = :P_MBS_DOCUMENT_ID
AND     ASP.org_id                   = FND_PROFILE.VALUE('ORG_ID') 
--AND     XACRT.customer_trx_id        = RCT.customer_trx_id Commented for defect 31838
--AND     RCT.bill_to_customer_id      = HCA.cust_account_id  Commented for defect 31838
--AND     RCT.term_id                  = RT.term_id   Commented for defect 31838
AND     RT.term_id      =   TMP.term_id      -- Added for defect 31838           
--AND     XACRT.attribute3             = HCASU.site_use_id  Commented for defect 31838
AND    HCASU.site_use_id = TMP.BILL_TO_TMP     -- Added for defect 31838
AND     HCA.CUST_ACCOUNT_ID          = :P_CUST_ACCOUNT_ID -- Added for defect 31838
AND     HCASU.cust_acct_site_id      = HCAS.cust_acct_site_id
AND     HCAS.party_site_id           = HPS.party_site_id
AND     HPS.location_id              = HL.location_id
AND     HCAS.cust_account_id         = HCA.cust_account_id
AND     HCA.PARTY_ID                 = HP.PARTY_ID
AND     HP.PARTY_ID                  = HPS.PARTY_ID
--AND     XACRT.inv_type               NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL') Commented for defect 31838
]]>
		</sqlStatement>
		<sqlStatement name="Q_CONSOLIDATED_BILLS">
			<![CDATA[
with  xx_temp as /* Added for Defect 31838 */
(select DECODE( :P_INFOCOPY_FLAG
                ,'Y',NULL
                ,xx_ar_reprint_summbill.xx_fin_check_digit( :ACCOUNT_NUMBER
                                                           ,A.cons_inv_id
                                                           ,(xx_ar_reprint_summbill.get_cbi_amount_due(A.cons_inv_id ,'TOTAL') *100)
                                                           )
                ) scan_line, cons_inv_id 
                from (select distinct cons_inv_id from xx_ar_cbi_rprn_trx where request_id = :p_request_id) a
),
xx_disc_info AS (																			--Added for defect 37807
SELECT 	  max(RCT.customer_trx_id) customer_trx_id, XACRT.cons_inv_id
	FROM     xx_ar_cbi_rprn_trx           XACRT,
            ra_customer_trx              rct
	WHERE   XACRT.request_id        = :p_request_id
	AND     XACRT.inv_type          = 'INV'         
	AND     XACRT.attribute3        = :BILL_TO_ID
    AND     XACRT.customer_trx_id   = rct.customer_trx_id
    AND     RCT.billing_date		= (select max(rct1.billing_date) 
                                        FROM    ra_customer_trx         rct1,
                                                xx_ar_cbi_rprn_trx      XACRT1
                                        where   rct1.customer_trx_id    = XACRT1.customer_trx_id
                                        AND     XACRT1.request_id       = :p_request_id
                                        AND     XACRT1.inv_type         = 'INV'         
                                        AND     XACRT1.attribute3       = :BILL_TO_ID)
	group by XACRT.cons_inv_id
)	                            
select A.*
		,xx_temp.scan_line
		,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL) DISCOUNT_INFO   --added for defect #37807                                              
FROM
(    
SELECT   :BILL_TO_PROVINCE                                        BILL_TO_PROVINCE
        ,XACRT.cons_inv_id                                        cbi_id
        ,XACRT.attribute2                                         BILLING_NUMBER
        ,:CURRENCY_CODE                                           CURRENCY
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_from_date( :CUST_ACCOUNT_ID
                                                            ,XACRT.attribute3
                                                            ,XACRT.attribute4
                                                            ,XACRT.attribute1
                                                            ,'N'
                                                            )
                 ,'DD-MON-YY'
                 )                                                  BILL_FROM_DATE
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_to_date( :CUST_ACCOUNT_ID
                                                         ,XACRT.attribute4
                                                         ,XACRT.attribute1
                                                         )
                 ,'DD-MON-YY'
                 )                                                  BILL_TO_DATE
        ,(SELECT TO_CHAR(ACI.due_date,'DD-MON-YY')
          FROM   ar_cons_inv ACI
          WHERE  ACI.cons_inv_id    = XACRT.cons_inv_id
          AND    :P_INFOCOPY_FLAG   = 'N'
          )                                                         PAYMENT_DUE
        ,:TERMS                                                     TERMS
        ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                            ,'EXTAMT_PLUS_DELVY'
                                            )
            )                                                        CBI_EXTAMT_PLUS_DELVY
        ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                            ,'DISCOUNT'
                                            )
             )                                                       CBI_DISCOUNTS
        ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                            ,'TAX'
                                            )
             )                                                       CBI_TAX
        ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                            ,'TOTAL'
                                            )
             )                                                       CBI_AMOUNT_DUE        
		,SUM(( SELECT SUM(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XACRT.customer_trx_id) +
						   XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XACRT.customer_trx_id))
				  FROM xx_ar_cbi_rprn_trx
				 WHERE cons_inv_id = XACRT.cons_inv_id) )           cbi_fee_amt
        ,DECODE( :P_INFOCOPY_FLAG
                ,'Y','**DO NOT PAY**'
                ,'N',DECODE(SIGN(SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                                                    ,'TOTAL'
                                                                   )
                                     )
                                 )
                            ,1,'**BAL DUE**'
                            ,'**DO NOT PAY**'
                            )
                )                                                    NO_PAYMENT_TEXT
        ,DECODE( :P_INFOCOPY_FLAG
                ,'Y','Reprint of Informational Copy'
                ,'N','Reprint of Original Consolidated Bill'
                )                                                    DOC_TITLE
        ,REPLACE(SFHDR.sfhdr1 ,':' ,'')                              sfhdr1
        ,REPLACE(SFHDR.sfhdr2 ,':' ,'')                              sfhdr2
        ,REPLACE(SFHDR.sfhdr3 ,':' ,'')                              sfhdr3
        ,REPLACE(SFHDR.sfhdr4 ,':' ,'')                              sfhdr4
        ,REPLACE(SFHDR.sfhdr5 ,':' ,'')                              sfhdr5
		--,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(XACRT.customer_trx_id),NULL) discount_info -- Added for Defect 36434	--Commented for defect #37640
		--,NULL														DISCOUNT_INFO 		--Added for Defect 37640  --Commented for defect #37807
          ,MAX(NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_fee_option(:P_CUST_DOC_ID,'Consolidated Bill',:cust_account_id),0)) FEE_OPTION
FROM     xx_ar_cbi_rprn_trx           XACRT
        ,(SELECT   cons_inv_id
                  ,sfhdr1
                  ,sfhdr2
                  ,sfhdr3
                  ,sfhdr4
                  ,sfhdr5
          FROM     xx_ar_cbi_rprn_trx
          WHERE    request_id =:p_request_id
          AND      inv_type NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
          GROUP BY cons_inv_id
                  ,sfhdr1
                  ,sfhdr2
                  ,sfhdr3
                  ,sfhdr4
                  ,sfhdr5
          )                           SFHDR
WHERE    XACRT.request_id    = :p_request_id 
AND      XACRT.inv_type      NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
AND      SFHDR.cons_inv_id   = XACRT.cons_inv_id
AND      XACRT.attribute3    = :BILL_TO_ID
GROUP BY :BILL_TO_PROVINCE
        ,XACRT.cons_inv_id
        ,XACRT.attribute2
        ,:CURRENCY_CODE
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_from_date( :CUST_ACCOUNT_ID
                                                            ,XACRT.attribute3
                                                            ,XACRT.attribute4
                                                            ,XACRT.attribute1
                                                            ,'N'
                                                            )
                 ,'DD-MON-YY'
                 )
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_to_date( :CUST_ACCOUNT_ID
                                                         ,XACRT.attribute4
                                                         ,XACRT.attribute1
                                                         )
                 ,'DD-MON-YY'
                 )
        ,:P_INFOCOPY_FLAG
        ,:TERMS
        ,DECODE( :P_INFOCOPY_FLAG
                ,'Y','Reprint of Informational Copy'
                ,'N','Reprint of Original Consolidated Bill'
                )
        ,REPLACE(SFHDR.sfhdr1 ,':' ,'')
        ,REPLACE(SFHDR.sfhdr2 ,':' ,'')
        ,REPLACE(SFHDR.sfhdr3 ,':' ,'')
        ,REPLACE(SFHDR.sfhdr4 ,':' ,'')
        ,REPLACE(SFHDR.sfhdr5 ,':' ,'')
		--,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(XACRT.customer_trx_id),NULL) -- Added for Defect 36434	--Commented for defect #37640
)  a, xx_temp
, xx_disc_info										-- Added for Defect 37807
where a.cbi_id = xx_temp.cons_inv_id
and   a.cbi_id = xx_disc_info.cons_inv_id(+)			-- Added for Defect 37807
ORDER BY A.cbi_id
]]>
		</sqlStatement>
		<sqlStatement name="Q_INVOICE_HEADER">
			<![CDATA[
SELECT 
      attribute3  trx_id
  /* 
     ,(
    SELECT 
          attribute3  
    FROM  xx_ar_cbi_rprn_rows a
    WHERE request_id      =:p_request_id
      AND cons_inv_id     =:cbi_id
      AND line_seq = 
                  (
                   SELECT MAX(line_seq)
                   FROM   xx_ar_cbi_rprn_rows
                   WHERE 1 =1
                 AND request_id  =:p_request_id
                 AND cons_inv_id =:cbi_id
                  )     
      ) last_trx_id     
  */
FROM  xx_ar_cbi_rprn_rows a
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND (line_type not like '%TOTAL') --Added this for defect 30147
  AND line_type <> 'TD_REC'
  AND line_type <> 'SPC_REC' -- Added for defect 35995
ORDER BY line_seq
]]>
		</sqlStatement>
		<sqlStatement name="Q_INVOICE_SPC">
			<![CDATA[
SELECT 
      a.sf_text   spc_text
FROM  xx_ar_cbi_rprn_rows a
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND attribute3      =:trx_id
  AND line_type       ='SPC_REC'
]]>
		</sqlStatement>
		<sqlStatement name="Q_INVOICE_INFO">
			<![CDATA[

SELECT DISTINCT SF_DATA1,
SF_DATA2,
SF_DATA3,
SF_DATA4,
SF_DATA5,
ORDER_NO,
ORDER_DATE,
(SUBTOTAL-FEE_AMT-FEE_HEA_AMT) AS INV_SUBTOTAL,
INV_DELIVERY,
INV_DISCOUNTS,
INV_TAX,
(FEE_AMT + FEE_HEA_AMT) INV_FEES,
INV_TOTAL,
SF_DATA6,
SF_HDR7,
SF_DATA7,
line_seq 
     FROM 
        ( 
SELECT 
      DISTINCT TRIM(XAECTRS.sfdata1)      sf_data1
     ,TRIM(XAECTRS.sfdata2)      sf_data2
     ,TRIM(XAECTRS.sfdata3)      sf_data3
     ,TRIM(XAECTRS.sfdata4)      sf_data4
     ,TRIM(XAECTRS.sfdata5)      sf_data5      
     ,XAECTRS.attribute1         order_no
     ,XAECTRS.attribute2         order_date     
 --    ,NVL(XAECTRS.subtotal ,0)   inv_subtotal   commented for defect 13937
     ,NVL(XAECTRS.subtotal ,0) -  NVL(XAECTRS.delivery ,0)  subtotal   -- added for defect 13937
	 ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XAECTRS.attribute3),0) FEE_AMT
     ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XAECTRS.attribute3),0) FEE_HEA_AMT
     ,NVL(XAECTRS.delivery ,0)   inv_delivery
     ,NVL(XAECTRS.discounts ,0)  inv_discounts
     ,NVL(XAECTRS.tax ,0)        inv_tax
--     ,NVL(XAECTRS.total ,0)      inv_total     commented for defect 13937
     ,NVL(XAECTRS.total ,0) - NVL(XAECTRS.delivery ,0)     inv_total           ---- added for defect 13937
	 ,TRIM(XAECHM.cust_contact_name)                    sf_data6
      ,'SHIP TO:'                                 sf_hdr7
	,trim(XAECHM.ship_to_address1||DECODE(trim(XAECHM.ship_to_address2),'','',', '||trim(XAECHM.ship_to_address2))||DECODE(trim(XAECHM.ship_to_city),'','',', '||trim(XAECHM.ship_to_city))||DECODE(trim(XAECHM.ship_to_state),'','',', '||trim(XAECHM.ship_to_state))||DECODE(trim(XAECHM.ship_to_zip),'','',' '||trim((CASE WHEN ((LENGTH(XAECHM.ship_to_zip) > 5) and XAECHM.ship_to_country IN('US','USA'))
                        THEN (SUBSTR(XAECHM.ship_to_zip,1,5)||'-'||SUBSTR(XAECHM.ship_to_zip,6))
                        ELSE (XAECHM.ship_to_zip)
                        END)))	
              )  sf_data7
              ,XAECTRS.line_seq
FROM  xx_ar_cbi_rprn_rows XAECTRS
     ,ra_customer_trx_all ract
	 ,xx_om_header_attributes_all XAECHM
WHERE XAECTRS.request_id      =:p_request_id
  AND XAECTRS.cons_inv_id     =:cbi_id
  AND XAECTRS.attribute3      =:trx_id
  AND XAECTRS.line_type       ='TRX_REC'
  AND XAECTRS.attribute3 = ract.customer_trx_id(+)
  AND ract.attribute14 = XAECHM.header_id(+)
)
         ORDER BY line_seq
]]>
		</sqlStatement>
		<sqlStatement name="Q_INVOICE_TD">
			<![CDATA[
SELECT 
      a.sf_text    td_text
FROM  xx_ar_cbi_rprn_rows a
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND attribute3      =:trx_id
  AND line_type       ='TD_REC'
UNION ALL
  SELECT '        '||:P_CM_TEXT1||' '||
--       TRIM(TO_CHAR(a.extended_price ,'$9G999G999D99PR'))||    -- Commented for R1.2 Defect 1143 (CR 621)
       TRIM(TO_CHAR(a.extended_price ,'$9G999G999D99'))||        -- Added for R1.2 Defect 1143 (CR 621)
       ' '||:P_CM_TEXT2||' '||
       a.customer_product_code||'.'    td_text             -- Added for R1.3 CR 733 Defect 1212
FROM   xx_ar_cbi_rprn_trx_lines a
WHERE a.request_id      =:p_request_id
  AND a.cons_inv_id     =:cbi_id
  AND a.customer_trx_id =:trx_id
  AND a.item_code       ='ACM'
  UNION ALL
-- Added the below two queries for R1.1 Defect # 1451 (CR 626)
--  SELECT '        '||:P_GIFT_CARD_TEXT1||a.extended_price||:P_GIFT_CARD_TEXT2    td_text     -- Commented for R1.2 Defect 1143 (CR 621)
  SELECT '        '||:P_GIFT_CARD_TEXT1||TRIM(TO_CHAR(a.extended_price*-1 ,'9G999G999D99'))||:P_GIFT_CARD_TEXT2    td_text   -- Added for R1.2 Defect 1143 (CR 621)
FROM   xx_ar_cbi_rprn_trx_lines a
WHERE a.request_id      =:p_request_id
  AND a.cons_inv_id     =:cbi_id
  AND a.customer_trx_id =:trx_id
  AND a.item_code       ='GIFT_CARD_INV'
  UNION ALL
--  SELECT '        '||:P_GIFT_CARD_TEXT3||TRIM(TO_CHAR(a.extended_price ,'9G999G999D99PR'))    td_text   -- Commented for R1.2 Defect 1143 (CR 621)
  SELECT '        '||:P_GIFT_CARD_TEXT3||TRIM(TO_CHAR(a.extended_price ,'9G999G999D99'))    td_text       -- Added for R1.2 Defect 1143 (CR 621)
FROM   xx_ar_cbi_rprn_trx_lines a
WHERE a.request_id      =:p_request_id
  AND a.cons_inv_id     =:cbi_id
  AND a.customer_trx_id =:trx_id
  AND a.item_code       ='GIFT_CARD_CM'
]]>
		</sqlStatement>
		<sqlStatement name="Q_INVOICE_TOTALS">
			<![CDATA[
SELECT * FROM 
(
SELECT
      1                      rec_type
     ,a.sf_text              sf_text1      
     ,a.attribute1           total_orders
     ,NVL(a.subtotal ,0)     sf_subtotal 
     ,NVL(a.delivery ,0)     sf_delivery
     ,NVL(a.discounts ,0)    sf_discounts
     ,NVL(a.tax ,0)          sf_tax
	 ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(a.attribute3),0)
                          + NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(a.attribute3),0) SF_FEE_AMT
     ,NVL(a.total ,0)        sf_total
     ,line_seq               view_seq   
     --,DECODE(:trx_id, :last_trx_id ,'N', NVL(page_break ,'N')) pg_break   Defect 9556  
     ,NVL(page_break ,'N')   pg_break   
--     ,DECODE(line_seq, b.line_seq1 ,'Y' ,'N')  show_line
     ,'Y'                   show_line
FROM  xx_ar_cbi_rprn_rows a
    ,(
       select max(line_seq) line_seq1
       from   xx_ar_cbi_rprn_rows
       where  request_id      =:p_request_id
         and  cons_inv_id     =:cbi_id
         and  attribute3      =:trx_id
     ) b
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND attribute3      =:trx_id
  AND line_type       ='SOFTHDR_TOTAL'
UNION ALL
SELECT
      3                     rec_type
     ,a.sf_text             sf_text1      
     ,a.attribute1          total_orders
     ,NVL(a.subtotal ,0)    sf_subtotal 
     ,NVL(a.delivery ,0)    sf_delivery
     ,NVL(a.discounts ,0)   sf_discounts
     ,NVL(a.tax ,0)         sf_tax
	 ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(a.attribute3),0)
                          + NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(a.attribute3),0) SF_FEE_AMT
     ,NVL(a.total ,0)       sf_total
     ,line_seq              view_seq
     ,'N'                   pg_break
     ,'Y'                   show_line
FROM  xx_ar_cbi_rprn_rows a
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND attribute3      =:trx_id
  AND line_type       ='BILL_TO_TOTAL'
UNION ALL
SELECT
        5                     rec_type
       ,a.sf_text             sf_text1      
       ,TO_CHAR(NULL)         total_orders
       ,TO_NUMBER(NULL)       sf_subtotal 
       ,TO_NUMBER(NULL)       sf_delivery
       ,TO_NUMBER(NULL)       sf_discounts
       ,TO_NUMBER(NULL)       sf_tax
	   ,TO_NUMBER(NULL)       SF_FEE_AMT
       ,NVL(a.total ,0)       sf_total
       ,line_seq              view_seq
       ,'N'                   pg_break
       ,'N'                   show_line       
FROM  xx_ar_cbi_rprn_rows a
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND attribute3      =:trx_id
  AND line_type       ='GRAND_TOTAL'
)   
ORDER BY rec_type ,view_seq
]]>
		</sqlStatement>
		
		<sqlStatement name="Q_POD_MSG">  <!--Added this sqlStatement for POD NAIT-80452-->
		   <![CDATA[
			  SELECT xx_ar_reprint_summbill.get_pod_msg(:cust_account_id ,:trx_id,:p_cust_doc_id) PD_CUST_MSG
			  FROM DUAL
		   ]]>
		</sqlStatement>	
		<sqlStatement name="Q_POD_IMAGE"> <!--Added this sqlStatement for POD NAIT-80452-->		
       <![CDATA[  
		  SELECT TO_CHAR(dtl.delivery_date,'DD-MON-YYYY HH24:MI:SS') DEL_DT_TM,
			     dtl.carrier_name CR_NM,
			     trim(dtl.consignee)  CNSNEE,
			     NVL( (select xx_ar_ebl_pod_invoices_pkg.resize_image(:trx_id) from dual),POD_IMAGE)  PD_IMG				 
		  FROM  xx_ar_ebl_pod_dtl dtl
		  WHERE customer_trx_id = :trx_id
				AND 'Y' =  xx_ar_reprint_summbill.get_paydoc_flag(:p_cust_doc_id,:cust_account_id)
	   ]]>
		</sqlStatement>
		<sqlStatement name="Q_CONS_MSG_BCC">  <!--Added this sqlStatement for NAIT-80452-->
		   <![CDATA[
		  SELECT xx_ar_reprint_summbill.get_cons_msg_bcc(:cbi_id,:p_cust_doc_id,:cust_account_id,:billing_number) CONS_MSG_BCC 		  
		  FROM DUAL
		   ]]>
		</sqlStatement>	
	<sqlStatement name="Q_CONS_FEE">  <!--Added this sqlStatement for NAIT-12967-->
       <![CDATA[	
	SELECT 
      flv.lookup_code FEE_CODE
     ,upper(flv.meaning)  FEE_DESCRIPTION
     ,TO_CHAR(sum(RCTL.unit_selling_price*QUANTITY_INVOICED),'9999999999.999')       FEE_AMT      
     ,RCTL.customer_trx_id
FROM
     ra_customer_trx_lines_All RCTL
     ,fnd_lookup_values flv
WHERE 1=1
  AND flv.lookup_type = 'OD_FEES_ITEMS'
  AND flv.LANGUAGE='US'
  AND flv.attribute6= rctl.INVENTORY_ITEM_ID
  AND FLV.enabled_flag = 'Y'                                   
  AND SYSDATE BETWEEN NVL(FLV.start_date_active,SYSDATE) AND NVL(FLV.end_date_active,SYSDATE+1)  
  AND FLV.attribute7 NOT IN ('DELIVERY','MISCELLANEOUS')  
  AND customer_trx_id                           = :trx_id
GROUP BY RCTL.customer_trx_id,flv.lookup_code,flv.meaning
       ]]>
    </sqlStatement>	
		
	</dataQuery>
	<dataTrigger name="beforeReportTrigger" source="xx_ar_reprint_summbill.beforereport"/>
	<dataStructure>
		<group name="G_BILL_TO_SITES" source="Q_BILL_TO_SITES">
			<element name="DOC_DESCRIPTION" value="DOC_DESCRIPTION" />
			<element name="BILL_TO_COUNTRY" value="BILL_TO_COUNTRY" />
			<element name="POSTAL_CODE" value="BILL_TO_POSTAL_CODE" />
			<element name="RETURN_ADDRESS" value="RETURN_ADDRESS" />
			<element name="REMIT_TO" value="REMIT_TO" />
			<element name="BILL_TO" value="BILL_TO" />
			<element name="MAIL_TO_ATTN" value="MAIL_TO_ATTN" />
			<!--Added for R1.4 Defect # 2424 (CR 547)-->
			<element name="TAX_ID_DESC" value="TAX_ID_DESC" />
			<element name="TAX_ID" value="TAX_ID" />
			<element name="ACCOUNT_CONTACT" value="ACCOUNT_CONTACT" />
			<element name="ORDER_CONTACT" value="ORDER_CONTACT" />
			<element name="CUSTOMER_NAME" value="CUSTOMER_NAME" />
			<element name="ACCOUNT_NUMBER" value="ACCOUNT_NUMBER" />
			<element name="BILLING_ID" value="BILLING_ID" />
			<element name="SPL_HANDLING" value="SPL_HANDLING" />
			<element name="COMMENTS" value="SPL_HANDLING_COMMENTS" />
			<element name="DOC_ID" value="DOC_ID" />
			<!--Added for R1.2 Defect # 1237 (CR 621)-->
			<group name="G_CONS_BILLS" source="Q_CONSOLIDATED_BILLS">
				<element name="SCANLINE" value="SCAN_LINE" />
				<element name="BILLING_NUMBER" value="BILLING_NUMBER" />
				<element name="TERMS" value="TERMS" />
				<element name="CURRENCY" value="CURRENCY" />
				<element name="BILL_FROM_DATE" value="BILL_FROM_DATE" />
				<element name="BILL_TO_DATE" value="BILL_TO_DATE" />
				<element name="PAYMENT_DUE" value="PAYMENT_DUE" />
				<element name="DOC_TITLE" value="DOC_TITLE" />
				<element name="SFHDR1" value="SFHDR1" />
				<element name="SFHDR2" value="SFHDR2" />
				<element name="SFHDR3" value="SFHDR3" />
				<element name="SFHDR4" value="SFHDR4" />
				<element name="SFHDR5" value="SFHDR5" />
				<element name="CBI_EXTAMT_PLUS_DELVY" value="CBI_EXTAMT_PLUS_DELVY" />
				<element name="CBI_DISCOUNTS" value="CBI_DISCOUNTS" />
				<element name="CBI_TAX" value="CBI_TAX" />
				<element name="CBI_FEE_AMT" value="CBI_FEE_AMT" />
				<element name="CBI_AMOUNT_DUE" value="CBI_AMOUNT_DUE" />
				<element name="NO_PAYMENT_TEXT" value="NO_PAYMENT_TEXT" />
				<!--Added for R1.2 Defect # 1210 (CR 466)-->
				<element name="DISCOUNT_INFO" value="DISCOUNT_INFO" />
				<!--Added for Defect # 36434 -->
				<element name = "FEE_OPTION"            value = "FEE_OPTION"/>
				<group name="G_INVOICE_HEADER" source="Q_INVOICE_HEADER">
					<element name="TRX_ID" value="TRX_ID" />
					<group name="G_SPC" source="Q_INVOICE_SPC">
						<element name="SPC_TEXT" value="SPC_TEXT" />
					</group>
					<group name="G_INVOICE_INFO" source="Q_INVOICE_INFO">
						<element name="SF_DATA1" value="SF_DATA1" />
						<element name="SF_DATA2" value="SF_DATA2" />
						<element name="SF_DATA3" value="SF_DATA3" />
						<element name="SF_DATA4" value="SF_DATA4" />
						<element name="SF_DATA5" value="SF_DATA5" />
						<element name = "SF_DATA6"  value = "SF_DATA6" />
						<element name = "SF_HDR7"   value = "SF_HDR7" />
						<element name = "SF_DATA7"  value = "SF_DATA7" />
						<element name="ORDER_NO" value="ORDER_NO" />
						<element name="ORDER_DATE" value="ORDER_DATE" />
						<element name="SUBTOTAL" value="INV_SUBTOTAL" />
						<element name="DELIVERY" value="INV_DELIVERY" />
						<element name="FEE_AMT" value="INV_FEES" />
						<element name="DISCOUNTS" value="INV_DISCOUNTS" />
						<element name="TAX" value="INV_TAX" />
						<element name="TOTAL" value="INV_TOTAL" />
					</group>
					<group name="G_TD" source="Q_INVOICE_TD">
						<element name="TD_TEXT" value="TD_TEXT" />
					</group>
					<group name="G_INV_STATEMENT" source="Q_INVOICE_TOTALS">
						<element name="SF_TEXT1" value="SF_TEXT1" />
						<element name="SF_TOTAL_ORDERS" value="TOTAL_ORDERS" />
						<element name="SF_SUBTOTAL" value="SF_SUBTOTAL" />
						<element name="SF_DELIVERY" value="SF_DELIVERY" />
						<element name="SF_DISCOUNTS" value="SF_DISCOUNTS" />
						<element name="SF_TAX" value="SF_TAX" />
						<element name="SF_FEES" value="SF_FEE_AMT" />
						<element name="SF_TOTAL" value="SF_TOTAL" />
						<element name="PG_BREAK" value="PG_BREAK" />
						<element name="SHOW_LINE" value="SHOW_LINE" />
					</group>
					<group name = "G_POD_MSG" source = "Q_POD_MSG">	<!--Added this Group for POD NAIT-80452-->
						<element name = "PD_CUST_MSG"              value = "PD_CUST_MSG"/>
					</group>
					<group name = "G_POD_DETAILS" source = "Q_POD_IMAGE"> 
						<element name = "PD_IMG"      value = "PD_IMG"/>
						<element name = "DEL_DT_TM"   value = "DEL_DT_TM"/>  
						<element name = "CR_NM"       value = "CR_NM"/>
						<element name = "CNSNEE"      value = "CNSNEE"/>
					</group>
				</group>
				<group name = "G_CONS_MSG_BCC" source = "Q_CONS_MSG_BCC">   <!--Added this group for NAIT-80452-->
						<element name = "CONS_MSG_BCC" value = "CONS_MSG_BCC"/>
				</group>
				<group name="G_INV_FEE" source="Q_CONS_FEE">
					<element name = "FEE_NAME"                value = "FEE_DESCRIPTION" />
					<element name = "AMOUNT"                  value = "FEE_AMT" />
				  </group>
			</group>
		</group>
	</dataStructure>
	<dataTrigger name="afterReportTrigger" source="xx_ar_reprint_summbill.afterreport"/>
</dataTemplate>