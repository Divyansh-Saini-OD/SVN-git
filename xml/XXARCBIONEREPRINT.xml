<?xml version="1.0" encoding="WINDOWS-1252" ?>
<dataTemplate name="XXARCBIONE" description="Reprint Summary Billing -ONE" defaultPackage="xx_ar_reprint_summbill" Version="1.0">
<properties>
<property name="scalable_mode" value="on" />
<property name="rtf-output-default-font">Arial:8</property>
</properties>
<parameters>
 <parameter name="P_SUMM_BILL_NUM" datatype="character" />
 <parameter name="P_SUMM_BILL_NUM_TO" datatype="character" />
 <parameter name="P_CUST_ACCOUNT_ID" datatype="number" />
 <parameter name="P_MBS_DOCUMENT_ID" datatype="number" />
 <parameter name="P_MBS_EXTENSION_ID" datatype="number" />
 <parameter name="P_SPEC_HANDLING_FLAG" datatype="character" />
 <parameter name="p_request_id" datatype="number" /> 
 <parameter name="P_ORIGIN" datatype="character" /> 
 <parameter name="P_DOC_DETAIL" datatype="character" />
 <parameter name="P_AS_OF_DATE1" datatype="character" />
 <parameter name="P_SEND_TO" datatype="character" />
 <parameter name="P_CUST_DOC_ID" dataType="number"/>                        <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_INFOCOPY_FLAG" dataType="character"/>                   <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_VIRTUAL_BILL_FLAG" dataType="character"/>               <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_VIRTUAL_BILL_NUM" dataType="character"/>                <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_MULTIPLE_BILL" dataType="character"/>                   <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_DATE_FROM" dataType="character"/>                       <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_DATE_TO" dataType="character"/>                         <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_EMAIL_OPTION" dataType="character"/>                    <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="P_EMAIL_ADDRESS" dataType="character"/>                   <!--Added for R1.2 Defect # 1210 (CR 466)-->
 <parameter name="DataTemplateCode" dataType="character"/>                  <!--Added for R1.2 Defect # 1210 (CR 466)-->
</parameters>
<dataQuery>
<sqlStatement name="Q_BILL_TO_SITES">
<![CDATA[
SELECT  DISTINCT UPPER(xx_ar_reprint_summbill.xx_bill_to_address(XACRT.attribute3))       BILL_TO
       ,UPPER(xx_ar_reprint_summbill.xx_remit_to_address(XACRT.attribute3))               REMIT_TO
       ,xx_ar_reprint_summbill.xx_return_address()                                        RETURN_ADDRESS
       ,XASI.tax_id                                                                       TAX_ID
       ,XASI.tax_id_desc                                                                  TAX_ID_DESC
       ,HCA.account_number                                                                BILLING_ID
       ,TRIM (SUBSTR (HCA.orig_system_reference, 1, 8))                                   ACCOUNT_NUMBER
       ,SUBSTR(NVL(HL.address_lines_phonetic,HP.party_name),1,40)                         CUSTOMER_NAME
       ,xx_ar_print_summbill.get_od_contact_info( HCA.attribute18
                                                 ,HL.country
                                                 ,'ACCOUNT'
                                                 )                                        ACCOUNT_CONTACT
       ,xx_ar_print_summbill.get_od_contact_info( HCA.attribute18
                                                 ,HL.country
                                                 ,'ORDER'
                                                 )                                        ORDER_CONTACT
       ,HL.county                                                                         BILL_TO_COUNTRY
       ,REPLACE (HL.postal_code, '-', '')                                                 BILL_TO_POSTAL_CODE
       ,'N'                                                                               SPL_HANDLING
       ,XCMDM.doc_desc                                                                    DOC_DESCRIPTION
       ,NULL                                                                              SPL_HANDLING_COMMENTS
       ,:P_MBS_DOCUMENT_ID                                                                DOC_ID
       ,DECODE( RCT.org_id
               ,ASP.org_id,ASP.tax_currency_code
               )                                                                          CURRENCY_CODE
       ,SUBSTR(RT.description ,1 ,15)                                                     TERMS
       ,HL.province                                                                       BILL_TO_PROVINCE
       ,HCA.cust_account_id                                                               CUST_ACCOUNT_ID
       ,XACRT.attribute3                                                                  BILL_TO_ID
       ,xx_ar_print_summbill.get_mail_to_attn( HCA.cust_account_id
                                              ,:P_CUST_DOC_ID
                                              ,XACRT.attribute3
                                              )                                           MAIL_TO_ATTN   -- Added as part of R1.4 CR# 547 DEfect# 2424
FROM    ra_customer_trx_all          RCT
       ,xx_ar_cbi_rprn_trx           XACRT
       ,hz_cust_accounts             HCA
       ,xx_cdh_mbs_document_master   XCMDM
       ,ar_system_parameters         ASP
       ,hz_locations                 HL
       ,hz_cust_site_uses            HCASU
       ,hz_party_sites               HPS
       ,hz_cust_acct_sites           HCAS
       ,ra_terms                     RT
       ,hz_parties                   HP
       ,xx_ar_sys_info               XASI
WHERE   XACRT.request_id             = :p_request_id
AND     XCMDM.document_id            = :P_MBS_DOCUMENT_ID
AND     ASP.org_id                   = FND_PROFILE.VALUE('ORG_ID')
AND     XACRT.customer_trx_id        = RCT.customer_trx_id
AND     RCT.bill_to_customer_id      = HCA.cust_account_id
AND     RCT.term_id                  = RT.term_id
AND     XACRT.attribute3             = HCASU.site_use_id
AND     HCASU.cust_acct_site_id      = HCAS.cust_acct_site_id
AND     HCAS.party_site_id           = HPS.party_site_id
AND     HPS.location_id              = HL.location_id
AND     HCAS.cust_account_id         = HCA.cust_account_id
AND     HCA.party_id                 = HP.party_id
AND     HP.party_id                  = HPS.party_id
AND     XACRT.inv_type               NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
]]>
</sqlStatement>
<sqlStatement name="Q_CONSOLIDATED_BILLS">
<![CDATA[
with xx_disc_info AS (																			--Added for defect 37807
SELECT 	  max(RCT.customer_trx_id) customer_trx_id, XACRT.cons_inv_id
	FROM     xx_ar_cbi_rprn_trx           XACRT,
             ra_customer_trx              rct
	WHERE   XACRT.request_id        = :p_request_id
	AND     XACRT.inv_type          = 'INV'         
	AND     XACRT.attribute3        = :BILL_TO_ID
    AND     XACRT.customer_trx_id   = rct.customer_trx_id
    AND     RCT.billing_date		= (select max(rct1.billing_date) 
                                        FROM    ra_customer_trx         rct1,
                                                xx_ar_cbi_rprn_trx     XACRT1
                                        where   rct1.customer_trx_id    = XACRT1.customer_trx_id
                                        AND     XACRT1.request_id       = :p_request_id
                                        AND     XACRT1.inv_type         = 'INV'         
                                        AND     XACRT1.attribute3       = :BILL_TO_ID)
	group by XACRT.cons_inv_id
)
SELECT   :BILL_TO_PROVINCE                                        BILL_TO_PROVINCE
        ,XACRT.cons_inv_id                                        cbi_id
        ,XACRT.attribute2                                         BILLING_NUMBER
        ,:CURRENCY_CODE                                           CURRENCY
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_from_date( :CUST_ACCOUNT_ID
                                                            ,XACRT.attribute3
                                                            ,XACRT.attribute4
                                                            ,XACRT.attribute1
                                                            ,'N'
                                                            )
                 ,'DD-MON-YY'
                 )                                                  BILL_FROM_DATE
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_to_date( :CUST_ACCOUNT_ID
                                                         ,XACRT.attribute4
                                                         ,XACRT.attribute1
                                                         )
                 ,'DD-MON-YY'
                 )                                                  BILL_TO_DATE
      ,(SELECT TO_CHAR(ACI.due_date,'DD-MON-YY')
        FROM   ar_cons_inv ACI
        WHERE  ACI.cons_inv_id    = XACRT.cons_inv_id
        AND    :P_INFOCOPY_FLAG   = 'N'
        )                                                         PAYMENT_DUE
      ,:TERMS                                                     TERMS
      ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                          ,'EXTAMT_PLUS_DELVY'
                                          )
          )                                                        CBI_EXTAMT_PLUS_DELVY
      ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                          ,'DISCOUNT'
                                          )
           )                                                       CBI_DISCOUNTS
      ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                          ,'TAX'
                                          )
           )                                                       CBI_TAX
	 ,SUM(( SELECT SUM(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XACRT.customer_trx_id) +
					   XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XACRT.customer_trx_id))
			  FROM xx_ar_cbi_rprn_trx
			 WHERE cons_inv_id = XACRT.cons_inv_id) )           cbi_fee_amt
      ,SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                          ,'TOTAL'
                                          )
           )                                                       CBI_AMOUNT_DUE
      ,DECODE( :P_INFOCOPY_FLAG
              ,'Y',NULL
              ,xx_ar_reprint_summbill.xx_fin_check_digit( :ACCOUNT_NUMBER
                                                         ,XACRT.cons_inv_id
                                                         ,(xx_ar_reprint_summbill.get_cbi_amount_due(XACRT.cons_inv_id ,'TOTAL') *100)
                                                         )
              )                                                    SCAN_LINE
      ,DECODE( :P_INFOCOPY_FLAG
              ,'Y','**DO NOT PAY**'
              ,'N',DECODE(SIGN(SUM(xx_ar_cbi_infocopy_order_stmnt( XACRT.customer_trx_id
                                                                  ,'TOTAL'
                                                                 )
                                   )
                               )
                          ,1,'**BAL DUE**'
                          ,'**DO NOT PAY**'
                          )
              )                                                    NO_PAYMENT_TEXT
      ,DECODE( :P_INFOCOPY_FLAG
              ,'Y','Reprint of Informational Copy'
              ,'N','Reprint of Original Consolidated Bill'
              )                                                    DOC_TITLE
	  --,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(XACRT.customer_trx_id),NULL) discount_info -- Added for Defect 36434	--Commented for defect #37640
	  --,NULL														DISCOUNT_INFO 		--Added for Defect 37640  --Commented for defect #37807
	  ,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL) DISCOUNT_INFO    --Added for defect #37807
        ,MAX(NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_fee_option(:P_CUST_DOC_ID,'Consolidated Bill',:cust_account_id),0)) FEE_OPTION
FROM     xx_ar_cbi_rprn_trx           XACRT
		,xx_disc_info											--Added for defect 37807
WHERE    request_id              = :p_request_id 
AND      inv_type                NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
AND      XACRT.attribute3        = :BILL_TO_ID
AND		 XACRT.cons_inv_id 		 = xx_disc_info.cons_inv_id(+)					--Added for defect 37807
GROUP BY :BILL_TO_PROVINCE
        ,XACRT.cons_inv_id
        ,XACRT.attribute2
        ,:CURRENCY_CODE
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_from_date( :CUST_ACCOUNT_ID
                                                            ,XACRT.attribute3
                                                            ,XACRT.attribute4
                                                            ,XACRT.attribute1
                                                            ,'N'
                                                            )
                 ,'DD-MON-YY'
                 )
        ,TO_CHAR(xx_ar_reprint_summbill.get_bill_to_date( :CUST_ACCOUNT_ID
                                                         ,XACRT.attribute4
                                                         ,XACRT.attribute1
                                                         )
                 ,'DD-MON-YY'
                 )
        ,:P_INFOCOPY_FLAG
        ,:TERMS
        ,DECODE( :P_INFOCOPY_FLAG
                ,'Y',NULL
                ,xx_ar_reprint_summbill.xx_fin_check_digit( :ACCOUNT_NUMBER
                                                           ,XACRT.cons_inv_id
                                                           ,(xx_ar_reprint_summbill.get_cbi_amount_due(XACRT.cons_inv_id ,'TOTAL') *100)
                                                           )
                )
        ,DECODE( :P_INFOCOPY_FLAG
                ,'Y','Reprint of Informational Copy'
                ,'N','Reprint of Original Consolidated Bill'
                )
		--,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(XACRT.customer_trx_id),NULL)  -- Added for Defect 36434	--Commented for defect #37640
		,DECODE(:P_INFOCOPY_FLAG,'N',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL)				--Added for defect 37807
ORDER BY XACRT.cons_inv_id
]]>
</sqlStatement>
<sqlStatement name="Q_ONE">
<![CDATA[
SELECT 
      a.sf_text                     soft_data
     ,DECODE( TRIM(a.sf_text)
             ,'GRAND TOTAL:'
             ,TO_CHAR(NULL)
             ,a.attribute1
            )                       order_no
     ,DECODE( TRIM(a.sf_text)
             ,'GRAND TOTAL:'
             ,TO_NUMBER(NULL)
             ,NVL(a.subtotal ,0) 
            )                       subtotal
     ,DECODE(
              TRIM(a.sf_text)
             ,'GRAND TOTAL:'
             ,TO_NUMBER(NULL)
             ,NVL(a.delivery ,0) 
            )                       delivery
     ,DECODE(
              TRIM(a.sf_text)
             ,'GRAND TOTAL:'
             ,TO_NUMBER(NULL)
             ,NVL(a.discounts ,0) 
            )                       discounts
     ,DECODE(
              TRIM(a.sf_text)
             ,'GRAND TOTAL:'
             ,TO_NUMBER(NULL)
             ,NVL(a.tax ,0) 
            )                       tax
     ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(a.attribute3),0)
                  +NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(a.attribute3),0) FEE
	 ,NVL(a.total ,0)               total 
     ,NVL(a.page_break ,'N')        pg_break
	 ,DECODE(a.line_type,'SOFTHDR_TOTAL','Y','BILL_TO_TOTAL','Y','N' ) SHOW_LINE
FROM  xx_ar_cbi_rprn_rows a
WHERE request_id      =:p_request_id
  AND cons_inv_id     =:cbi_id
  AND line_type IN ('SOFTHDR_TOTAL' ,'BILL_TO_TOTAL' ,'GRAND_TOTAL')  
ORDER BY line_seq 
]]>
</sqlStatement>
<sqlStatement name="Q_CONS_MSG_BCC">  <!--Added this sqlStatement for NAIT-80452-->
       <![CDATA[
          SELECT xx_ar_reprint_summbill.get_cons_msg_bcc(:cbi_id,:p_cust_doc_id,:cust_account_id,:billing_number) CONS_MSG_BCC 		  
		  FROM DUAL
       ]]>
</sqlStatement>
</dataQuery>
<dataTrigger name="beforeReportTrigger" source="xx_ar_reprint_summbill.beforereport"/>
<dataStructure>
<group name="G_BILL_TO_SITES" source="Q_BILL_TO_SITES">
<element name="DOC_DESCRIPTION" value="DOC_DESCRIPTION" />
<element name="BILL_TO_COUNTRY" value="BILL_TO_COUNTRY" />
<element name="POSTAL_CODE" value="BILL_TO_POSTAL_CODE" />
<element name="RETURN_ADDRESS" value="RETURN_ADDRESS" />
<element name="REMIT_TO" value="REMIT_TO" />
<element name="BILL_TO" value="BILL_TO" />
<element name="MAIL_TO_ATTN" value="MAIL_TO_ATTN" />       <!--Added for R1.4 Defect # 2424 (CR 547)-->
<element name="TAX_ID_DESC" value="TAX_ID_DESC" />
<element name="TAX_ID" value="TAX_ID" />
<element name="ACCOUNT_CONTACT" value="ACCOUNT_CONTACT" />
<element name="ORDER_CONTACT" value="ORDER_CONTACT" />
<element name="CUSTOMER_NAME" value="CUSTOMER_NAME" />
<element name="ACCOUNT_NUMBER" value="ACCOUNT_NUMBER" />
<element name="BILLING_ID" value="BILLING_ID" />
<element name="SPL_HANDLING" value="SPL_HANDLING" />
<element name="COMMENTS" value="SPL_HANDLING_COMMENTS" />
<element name="DOC_ID" value="DOC_ID" />                 <!--Added for R1.2 Defect # 1237 (CR 621)-->
<group name="G_CONS_BILLS" source="Q_CONSOLIDATED_BILLS">
<element name="SCANLINE" value="SCAN_LINE" />
<element name="BILLING_NUMBER" value="BILLING_NUMBER" />
<element name="TERMS" value="TERMS" />
<element name="CURRENCY" value="CURRENCY" />
<element name="BILL_FROM_DATE" value="BILL_FROM_DATE" />
<element name="BILL_TO_DATE" value="BILL_TO_DATE" />
<element name="PAYMENT_DUE" value="PAYMENT_DUE" />
<element name="DOC_TITLE" value="DOC_TITLE" />
<element name="SFHDR1" value="SFHDR1" />
<element name="SFHDR2" value="SFHDR2" />
<element name="SFHDR3" value="SFHDR3" />
<element name="SFHDR4" value="SFHDR4" />
<element name="SFHDR5" value="SFHDR5" />
<element name="CBI_EXTAMT_PLUS_DELVY" value="CBI_EXTAMT_PLUS_DELVY" />
<element name="CBI_DISCOUNTS" value="CBI_DISCOUNTS" />
<element name="CBI_TAX" value="CBI_TAX" />
<element name = "CBI_FEE_AMT" value = "CBI_FEE_AMT" />
<element name="CBI_AMOUNT_DUE" value="CBI_AMOUNT_DUE" />
<element name="NO_PAYMENT_TEXT" value="NO_PAYMENT_TEXT" />   <!--Added for R1.2 Defect # 1210 (CR 466)-->
<element name="DISCOUNT_INFO" value="DISCOUNT_INFO" />   <!--Added for Defect # 36434 -->
<element name = "FEE_OPTION"  value = "FEE_OPTION"/>
<group name="G_SUMMARIZE" source="Q_ONE">
<element name="SOFT_DATA" value="SOFT_DATA" />
<element name="ORDER_NO" value="ORDER_NO" />
<element name="SUBTOTAL" value="SUBTOTAL" />
<element name="DELIVERY" value="DELIVERY" />
<element name="DISCOUNTS" value="DISCOUNTS" />
<element name="TAX" value="TAX" />
<element name = "FEE" value = "FEE" />
<element name="TOTAL" value="TOTAL" />
<element name="PG_BREAK" value="PG_BREAK" />
<element name = "SHOW_LINE"  value = "SHOW_LINE" />
</group>
<group name = "G_CONS_MSG_BCC" source = "Q_CONS_MSG_BCC">   <!--Added this group for NAIT-80452-->
<element name = "CONS_MSG_BCC" value = "CONS_MSG_BCC"/>
</group>
</group>
</group>
</dataStructure>
<dataTrigger name="afterReportTrigger" source="xx_ar_reprint_summbill.afterreport"/>
</dataTemplate>