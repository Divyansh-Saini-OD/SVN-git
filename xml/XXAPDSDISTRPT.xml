<?xml version="1.0" encoding="UTF-8"?>
<dataTemplate name="XXAPDSDISTRPT" defaultPackage="XX_AP_DSDISTRPT_PKG" dataSourceRef="ORCL" version="1.0">
   <parameters>
      <parameter name="P_VENDOR_SITE_ID" dataType="string" include_in_output="true" />
      <parameter name="P_PERIOD_FROM" dataType="string" include_in_output="true" />
      <parameter name="P_PERIOD_TO" dataType="string" include_in_output="true" />
	  <parameter name="P_GL_DATE_FROM" dataType="string" include_in_output="true" />
	  <parameter name="P_GL_DATE_TO" dataType="string" include_in_output="true" />
   </parameters>
   <dataQuery>
      <sqlStatement name="Q_EMAIL_DETAILS"><![CDATA[SELECT :G_SMTP_SERVER SMTP_SERVER
	, :G_EMAIL_SUBJECT EMAIL_SUBJECT
	, :G_EMAIL_CONTENT EMAIL_CONTENT
	, :G_DISTRIBUTION_LIST DISTRIBUTION_LIST
	, TO_CHAR(SYSDATE, 'DD-MON-RR HH24:MI') REPORTING_DATE
	, TO_CHAR(fnd_date.canonical_to_date(:P_GL_DATE_FROM), 'DD-MON-RRRR') GL_DATE_FROM
	, TO_CHAR(fnd_date.canonical_to_date(:P_GL_DATE_TO), 'DD-MON-RRRR') GL_DATE_TO
FROM dual]]></sqlStatement>
      <sqlStatement name="Q_DROPSHIP_DIST"><![CDATA[SELECT
	/*+ LEADING(AIA AIDA) FULL(AIA) PARALLEL(AIA,8) PARALLEL(AIDA,8) NO_MERGE */
	aps.vendor_name supplier_name
	, assa.vendor_site_code site_number
	, pha.segment1 po_number
	, (
		SELECT SUM(ROUND(pla.unit_price * pla.quantity, 2))
		FROM po_lines_all pla
		WHERE pha.po_header_id = pla.po_header_id
		) po_amount
	, aia.invoice_num invoice_number
    , TO_CHAR(aida.accounting_date, 'DD-MON-RR') gl_date
    , TO_CHAR(aia.invoice_date, 'DD-MON-RR') invoice_date
	, aia.invoice_amount invoice_total
	, SUM(CASE WHEN gcc.segment3 = '22003000' THEN aida.amount ELSE 0 END) dropship_liability_sum
	, SUM(CASE WHEN gcc.segment3 = '51105000' THEN aida.amount ELSE 0 END) dropship_cogs_sum
	, SUM(CASE WHEN gcc.segment3 = '51101000' THEN aida.amount ELSE 0 END) freight_sum
	, aia.invoice_amount - SUM(CASE WHEN gcc.segment3 = '22003000' THEN aida.amount ELSE 0 END) variance
FROM ap_invoices_all aia
	, ap_invoice_distributions_all aida
	, gl_code_combinations gcc
	, po_headers_all pha
	, ap_suppliers aps
	, ap_supplier_sites_all assa
	&p_from_clause
WHERE aia.invoice_id = aida.invoice_id
	AND aia.org_id = aida.org_id
	AND aia.quick_po_header_id = pha.po_header_id
	AND aia.vendor_id = aps.vendor_id
	AND aia.vendor_id = assa.vendor_id
	AND aia.vendor_site_id = assa.vendor_site_id
	AND aps.vendor_id = assa.vendor_id
	AND aida.dist_code_combination_id = gcc.code_combination_id
	AND aida.posted_flag = 'Y'
	AND aia.creation_date >= to_date('07-APR-18 00:00:00', 'DD-MON-RR HH24:MI:SS')
	AND aia.source = 'US_OD_DROPSHIP'
	AND NOT EXISTS (
		SELECT 1
		FROM ap_invoice_distributions_all aida1
		WHERE aia.invoice_id = aida1.invoice_id
			AND aia.org_id = aida1.org_id
			AND aida1.posted_flag = 'N'
		)
	&p_where_clause
GROUP BY aps.vendor_name
	, assa.vendor_site_code
	, pha.segment1
	, pha.po_header_id
	, aia.invoice_num
    , aida.accounting_date
    , aia.invoice_date
	, aia.invoice_amount
HAVING ABS(aia.invoice_amount - SUM(CASE WHEN gcc.segment3 = '22003000' THEN aida.amount ELSE 0 END)) >= 100
	AND SUM(CASE WHEN gcc.segment3 = '22003000' THEN 1 ELSE 0 END) > 0
ORDER BY ABS(variance) DESC
	, supplier_name
	, site_number
	, invoice_number]]></sqlStatement>
   </dataQuery>
   <dataTrigger name="beforeReport" source="XX_AP_DSDISTRPT_PKG.beforeReport()" />
   <dataStructure>
      <group name="G_EMAIL_DETAILS" source="Q_EMAIL_DETAILS">
         <element name="SMTP_SERVER" dataType="VARCHAR2" value="SMTP_SERVER" />
         <element name="EMAIL_SUBJECT" dataType="VARCHAR2" value="EMAIL_SUBJECT" />
         <element name="EMAIL_CONTENT" dataType="VARCHAR2" value="EMAIL_CONTENT" />
         <element name="DISTRIBUTION_LIST" dataType="VARCHAR2" value="DISTRIBUTION_LIST" />
		 <element name="REPORTING_DATE" dataType="VARCHAR2" value="REPORTING_DATE" />
		 <element name="GL_DATE_FROM" dataType="VARCHAR2" value="GL_DATE_FROM" />
		 <element name="GL_DATE_TO" dataType="VARCHAR2" value="GL_DATE_TO" />
      </group>
      <group name="G_DROPSHIP_DIST" source="Q_DROPSHIP_DIST">
         <element name="SUPPLIER_NAME" dataType="VARCHAR2" value="SUPPLIER_NAME" />
         <element name="SITE_NUMBER" dataType="VARCHAR2" value="SITE_NUMBER" />
         <element name="PO_NUMBER" dataType="VARCHAR2" value="PO_NUMBER" />
         <element name="PO_AMOUNT" dataType="NUMBER" value="PO_AMOUNT" />
         <element name="INVOICE_NUMBER" dataType="VARCHAR2" value="INVOICE_NUMBER" />
         <element name="GL_DATE" dataType="VARCHAR2" value="GL_DATE" />
         <element name="INVOICE_DATE" dataType="VARCHAR2" value="INVOICE_DATE" />
         <element name="INVOICE_TOTAL" dataType="NUMBER" value="INVOICE_TOTAL" />
         <element name="DROPSHIP_LIABILITY_SUM" dataType="NUMBER" value="DROPSHIP_LIABILITY_SUM" />
         <element name="DROPSHIP_COGS_SUM" dataType="NUMBER" value="DROPSHIP_COGS_SUM" />
         <element name="FREIGHT_SUM" dataType="NUMBER" value="FREIGHT_SUM" />
         <element name="VARIANCE" dataType="NUMBER" value="VARIANCE" />
      </group>
      <element name="R_TOT_INVOICE_TOTAL" function="sum" dataType="NUMBER" value="G_DROPSHIP_DIST.INVOICE_TOTAL" />
      <element name="R_TOT_DROPSHIP_LIABILITY_SUM" function="sum" dataType="NUMBER" value="G_DROPSHIP_DIST.DROPSHIP_LIABILITY_SUM" />
      <element name="R_TOT_DROPSHIP_COGS_SUM" function="sum" dataType="NUMBER" value="G_DROPSHIP_DIST.DROPSHIP_COGS_SUM" />
      <element name="R_TOT_FREIGHT_SUM" function="sum" dataType="NUMBER" value="G_DROPSHIP_DIST.FREIGHT_SUM" />
      <element name="R_TOT_VARIANCE" function="sum" dataType="NUMBER" value="G_DROPSHIP_DIST.VARIANCE" />
	  <element name="R_RECORD_COUNT" function="count" dataType="NUMBER" value="G_DROPSHIP_DIST.INVOICE_NUMBER" />
   </dataStructure>
   <dataTrigger name="afterReport" source="XX_AP_DSDISTRPT_PKG.afterReport()" />
</dataTemplate>