<?xml version="1.0" encoding="WINDOWS-1252"?>
<dataTemplate name="XXAREBLCONS" description="OD: AR EBL Consolidated ePDF Render Child - One" defaultPackage="XX_AR_EBL_CONS_ePDF_PKG" Version="1.0">
  <properties>
    <property name="scalable_mode" value="on"/>
    <property name="rtf-output-default-font">Arial:8</property>
  </properties>
  <parameters>
    <!-- <parameter name = "P_SUMM_BILL_NUM"      datatype = "character"/>
 <parameter name = "P_SUMM_BILL_NUM_TO"   datatype = "character"/>
 <parameter name = "P_CUST_ACCOUNT_ID"    datatype = "number"/>
 <parameter name = "P_MBS_DOCUMENT_ID"    datatype = "number"/>
 <parameter name = "P_MBS_EXTENSION_ID"   datatype = "number"/>
 <parameter name = "P_SPL_HANDLING_FLAG"  datatype = "character"/>
 <parameter name = "P_REQUEST_ID"         datatype = "number"/>
 <parameter name = "P_ORIGIN"             datatype = "character"/>
 <parameter name = "P_DOC_DETAIL"         datatype = "character"/>
 <parameter name = "P_AS_OF_DATE1"        datatype = "character"/>
 <parameter name = "P_SEND_TO"            datatype = "character"/>
 <parameter name = "P_CUST_DOC_ID"        dataType = "number"/>
 <parameter name = "P_INFOCOPY_FLAG"      dataType = "character"/>
 <parameter name = "P_VIRTUAL_BILL_FLAG"  dataType = "character"/>
 <parameter name = "P_VIRTUAL_BILL_NUM"   dataType = "character"/>
 <parameter name = "P_MULTIPLE_BILL"      dataType = "character"/>
 <parameter name = "P_DATE_FROM"          dataType = "character"/>
 <parameter name = "P_DATE_TO"            dataType = "character"/>
 <parameter name = "P_EMAIL_OPTION"       dataType = "character"/>
 <parameter name = "P_EMAIL_ADDRESS"      dataType = "character"/>
 <parameter name = "DataTemplateCode"     dataType = "character"/>-->
    <parameter name = "P_BATCH_ID"           dataType = "number"/>
    <parameter name = "P_CM_TEXT1"           datatype = "character"/>
    <parameter name = "P_CM_TEXT2"           datatype = "character"/>
    <parameter name = "P_GIFT_CARD_TEXT1"    dataType = "character"/>
    <parameter name = "P_GIFT_CARD_TEXT2"    dataType = "character"/>
    <parameter name = "P_GIFT_CARD_TEXT3"    dataType = "character"/>
  </parameters>
  <dataQuery>
    <sqlStatement name="Q_FILE_ID">
      <![CDATA[
         SELECT DISTINCT XAECHM.file_id                         file_id
               ,SUBSTR( file_name
                       ,1,INSTR(XAECHM.file_name,'.PDF',1)-1
                       )||'_'||XAECHM.file_id||'.PDF'           file_name
         FROM   xx_ar_ebl_cons_hdr_main      XAECHM
         WHERE  XAECHM.batch_id              = :p_batch_id
      ]]>
    </sqlStatement>
    <sqlStatement name="Q_BILL_TO_SITES">
      <![CDATA[
         SELECT  DISTINCT XAECTS.bill_to_address                                                   bill_to
                ,XAECHM.mail_to_attention                                                          mail_to_attention
                ,XAECTS.remit_to_address                                                           remit_to
                ,XX_AR_EBL_CONS_ePDF_PKG.RETURN_ADDRESS()                                          return_address
                ,NVL(XAECHM.us_federal_id,XAECHM.canadian_tax_number)                              tax_id
                ,DECODE ( XAECHM.invoice_currency_code
                         ,'USD', 'FEDERAL ID #:'
                         ,'CAD', 'GST REGISTRATION #:'
                         )                                                                         tax_id_desc
                ,XAECHM.oracle_account_number                                                      billing_id
                ,XAECHM.aops_account_number                                                        account_number
                ,XAECHM.bill_to_name                                                               customer_name
                ,XAECHM.account_contact                                                            account_contact
                ,XAECHM.order_contact                                                              order_contact
                ,UPPER(XAECHM.bill_to_country)                                                     bill_to_country
                ,XAECHM.bill_to_zip                                                                bill_to_postal_code
                ,XAECHM.mbs_doc_id                                                                 doc_id
                ,XAECHM.invoice_currency_code                                                      currency_code
                ,SUBSTR(XAECHM.payment_term_description ,1 ,15)                                    terms
                ,XAECHM.cust_account_id                                                            cust_account_id
                ,XAECHM.bill_to_site_use_id                                                        bill_to_id
                ,XAECHM.parent_cust_doc_id                                                         parent_cust_doc_id
				--,XAECHM.cust_doc_id                                                                cust_doc_id   --Added for NAIT-65564    
         FROM     xx_ar_ebl_cons_trx_stg       XAECTS
                 ,xx_ar_ebl_cons_hdr_main      XAECHM
         WHERE   XAECTS.request_id                   = XAECHM.batch_id
         AND     XAECHM.batch_id                     = :p_batch_id
         AND     XAECTS.inv_type                     NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
         AND     XAECTS.bill_to_site_use_id          = XAECHM.bill_to_site_use_id
         AND     XAECHM.file_id                      = :file_id
         AND     XAECHM.cust_doc_id                  = XAECTS.cust_doc_id
         AND     XAECHM.customer_trx_id              = XAECTS.customer_trx_id
         AND     XAECHM.cons_inv_id                  = XAECTS.cons_inv_id
       ]]>
    </sqlStatement>
    <sqlStatement name="Q_CONSOLIDATED_BILLS">
      <![CDATA[
		  with xx_disc_info AS (																			--Added for defect 37807
		  SELECT 	MAX(XAECTS.customer_trx_id) customer_trx_id, XAECTS.cons_inv_id
		  	FROM     xx_ar_ebl_cons_trx_stg       XAECTS
					,xx_ar_ebl_cons_hdr_main      XAECHM
					,ra_customer_trx			  RCT
		  		WHERE    XAECTS.request_id                   = XAECHM.batch_id
		  		AND      XAECHM.batch_id                     = :p_batch_id
		  		AND      XAECTS.inv_type                     = 'Invoice'
		  		AND      XAECTS.bill_to_site_use_id          = XAECHM.bill_to_site_use_id
		  		AND      XAECHM.bill_to_site_use_id          = :bill_to_id
		  		AND      XAECHM.parent_cust_doc_id           = :parent_cust_doc_id
		  		AND      XAECHM.cust_doc_id                  = XAECTS.cust_doc_id
		  		AND      XAECHM.customer_trx_id              = XAECTS.customer_trx_id
		  		AND      XAECHM.cons_inv_id                  = XAECTS.cons_inv_id
		  		AND      XAECHM.file_id                      = :file_id
				AND		 XAECTS.customer_trx_id				 = RCT.customer_trx_id
				AND		 RCT.billing_date					 = (SELECT 	MAX(RCT1.billing_date)
																 FROM     xx_ar_ebl_cons_trx_stg       XAECTS1
																		 ,xx_ar_ebl_cons_hdr_main      XAECHM1
																		 ,ra_customer_trx			   RCT1
																 WHERE    XAECTS1.request_id                   = XAECHM1.batch_id
																 AND      XAECHM1.batch_id                     = :p_batch_id
																 AND      XAECTS1.inv_type                     = 'Invoice'
																 AND      XAECTS1.bill_to_site_use_id          = XAECHM1.bill_to_site_use_id
																 AND      XAECHM1.bill_to_site_use_id          = :bill_to_id
																 AND      XAECHM1.parent_cust_doc_id           = :parent_cust_doc_id
																 AND      XAECHM1.cust_doc_id                  = XAECTS1.cust_doc_id
																 AND      XAECHM1.customer_trx_id              = XAECTS1.customer_trx_id
																 AND      XAECHM1.cons_inv_id                  = XAECTS1.cons_inv_id
																 AND      XAECHM1.file_id                      = :file_id
																 AND	  XAECTS1.customer_trx_id		       = RCT1.customer_trx_id)
				group by XAECTS.cons_inv_id
		  )
         SELECT   XAECTS.cons_inv_id                                         cbi_id
                 ,XAECHM.consolidated_bill_number                            billing_number
                 ,:currency_code                                             currency
                 ,TO_CHAR(XAECHM.bill_from_date,'MM/DD/YYYY')                bill_from_date
                 ,TO_CHAR(XAECHM.bill_to_date,'MM/DD/YYYY')                  bill_to_date
                 ,DECODE( XAECHM.document_type
                          ,'Paydoc',TO_CHAR(XAECHM.bill_due_date,'MM/DD/YYYY')
                          )                                                  payment_due
                 ,:terms                                                     terms
                 ,SUM(XAECHM.sku_lines_subtotal
                      + XAECHM.total_coupon_amount
                      + XAECHM.total_bulk_amount
                      + XAECHM.total_freight_amount
                      )                                                      cbi_extamt_plus_delvy
                 ,SUM(XAECHM.total_miscellaneous_amount
                      + XAECHM.total_association_discount
                      + XAECHM.total_tiered_discount_amount
                      - XAECHM.total_gift_card_amount
                      )                                                      cbi_discounts
                 ,SUM(XAECHM.total_us_tax_amount
                      + XAECHM.total_gst_amount
                      + XAECHM.total_pst_amount
                      + XAECHM.total_qst_amount
                      )                                                      cbi_tax
			     ,MAX( NVL(( SELECT SUM(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(xx.customer_trx_id) +
				                   XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(xx.customer_trx_id))
                          FROM xx_ar_ebl_cons_hdr_main xx
						 WHERE cons_inv_id = XAECHM.cons_inv_id
						   AND cust_doc_id = XAECHM.cust_doc_id
						   AND batch_id    = :p_batch_id
						   AND file_id     = :file_id),0) )           cbi_fee_amt	  
                 ,SUM(XAECHM.original_invoice_amount
                      - XAECHM.total_gift_card_amount
                      )                                                      cbi_amount_due
                 ,SUM(XAECHM.original_invoice_amount
                      - XAECHM.total_gift_card_amount) *100                  total_amount
                 ,DECODE( XAECHM.document_type
                         ,'Infocopy','**DO NOT PAY**'
                         ,'Paydoc',DECODE(SIGN(SUM(XAECHM.original_invoice_amount - XAECHM.total_gift_card_amount)
                                          )
                                     ,1,'**BAL DUE**'
                                     ,'**DO NOT PAY**'
                                     )
                         )                                                   no_payment_text
                ,DECODE( XAECHM.document_type
                        ,'Infocopy','Informational Copy of Consolidated Bill'
                        ,'Paydoc','Original Consolidated Bill'
                        )                                                    doc_title
                ,XAECTS.cust_doc_id                                          cust_doc_id
                ,XAECHM.document_type                                        document_type
				--,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(XAECHM.customer_trx_id),NULL) discount_info -- Added for Defect 36437	--Commented for defect #37640
				--,NULL														DISCOUNT_INFO 		--Added for Defect 37640       --Commented for Defect 37807
				,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL) DISCOUNT_INFO     --Added for Defect 37807
				,MAX((  SELECT fee_option 
						FROM xx_cdh_cust_acct_ext_b
					   WHERE cust_account_id = XAECHM.cust_account_id
						 AND ATTR_GROUP_ID = 166
						 AND N_EXT_ATTR1 = XAECHM.MBS_DOC_ID
						 AND N_EXT_ATTR2 = XAECHM.CUST_DOC_ID 
						 AND rownum =1)) FEE_OPTION
         FROM     xx_ar_ebl_cons_trx_stg       XAECTS
                 ,xx_ar_ebl_cons_hdr_main      XAECHM
				 ,xx_disc_info													 		--Added for Defect 37807
         WHERE    XAECTS.request_id                   = XAECHM.batch_id
         AND      XAECHM.batch_id                     = :p_batch_id
         AND      XAECTS.inv_type                     NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
         AND      XAECTS.bill_to_site_use_id          = XAECHM.bill_to_site_use_id
         AND      XAECHM.bill_to_site_use_id          = :bill_to_id
         AND      XAECHM.parent_cust_doc_id           = :parent_cust_doc_id
         AND      XAECHM.cust_doc_id                  = XAECTS.cust_doc_id
         AND      XAECHM.customer_trx_id              = XAECTS.customer_trx_id
         AND      XAECHM.cons_inv_id                  = XAECTS.cons_inv_id
		 AND	  XAECHM.cons_inv_id				  = xx_disc_info.cons_inv_id 		--Added for Defect 37807
         AND      XAECHM.file_id                      = :file_id
         GROUP BY XAECTS.cons_inv_id
                 ,XAECHM.consolidated_bill_number
                 ,:currency_code
                 ,XAECHM.bill_from_date
                 ,XAECHM.bill_to_date
                 ,DECODE( XAECHM.document_type
                          ,'Paydoc',TO_CHAR(XAECHM.bill_due_date,'MM/DD/YYYY')
                          )
                 ,XAECHM.document_type
                 ,:terms
                 ,DECODE( XAECHM.document_type
                         ,'Infocopy','Informational Copy of Consolidated Bill'
                         ,'Paydoc','Original Consolidated Bill'
                         )
                 ,XAECTS.cust_doc_id
                 ,XAECHM.document_type
				 --,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(XAECHM.customer_trx_id),NULL)  -- Added for Defect 36437	--Commented for defect #37640
				 ,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL)     -- Added for Defect 37807
         ORDER BY XAECTS.cons_inv_id
       ]]>
    </sqlStatement>
    <sqlStatement name="Q_SCAN_LINE">
       <![CDATA[
          SELECT xx_ar_ebl_common_util_pkg.xx_fin_check_digit( :account_number
                                                              ,:cbi_id
                                                              ,:total_amount
                                                              ) scan_line
          FROM   dual
          WHERE  :document_type  = 'Paydoc'
       ]]>
    </sqlStatement>
    <sqlStatement name="Q_ONE">
      <![CDATA[
         SELECT  XAECTRS.sf_text                soft_data
                ,DECODE( TRIM(XAECTRS.sf_text)
                        ,'GRAND TOTAL:',TO_CHAR(NULL)
                        ,XAECTRS.attribute1
                        )                       order_no
                ,DECODE( TRIM(XAECTRS.sf_text)
                        ,'GRAND TOTAL:',TO_NUMBER(NULL)
                        ,NVL(XAECTRS.subtotal ,0)
                        )                       subtotal
                ,DECODE( TRIM(XAECTRS.sf_text)
                        ,'GRAND TOTAL:',TO_NUMBER(NULL)
                        ,NVL(XAECTRS.delivery ,0)
                        )                       delivery
                ,DECODE( TRIM(XAECTRS.sf_text)
                        ,'GRAND TOTAL:',TO_NUMBER(NULL)
                        ,NVL(XAECTRS.discounts ,0)
                       )                       discounts
                ,DECODE( TRIM(XAECTRS.sf_text)
                        ,'GRAND TOTAL:',TO_NUMBER(NULL)
                        ,NVL(XAECTRS.tax ,0)
                        )                       tax
				  ,XX_AR_EBL_COMMON_UTIL_PKG.get_softhdr_amount(XAECTRS.line_type,XAECTRS.sf_text,XAECTRS.cons_inv_id,XAECTRS.cust_doc_id,XAECTRS.request_id,XAECTRS.attribute3) FEE
                ,NVL(XAECTRS.total ,0)          total
                ,NVL(XAECTRS.page_break ,'N')   pg_break
				,DECODE(XAECTRS.line_type,'SOFTHDR_TOTAL','Y','BILL_TO_TOTAL','Y','N' ) SHOW_LINE
         FROM    xx_ar_ebl_cons_trx_rows_stg XAECTRS
         WHERE   XAECTRS.request_id           = :p_batch_id
         AND     XAECTRS.cons_inv_id          = :cbi_id
         AND     XAECTRS.bill_to_site_use_id  = :bill_to_id
         AND     XAECTRS.cust_doc_id          = :cust_doc_id
         AND     XAECTRS.line_type            IN ('SOFTHDR_TOTAL' ,'BILL_TO_TOTAL' ,'GRAND_TOTAL')
         ORDER BY XAECTRS.line_seq
      ]]>
    </sqlStatement>
	<sqlStatement name="Q_CONS_MSG_BCC">  <!--Added this sqlStatement for NAIT-65564-->
       <![CDATA[
          SELECT xx_ar_ebl_common_util_pkg.get_cons_msg_bcc(:cust_doc_id,:cust_account_id,:billing_number) CONS_MSG_BCC 
		  FROM DUAL
       ]]>
    </sqlStatement>
  </dataQuery>
  <dataTrigger name="beforeReportTrigger" source="xx_ar_ebl_cons_epdf_pkg.beforereport"/>
    <dataStructure>
      <group name = "G_FILE_ID" source = "Q_FILE_ID">
        <element name = "FILE_ID"             value = "FILE_ID"/>
        <element name = "FILE_NAME"           value = "FILE_NAME"/>
        <group name = "G_BILL_TO_SITES"           source = "Q_BILL_TO_SITES">
          <element name = "DOC_DESCRIPTION"         value = "DOC_DESCRIPTION" />
          <element name = "BILL_TO_COUNTRY"         value = "BILL_TO_COUNTRY" />
          <element name = "POSTAL_CODE"             value = "BILL_TO_POSTAL_CODE" />
          <element name = "RETURN_ADDRESS"          value = "RETURN_ADDRESS" />
          <element name = "REMIT_TO"                value = "REMIT_TO" />
          <element name = "BILL_TO"                 value = "BILL_TO" />
          <element name = "MAIL_TO_ATTENTION"       value = "MAIL_TO_ATTENTION" />
          <element name = "TAX_ID_DESC"             value = "TAX_ID_DESC" />
          <element name = "TAX_ID"                  value = "TAX_ID" />
          <element name = "ACCOUNT_CONTACT"         value = "ACCOUNT_CONTACT" />
          <element name = "ORDER_CONTACT"           value = "ORDER_CONTACT" />
          <element name = "CUSTOMER_NAME"           value = "CUSTOMER_NAME" />
          <element name = "ACCOUNT_NUMBER"          value = "ACCOUNT_NUMBER" />
          <element name = "BILLING_ID"              value = "BILLING_ID" />
          <element name = "DOC_ID"                  value = "DOC_ID" />
          <group name = "G_CONS_BILLS"                source = "Q_CONSOLIDATED_BILLS">
            <element name = "BILLING_NUMBER"              value = "BILLING_NUMBER" />
            <element name = "TERMS"                       value = "TERMS" />
            <element name = "CURRENCY"                    value = "CURRENCY" />
            <element name = "BILL_FROM_DATE"              value = "BILL_FROM_DATE" />
            <element name = "BILL_TO_DATE"                value = "BILL_TO_DATE" />
            <element name = "PAYMENT_DUE"                 value = "PAYMENT_DUE" />
            <element name = "DOC_TITLE"                   value = "DOC_TITLE" />
            <element name = "SFHDR1"                      value = "SFHDR1" />
            <element name = "SFHDR2"                      value = "SFHDR2" />
            <element name = "SFHDR3"                      value = "SFHDR3" />
            <element name = "SFHDR4"                      value = "SFHDR4" />
            <element name = "SFHDR5"                      value = "SFHDR5" />
            <element name = "CBI_EXTAMT_PLUS_DELVY"       value = "CBI_EXTAMT_PLUS_DELVY" />
            <element name = "CBI_DISCOUNTS"               value = "CBI_DISCOUNTS" />
            <element name = "CBI_TAX"                     value = "CBI_TAX" />
			<element name = "CBI_FEE_AMT"                 value = "CBI_FEE_AMT" />
            <element name = "CBI_AMOUNT_DUE"              value = "CBI_AMOUNT_DUE" />
            <element name = "NO_PAYMENT_TEXT"             value = "NO_PAYMENT_TEXT"/>
            <element name = "DOCUMENT_TYPE"               value = "DOCUMENT_TYPE"/>
			<element name = "DISCOUNT_INFO"               value = "DISCOUNT_INFO"/>     <!--Added for Defect # 36437-->
		    <element name = "FEE_OPTION"               value = "FEE_OPTION"/>
            <group name = "G_SUMMARIZE"                     source="Q_ONE">
              <element name = "SOFT_DATA"                       value = "SOFT_DATA" />
              <element name = "ORDER_NO"                        value = "ORDER_NO" />
              <element name = "SUBTOTAL"                        value = "SUBTOTAL" />
              <element name = "DELIVERY"                        value = "DELIVERY" />
              <element name = "DISCOUNTS"                       value = "DISCOUNTS" />
              <element name = "TAX"                             value = "TAX" />
			  <element name = "FEE"                             value = "FEE" />
              <element name = "TOTAL"                           value = "TOTAL" />
              <element name = "PG_BREAK"                        value = "PG_BREAK" />
              <element name = "SHOW_LINE"                       value = "SHOW_LINE" />
            </group>
            <group name = "G_SCAN_LINE"                     source = "Q_SCAN_LINE">
              <element name = "SCANLINE"                        value = "SCAN_LINE"/>
            </group>
			<group name = "G_CONS_MSG_BCC"                  source = "Q_CONS_MSG_BCC">   <!--Added this group for NAIT-65564-->
              <element name = "CONS_MSG_BCC"                    value = "CONS_MSG_BCC"/>
            </group>
          </group>
        </group>
      </group>
    </dataStructure>
  <dataTrigger name="afterReportTrigger" source="xx_ar_ebl_cons_epdf_pkg.afterreport"/>
</dataTemplate>