<?xml version="1.0" encoding="WINDOWS-1252"?>
<dataTemplate name="XXAREBLCONS" description="OD: AR EBL Consolidated ePDF Render Child - Summary" defaultPackage="XX_AR_EBL_CONS_ePDF_PKG" Version="1.0">
  <properties>
    <property name="scalable_mode" value="on"/>
    <property name="rtf-output-default-font">Arial:8</property>
  </properties>
  <parameters>
    <!-- <parameter name = "P_SUMM_BILL_NUM"      datatype = "character"/>
 <parameter name = "P_SUMM_BILL_NUM_TO"   datatype = "character"/>
 <parameter name = "P_CUST_ACCOUNT_ID"    datatype = "number"/>
 <parameter name = "P_MBS_DOCUMENT_ID"    datatype = "number"/>
 <parameter name = "P_MBS_EXTENSION_ID"   datatype = "number"/>
 <parameter name = "P_SPL_HANDLING_FLAG"  datatype = "character"/>
 <parameter name = "P_REQUEST_ID"         datatype = "number"/>
 <parameter name = "P_ORIGIN"             datatype = "character"/>
 <parameter name = "P_DOC_DETAIL"         datatype = "character"/>
 <parameter name = "P_AS_OF_DATE1"        datatype = "character"/>
 <parameter name = "P_SEND_TO"            datatype = "character"/>
 <parameter name = "P_CUST_DOC_ID"        dataType = "number"/>
 <parameter name = "P_INFOCOPY_FLAG"      dataType = "character"/>
 <parameter name = "P_VIRTUAL_BILL_FLAG"  dataType = "character"/>
 <parameter name = "P_VIRTUAL_BILL_NUM"   dataType = "character"/>
 <parameter name = "P_MULTIPLE_BILL"      dataType = "character"/>
 <parameter name = "P_DATE_FROM"          dataType = "character"/>
 <parameter name = "P_DATE_TO"            dataType = "character"/>
 <parameter name = "P_EMAIL_OPTION"       dataType = "character"/>
 <parameter name = "P_EMAIL_ADDRESS"      dataType = "character"/>
 <parameter name = "DataTemplateCode"     dataType = "character"/>-->
    <parameter name = "P_BATCH_ID"           dataType = "number"/>
    <parameter name = "P_CM_TEXT1"           datatype = "character"/>
    <parameter name = "P_CM_TEXT2"           datatype = "character"/>
    <parameter name = "P_GIFT_CARD_TEXT1"    dataType = "character"/>
    <parameter name = "P_GIFT_CARD_TEXT2"    dataType = "character"/>
    <parameter name = "P_GIFT_CARD_TEXT3"    dataType = "character"/>
  </parameters>
  <dataQuery>
    <sqlStatement name="Q_FILE_ID">
      <![CDATA[
         SELECT DISTINCT XAECHM.file_id                         file_id
               ,SUBSTR( file_name
                       ,1,INSTR(XAECHM.file_name,'.PDF',1)-1
                       )||'_'||XAECHM.file_id||'.PDF'           file_name
         FROM   xx_ar_ebl_cons_hdr_main      XAECHM
         WHERE  XAECHM.batch_id              = :p_batch_id
      ]]>
    </sqlStatement>
    <sqlStatement name="Q_BILL_TO_SITES">
      <![CDATA[
         SELECT  DISTINCT XAECTS.bill_to_address                                                   bill_to
                ,XAECHM.mail_to_attention                                                          mail_to_attention
                ,XAECTS.remit_to_address                                                           remit_to
                ,XX_AR_EBL_CONS_ePDF_PKG.RETURN_ADDRESS()                                          return_address
                ,NVL(XAECHM.us_federal_id,XAECHM.canadian_tax_number)                              tax_id
                ,DECODE ( XAECHM.invoice_currency_code
                         ,'USD', 'FEDERAL ID #:'
                         ,'CAD', 'GST REGISTRATION #:'
                         )                                                                         tax_id_desc
                ,XAECHM.oracle_account_number                                                      billing_id
                ,XAECHM.aops_account_number                                                        account_number
                ,XAECHM.bill_to_name                                                               customer_name
                ,XAECHM.account_contact                                                            account_contact
                ,XAECHM.order_contact                                                              order_contact
                ,UPPER(XAECHM.bill_to_country)                                                     bill_to_country
                ,XAECHM.bill_to_zip                                                                bill_to_postal_code
                ,XAECHM.mbs_doc_id                                                                 doc_id
                ,XAECHM.invoice_currency_code                                                      currency_code
                ,SUBSTR(XAECHM.payment_term_description ,1 ,15)                                    terms
                ,XAECHM.cust_account_id                                                            cust_account_id
                ,XAECHM.bill_to_site_use_id                                                        bill_to_id
                ,XAECHM.parent_cust_doc_id                                                         parent_cust_doc_id
         FROM    xx_ar_ebl_cons_trx_stg       XAECTS
                ,xx_ar_ebl_cons_hdr_main      XAECHM
         WHERE   XAECTS.request_id                   = XAECHM.batch_id
         AND     XAECHM.batch_id                     = :p_batch_id
         AND     XAECTS.inv_type                     NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
         AND     XAECTS.bill_to_site_use_id          = XAECHM.bill_to_site_use_id
         AND     XAECHM.file_id                      = :file_id
         AND     XAECHM.cust_doc_id                  = XAECTS.cust_doc_id
         AND     XAECHM.customer_trx_id              = XAECTS.customer_trx_id
         AND     XAECHM.cons_inv_id                  = XAECTS.cons_inv_id
         ]]>
    </sqlStatement>
    <sqlStatement name="Q_CONSOLIDATED_BILLS">
      <![CDATA[
	     with xx_disc_info AS (																			--Added for defect 37807
		  SELECT 	MAX(XAECTS.customer_trx_id) customer_trx_id, XAECTS.cons_inv_id
		  	FROM     xx_ar_ebl_cons_trx_stg       XAECTS
                ,xx_ar_ebl_cons_hdr_main      XAECHM
                ,ra_customer_trx			  RCT
		  		WHERE    XAECTS.request_id                   = XAECHM.batch_id
		  		AND      XAECHM.batch_id                     = :p_batch_id
		  		AND      XAECTS.inv_type                     = 'Invoice'
		  		AND      XAECTS.bill_to_site_use_id          = XAECHM.bill_to_site_use_id
		  		AND      XAECHM.bill_to_site_use_id          = :bill_to_id
		  		AND      XAECHM.parent_cust_doc_id           = :parent_cust_doc_id
		  		AND      XAECHM.cust_doc_id                  = XAECTS.cust_doc_id
		  		AND      XAECHM.customer_trx_id              = XAECTS.customer_trx_id
		  		AND      XAECHM.cons_inv_id                  = XAECTS.cons_inv_id
		  		AND      XAECHM.file_id                      = :file_id
				AND		 XAECTS.customer_trx_id				 = RCT.customer_trx_id
				AND		 RCT.billing_date					 = (SELECT 	MAX(RCT1.billing_date)
																 FROM     xx_ar_ebl_cons_trx_stg       XAECTS1
																		 ,xx_ar_ebl_cons_hdr_main      XAECHM1
																		 ,ra_customer_trx			   RCT1
																 WHERE    XAECTS1.request_id                   = XAECHM1.batch_id
																 AND      XAECHM1.batch_id                     = :p_batch_id
																 AND      XAECTS1.inv_type                     = 'Invoice'
																 AND      XAECTS1.bill_to_site_use_id          = XAECHM1.bill_to_site_use_id
																 AND      XAECHM1.bill_to_site_use_id          = :bill_to_id
																 AND      XAECHM1.parent_cust_doc_id           = :parent_cust_doc_id
																 AND      XAECHM1.cust_doc_id                  = XAECTS1.cust_doc_id
																 AND      XAECHM1.customer_trx_id              = XAECTS1.customer_trx_id
																 AND      XAECHM1.cons_inv_id                  = XAECTS1.cons_inv_id
																 AND      XAECHM1.file_id                      = :file_id
																 AND	  XAECTS1.customer_trx_id			   = RCT1.customer_trx_id)
				group by XAECTS.cons_inv_id
		  )
         SELECT  XAECHM.cons_inv_id                                         cbi_id
                ,XAECHM.consolidated_bill_number                            billing_number
                ,:currency_code                                             currency
                ,TO_CHAR(XAECHM.bill_from_date,'MM/DD/YYYY')                bill_from_date
                ,TO_CHAR(XAECHM.bill_to_date,'MM/DD/YYYY')                   bill_to_date
                ,DECODE( XAECHM.document_type
                          ,'Paydoc',TO_CHAR(XAECHM.bill_due_date,'MM/DD/YYYY')
                          )                                                 payment_due
                ,:terms                                                     terms
                 ,SUM(XAECHM.sku_lines_subtotal
                      + XAECHM.total_coupon_amount
                      + XAECHM.total_bulk_amount
                      + XAECHM.total_freight_amount
                      )                                                      cbi_extamt_plus_delvy
                 ,SUM(XAECHM.total_miscellaneous_amount
                      + XAECHM.total_association_discount
                      + XAECHM.total_tiered_discount_amount
                      - XAECHM.total_gift_card_amount
                      )                                                      cbi_discounts
                 ,SUM(XAECHM.total_us_tax_amount
                      + XAECHM.total_gst_amount
                      + XAECHM.total_pst_amount
                      + XAECHM.total_qst_amount
                      )                                                      cbi_tax
                 ,SUM(XAECHM.original_invoice_amount
                      - XAECHM.total_gift_card_amount
                      )                                                      cbi_amount_due
			     ,SUM(( SELECT SUM(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XAECHM.customer_trx_id) +
				                   XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XAECHM.customer_trx_id))
                          FROM xx_ar_ebl_cons_hdr_main
						 WHERE cons_inv_id = XAECHM.cons_inv_id) )           cbi_fee_amt
                 ,SUM(XAECHM.original_invoice_amount
                      - XAECHM.total_gift_card_amount) *100                  total_amount
                 ,DECODE( XAECHM.document_type
                         ,'Infocopy','**DO NOT PAY**'
                         ,'Paydoc',DECODE(SIGN(SUM(XAECHM.original_invoice_amount - XAECHM.total_gift_card_amount)
                                          )
                                     ,1,'**BAL DUE**'
                                     ,'**DO NOT PAY**'
                                     )
                         )                                                   no_payment_text
                ,DECODE( XAECHM.document_type
                        ,'Infocopy','Informational Copy of Consolidated Bill'
                        ,'Paydoc','Original Consolidated Bill'
                        )                                                    doc_title
                ,XAECHM.cust_doc_id                                          cust_doc_id
                ,XAECHM.document_type                                        document_type
                ,RPAD(NVL(sfhdr.sfhdr1 ,' ') ,15 ,' ')
                 ||RPAD(NVL(sfhdr.sfhdr2 ,' ') ,15 ,' ')
                 ||RPAD(NVL(sfhdr.sfhdr3 ,' ') ,15 ,' ')
                 ||RPAD(NVL(sfhdr.sfhdr4 ,' ') ,15 ,' ')
                 ||RPAD(NVL(sfhdr.sfhdr5 ,' ') ,15 ,' ')                     soft_header1
                ,RPAD('Sub' ,11 ,' ')
                 ||RPAD('Del' ,9 ,' ')
                 ||RPAD('MiscDisc' ,9 ,' ')
                 ||RPAD('Sales' ,9 ,' ')
                 ||RPAD('Order' ,11 ,' ')                                    soft_header2
                ,RPAD('Total' ,11 ,' ')
                 ||RPAD('CHG' ,9 ,' ')
                 ||RPAD('and.CPNS' ,9 ,' ')
                 ||RPAD('Tax' ,9 ,' ')
                 ||RPAD('Total' ,11 ,' ')                                    soft_header3
                ,REPLACE(SFHDR.sfhdr1 ,':' ,'')                              sfhdr1
                ,REPLACE(SFHDR.sfhdr2 ,':' ,'')                              sfhdr2
                ,REPLACE(SFHDR.sfhdr3 ,':' ,'')                              sfhdr3
                ,REPLACE(SFHDR.sfhdr4 ,':' ,'')                              sfhdr4
                ,REPLACE(SFHDR.sfhdr5 ,':' ,'')                              sfhdr5
				--,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(XAECHM.customer_trx_id),NULL) discount_info -- Added for Defect 36437	--Commented for defect #37640
				,NULL														DISCOUNT_INFO 		--Added for Defect 37640 		--Added for Defect 37640       --Commented for Defect 37807
				,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL) DISCOUNT_INFO     --Added for Defect 37807
                ,MAX((  SELECT fee_option 
						FROM xx_cdh_cust_acct_ext_b
					   WHERE cust_account_id = XAECHM.cust_account_id
						 AND ATTR_GROUP_ID = 166
						 AND N_EXT_ATTR1 = XAECHM.MBS_DOC_ID
						 AND N_EXT_ATTR2 = XAECHM.CUST_DOC_ID 
						 AND rownum =1)) FEE_OPTION
		 FROM    xx_ar_ebl_cons_hdr_main      XAECHM
                ,(SELECT    cons_inv_id
                           ,cust_doc_id
                           ,bill_to_site_use_id
                           ,customer_trx_id
                           ,sfhdr1
                           ,sfhdr2
                           ,sfhdr3
                           ,sfhdr4
                           ,sfhdr5
                  FROM     xx_ar_ebl_cons_trx_stg       XAECTS
                  WHERE    request_id        = :p_batch_id
                  AND      inv_type          NOT IN ('SOFTHDR_TOTALS' ,'BILLTO_TOTALS' ,'GRAND_TOTAL')
                  GROUP BY cons_inv_id
                           ,cust_doc_id
                           ,bill_to_site_use_id
                           ,customer_trx_id
                           ,sfhdr1
                           ,sfhdr2
                           ,sfhdr3
                           ,sfhdr4
                           ,sfhdr5
                  )                            SFHDR
				  ,xx_disc_info													 		--Added for Defect 37807
         WHERE  XAECHM.cons_inv_id             = SFHDR.cons_inv_id
		 AND	XAECHM.cons_inv_id			   = xx_disc_info.cons_inv_id 				--Added for Defect 37807
         AND    XAECHM.cust_doc_id             = SFHDR.cust_doc_id
         AND    XAECHM.parent_cust_doc_id      = :parent_cust_doc_id
         AND    XAECHM.batch_id                = :p_batch_id
         AND    XAECHM.bill_to_site_use_id     = SFHDR.bill_to_site_use_id
         AND    XAECHM.bill_to_site_use_id     = :bill_to_id
         AND    XAECHM.customer_trx_id         = SFHDR.customer_trx_id
         AND    XAECHM.file_id                 = :file_id
         GROUP BY  XAECHM.cons_inv_id
                  ,XAECHM.consolidated_bill_number
                  ,:currency_code
                  ,TO_CHAR(XAECHM.bill_from_date,'MM/DD/YYYY')
                  ,TO_CHAR(XAECHM.bill_to_date,'MM/DD/YYYY')
                  ,DECODE( XAECHM.document_type
                          ,'Paydoc',TO_CHAR(XAECHM.bill_due_date,'MM/DD/YYYY')
                          )
                  ,:terms
                  ,XAECHM.document_type
                  ,DECODE( XAECHM.document_type
                          ,'Infocopy','Informational Copy of Consolidated Bill'
                          ,'Paydoc','Original Consolidated Bill'
                          )
                  ,XAECHM.cust_doc_id
                  ,XAECHM.document_type
                  ,RPAD(NVL(sfhdr.sfhdr1 ,' ') ,15 ,' ')
                   ||RPAD(NVL(sfhdr.sfhdr2 ,' ') ,15 ,' ')
                  ||RPAD(NVL(sfhdr.sfhdr3 ,' ') ,15 ,' ')
                  ||RPAD(NVL(sfhdr.sfhdr4 ,' ') ,15 ,' ')
                  ||RPAD(NVL(sfhdr.sfhdr5 ,' ') ,15 ,' ')
                 ,RPAD('Sub' ,11 ,' ')
                  ||RPAD('Del' ,9 ,' ')
                  ||RPAD('MiscDisc' ,9 ,' ')
                  ||RPAD('Sales' ,9 ,' ')
                  ||RPAD('Order' ,11 ,' ')
                 ,RPAD('Total' ,11 ,' ')
                  ||RPAD('CHG' ,9 ,' ')
                  ||RPAD('and.CPNS' ,9 ,' ')
                  ||RPAD('Tax' ,9 ,' ')
                  ||RPAD('Total' ,11 ,' ')
                 ,REPLACE(SFHDR.sfhdr1 ,':' ,'')
                 ,REPLACE(SFHDR.sfhdr2 ,':' ,'')
                 ,REPLACE(SFHDR.sfhdr3 ,':' ,'')
                 ,REPLACE(SFHDR.sfhdr4 ,':' ,'')
                 ,REPLACE(SFHDR.sfhdr5 ,':' ,'')
				 --,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(XAECHM.customer_trx_id),NULL)  -- Added for Defect 36437	--Commented for defect #37640
				 ,DECODE(XAECHM.document_type,'Paydoc',xx_ar_ebl_common_util_pkg.get_header_discount(xx_disc_info.customer_trx_id),NULL)     -- Added for Defect 37807
         ORDER BY XAECHM.cons_inv_id
      ]]>
    </sqlStatement>
    <sqlStatement name="Q_SCAN_LINE">
       <![CDATA[
          SELECT xx_ar_ebl_common_util_pkg.xx_fin_check_digit( :account_number
                                                              ,:cbi_id
                                                              ,:total_amount
                                                              ) scan_line
          FROM   dual
          WHERE  :document_type  = 'Paydoc'
       ]]>
    </sqlStatement>
    <sqlStatement name="Q_INVOICE_HEADER">
      <![CDATA[
         SELECT   attribute3     trx_id
         FROM     xx_ar_ebl_cons_trx_rows_stg  XAECTRS
         WHERE    XAECTRS.request_id           = :p_batch_id
         AND      XAECTRS.cons_inv_id          = :cbi_id
         AND      XAECTRS.bill_to_site_use_id  = :bill_to_id
         AND      XAECTRS.cust_doc_id          = :cust_doc_id
	 AND      (XAECTRS.line_type not like '%TOTAL') --Added this for defect 30147
	 AND      line_type <> 'TD_REC'
         AND      line_type <> 'SPC_REC' 
         ORDER BY line_seq
       ]]>
    </sqlStatement>
    <sqlStatement name="Q_INVOICE_SPC">
      <![CDATA[
         SELECT  XAECTRS.sf_text   spc_text
         FROM    xx_ar_ebl_cons_trx_rows_stg  XAECTRS
         WHERE   XAECTRS.request_id           = :p_batch_id
         AND     XAECTRS.cons_inv_id          = :cbi_id
         AND     XAECTRS.attribute3           = :trx_id
         AND     XAECTRS.bill_to_site_use_id  = :bill_to_id
         AND     XAECTRS.cust_doc_id          = :cust_doc_id
         AND     XAECTRS.line_type            = 'SPC_REC'
      ]]>
    </sqlStatement>
    <sqlStatement name="Q_INVOICE_INFO">
      <![CDATA[
     SELECT DISTINCT SF_DATA1,
SF_DATA2,
SF_DATA3,
SF_DATA4,
SF_DATA5,
ORDER_NO,
ORDER_DATE,
(SUBTOTAL-FEE_AMT-FEE_HEA_AMT) AS INV_SUBTOTAL,
INV_DELIVERY,
INV_DISCOUNTS,
INV_TAX,
(FEE_AMT + FEE_HEA_AMT) FEE_AMT,
INV_TOTAL,
SF_DATA6,
SF_HDR7,
SF_DATA7,
line_seq 
     FROM 
        ( SELECT    TRIM(XAECTRS.sfdata1)                             sf_data1
                  ,TRIM(XAECTRS.sfdata2)                             sf_data2
                  ,TRIM(XAECTRS.sfdata3)                             sf_data3
                  ,TRIM(XAECTRS.sfdata4)                             sf_data4
                  ,TRIM(XAECTRS.sfdata5)                             sf_data5
                  ,XAECTRS.attribute1                                order_no
                  ,TO_CHAR(TO_DATE(XAECTRS.attribute2),'MM/DD/YYYY') order_date
                  ,NVL(XAECTRS.subtotal ,0) -  NVL(XAECTRS.delivery ,0)                       subtotal
				  ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XAECTRS.attribute3),0) FEE_AMT
                  ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XAECTRS.attribute3),0) FEE_HEA_AMT
				  ,NVL(XAECTRS.delivery ,0)                          inv_delivery
                  ,NVL(XAECTRS.discounts ,0)                         inv_discounts
                  ,NVL(XAECTRS.tax ,0)                               inv_tax
                  ,NVL(XAECTRS.total ,0)
                   - NVL(XAECTRS.delivery ,0)                        inv_total
				   ,TRIM(XAECHM.ordered_by)                    sf_data6
                  ,'SHIP TO:'                                 sf_hdr7
				   ,trim(XAECHM.ship_to_address1||DECODE(trim(XAECHM.ship_to_address2),'','',', '||trim(XAECHM.ship_to_address2))||DECODE(trim(XAECHM.ship_to_address3),'','',', '||trim(XAECHM.ship_to_address3))||DECODE(trim(XAECHM.ship_to_address4),'','',', '||trim(XAECHM.ship_to_address4))||DECODE(trim(XAECHM.ship_to_city),'','',', '||trim(XAECHM.ship_to_city))||DECODE(trim(XAECHM.ship_to_state),'','',', '||trim(XAECHM.ship_to_state))||DECODE(trim(XAECHM.ship_to_zip),'','',' '||trim(XAECHM.ship_to_zip))	
              ) sf_data7
              ,XAECTRS.line_seq
         FROM     xx_ar_ebl_cons_trx_rows_stg  XAECTRS
		          ,xx_ar_ebl_cons_hdr_main    XAECHM
        WHERE    XAECTRS.request_id            = :p_batch_id
         AND      XAECTRS.cons_inv_id           = :cbi_id
         AND      XAECTRS.attribute3            = :trx_id
         AND      XAECTRS.bill_to_site_use_id   = :bill_to_id
         AND      XAECTRS.cust_doc_id           = :cust_doc_id 
	     AND     XAECTRS.line_type             = 'TRX_REC'
        AND    XAECTRS.request_id                   = XAECHM.batch_id(+) 
	    AND    XAECTRS.bill_to_site_use_id          = XAECHM.bill_to_site_use_id(+)
        AND    XAECTRS.cust_doc_id                  = XAECHM.cust_doc_id(+)
        -- AND    XAECTRS.attribute3              = XAECHM.customer_trx_id(+)
		AND XAECTRS.attribute1                    = XAECHM.invoice_number(+)
         AND    XAECTRS.cons_inv_id                  = XAECHM.cons_inv_id(+)
         )
         ORDER BY line_seq
      ]]>
    </sqlStatement>
    <sqlStatement name="Q_INVOICE_TD">
      <![CDATA[
         SELECT XAECTRS.sf_text    td_text
         FROM   xx_ar_ebl_cons_trx_rows_stg  XAECTRS
         WHERE  XAECTRS.request_id            = :p_batch_id
         AND    XAECTRS.cons_inv_id           = :cbi_id
         AND    XAECTRS.attribute3            = :trx_id
         AND    XAECTRS.bill_to_site_use_id   = :bill_to_id
         AND    XAECTRS.cust_doc_id           = :cust_doc_id
         AND    XAECTRS.line_type             = 'TD_REC'
         UNION ALL
         SELECT '        '||:P_CM_TEXT1||' '||TRIM(TO_CHAR(XAECLS.extended_price ,'$9G999G999D99'))
                 ||' '||:P_CM_TEXT2||' '||XAECLS.customer_product_code||'.'    td_text
         FROM   xx_ar_ebl_cons_lines_stg  XAECLS
         WHERE  XAECLS.request_id            = :p_batch_id
         AND    XAECLS.cons_inv_id           = :cbi_id
         AND    XAECLS.customer_trx_id       = :trx_id
         AND    XAECLS.bill_to_site_use_id   = :bill_to_id
         AND    XAECLS.cust_doc_id           = :cust_doc_id
         AND    XAECLS.item_code             = 'ACM'
         UNION ALL
         SELECT '        '||:P_GIFT_CARD_TEXT1||TRIM(TO_CHAR(XAECLS.extended_price*-1 ,'9G999G999D99'))||:P_GIFT_CARD_TEXT2    td_text
         FROM   xx_ar_ebl_cons_lines_stg  XAECLS
         WHERE  XAECLS.request_id            = :p_batch_id
         AND    XAECLS.cons_inv_id           = :cbi_id
         AND    XAECLS.customer_trx_id       = :trx_id
         AND    XAECLS.bill_to_site_use_id   = :bill_to_id
         AND    XAECLS.cust_doc_id           = :cust_doc_id
         AND    XAECLS.item_code             ='GIFT_CARD_INV'
         UNION ALL
         SELECT '        '||:P_GIFT_CARD_TEXT3||TRIM(TO_CHAR(XAECLS.extended_price*-1 ,'9G999G999D99'))    td_text
         FROM   xx_ar_ebl_cons_lines_stg  XAECLS
         WHERE  XAECLS.request_id            = :p_batch_id
         AND    XAECLS.cons_inv_id           = :cbi_id
         AND    XAECLS.customer_trx_id       = :trx_id
         AND    XAECLS.bill_to_site_use_id   = :bill_to_id
         AND    XAECLS.cust_doc_id           = :cust_doc_id
         AND    XAECLS.item_code             ='GIFT_CARD_CM'
      ]]>
    </sqlStatement>
    <sqlStatement name="Q_INVOICE_TOTALS">
      <![CDATA[
         SELECT A.*
         FROM   ( SELECT  1                              rec_type
                         ,XAECTRS.sf_text                sf_text1
                         ,XAECTRS.attribute1             total_orders
                         ,NVL(XAECTRS.subtotal ,0)       sf_subtotal
                         ,NVL(XAECTRS.delivery ,0)       sf_delivery
                         ,NVL(XAECTRS.discounts ,0)      sf_discounts
                         ,NVL(XAECTRS.tax ,0)            sf_tax
						 ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XAECTRS.attribute3),0)
                          + NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XAECTRS.attribute3),0) SF_FEE_AMT
                         ,NVL(XAECTRS.total ,0)          sf_total
                         ,XAECTRS.line_seq               view_seq
                         ,NVL(XAECTRS.page_break ,'N')   pg_break
--                         ,DECODE(XAECTRS.line_seq
--                                 ,MAX_SEQ.line_seq1,'Y'
--                                 ,'N'
--                                 )                       show_line
                         ,'Y'                              show_line
						 ,XAECTRS.cons_inv_id
                  FROM   xx_ar_ebl_cons_trx_rows_stg  XAECTRS
                         ,( SELECT MAX(line_seq) line_seq1
                            FROM   xx_ar_ebl_cons_trx_rows_stg
                            WHERE  request_id            = :p_batch_id
                            AND    cons_inv_id           = :cbi_id
                            AND    attribute3            = :trx_id
                            AND    bill_to_site_use_id   = :bill_to_id
                            AND    cust_doc_id           = :cust_doc_id
                          ) MAX_SEQ
                  WHERE  XAECTRS.request_id            = :p_batch_id
                  AND    XAECTRS.cons_inv_id           = :cbi_id
                  AND    XAECTRS.attribute3            = :trx_id
                  AND    XAECTRS.bill_to_site_use_id   = :bill_to_id
                  AND    XAECTRS.cust_doc_id           = :cust_doc_id
                  AND    XAECTRS.line_type             = 'SOFTHDR_TOTAL'
                  UNION ALL
                  SELECT  3                             rec_type
                         ,XAECTRS.sf_text               sf_text1
                         ,XAECTRS.attribute1            total_orders
                         ,NVL(XAECTRS.subtotal ,0)      sf_subtotal
                         ,NVL(XAECTRS.delivery ,0)      sf_delivery
                         ,NVL(XAECTRS.discounts ,0)     sf_discounts
                         ,NVL(XAECTRS.tax ,0)           sf_tax
						 ,NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_line_fee_amount(XAECTRS.attribute3),0)
                          + NVL(XX_AR_EBL_COMMON_UTIL_PKG.get_hea_fee_amount(XAECTRS.attribute3),0) SF_FEE_AMT
                         ,NVL(XAECTRS.total ,0)         sf_total
                         ,XAECTRS.line_seq              view_seq
                         ,'N'                           pg_break
                         ,'Y'                           show_line
						 ,XAECTRS.cons_inv_id
                  FROM   xx_ar_ebl_cons_trx_rows_stg  XAECTRS
                  WHERE  XAECTRS.request_id            = :p_batch_id
                  AND    XAECTRS.cons_inv_id           = :cbi_id
                  AND    XAECTRS.attribute3            = :trx_id
                  AND    XAECTRS.bill_to_site_use_id   = :bill_to_id
                  AND    XAECTRS.cust_doc_id           = :cust_doc_id
                  AND    XAECTRS.line_type             = 'BILL_TO_TOTAL'
                  UNION ALL
                  SELECT  5                             rec_type
                         ,XAECTRS.sf_text               sf_text1
                         ,TO_CHAR(NULL)                 total_orders
                         ,TO_NUMBER(NULL)               sf_subtotal
                         ,TO_NUMBER(NULL)               sf_delivery
                         ,TO_NUMBER(NULL)               sf_discounts
                         ,TO_NUMBER(NULL)               sf_tax
						 ,TO_NUMBER(NULL) SF_FEE_AMT
                         ,NVL(XAECTRS.total ,0)         sf_total
                         ,XAECTRS.line_seq              view_seq
                         ,'N'                           pg_break
                         ,'N'                           show_line
						 ,XAECTRS.cons_inv_id
                  FROM   xx_ar_ebl_cons_trx_rows_stg  XAECTRS
                  WHERE  XAECTRS.request_id            = :p_batch_id
                  AND    XAECTRS.cons_inv_id           = :cbi_id
                  AND    XAECTRS.attribute3            = :trx_id
                  AND    XAECTRS.bill_to_site_use_id   = :bill_to_id
                  AND    XAECTRS.cust_doc_id           = :cust_doc_id
                  AND    XAECTRS.line_type             ='GRAND_TOTAL'
                 ) A
         ORDER BY  rec_type
                  ,view_seq
      ]]>
    </sqlStatement>
	<sqlStatement name="Q_POD_MSG">  <!--Added this sqlStatement for POD NAIT-70471-->
       <![CDATA[
          SELECT xx_ar_ebl_pod_invoices_pkg.get_pod_msg(:cust_account_id ,:trx_id,:cust_doc_id) PD_CUST_MSG
		  FROM DUAL
       ]]>
    </sqlStatement>	
	<sqlStatement name="Q_POD_IMAGE">  <!--Added this sqlStatement for POD NAIT-70471-->
       <![CDATA[
          SELECT NVL(xx_ar_ebl_pod_invoices_pkg.resize_image(customer_trx_id),pod_image)  PD_IMG,
				 TO_CHAR(delivery_date,'DD-MON-YYYY HH24:MI:SS') DEL_DT_TM,
			     trim(consignee)  CNSNEE			     					 
		  FROM  XX_AR_EBL_POD_DTL
		  WHERE customer_trx_id = :trx_id
		  AND 'Y' = xx_ar_ebl_pod_invoices_pkg.get_pay_doc_flag(:cust_doc_id)
       ]]>
    </sqlStatement>
	<sqlStatement name="Q_CONS_MSG_BCC">  <!--Added this sqlStatement for NAIT-65564-->
       <![CDATA[
          SELECT xx_ar_ebl_common_util_pkg.get_cons_msg_bcc(:cust_doc_id,:cust_account_id,:billing_number) CONS_MSG_BCC 
		  FROM DUAL
       ]]>
    </sqlStatement>
	
	<sqlStatement name="Q_CONS_FEE">  <!--Added this sqlStatement for NAIT-65564-->
       <![CDATA[	
	SELECT 
      flv.lookup_code FEE_CODE
     ,upper(flv.meaning)  FEE_DESCRIPTION
     ,TO_CHAR(sum(RCTL.unit_selling_price),'9999999999.999')       FEE_AMT      
     ,RCTL.customer_trx_id
FROM
     ra_customer_trx_lines_All RCTL
	 ,xx_ar_ebl_cons_trx_rows_stg  XAECTRS
     ,fnd_lookup_values flv
WHERE 1=1
  AND flv.lookup_type = 'OD_FEES_ITEMS'
  AND flv.LANGUAGE='US'
  AND flv.attribute6= rctl.INVENTORY_ITEM_ID
  AND FLV.enabled_flag = 'Y'                                   
  AND SYSDATE BETWEEN NVL(FLV.start_date_active,SYSDATE) AND NVL(FLV.end_date_active,SYSDATE+1)  
  AND FLV.attribute7 NOT IN ('DELIVERY','MISCELLANEOUS')  
  AND RCTL.customer_trx_id                           = XAECTRS.attribute3
  AND XAECTRS.cons_inv_id           = :cbi_id 
  AND XAECTRS.request_id            = :p_batch_id
GROUP BY RCTL.customer_trx_id,flv.lookup_code,flv.meaning
       ]]>
    </sqlStatement>	
	
	
  </dataQuery>
  <dataTrigger name="beforeReportTrigger" source="xx_ar_ebl_cons_epdf_pkg.beforereport"/>
    <dataStructure>
    <group name = "G_FILE_ID" source = "Q_FILE_ID">
      <element name = "FILE_ID"             value = "FILE_ID"/>
      <element name = "FILE_NAME"           value = "FILE_NAME"/>
      <group name="G_BILL_TO_SITES" source="Q_BILL_TO_SITES">
        <element name = "DOC_DESCRIPTION"     value = "DOC_DESCRIPTION" />
        <element name = "BILL_TO_COUNTRY"     value = "BILL_TO_COUNTRY" />
        <element name = "POSTAL_CODE"         value = "BILL_TO_POSTAL_CODE" />
        <element name = "RETURN_ADDRESS"      value = "RETURN_ADDRESS" />
        <element name = "REMIT_TO"            value = "REMIT_TO" />
        <element name = "BILL_TO"             value = "BILL_TO" />
        <element name = "MAIL_TO_ATTENTION"   value = "MAIL_TO_ATTENTION" />
        <element name = "TAX_ID_DESC"         value = "TAX_ID_DESC" />
        <element name = "TAX_ID"              value = "TAX_ID" />
        <element name = "ACCOUNT_CONTACT"     value = "ACCOUNT_CONTACT" />
        <element name = "ORDER_CONTACT"       value = "ORDER_CONTACT" />
        <element name = "CUSTOMER_NAME"       value = "CUSTOMER_NAME" />
        <element name = "ACCOUNT_NUMBER"      value = "ACCOUNT_NUMBER" />
        <element name = "BILLING_ID"          value = "BILLING_ID" />
        <element name = "DOC_ID"              value = "DOC_ID" />
        <group name="G_CONS_BILLS" source="Q_CONSOLIDATED_BILLS">
          <element name = "BILLING_NUMBER"        value = "BILLING_NUMBER" />
          <element name = "TERMS"                 value = "TERMS" />
          <element name = "CURRENCY"              value = "CURRENCY" />
          <element name = "BILL_FROM_DATE"        value = "BILL_FROM_DATE" />
          <element name = "BILL_TO_DATE"          value = "BILL_TO_DATE" />
          <element name = "PAYMENT_DUE"           value = "PAYMENT_DUE" />
          <element name = "DOC_TITLE"             value = "DOC_TITLE" />
          <element name = "SFHDR1"                value = "SFHDR1" />
          <element name = "SFHDR2"                value = "SFHDR2" />
          <element name = "SFHDR3"                value = "SFHDR3" />
          <element name = "SFHDR4"                value = "SFHDR4" />
          <element name = "SFHDR5"                value = "SFHDR5" />
          <element name = "CBI_EXTAMT_PLUS_DELVY" value = "CBI_EXTAMT_PLUS_DELVY" />
          <element name = "CBI_DISCOUNTS"         value = "CBI_DISCOUNTS" />
          <element name = "CBI_TAX"               value = "CBI_TAX" />
          <element name = "CBI_AMOUNT_DUE"        value = "CBI_AMOUNT_DUE" />
		  <element name = "CBI_FEE_AMT"           value = "CBI_FEE_AMT" />
          <element name = "NO_PAYMENT_TEXT"       value = "NO_PAYMENT_TEXT"/>
          <element name = "DOCUMENT_TYPE"         value = "DOCUMENT_TYPE"/>
		  <element name = "DISCOUNT_INFO"         value = "DISCOUNT_INFO"/>  <!--Added for Defect # 36437-->
		  <element name = "FEE_OPTION"            value = "FEE_OPTION"/>
          <group name="G_INVOICE_HEADER" source="Q_INVOICE_HEADER">
            <element name="TRX_ID"                  value="TRX_ID" />
            <group name="G_SPC" source="Q_INVOICE_SPC">
              <element name="SPC_TEXT"                value="SPC_TEXT" />
            </group>
            <group name="G_INVOICE_INFO" source="Q_INVOICE_INFO">
              <element name = "SF_DATA1"                value = "SF_DATA1" />
              <element name = "SF_DATA2"                value = "SF_DATA2" />
              <element name = "SF_DATA3"                value = "SF_DATA3" />
              <element name = "SF_DATA4"                value = "SF_DATA4" />
              <element name = "SF_DATA5"                value = "SF_DATA5" />
              <element name = "ORDER_NO"                value = "ORDER_NO" />
              <element name = "ORDER_DATE"              value = "ORDER_DATE" />
              <element name = "SUBTOTAL"                value = "INV_SUBTOTAL" />
              <element name = "DELIVERY"                value = "INV_DELIVERY" />
              <element name = "DISCOUNTS"               value = "INV_DISCOUNTS" />
              <element name = "TAX"                     value = "INV_TAX" />
			  <element name = "LINE_FEE"                value = "FEE_AMT" />
			  <element name = "TOTAL"                   value = "INV_TOTAL" />
              <element name = "SF_DATA6"                value = "SF_DATA6" />
              <element name = "SF_HDR7"                 value = "SF_HDR7" />
              <element name = "SF_DATA7"                value = "SF_DATA7" />
            </group>
            <group name="G_TD" source="Q_INVOICE_TD">
              <element name = "TD_TEXT"                 value = "TD_TEXT" />
            </group>
            <group name="G_INV_STATEMENT" source="Q_INVOICE_TOTALS">
              <element name = "SF_TEXT1"                value = "SF_TEXT1" />
              <element name = "SF_TOTAL_ORDERS"         value = "TOTAL_ORDERS" />
              <element name = "SF_SUBTOTAL"             value = "SF_SUBTOTAL" />
              <element name = "SF_DELIVERY"             value = "SF_DELIVERY" />
              <element name = "SF_DISCOUNTS"            value = "SF_DISCOUNTS" />
              <element name = "SF_TAX"                  value = "SF_TAX" />
			  <element name = "SF_FEE_AMT"              value = "SF_FEE_AMT" />
              <element name = "SF_TOTAL"                value = "SF_TOTAL" />
              <element name = "PG_BREAK"                value = "PG_BREAK" />
              <element name = "SHOW_LINE"               value = "SHOW_LINE" />
            </group>
			<group name = "G_POD_MSG" source = "Q_POD_MSG">	<!--Added this group for POD NAIT-70471-->
			<element name = "PD_CUST_MSG"              value = "PD_CUST_MSG"/>
			</group>
			<group name = "G_POD_DETAILS" source = "Q_POD_IMAGE"><!--Added this group for POD NAIT-70471-->
              <element name = "PD_IMG"                    value = "PD_IMG"/>
			  <element name = "DEL_DT_TM"                 value = "DEL_DT_TM"/>
              <element name = "CNSNEE"                    value = "CNSNEE"/>	
            </group>
          </group>
          <group name = "G_SCAN_LINE" source = "Q_SCAN_LINE">
            <element name = "SCANLINE"                 value = "SCAN_LINE"/>
          </group>
		  <group name = "G_CONS_MSG_BCC" source = "Q_CONS_MSG_BCC">        	<!--Added this group for NAIT-65564-->
            <element name = "CONS_MSG_BCC"             value = "CONS_MSG_BCC"/>
          </group>
		  <group name="G_INV_FEE" source="Q_CONS_FEE">
			<element name = "FEE_NAME"                value = "FEE_DESCRIPTION" />
			<element name = "AMOUNT"                  value = "FEE_AMT" />
		  </group>
        </group>
      </group>
    </group>
    </dataStructure>
  <dataTrigger name="afterReportTrigger" source="xx_ar_ebl_cons_epdf_pkg.afterreport"/>
</dataTemplate>