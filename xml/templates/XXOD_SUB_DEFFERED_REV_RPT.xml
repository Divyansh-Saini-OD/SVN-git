<?xml version="1.0" encoding="UTF-8"?>
<dataTemplate name="XXOD_SUB_DEFFERED_REV_RPT" defaultPackage="XXOD_DEFFERED_RPT_BURST_F" description="Deferred Revenue Subledger Report" version="1.0">
<dataQuery> 
      <sqlStatement name="Q1">
            <![CDATA[select SUM(contract_line_amount)s_contract_line_amount,
                            SUM(total_contract_line_amount)s_total_contract_line_amount,
                            SUM(TotalAmountBilledToDate)S_TotalAmountBilledToDate,
                            SUM(TotalAmntOfRevRecToDate)S_TotalAmntOfRevRecToDate,
                            SUM(DeferredRevenueTotal)S_DeferredRevenueTotal,
                            SUM(AnticAmtLeftforContract)S_AnticAmtLeftforContract,
                            SUM(RevRecogInCurrPeriod)S_RevRecogInCurrPeriod
                      from (
                      SELECT A.contract_number,
                             A.quantity,
                             A.contract_line_amount,
                             A.total_contract_line_amount,
                             A.TotalAmountBilledToDate,
                             A.TotalAmntOfRevRecToDate,
                            (A.TotalAmountBilledToDate - A.TotalAmntOfRevRecToDate) DeferredRevenueTotal,
                            (A.quantity*A.total_contract_line_amount - A.TotalAmntOfRevRecToDate) AnticAmtLeftforContract,
                             A.RevRecogInCurrPeriod
                        FROM 
                            (
                       select QRLST.contract_number
                             ,QRLST.quantity
                             ,QRLST.contract_line_amount
                             ,QRLST.total_contract_line_amount
                             ,(SELECT NVL(SUM(rtla.unit_selling_price* 
                                                rtla.quantity_invoiced ),0) TotalAmountBilledToDate
                                   FROM ar.ra_customer_trx_all             trx,
                                        xx_ar_subscriptions                xas1,
                                        xx_ar_contract_lines               contl,
                                        ar.ra_customer_trx_lines_all       rtla
                                  WHERE 1                                  = 1
                                    AND xas1.contract_id                   = contl.contract_id
                                    AND xas1.CONTRACT_LINE_NUMBER          = contl.CONTRACT_LINE_NUMBER
                                    AND rtla.accounting_rule_id            = (select rule_id  from  ra_rules where type='PP_DR_ALL' and status='A')
                                    AND xas1.invoice_number                = trx.trx_number
                                    AND trx.customer_trx_id                = rtla.customer_trx_id 
                                    AND xas1.contract_id                   = QRLST.contract_id
                                    AND xas1.contract_line_number          = rtla.line_number
                                    AND rtla.inventory_item_id             = QRLST.inventory_item_id
                                    AND xas1.contract_line_number          = QRLST.contract_line_number
                                 ) AS TotalAmountBilledToDate
                               ,(select NVL(SUM(rctg.amount),0) TotalAmntOfRevRecToDate
                                  from   ra_customer_trx_all rct
                                        ,ra_customer_trx_lines_all rctl
                                        ,ra_cust_trx_line_gl_dist_all rctg
                                        ,xx_ar_subscriptions subs
                                        ,xx_ar_contract_lines contl
                                        ,gl_periods gps
                                  where 1=1
                                  and   rct.CUSTOMER_TRX_ID=rctl.CUSTOMER_TRX_ID
                                  and   rctl.CUSTOMER_TRX_LINE_ID=rctg.CUSTOMER_TRX_LINE_ID
                                  and   rct.trx_number=subs.invoice_number
                                  and   subs.contract_id = contl.contract_id
                                  and   subs.contract_line_number=contl.contract_line_number
                                  and   subs.contract_number= QRLST.contract_number --310136
                                  and   rctg.ACCOUNT_CLASS='REV'
                                  and   rctg.percent <>100
                                  and   subs.CONTRACT_LINE_NUMBER = rctl.line_number
                                  and   subs.CONTRACT_LINE_NUMBER=QRLST.contract_line_NUMBER           
                                  and   rctg.gl_date  between gps.start_date and gps.end_date
                                  and  rctg.gl_date < sysdate 
                                  ) AS TotalAmntOfRevRecToDate           
                                 ,(SELECT NVL(SUM(trx_dist.amount),0)/min(rtla.quantity_invoiced) RevRecogInCurrPeriod       
                                     FROM ar.ra_customer_trx_all           trx,
                                          apps.xx_ar_subscriptions         xas,
                                          ar.ra_customer_trx_lines_all     rtla,
                                          ar.ra_cust_trx_line_gl_dist_all  trx_dist,
                                          gl.gl_code_combinations          gcc,
                                          gl.gl_ledgers                    gl,
                                          xla.xla_transaction_entities     xte,
                                          xla.xla_ae_headers               xah,
                                          xla.xla_ae_lines                 xal,
                                          xla.xla_distribution_links       xdl,
                                          gl.gl_period_statuses            gps
                                    WHERE 1                                = 1   
                                      AND rtla.accounting_rule_id          = (select rule_id  from  ra_rules where type='PP_DR_ALL' and status='A')
                                      AND xas.invoice_number               = trx.trx_number
                                      AND xas.contract_id                  = QRLST.contract_id
                                      AND xas.contract_line_number         = rtla.line_number
                                      AND xas.contract_line_number         = QRLST.contract_line_number
                                      AND rtla.inventory_item_id           = QRLST.inventory_item_id     
                                      AND trx.customer_trx_id              = rtla.customer_trx_id
                                      AND rtla.customer_trx_line_id        = trx_dist.customer_trx_line_id
                                      AND trx.customer_trx_id              = trx_dist.customer_trx_id
                                      AND gcc.code_combination_id          = trx_dist.code_combination_id
                                      AND gl.chart_of_accounts_id          = gcc.chart_of_accounts_id
                                      AND xte.ledger_id                    = gl.ledger_id
                                      AND gl.ledger_id                     = gps.ledger_id
                                      AND xte.entity_code                  = 'TRANSACTIONS'
                                      AND xte.application_id               = gps.application_id
                                      AND xte.source_id_int_1              = trx.customer_trx_id
                                      AND xah.entity_id                    = xte.entity_id
                                      AND xal.ae_header_id                 = xah.ae_header_id
                                      AND xal.accounting_class_code        = 'REVENUE'
                                      AND xdl.ae_header_id                 = xah.ae_header_id
                                      AND xdl.ae_line_num                  = xal.ae_line_num
                                      AND xdl.source_distribution_id_num_1 = trx_dist.cust_trx_line_gl_dist_id
                                      AND xdl.application_id               = 222
                                      AND GL_DATE                          BETWEEN gps.start_date 
                                                                              AND gps.end_date
                                      AND SYSDATE                          BETWEEN  gps.start_date 
                                                                              AND gps.end_date
                                     ) AS RevRecogInCurrPeriod          
                               FROM       
                                  (
        select subs.contract_number
              ,contl.item_name
              ,msib.inventory_item_id 
              ,min(rctl.quantity_invoiced) quantity
              ,CONTS.CONTRACT_START_DATE
              ,CONTS.CONTRACT_END_DATE
              ,contl.contract_id
              ,subs.contract_line_amount
              ,contl.contract_line_amount total_contract_line_amount
              ,subs.contract_line_NUMBER
        from   xx_ar_contracts            conts
              ,xx_ar_contract_lines       contl
              ,xx_ar_subscriptions        subs
              ,mtl_system_items_b         msib
              ,ra_customer_trx_all        rct
              ,ra_customer_trx_lines_all  rctl
        where conts.contract_id         = contl.contract_id
        and   contl.contract_id         = subs.contract_id
        and   subs.contract_line_number = contl.contract_line_number
        and   subs.invoice_number       = rct.trx_number
        and   rct.customer_trx_id       = rctl.customer_trx_id
        and   rct.invoicing_rule_id is not null
        --and   conts.contract_number     in (310007) --310009,310136,310137,310142,310254,310255) --( 312177 ,310008)
               and   conts.contract_status     ='ACTIVE'
        and   contl.item_name           = msib.segment1
        and   msib.organization_id      = 441        
        AND trunc(subs.last_update_date) >  '10-JUN-2020' --BETWEEN trunc(sysdate-60) AND trunc(sysdate-1)                                                                                                        
        group by subs.contract_number
              ,contl.item_name
              ,msib.inventory_item_id 
              --,rctl.quantity_invoiced 
              ,CONTS.CONTRACT_START_DATE
              ,CONTS.CONTRACT_END_DATE
              ,contl.contract_id
              ,subs.contract_line_amount
              ,contl.contract_line_amount 
              ,subs.contract_line_NUMBER
      ) QRLST
)A
order by a.contract_number
)B
where b.TOTALAMOUNTBILLEDTODATE is not null
and   b.quantity is not null
and   b.DeferredRevenueTotal > 0
            ]]>
        </sqlStatement>
          <sqlStatement name="Q2">
           <![CDATA[ 
          select contract_number,
       sku,
       quantity,
       contract_start_date,
       contract_end_date,
       contract_line_NUMBER,
       contract_line_amount,
       total_contract_line_amount,
       TotalAmountBilledToDate,
       TotalAmntOfRevRecToDate,
       DeferredRevenueTotal,
       AnticAmtLeftforContract,
       RevRecogInCurrPeriod
from (
SELECT A.contract_number,
       A.sku,
       A.quantity,
       A.contract_start_date,
       A.contract_end_date,
        A.contract_line_NUMBER,
       A.contract_line_amount,
       A.total_contract_line_amount,
        A.TotalAmountBilledToDate,
       A.TotalAmntOfRevRecToDate,
       (A.TotalAmountBilledToDate - A.TotalAmntOfRevRecToDate) DeferredRevenueTotal,
       (A.quantity*A.total_contract_line_amount - A.TotalAmntOfRevRecToDate) AnticAmtLeftforContract,
        A.RevRecogInCurrPeriod,
        A.contract_id,
        A.inventory_item_id
     
 FROM 
(
select QRLST.contract_number
      ,QRLST.item_name SKU  
      ,QRLST.quantity
      ,QRLST.inventory_item_id
      ,QRLST.CONTRACT_START_DATE
      ,QRLST.CONTRACT_END_DATE
      ,QRLST.contract_line_NUMBER
      ,QRLST.contract_line_amount
      ,QRLST.total_contract_line_amount
      ,QRLST.contract_ID
      ,(SELECT NVL(SUM(rtla.unit_selling_price* 
                         rtla.quantity_invoiced ),0) TotalAmountBilledToDate
            FROM ar.ra_customer_trx_all             trx,
                 xx_ar_subscriptions                xas1,
                 xx_ar_contract_lines               contl,
                 ar.ra_customer_trx_lines_all       rtla
           WHERE 1                                  = 1
             AND xas1.contract_id = contl.contract_id
             AND xas1.CONTRACT_LINE_NUMBER = contl.CONTRACT_LINE_NUMBER
             AND rtla.accounting_rule_id            = (select rule_id  from  ra_rules where type='PP_DR_ALL' and status='A')
             AND xas1.invoice_number                = trx.trx_number
             AND trx.customer_trx_id                = rtla.customer_trx_id 
             AND xas1.contract_id                   = QRLST.contract_id
             AND xas1.contract_line_number          = rtla.line_number
             AND rtla.inventory_item_id             = QRLST.inventory_item_id
             AND xas1.contract_line_number          = QRLST.contract_line_number
          ) AS TotalAmountBilledToDate
        ,(select NVL(SUM(rctg.amount),0) TotalAmntOfRevRecToDate
           from   ra_customer_trx_all rct
                 ,ra_customer_trx_lines_all rctl
                 ,ra_cust_trx_line_gl_dist_all rctg
                 ,xx_ar_subscriptions subs
                 ,xx_ar_contract_lines contl
                 ,gl_periods gps
           where 1=1
           and   rct.CUSTOMER_TRX_ID=rctl.CUSTOMER_TRX_ID
           and   rctl.CUSTOMER_TRX_LINE_ID=rctg.CUSTOMER_TRX_LINE_ID
           and   rct.trx_number=subs.invoice_number
           and   subs.contract_id = contl.contract_id
           and   subs.contract_line_number=contl.contract_line_number
           and   subs.contract_number= QRLST.contract_number --310136
           and   rctg.ACCOUNT_CLASS='REV'
           and   rctg.percent <>100
           and   subs.CONTRACT_LINE_NUMBER = rctl.line_number
           and   subs.CONTRACT_LINE_NUMBER=QRLST.contract_line_NUMBER           
           and   rctg.gl_date  between gps.start_date and gps.end_date
           and  rctg.gl_date < sysdate 
           ) AS TotalAmntOfRevRecToDate           
            ,(SELECT NVL(SUM(trx_dist.amount),0)/min(rtla.quantity_invoiced) RevRecogInCurrPeriod       
                FROM ar.ra_customer_trx_all           trx,
                     apps.xx_ar_subscriptions         xas,
                     ar.ra_customer_trx_lines_all     rtla,
                     ar.ra_cust_trx_line_gl_dist_all  trx_dist,
                     gl.gl_code_combinations          gcc,
                     gl.gl_ledgers                    gl,
                     xla.xla_transaction_entities     xte,
                     xla.xla_ae_headers               xah,
                     xla.xla_ae_lines                 xal,
                     xla.xla_distribution_links       xdl,
                     gl.gl_period_statuses            gps
               WHERE 1                                = 1   
                 AND rtla.accounting_rule_id          = (select rule_id  from  ra_rules where type='PP_DR_ALL' and status='A')
                 AND xas.invoice_number               = trx.trx_number
                 AND xas.contract_id                  = QRLST.contract_id
                 AND xas.contract_line_number         = rtla.line_number
                 AND xas.contract_line_number         = QRLST.contract_line_number
                 AND rtla.inventory_item_id           = QRLST.inventory_item_id     
                 AND trx.customer_trx_id              = rtla.customer_trx_id
                 AND rtla.customer_trx_line_id        = trx_dist.customer_trx_line_id
                 AND trx.customer_trx_id              = trx_dist.customer_trx_id
                 AND gcc.code_combination_id          = trx_dist.code_combination_id
                 AND gl.chart_of_accounts_id          = gcc.chart_of_accounts_id
                 AND xte.ledger_id                    = gl.ledger_id
                 AND gl.ledger_id                     = gps.ledger_id
                 AND xte.entity_code                  = 'TRANSACTIONS'
                 AND xte.application_id               = gps.application_id
                 AND xte.source_id_int_1              = trx.customer_trx_id
                 AND xah.entity_id                    = xte.entity_id
                 AND xal.ae_header_id                 = xah.ae_header_id
                 AND xal.accounting_class_code        = 'REVENUE'
                 AND xdl.ae_header_id                 = xah.ae_header_id
                 AND xdl.ae_line_num                  = xal.ae_line_num
                 AND xdl.source_distribution_id_num_1 = trx_dist.cust_trx_line_gl_dist_id
                 AND xdl.application_id               = 222
                 AND GL_DATE                          BETWEEN gps.start_date 
                                                         AND gps.end_date
                 AND SYSDATE                          BETWEEN  gps.start_date 
                                                         AND gps.end_date
                ) AS RevRecogInCurrPeriod          
FROM       
      (
        select subs.contract_number
              ,contl.item_name
              ,msib.inventory_item_id 
              ,min(rctl.quantity_invoiced) quantity
              ,CONTS.CONTRACT_START_DATE
              ,CONTS.CONTRACT_END_DATE
              ,contl.contract_id
              ,subs.contract_line_amount
              ,contl.contract_line_amount total_contract_line_amount
              ,subs.contract_line_NUMBER
        from   xx_ar_contracts            conts
              ,xx_ar_contract_lines       contl
              ,xx_ar_subscriptions        subs
              ,mtl_system_items_b         msib
              ,ra_customer_trx_all        rct
              ,ra_customer_trx_lines_all  rctl
        where conts.contract_id         = contl.contract_id
        and   contl.contract_id         = subs.contract_id
        and   subs.contract_line_number = contl.contract_line_number
        and   subs.invoice_number       = rct.trx_number
        and   rct.customer_trx_id       = rctl.customer_trx_id
        and   rct.invoicing_rule_id is not null
        --and   conts.contract_number     in (310007) --310009,310136,310137,310142,310254,310255) --( 312177 ,310008)
               and   conts.contract_status     ='ACTIVE'
        and   contl.item_name           = msib.segment1
        and   msib.organization_id      = 441        
        AND trunc(subs.last_update_date) >  '10-JUN-2020' --BETWEEN trunc(sysdate-60) AND trunc(sysdate-1)                                                                                                        
        group by subs.contract_number
              ,contl.item_name
              ,msib.inventory_item_id 
              --,rctl.quantity_invoiced 
              ,CONTS.CONTRACT_START_DATE
              ,CONTS.CONTRACT_END_DATE
              ,contl.contract_id
              ,subs.contract_line_amount
              ,contl.contract_line_amount 
              ,subs.contract_line_NUMBER
      ) QRLST
)A
order by a.contract_number
)B
where b.TOTALAMOUNTBILLEDTODATE is not null
and   b.quantity is not null
and   b.DeferredRevenueTotal > 0
           ]]>
           </sqlStatement> 
           <sqlStatement name="Q_SMTP_DTLS_EMAIL">
               <![CDATA[SELECT SMTP_DTLS.SMTP_SERVER,
                               SMTP_DTLS.SMTP_PORT,
                               SMTP_DTLS.EMAIL_FROM,
                               EMAIL_ADDRESS.EMAIL_ADDR,
                               TO_CHAR((sysdate-1),'DD-MON-YYYY') CURRENT_DATE
                        FROM   (SELECT XFTV.target_value1 SMTP_SERVER,
                                       XFTV.target_value2 SMTP_PORT,
                                       XFTV.target_value3 EMAIL_FROM
                                FROM   xx_fin_translatedefinition XFTD,
                                       xx_fin_translatevalues XFTV 
                                WHERE  XFTD.translation_name ='AR_EBL_EMAIL_CONFIG'
                                 AND   SYSDATE BETWEEN XFTD.start_date_active AND NVL(XFTD.end_date_active, SYSDATE + 1)
                                 AND   XFTD.enabled_flag   = 'Y'
                                 AND   XFTD.translate_id   = XFTV.translate_id
                                 AND   SYSDATE BETWEEN XFTV.start_date_active AND NVL(XFTV.end_date_active, SYSDATE + 1)
                                 AND   XFTV.enabled_flag   = 'Y'
                               )SMTP_DTLS,
                               (SELECT XFTV.target_value1 EMAIL_ADDR
                                FROM   xx_fin_translatedefinition XFTD,
                                       xx_fin_translatevalues XFTV
                                WHERE  XFTD.translation_name = 'XX_AR_SUBS_DEFERRED_RPT'
                                AND    XFTD.translate_id   = XFTV.translate_id                             
                                AND    SYSDATE BETWEEN XFTD.start_date_active AND NVL(XFTD.end_date_active, SYSDATE + 1)
                                AND    XFTD.enabled_flag   = 'Y'
                                AND    SYSDATE BETWEEN XFTV.start_date_active AND NVL(XFTV.end_date_active, SYSDATE + 1)
                                AND    XFTV.enabled_flag   = 'Y'                             
                               )EMAIL_ADDRESS
               ]]>
           </sqlStatement>  		   		   
</dataQuery>

<dataStructure>  
            <!-- Summary  --> 
		   <group name="G_BILLING_SUMMARY"                    source="Q1">
		    <element name="S_CONTRACT_LINE_AMOUNT"            value="S_CONTRACT_LINE_AMOUNT" /> 
	        <element name="S_TOTAL_CONTRACT_LINE_AMOUNT"      value="S_TOTAL_CONTRACT_LINE_AMOUNT" /> 
		    <element name="S_TOTALAMOUNTBILLEDTODATE"         value="S_TOTALAMOUNTBILLEDTODATE" />
            <element name="S_TOTALAMNTOFREVRECTODATE"         value="S_TOTALAMNTOFREVRECTODATE"/>
            <element name="S_DEFERREDREVENUETOTAL"            value="S_DEFERREDREVENUETOTAL"/>
            <element name="S_ANTICAMTLEFTFORCONTRACT"         value="S_ANTICAMTLEFTFORCONTRACT"/>
			<element name="S_REVRECOGINCURRPERIOD"            value="S_REVRECOGINCURRPERIOD" /> 
           </group>           
           <!-- Deferred Revenue Subledger Report Group --> 
          <group name="G_SUB_DEFFERED_REV_RPT" 	              source="Q2">
	       <element name="CONTRACT_NUMBER"                    value="CONTRACT_NUMBER" />
	       <element name="SKU"                                value="SKU" />
           <element name="QUANTITY"                           value="QUANTITY" />	       
	       <element name="CONTRACT_START_DATE"                value="CONTRACT_START_DATE" />
	       <element name="CONTRACT_END_DATE"                  value="CONTRACT_END_DATE"/>
		   <element name="CONTRACT_LINE_NUMBER"               value="CONTRACT_LINE_NUMBER" /> 
	       <element name="CONTRACT_LINE_AMOUNT"               value="CONTRACT_LINE_AMOUNT" /> 
	       <element name="TOTAL_CONTRACT_LINE_AMOUNT"         value="TOTAL_CONTRACT_LINE_AMOUNT" /> 
           <element name="TOTALAMOUNTBILLEDTODATE"            value="TOTALAMOUNTBILLEDTODATE" />
           <element name="TOTALAMNTOFREVRECTODATE"            value="TOTALAMNTOFREVRECTODATE" />  
           <element name="DEFERREDREVENUETOTAL"               value="DEFERREDREVENUETOTAL" />
           <element name="ANTICAMTLEFTFORCONTRACT"            value="ANTICAMTLEFTFORCONTRACT" />
           <element name="REVRECOGINCURRPERIOD"               value="REVRECOGINCURRPERIOD" />     	
          </group> 		  
           <!-- Bursting Group --> 
          <group name="G_SMTP_DTLS_EMAIL" source="Q_SMTP_DTLS_EMAIL">
            <element name="SMTP_SERVER"   value="SMTP_SERVER"/>
            <element name="SMTP_PORT"     value="SMTP_PORT"/>
            <element name="EMAIL_FROM"    value="EMAIL_FROM"/>
            <element name="EMAIL_SUBJECT" value="EMAIL_SUBJECT"/>
            <element name="EMAIL_ADDR"    value="EMAIL_ADDR"/>
            <element name="CURRENT_DATE"  value="CURRENT_DATE"/>
		  </group> 		  
</dataStructure>   
<dataTrigger name="afterReport" source="XXOD_DEFFERED_RPT_BURST_F()"/>
<!-- <dataTrigger name="afterReport" source="XXSSN_TIMECARD_MGR_BRST_PKG.XXSSN_SUBMIT_BURSTING" /> -->    
</dataTemplate>