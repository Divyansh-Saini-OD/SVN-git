<?xml version="1.0" encoding="UTF-8"?>
<dataTemplate name="XXFINMISSINGAPCONTACTS" defaultPackage="XX_FIN_MISSING_AP_CONTACT_PKG" dataSourceRef="1.0">
	<properties>
		<property name="include_parameters" value="true"/>
		<property name="include_null_Element" value="true"/>
		<property name="db_fetch_size" value="300"/>
	</properties>
	<parameters>
		<parameter name="P_MAIL_FROM" dataType="varchar2" defaultValue=""/>
		<parameter name="P_MAIL_TO" dataType="varchar2" defaultValue=""/>
	</parameters>
<dataQuery>
<sqlStatement name="Q1" dataSourceRef="">
<![CDATA[ SELECT hca.account_name                  CUSTOMER_NAME ,
                 hca.account_number                CUSTOMER_ACCOUNT_NUMBER, 
                 SUBSTR(hca.orig_system_reference,1,INSTR(hca.orig_system_reference,'-')-1) CUSTOMER_AOPS_NUMBER,
                 xxcca.n_ext_attr2 BILLING_DOC_ID,
                 hcsa.orig_system_reference        SITE_SEQUENCE,
				 'AP Contact is missing from site' ERROR_MESSAGE,
                 TO_CHAR(hcps.last_update_date,'DD-MON-YYYY') ERROR_DATE
            FROM hz_contact_points             hcps,
                 hz_org_contacts               hoc,
                 hz_relationships              hr,
                 hz_cust_site_uses_all         hcsu,
                 hz_cust_account_roles         hcar,
                 hz_party_sites                hps,
                 hz_cust_acct_sites_all        hcsa,
                 xx_cdh_cust_acct_ext_b        xxcca,
                 hz_customer_profiles          hcp,
                 hz_cust_accounts              hca,  
                 hz_parties                    hp
           WHERE 1 = 1
             AND hcps.OWNER_TABLE_ID = hr.party_id
             AND hcps.OWNER_TABLE_name='HZ_PARTIES'
             AND hcps.PRIMARY_FLAG='Y'
             AND hcps.contact_point_type = 'EMAIL'
             AND hr.subject_id = hp.party_id
             AND hr.subject_type='PERSON'
             AND hr.party_id = hcar.party_id
             AND hcsu.site_use_code = 'BILL_TO' -- 'SHIP_TO'
             AND hcsu.cust_acct_site_id = hcsa.cust_acct_site_id
             AND hcsu.status = 'A'
             AND hcsu.primary_flag='Y'
             AND hoc.party_relationship_id = hr.relationship_id
             AND UPPER(hoc.job_title) NOT LIKE '%AP%'
             AND hr.party_id = hcar.party_id
             AND hcar.primary_flag = 'Y'
             AND hcar.CUST_ACCT_SITE_ID = hcsa.cust_acct_site_id
             AND hcar.CUST_ACCOUNT_ID = hca.CUST_ACCOUNT_ID
             AND hps.party_site_id = hcsa.party_site_id
             AND hcsa.status = 'A'
             AND hcsa.cust_account_id = hca.cust_account_id
             AND xxcca.cust_account_id = hcp.cust_account_id
             AND xxcca.c_ext_attr2 = 'Y'
             AND xxcca.attr_group_id = 166
             AND xxcca.c_ext_attr13 = 'DB'
             AND hcp.site_use_id IS NULL 
             AND hcp.attribute3 = 'Y'
             AND hcp.cust_account_id = hca.cust_account_id
             AND hca.status = 'A'
       ORDER BY hcps.last_update_date
]]>
</sqlStatement>
<sqlStatement name="Q2" dataSourceRef="">
<![CDATA[ SELECT  (SELECT FND_PROFILE.VALUE('XX_COMN_SMTP_MAIL_SERVER') 
                     FROM dual)         SMTP_SERVER,
                  :P_MAIL_FROM          MAIL_FROM,
				  :P_MAIL_TO            MAIL_TO,
				  (SELECT instance_name 
				     FROM v$instance)   INSTANCE_NAME
            FROM DUAL
]]>
</sqlStatement>
</dataQuery>
<dataTrigger name="beforeReport" source="XX_FIN_MISSING_AP_CONTACT_PKG.beforeReport" /> 
<dataStructure>
<group name="G1" source="Q1" groupFilter="">
	 <element name="CUSTOMER_NAME" value="CUSTOMER_NAME" function=""/>
	 <element name="CUSTOMER_ACCOUNT_NUMBER" value="CUSTOMER_ACCOUNT_NUMBER" function=""/>
	 <element name="CUSTOMER_AOPS_NUMBER" value="CUSTOMER_AOPS_NUMBER" function=""/>
	 <element name="BILLING_DOC_ID" value="BILLING_DOC_ID" function=""/>
	 <element name="SITE_SEQUENCE" value="SITE_SEQUENCE" function=""/>
	 <element name="ERROR_MESSAGE" value="ERROR_MESSAGE" function=""/>
	 <element name="ERROR_DATE" value="ERROR_DATE" function=""/>
</group>
<group name="G2" source="Q2" groupFilter="">
     <element name="C_SMTP_SERVER" value="SMTP_SERVER" function=""/>
     <element name="C_MAIL_FROM"  value="MAIL_FROM" function=""/>
     <element name="C_MAIL_TO"    value="MAIL_TO" function=""/>
	 <element name="C_INSTANCE_NAME"    value="INSTANCE_NAME" function=""/>
</group>
</dataStructure>
<dataTrigger name="afterReport" source="XX_FIN_MISSING_AP_CONTACT_PKG.afterReport"/>
</dataTemplate>
