#!/bin/ksh
# ----------------------------------------------------------------------------------------
# Filename:   XXODROEMAILER
# Purpose:    This Program is used to send the Concurrent Program Request Output as an 
#             Email to the user based on the Attachment Flag.If the Flag is selected as 
#             N (No),then the output is sent as the Email body.If the Flag is selected as
#	      Y (Yes),then the output file is sent as an Attachment with the Email.
#             The user has to enter the Program Name,Email Address(es),Email Subject,  
#             Email Body and the value for the Attachment Flag. 
# ----------------------------------------------------------------------------------------

#  Concurrent Program Definitions Parameters

#  var1  is --> Job name 
#  var2  is --> Concurrent Program Request ID.
#  var3  is --> Login Credentials

#  User defined Parameters

#  var9  is --> Concurrent Program Short Name
#  var10 is --> Email Address(es)
#  var11 is --> Email Subject
#  var12 is --> Email Body Text
#  var13 is --> Email Attachment Flag
#  var14 is --> Request ID

# VERSION  AUTHOR                        COMMENTS           DATE     
# ----------------------------------------------------------------------------------------
# 1.0      Shivkumar Arunachalam Iyer    Initial Version    13-FEB-2007 
# ----------------------------------------------------------------------------------------

# Parsing System Defined Parameters.

var1=`echo $1 | awk '{print $1}'| tr -d '"'`
var2=`echo $1 | awk '{print $2}'| tr -d '"'`
var3=`echo $1 | awk '{print $3}'| tr -d '"'`

# Defining User Defined Parameters.

var9=`echo $1 | cut -f8 -d '"'`
var10=`echo $1 | cut -f10 -d '"'`
var11=`echo $1 | cut -f12 -d '"'`
var12=`echo $1 | cut -f14 -d '"'`
var13=`echo $1 | cut -f16 -d '"'`
var14=`echo $1 | cut -f18 -d '"'`

# Assigning Required Parameters to the Shell variables.

program_name=${var9}
to_email_address=${var10}
email_sub=`echo $var11 | awk '{print $var11}'| tr [:blank:] [_]`
email_body=${var12}
email_attachment=${var13}
req_id=0

# Defining Constants.

u_mail_subject=${email_sub}
filepath=$APPLCSF/$APPLOUT/
cust_path=$XXFIN_DATA/inbound/

# Printing User Defined Parameters in the Request Log File.

echo "Email Address(es) : "${var10}
echo "Attachment ?      : "${var13}

if [ "$var14" != "" ]
then

p_req_id=$var14
echo "Request ID        : "${p_req_id}

# Constructing the names of the request output and email attachment files.

filename=o${p_req_id}.out
file=$filepath$filename

if [ ! -f $file ]
then
echo "No Request Output file found.   Email not sent."
else
attachment=XX_${email_sub}_${p_req_id}.txt
cp $file $cust_path$attachment

if [ "${email_attachment}" = "Y" ]
then

# Send an email the user with the attachment.

/usr/bin/uuencode $cust_path$attachment $cust_path$attachment | mailx -s ${u_mail_subject}_${p_req_id} -a $cust_path$attachment ${to_email_address} <<-EOF
${email_body}
----------------------------------------------------
This is a system generated mail.Please do not reply.
----------------------------------------------------
EOF
echo "Email Sent with Request Output as Attachment."
chmod 777 $cust_path$attachment
rm $cust_path$attachment

else 
cat $file|mailx -s ${u_mail_subject}_${p_req_id} ${to_email_address}
fi

fi

else
echo "Program Name      : "${var9}

# Getting the request id of the Current emailer shell program.

shell_req=`echo $var2|awk -F= '{print $2}'`

# Setting up database connection credentials.

appspw=`echo $var3|awk -F= '{print $2}'`
connect=$appspw@$TWO_TASK

# Connecting to ORACLE and determining the request id of the output file.

req_id=`sqlplus -s ${connect} <<EOF
set heading off
set pagesize 0
set linesize 255
set sqlprompt ""
set echo off
set feedback off
set verify off
set serveroutput on 
VARIABLE ln_fileid NUMBER;
DECLARE
   ln_req_id     NUMBER;
BEGIN
   SELECT fcr2.request_id
     INTO ln_req_id
     FROM fnd_concurrent_programs FCP,
          fnd_concurrent_requests FCR2,
          fnd_concurrent_requests FCR1
    WHERE FCR1.request_id = ${shell_req}
      AND FCR2.priority_request_id = FCR1.priority_request_id
      AND FCR2.concurrent_program_id = FCP.concurrent_program_id
      AND FCP.concurrent_program_name = UPPER('${program_name}');
      :ln_fileid := ln_req_id;
      DBMS_OUTPUT.PUT_LINE(ln_req_id);
EXCEPTION
WHEN NO_DATA_FOUND THEN
:ln_fileid := 0;
WHEN OTHERS THEN
:ln_fileid := 0;
END;
/
EOF`

if [ "${req_id}" -ne 0 ]
then

# Constructing the names of the request output and email attachment files.

filename=o$req_id.out
file=$filepath$filename
attachment=XX_${email_sub}_$req_id.txt
cp $file $cust_path$attachment

if [ "${email_attachment}" = "Y" ]
then

# Send an email the user with the attachment.

/usr/bin/uuencode $cust_path$attachment $cust_path$attachment | mailx -s ${u_mail_subject}_$req_id -a $cust_path$attachment ${to_email_address} <<-EOF
${email_body}
----------------------------------------------------
This is a system generated mail.Please do not reply.
----------------------------------------------------
EOF
echo "Email sent with attachment."
chmod 777 $cust_path$attachment
rm $cust_path$attachment

else 
cat $file|mailx -s ${u_mail_subject}_$req_id ${to_email_address}
fi

else
echo "No Request Output file found.   Email not sent."
fi

fi

# Exiting from the shell program.
exit 0   # Success.