#!/bin/ksh
# ----------------------------------------------------------------------------------------
# Filename:   XXARDELIVERYDOC
# ----------------------------------------------------------------------------------------

#  Concurrent Program Definitions Parameters
#  var1  is --> Job name 
#  var2  is --> Concurrent Program Request ID.
#  var3  is --> Login Credentials

#  User defined Parameters

#  var9  is --> File Path

# VERSION  AUTHOR                        COMMENTS           DATE     
# ----------------------------------------------------------------------------------------
# 1.0      Shivkumar Arunachalam Iyer    Initial Version    12-JUN-2007 
# ----------------------------------------------------------------------------------------

# Parsing System Defined Parameters.

var1=`echo $1 | awk '{print $1}'| tr -d '"'`
var2=`echo $1 | awk '{print $2}'| tr -d '"'`
var3=`echo $1 | awk '{print $3}'| tr -d '"'`
(warn= -1)

# Defining User Defined Parameters.

var9=`echo $1 | cut -f8 -d '"'`

# Assigning Required Parameters to the Shell variables.

lc_file_path=${var9}
lc_arch_path=$lc_file_path/archive

# Printing User Defined Parameters in the Request Log File.

echo "File Path     : "${var9}
echo "Archive Path  : "${lc_arch_path}

ls -lrt 1>/dev/null $lc_file_path/*.pdf
if [ $? -ne 0 ] 
then
echo "Result/Error                          : No Acrobat Files exist in "$lc_file_path 
else
cd $lc_file_path
for FILE in `ls -rt *.pdf`
do
echo ""
echo "Delivery File                         : "$FILE
attachment=$lc_file_path/$FILE

p_site_use_id=`echo $FILE|awk '{print $1}'| tr -d '.pdf'`
echo "Site Use ID                           : "$p_site_use_id

# Setting up database connection credentials.

appspw=`echo $var3|awk -F= '{print $2}'`
connect=$appspw@$TWO_TASK

# Connecting to Oracle Application Database. 

lc_check=`sqlplus -s ${connect} <<EOF 
SET FEEDBACK OFF
SET SERVEROUTPUT ON SIZE 10000
DECLARE
o_mail_add        VARCHAR2(100);
BEGIN
FND_CLIENT_INFO.SET_ORG_CONTEXT(FND_PROFILE.VALUE('ORG_ID'));
xx_ar_get_delivery_email('$p_site_use_id',o_mail_add);
END;
/
SET FEEDBACK OFF
EOF`

# Determining the Email Address of the Site Use ID. 
o_mail_add=`echo $lc_check | cut -f2 -d '~'`

if [ "$o_mail_add" = "No_Email_Addr" ]
then
echo "Email Address                         : Not Found for the Site Use ID : " $p_site_use_id
echo "Result/Error                          : File Not Delivered."
echo " "
else
echo "Email Address.                        : "$o_mail_add  
/usr/bin/uuencode $attachment $attachment | mailx -s "Delivery_File_Attached" -a $attachment ${o_mail_add} <<-EOF
----------------------------------------------------
This is a system generated mail.Please do not reply.
----------------------------------------------------
EOF

DATE_TIME_STAMP=`date +"%Y%m%d_%H%M%S"`

if (test -r $FILE )
then
mv $lc_file_path/$FILE $lc_arch_path/${p_site_use_id}_${DATE_TIME_STAMP}'.pdf'
echo "Result/Error                          : File "$FILE "delivered and moved to archive folder."
else
echo "Result/Error                          : File "$FILE "has no READ previleges.   Hence cannot be mailed or archived."
fi

fi
done
fi
# Exiting from Shell.
echo " "
echo "Exiting from Shell."
exit 0   # Success.